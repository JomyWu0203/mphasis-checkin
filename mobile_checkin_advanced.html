<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mphasis ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MphasisÈÄ≤ÈöéÊâìÂç°">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-status-bar-style" content="#667eea">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196F3;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            padding: 20px;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .header h1 {
            color: var(--text-dark);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .advanced-badge {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .time-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 3rem;
            font-weight: 200;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-family: monospace;
        }

        .current-date {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .checkin-status {
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            margin: 12px 0;
        }

        .status-not-checked {
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid var(--warning-color);
            color: #ef6c00;
        }

        .status-checked {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid var(--success-color);
            color: #2e7d32;
        }

        .status-checking {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid var(--info-color);
            color: #1565c0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .weekdays-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .weekday-btn {
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .weekday-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .weekday-btn:hover {
            border-color: var(--primary-color);
        }

        .button {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .button-primary {
            background: linear-gradient(45deg, var(--success-color), #45a049);
            color: white;
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.3);
        }

        .button-secondary {
            background: linear-gradient(45deg, var(--info-color), #1976D2);
            color: white;
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.3);
        }

        .button-warning {
            background: linear-gradient(45deg, var(--warning-color), #f57c00);
            color: white;
            box-shadow: 0 6px 25px rgba(255, 152, 0, 0.3);
        }

        .button:active {
            transform: translateY(2px);
        }

        .button:disabled {
            background: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .automation-controls {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .automation-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .automation-title::before {
            content: "ü§ñ";
            margin-right: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: auto;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-message {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success-color);
            color: #2e7d32;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--error-color);
            color: #c62828;
        }

        .status-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid var(--info-color);
            color: #1565c0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--success-color), #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .automation-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            margin: 12px 0;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-warning { color: var(--warning-color); }
        .log-info { color: var(--info-color); }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulsing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ê®ôÈ°å -->
        <div class="card header">
            <h1>ü§ñ Mphasis ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±</h1>
            <div style="color: var(--text-light); font-size: 1rem;">ÂÖ∑ÂÇôÂÆåÊï¥Ëá™ÂãïÂåñÂäüËÉΩ</div>
            <div class="advanced-badge">ÈÄ≤ÈöéÁâà</div>
        </div>

        <!-- ÊôÇÈñìÈ°ØÁ§∫ -->
        <div class="card time-card">
            <div class="current-time" id="currentTime">--:--</div>
            <div class="current-date" id="currentDate">ËºâÂÖ•‰∏≠...</div>
            <div class="checkin-status status-not-checked" id="checkinStatus">
                üîç Ê™¢Êü•ÊâìÂç°ÁãÄÊÖã‰∏≠...
            </div>
        </div>

        <!-- Âü∫Êú¨Ë®≠ÂÆö -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">‚öôÔ∏è Âü∫Êú¨Ë®≠ÂÆö</h3>
            
            <div class="form-group">
                <label for="checkinUrl">üåê ÊâìÂç°Á∂≤ÂùÄÔºö</label>
                <input type="url" id="checkinUrl" value="https://enterprise-apps.mphasis.com/ess/v1/#/home" placeholder="Ë´ãËº∏ÂÖ•ÂÆåÊï¥ÁöÑÊâìÂç°Á∂≤ÂùÄ">
            </div>

            <div class="form-group">
                <label for="checkinTime">‚è∞ ÊâìÂç°ÊôÇÈñìÔºö</label>
                <input type="time" id="checkinTime" value="09:00">
            </div>

            <div class="form-group">
                <label for="companyName">üè¢ ÂÖ¨Âè∏ÂêçÁ®±Ôºö</label>
                <input type="text" id="companyName" value="Mphasis" placeholder="Ë´ãËº∏ÂÖ•ÂÖ¨Âè∏ÂêçÁ®±">
            </div>
        </div>

        <!-- ÊâìÂç°Êó•ÊúüË®≠ÂÆö -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">üìÖ ÊâìÂç°Êó•ÊúüË®≠ÂÆö</h3>
            
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">ÈÅ∏ÊìáÊâìÂç°Êó•ÊúüÔºö</label>
            <div class="weekdays-selector">
                <div class="weekday-btn" data-day="monday">‰∏Ä</div>
                <div class="weekday-btn" data-day="tuesday">‰∫å</div>
                <div class="weekday-btn" data-day="wednesday">‰∏â</div>
                <div class="weekday-btn" data-day="thursday">Âõõ</div>
                <div class="weekday-btn" data-day="friday">‰∫î</div>
                <div class="weekday-btn" data-day="saturday">ÂÖ≠</div>
                <div class="weekday-btn" data-day="sunday">Êó•</div>
            </div>

            <div class="form-group">
                <label for="excludeDates">üö´ ÊéíÈô§Êó•ÊúüÔºö</label>
                <input type="text" id="excludeDates" placeholder="‰æãÂ¶ÇÔºö2024-12-25,2024-01-01" 
                       title="Áî®ÈÄóËôüÂàÜÈöîÂ§öÂÄãÊó•ÊúüÔºåÊ†ºÂºèÔºöYYYY-MM-DD">
            </div>
        </div>

        <!-- Ëá™ÂãïÂåñÊéßÂà∂ -->
        <div class="card">
            <div class="automation-controls">
                <div class="automation-title">
                    Ëá™ÂãïÂåñÊâìÂç°
                    <label class="toggle-switch">
                        <input type="checkbox" id="automationToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="automationOptions" class="hidden">
                    <div class="form-group">
                        <label for="retryAttempts">üîÑ ÈáçË©¶Ê¨°Êï∏Ôºö</label>
                        <select id="retryAttempts">
                            <option value="1">1 Ê¨°</option>
                            <option value="3" selected>3 Ê¨°</option>
                            <option value="5">5 Ê¨°</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="waitTimeout">‚è±Ô∏è Á≠âÂæÖË∂ÖÊôÇÔºàÁßíÔºâÔºö</label>
                        <select id="waitTimeout">
                            <option value="10">10 Áßí</option>
                            <option value="15" selected>15 Áßí</option>
                            <option value="30">30 Áßí</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊâìÂç°ÊéßÂà∂ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">üéØ ÊâìÂç°ÊéßÂà∂</h3>
            
            <button class="button button-primary" onclick="executeAdvancedCheckin()">
                ü§ñ Êô∫ËÉΩËá™ÂãïÊâìÂç°
            </button>

            <button class="button button-secondary" onclick="checkCurrentStatus()">
                üîç Ê™¢Êü•ÊâìÂç°ÁãÄÊÖã
            </button>

            <button class="button button-warning" onclick="testAutomation()">
                üß™ Ê∏¨Ë©¶Ëá™ÂãïÂåñÂäüËÉΩ
            </button>

            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- Ëá™ÂãïÂåñÊó•Ë™å -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">üìã Ëá™ÂãïÂåñÊó•Ë™å</h3>
            
            <div class="automation-log" id="automationLog">
                <div class="log-entry log-info">[INFO] ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±Â∑≤ÂïüÂãï</div>
            </div>

            <button class="button button-secondary" onclick="clearLog()">
                üóëÔ∏è Ê∏ÖÈô§Êó•Ë™å
            </button>

            <button class="button button-secondary" onclick="exportLog()">
                üì§ ÂåØÂá∫Êó•Ë™å
            </button>
        </div>

        <!-- Ë®≠ÂÆöÁÆ°ÁêÜ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">üíæ Ë®≠ÂÆöÁÆ°ÁêÜ</h3>
            
            <button class="button button-secondary" onclick="saveAllSettings()">
                üíæ ÂÑ≤Â≠òÊâÄÊúâË®≠ÂÆö
            </button>

            <button class="button button-secondary" onclick="resetToDefaults()">
                üîÑ ÈáçÁΩÆÁÇ∫È†êË®≠ÂÄº
            </button>

            <button class="button button-secondary" onclick="showAdvancedHelp()">
                ‚ùì ÈÄ≤ÈöéÂäüËÉΩË™™Êòé
            </button>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let settings = {
            checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
            checkinTime: '09:00',
            companyName: 'Mphasis',
            scheduleDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
            excludeDates: [],
            automationEnabled: false,
            retryAttempts: 3,
            waitTimeout: 15
        };

        let automationLog = [];
        let isAutomationRunning = false;
        let checkinWindow = null;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadAllSettings();
            updateTime();
            setInterval(updateTime, 1000);
            setupEventListeners();
            
            addLog('ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê', 'success');
            console.log('ü§ñ Mphasis ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±Â∑≤ÂïüÂãï');
        });

        // Ë®≠ÂÆö‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupEventListeners() {
            // Ëá™ÂãïÂåñÈñãÈóú
            document.getElementById('automationToggle').addEventListener('change', function() {
                const options = document.getElementById('automationOptions');
                if (this.checked) {
                    options.classList.remove('hidden');
                    settings.automationEnabled = true;
                    addLog('Ëá™ÂãïÂåñÂäüËÉΩÂ∑≤ÂïüÁî®', 'info');
                } else {
                    options.classList.add('hidden');
                    settings.automationEnabled = false;
                    addLog('Ëá™ÂãïÂåñÂäüËÉΩÂ∑≤ÂÅúÁî®', 'info');
                }
            });

            // ÈÄ±Êó•ÈÅ∏ÊìáÂô®
            document.querySelectorAll('.weekday-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const day = this.dataset.day;
                    this.classList.toggle('selected');
                    
                    if (this.classList.contains('selected')) {
                        if (!settings.scheduleDays.includes(day)) {
                            settings.scheduleDays.push(day);
                        }
                    } else {
                        settings.scheduleDays = settings.scheduleDays.filter(d => d !== day);
                    }
                    
                    addLog(`ÊâìÂç°Êó•ÊúüÂ∑≤Êõ¥Êñ∞: ${settings.scheduleDays.join(', ')}`, 'info');
                });
            });
        }

        // ËºâÂÖ•ÊâÄÊúâË®≠ÂÆö
        function loadAllSettings() {
            try {
                const saved = localStorage.getItem('mphasis_advanced_settings');
                if (saved) {
                    const savedSettings = JSON.parse(saved);
                    settings = { ...settings, ...savedSettings };
                }
                
                updateSettingsUI();
                addLog('Ë®≠ÂÆöËºâÂÖ•ÂÆåÊàê', 'success');
            } catch (error) {
                addLog('ËºâÂÖ•Ë®≠ÂÆöÂ§±Êïó: ' + error.message, 'error');
            }
        }

        // Êõ¥Êñ∞Ë®≠ÂÆö UI
        function updateSettingsUI() {
            document.getElementById('checkinUrl').value = settings.checkinUrl;
            document.getElementById('checkinTime').value = settings.checkinTime;
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('excludeDates').value = settings.excludeDates.join(',');
            document.getElementById('automationToggle').checked = settings.automationEnabled;
            document.getElementById('retryAttempts').value = settings.retryAttempts;
            document.getElementById('waitTimeout').value = settings.waitTimeout;

            // Êõ¥Êñ∞ÈÄ±Êó•ÈÅ∏ÊìáÂô®
            document.querySelectorAll('.weekday-btn').forEach(btn => {
                const day = btn.dataset.day;
                if (settings.scheduleDays.includes(day)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            // Êõ¥Êñ∞Ëá™ÂãïÂåñÈÅ∏È†ÖÈ°ØÁ§∫
            const options = document.getElementById('automationOptions');
            if (settings.automationEnabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        // Êõ¥Êñ∞ÊôÇÈñì
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // Âü∑Ë°åÈÄ≤ÈöéÊâìÂç°
        async function executeAdvancedCheckin() {
            if (isAutomationRunning) {
                showMessage('‚ö†Ô∏è Ëá™ÂãïÂåñÊâìÂç°Ê≠£Âú®Âü∑Ë°å‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶', 'warning');
                return;
            }

            isAutomationRunning = true;
            showProgress(true);
            addLog('ÈñãÂßãÂü∑Ë°åÈÄ≤ÈöéËá™ÂãïÊâìÂç°', 'info');

            try {
                // Ê™¢Êü•‰ªäÂ§©ÊòØÂê¶ÁÇ∫ÊâìÂç°Êó•
                if (!isTodayScheduled()) {
                    showMessage('‚ÑπÔ∏è ‰ªäÂ§©‰∏çÂú®ÊâìÂç°ÊéíÁ®ã‰∏≠', 'info');
                    addLog('‰ªäÂ§©‰∏çÂú®ÊâìÂç°ÊéíÁ®ã‰∏≠ÔºåË∑≥ÈÅéÊâìÂç°', 'info');
                    return;
                }

                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊéíÈô§Êó•Êúü
                if (isTodayExcluded()) {
                    showMessage('‚ÑπÔ∏è ‰ªäÂ§©ÊòØÊéíÈô§Êó•Êúü', 'info');
                    addLog('‰ªäÂ§©ÊòØÊéíÈô§Êó•ÊúüÔºåË∑≥ÈÅéÊâìÂç°', 'info');
                    return;
                }

                // ÈñãÂïüÊâìÂç°Á∂≤Á´ô
                addLog('Ê≠£Âú®ÈñãÂïüÊâìÂç°Á∂≤Á´ô...', 'info');
                checkinWindow = window.open(settings.checkinUrl, 'checkinWindow', 'width=800,height=600');
                
                if (!checkinWindow) {
                    throw new Error('ÁÑ°Ê≥ïÈñãÂïüÊâìÂç°Á∂≤Á´ôÔºåË´ãÊ™¢Êü•ÂΩàÁ™óË®≠ÂÆö');
                }

                // Á≠âÂæÖÈ†ÅÈù¢ËºâÂÖ•
                await waitForPageLoad();

                // Âü∑Ë°åËá™ÂãïÂåñÊâìÂç°ÊµÅÁ®ã
                if (settings.automationEnabled) {
                    await executeAutomatedCheckin();
                } else {
                    showMessage('‚úÖ ÊâìÂç°Á∂≤Á´ôÂ∑≤ÈñãÂïüÔºåË´ãÊâãÂãïÂÆåÊàêÊâìÂç°', 'success');
                    addLog('ÊâìÂç°Á∂≤Á´ôÂ∑≤ÈñãÂïüÔºåÁ≠âÂæÖÊâãÂãïÊìç‰Ωú', 'info');
                }

            } catch (error) {
                addLog('Ëá™ÂãïÊâìÂç°Âü∑Ë°åÂ§±Êïó: ' + error.message, 'error');
                showMessage('‚ùå Ëá™ÂãïÊâìÂç°Â§±Êïó: ' + error.message, 'error');
            } finally {
                isAutomationRunning = false;
                showProgress(false);
            }
        }

        // Âü∑Ë°åËá™ÂãïÂåñÊâìÂç°ÊµÅÁ®ã
        async function executeAutomatedCheckin() {
            addLog('ÈñãÂßãÂü∑Ë°åËá™ÂãïÂåñÊâìÂç°ÊµÅÁ®ã', 'info');
            
            for (let attempt = 1; attempt <= settings.retryAttempts; attempt++) {
                try {
                    addLog(`Á¨¨ ${attempt} Ê¨°ÂòóË©¶Ëá™ÂãïÊâìÂç°`, 'info');
                    
                    // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊâìÂç°
                    const alreadyCheckedIn = await checkIfAlreadyCheckedIn();
                    if (alreadyCheckedIn) {
                        showMessage('‚úÖ Ê™¢Ê∏¨Âà∞Â∑≤ÊâìÂç°ÔºåÁÑ°ÈúÄÈáçË§áÊìç‰Ωú', 'success');
                        addLog('Ê™¢Ê∏¨Âà∞Â∑≤ÊâìÂç°ÁãÄÊÖã', 'success');
                        return;
                    }

                    // Â∞ãÊâæ‰∏¶ÈªûÊìäÊâìÂç°ÊåâÈàï
                    const success = await findAndClickCheckinButton();
                    if (success) {
                        showMessage('‚úÖ Ëá™ÂãïÊâìÂç°Âü∑Ë°åÊàêÂäüÔºÅ', 'success');
                        addLog('Ëá™ÂãïÊâìÂç°Âü∑Ë°åÊàêÂäü', 'success');
                        
                        // Ë®òÈåÑÊâìÂç°ÊôÇÈñì
                        recordCheckinTime();
                        return;
                    }

                } catch (error) {
                    addLog(`Á¨¨ ${attempt} Ê¨°ÂòóË©¶Â§±Êïó: ${error.message}`, 'warning');
                    
                    if (attempt < settings.retryAttempts) {
                        addLog(`Á≠âÂæÖ 3 ÁßíÂæåÈáçË©¶...`, 'info');
                        await sleep(3000);
                    }
                }
            }

            throw new Error(`ÊâÄÊúâ ${settings.retryAttempts} Ê¨°ÂòóË©¶ÈÉΩÂ§±Êïó‰∫Ü`);
        }

        // Á≠âÂæÖÈ†ÅÈù¢ËºâÂÖ•
        async function waitForPageLoad() {
            addLog('Á≠âÂæÖÈ†ÅÈù¢ËºâÂÖ•ÂÆåÊàê...', 'info');
            
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = settings.waitTimeout;
                
                const checkLoad = () => {
                    attempts++;
                    
                    if (!checkinWindow || checkinWindow.closed) {
                        reject(new Error('ÊâìÂç°Ë¶ñÁ™óÂ∑≤ÈóúÈñâ'));
                        return;
                    }

                    try {
                        // Ê™¢Êü•È†ÅÈù¢ÊòØÂê¶ËºâÂÖ•ÂÆåÊàê
                        if (checkinWindow.document && checkinWindow.document.readyState === 'complete') {
                            addLog('È†ÅÈù¢ËºâÂÖ•ÂÆåÊàê', 'success');
                            resolve();
                            return;
                        }
                    } catch (e) {
                        // Ë∑®ÂüüÈôêÂà∂ÔºåÂÅáË®≠È†ÅÈù¢Â∑≤ËºâÂÖ•
                        if (attempts >= 5) {
                            addLog('ÂÅáË®≠È†ÅÈù¢Â∑≤ËºâÂÖ•ÂÆåÊàêÔºàË∑®ÂüüÈôêÂà∂Ôºâ', 'info');
                            resolve();
                            return;
                        }
                    }

                    if (attempts >= maxAttempts) {
                        reject(new Error('È†ÅÈù¢ËºâÂÖ•Ë∂ÖÊôÇ'));
                        return;
                    }

                    setTimeout(checkLoad, 1000);
                };

                setTimeout(checkLoad, 2000); // ÂàùÂßãÂª∂ÈÅ≤
            });
        }

        // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊâìÂç°
        async function checkIfAlreadyCheckedIn() {
            addLog('Ê™¢Êü•ÊâìÂç°ÁãÄÊÖã...', 'info');
            
            try {
                if (!checkinWindow || checkinWindow.closed) {
                    throw new Error('ÊâìÂç°Ë¶ñÁ™ó‰∏çÂèØÁî®');
                }

                // Áî±ÊñºË∑®ÂüüÈôêÂà∂ÔºåÊàëÂÄëÁÑ°Ê≥ïÁõ¥Êé•Ê™¢Êü•È†ÅÈù¢ÂÖßÂÆπ
                // ÈÄôË£°Êèê‰æõ‰∏ÄÂÄãÊ®°Êì¨ÁöÑÊ™¢Êü•ÈÇèËºØ
                addLog('Áî±ÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÁÑ°Ê≥ïËá™ÂãïÊ™¢Êü•ÊâìÂç°ÁãÄÊÖã', 'warning');
                addLog('Ë´ãÊâãÂãïÁ¢∫Ë™çÊòØÂê¶Â∑≤ÊâìÂç°', 'info');
                
                return false; // ÂÅáË®≠Êú™ÊâìÂç°ÔºåÁπºÁ∫åÂü∑Ë°å
                
            } catch (error) {
                addLog('Ê™¢Êü•ÊâìÂç°ÁãÄÊÖãÂ§±Êïó: ' + error.message, 'warning');
                return false;
            }
        }

        // Â∞ãÊâæ‰∏¶ÈªûÊìäÊâìÂç°ÊåâÈàï
        async function findAndClickCheckinButton() {
            addLog('Â∞ãÊâæÊâìÂç°ÊåâÈàï...', 'info');
            
            try {
                if (!checkinWindow || checkinWindow.closed) {
                    throw new Error('ÊâìÂç°Ë¶ñÁ™ó‰∏çÂèØÁî®');
                }

                // Áî±ÊñºË∑®ÂüüÈôêÂà∂ÔºåÊàëÂÄëÁÑ°Ê≥ïÁõ¥Êé•Êìç‰ΩúÈ†ÅÈù¢ÂÖÉÁ¥†
                // ÈÄôË£°Êèê‰æõÊåáÂ∞éË®äÊÅØÁµ¶Áî®Êà∂
                addLog('Áî±ÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÁÑ°Ê≥ïËá™ÂãïÈªûÊìäÊåâÈàï', 'warning');
                addLog('Ë´ãÂú®ÈñãÂïüÁöÑË¶ñÁ™ó‰∏≠ÊâãÂãïÈªûÊìä CHECK-IN ÊåâÈàï', 'info');
                
                showMessage('üîç Ë´ãÂú®ÊâìÂç°Ë¶ñÁ™ó‰∏≠Â∞ãÊâæ‰∏¶ÈªûÊìä "CHECK-IN" ÊåâÈàï', 'info');
                
                // Áõ£ÊéßË¶ñÁ™óÁãÄÊÖã
                return await monitorCheckinWindow();
                
            } catch (error) {
                addLog('Â∞ãÊâæÊâìÂç°ÊåâÈàïÂ§±Êïó: ' + error.message, 'error');
                return false;
            }
        }

        // Áõ£ÊéßÊâìÂç°Ë¶ñÁ™ó
        async function monitorCheckinWindow() {
            return new Promise((resolve) => {
                let monitorCount = 0;
                const maxMonitor = 60; // Áõ£Êéß 60 Áßí
                
                const monitor = () => {
                    monitorCount++;
                    
                    if (!checkinWindow || checkinWindow.closed) {
                        addLog('ÊâìÂç°Ë¶ñÁ™óÂ∑≤ÈóúÈñâÔºåÂÅáË®≠ÊâìÂç°ÂÆåÊàê', 'info');
                        resolve(true);
                        return;
                    }

                    if (monitorCount >= maxMonitor) {
                        addLog('Áõ£ÊéßË∂ÖÊôÇÔºåË´ãÁ¢∫Ë™çÊâìÂç°ÊòØÂê¶ÂÆåÊàê', 'warning');
                        resolve(false);
                        return;
                    }

                    setTimeout(monitor, 1000);
                };

                setTimeout(monitor, 1000);
            });
        }

        // Ê™¢Êü•‰ªäÂ§©ÊòØÂê¶ÁÇ∫ÊâìÂç°Êó•
        function isTodayScheduled() {
            const today = new Date();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayName = dayNames[today.getDay()];
            
            return settings.scheduleDays.includes(todayName);
        }

        // Ê™¢Êü•‰ªäÂ§©ÊòØÂê¶ÁÇ∫ÊéíÈô§Êó•Êúü
        function isTodayExcluded() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD Ê†ºÂºè
            return settings.excludeDates.includes(today);
        }

        // Ê™¢Êü•Áï∂ÂâçÁãÄÊÖã
        async function checkCurrentStatus() {
            addLog('Ê™¢Êü•Áï∂ÂâçÊâìÂç°ÁãÄÊÖã', 'info');
            showProgress(true);

            try {
                const today = new Date();
                const isScheduled = isTodayScheduled();
                const isExcluded = isTodayExcluded();
                
                let statusText = '';
                let statusClass = '';

                if (isExcluded) {
                    statusText = 'üö´ ‰ªäÂ§©ÊòØÊéíÈô§Êó•ÊúüÔºå‰∏çÈúÄË¶ÅÊâìÂç°';
                    statusClass = 'status-info';
                } else if (!isScheduled) {
                    statusText = 'üìÖ ‰ªäÂ§©‰∏çÂú®ÊâìÂç°ÊéíÁ®ã‰∏≠';
                    statusClass = 'status-info';
                } else {
                    statusText = '‚è∞ ‰ªäÂ§©ÈúÄË¶ÅÊâìÂç°';
                    statusClass = 'status-not-checked';
                }

                document.getElementById('checkinStatus').textContent = statusText;
                document.getElementById('checkinStatus').className = `checkin-status ${statusClass}`;
                
                addLog(`ÁãÄÊÖãÊ™¢Êü•ÂÆåÊàê: ${statusText}`, 'info');
                showMessage('‚úÖ ÁãÄÊÖãÊ™¢Êü•ÂÆåÊàê', 'success');

            } catch (error) {
                addLog('ÁãÄÊÖãÊ™¢Êü•Â§±Êïó: ' + error.message, 'error');
                showMessage('‚ùå ÁãÄÊÖãÊ™¢Êü•Â§±Êïó', 'error');
            } finally {
                showProgress(false);
            }
        }

        // Ê∏¨Ë©¶Ëá™ÂãïÂåñÂäüËÉΩ
        async function testAutomation() {
            addLog('ÈñãÂßãÊ∏¨Ë©¶Ëá™ÂãïÂåñÂäüËÉΩ', 'info');
            showProgress(true);

            try {
                // Ê∏¨Ë©¶Ë®≠ÂÆöËºâÂÖ•
                addLog('‚úì Ë®≠ÂÆöËºâÂÖ•Ê∏¨Ë©¶ÈÄöÈÅé', 'success');
                
                // Ê∏¨Ë©¶Êó•ÊúüÊ™¢Êü•
                const isScheduled = isTodayScheduled();
                const isExcluded = isTodayExcluded();
                addLog(`‚úì Êó•ÊúüÊ™¢Êü•Ê∏¨Ë©¶ÈÄöÈÅé - ÊéíÁ®ã: ${isScheduled}, ÊéíÈô§: ${isExcluded}`, 'success');
                
                // Ê∏¨Ë©¶Ë¶ñÁ™óÈñãÂïü
                const testWindow = window.open('about:blank', 'testWindow', 'width=400,height=300');
                if (testWindow) {
                    addLog('‚úì Ë¶ñÁ™óÈñãÂïüÊ∏¨Ë©¶ÈÄöÈÅé', 'success');
                    setTimeout(() => testWindow.close(), 2000);
                } else {
                    addLog('‚úó Ë¶ñÁ™óÈñãÂïüÊ∏¨Ë©¶Â§±Êïó - Ë´ãÊ™¢Êü•ÂΩàÁ™óË®≠ÂÆö', 'error');
                }
                
                // Ê∏¨Ë©¶ÂÑ≤Â≠òÂäüËÉΩ
                const testData = { test: 'automation_test' };
                localStorage.setItem('mphasis_test', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('mphasis_test'));
                if (retrieved.test === 'automation_test') {
                    addLog('‚úì ÂÑ≤Â≠òÂäüËÉΩÊ∏¨Ë©¶ÈÄöÈÅé', 'success');
                    localStorage.removeItem('mphasis_test');
                } else {
                    addLog('‚úó ÂÑ≤Â≠òÂäüËÉΩÊ∏¨Ë©¶Â§±Êïó', 'error');
                }

                showMessage('‚úÖ Ëá™ÂãïÂåñÂäüËÉΩÊ∏¨Ë©¶ÂÆåÊàê', 'success');
                
            } catch (error) {
                addLog('Ëá™ÂãïÂåñÂäüËÉΩÊ∏¨Ë©¶Â§±Êïó: ' + error.message, 'error');
                showMessage('‚ùå Ëá™ÂãïÂåñÂäüËÉΩÊ∏¨Ë©¶Â§±Êïó', 'error');
            } finally {
                showProgress(false);
            }
        }

        // ÂÑ≤Â≠òÊâÄÊúâË®≠ÂÆö
        function saveAllSettings() {
            try {
                // Âæû UI Áç≤ÂèñÊúÄÊñ∞Ë®≠ÂÆö
                settings.checkinUrl = document.getElementById('checkinUrl').value.trim();
                settings.checkinTime = document.getElementById('checkinTime').value;
                settings.companyName = document.getElementById('companyName').value.trim();
                settings.excludeDates = document.getElementById('excludeDates').value
                    .split(',')
                    .map(date => date.trim())
                    .filter(date => date);
                settings.automationEnabled = document.getElementById('automationToggle').checked;
                settings.retryAttempts = parseInt(document.getElementById('retryAttempts').value);
                settings.waitTimeout = parseInt(document.getElementById('waitTimeout').value);

                // ÂÑ≤Â≠òÂà∞ localStorage
                localStorage.setItem('mphasis_advanced_settings', JSON.stringify(settings));
                
                addLog('ÊâÄÊúâË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò', 'success');
                showMessage('‚úÖ ÊâÄÊúâË®≠ÂÆöÂ∑≤ÊàêÂäüÂÑ≤Â≠ò', 'success');
                
            } catch (error) {
                addLog('ÂÑ≤Â≠òË®≠ÂÆöÂ§±Êïó: ' + error.message, 'error');
                showMessage('‚ùå ÂÑ≤Â≠òË®≠ÂÆöÂ§±Êïó', 'error');
            }
        }

        // ÈáçÁΩÆÁÇ∫È†êË®≠ÂÄº
        function resetToDefaults() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâË®≠ÂÆöÁÇ∫È†êË®≠ÂÄºÂóéÔºü')) {
                settings = {
                    checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
                    checkinTime: '09:00',
                    companyName: 'Mphasis',
                    scheduleDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                    excludeDates: [],
                    automationEnabled: false,
                    retryAttempts: 3,
                    waitTimeout: 15
                };

                updateSettingsUI();
                saveAllSettings();
                
                addLog('Ë®≠ÂÆöÂ∑≤ÈáçÁΩÆÁÇ∫È†êË®≠ÂÄº', 'info');
                showMessage('‚úÖ Ë®≠ÂÆöÂ∑≤ÈáçÁΩÆÁÇ∫È†êË®≠ÂÄº', 'success');
            }
        }

        // Ë®òÈåÑÊâìÂç°ÊôÇÈñì
        function recordCheckinTime() {
            const now = new Date();
            const record = {
                timestamp: now.toISOString(),
                time: now.toLocaleString('zh-TW'),
                type: 'advanced_auto',
                success: true
            };

            try {
                const history = JSON.parse(localStorage.getItem('mphasis_checkin_history') || '[]');
                history.unshift(record);
                
                if (history.length > 100) {
                    history.splice(100);
                }
                
                localStorage.setItem('mphasis_checkin_history', JSON.stringify(history));
                localStorage.setItem('mphasis_last_checkin', JSON.stringify(record));
                
                addLog(`ÊâìÂç°Ë®òÈåÑÂ∑≤ÂÑ≤Â≠ò: ${record.time}`, 'success');
                
            } catch (error) {
                addLog('ÂÑ≤Â≠òÊâìÂç°Ë®òÈåÑÂ§±Êïó: ' + error.message, 'error');
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∏
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showProgress(show) {
            const progressBar = document.getElementById('progressBar');
            if (show) {
                progressBar.classList.remove('hidden');
                animateProgress();
            } else {
                progressBar.classList.add('hidden');
            }
        }

        function animateProgress() {
            const fill = document.getElementById('progressFill');
            let width = 0;
            const interval = setInterval(() => {
                width += Math.random() * 10;
                if (width >= 90) {
                    width = 90;
                    clearInterval(interval);
                }
                fill.style.width = width + '%';
            }, 500);
        }

        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('statusMessage');
            messageContainer.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;

            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = {
                timestamp,
                message,
                type
            };
            
            automationLog.unshift(logEntry);
            
            if (automationLog.length > 100) {
                automationLog.splice(100);
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('automationLog');
            const html = automationLog.slice(0, 20).map(entry => 
                `<div class="log-entry log-${entry.type}">[${entry.type.toUpperCase()}] ${entry.timestamp} - ${entry.message}</div>`
            ).join('');
            
            logContainer.innerHTML = html;
            logContainer.scrollTop = 0;
        }

        function clearLog() {
            automationLog = [];
            updateLogDisplay();
            addLog('Êó•Ë™åÂ∑≤Ê∏ÖÈô§', 'info');
        }

        function exportLog() {
            try {
                const logData = automationLog.map(entry => 
                    `[${entry.type.toUpperCase()}] ${entry.timestamp} - ${entry.message}`
                ).join('\n');
                
                const blob = new Blob([logData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `mphasis_automation_log_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addLog('Êó•Ë™åÂ∑≤ÂåØÂá∫', 'success');
                showMessage('‚úÖ Êó•Ë™åÂ∑≤ÂåØÂá∫', 'success');
                
            } catch (error) {
                addLog('ÂåØÂá∫Êó•Ë™åÂ§±Êïó: ' + error.message, 'error');
                showMessage('‚ùå ÂåØÂá∫Êó•Ë™åÂ§±Êïó', 'error');
            }
        }

        function showAdvancedHelp() {
            const helpText = `
ü§ñ ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±ÂäüËÉΩË™™Êòé

üìÖ ÊâìÂç°Êó•ÊúüË®≠ÂÆöÔºö
‚Ä¢ ÈªûÊìäÈÄ±‰∏ÄÂà∞ÈÄ±Êó•ÈÅ∏ÊìáÊâìÂç°Êó•Êúü
‚Ä¢ ÊîØÊè¥ÊéíÈô§ÁâπÂÆöÊó•ÊúüÔºàÁØÄÂÅáÊó•Á≠âÔºâ

üîß Ëá™ÂãïÂåñÂäüËÉΩÔºö
‚Ä¢ Êô∫ËÉΩÊ™¢Ê∏¨ÊâìÂç°ÁãÄÊÖã
‚Ä¢ Ëá™ÂãïÈáçË©¶Ê©üÂà∂
‚Ä¢ ÂèØË™øÊï¥Á≠âÂæÖË∂ÖÊôÇÊôÇÈñì

‚ö†Ô∏è ÈáçË¶ÅÊèêÈÜíÔºö
‚Ä¢ Áî±ÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÊüê‰∫õËá™ÂãïÂåñÂäüËÉΩÈúÄË¶ÅÊâãÂãïÈÖçÂêà
‚Ä¢ Âª∫Ë≠∞ÂÖà‰ΩøÁî®Ê∏¨Ë©¶ÂäüËÉΩÁ¢∫Ë™çÁ≥ªÁµ±Ê≠£Â∏∏
‚Ä¢ Ë´ãÁ¢∫‰øùÂΩàÁ™óË®≠ÂÆöÂÖÅË®±ÈñãÂïüÊñ∞Ë¶ñÁ™ó

üõ†Ô∏è ÊïÖÈöúÊéíÈô§Ôºö
‚Ä¢ Â¶ÇÊûúËá™ÂãïÂåñÂ§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö
‚Ä¢ Á¢∫Ë™çÊâìÂç°Á∂≤ÂùÄÊ≠£Á¢∫
‚Ä¢ Ê™¢Êü•ÁÄèË¶ΩÂô®ÂΩàÁ™óË®≠ÂÆö
            `;
            
            alert(helpText);
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàê
        addLog('ÈÄ≤ÈöéÊâìÂç°Á≥ªÁµ±ËºâÂÖ•ÂÆåÊàê', 'success');
    </script>
</body>
</html>
