<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mphasis é€²éšæ‰“å¡ç³»çµ±</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mphasisé€²éšæ‰“å¡">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-status-bar-style" content="#667eea">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196F3;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            padding: 20px;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .header h1 {
            color: var(--text-dark);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .advanced-badge {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .time-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 3rem;
            font-weight: 200;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-family: monospace;
        }

        .current-date {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .checkin-status {
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            margin: 12px 0;
        }

        .status-not-checked {
            background: rgba(255, 152, 0, 0.1);
            border: 2px solid var(--warning-color);
            color: #ef6c00;
        }

        .status-checked {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid var(--success-color);
            color: #2e7d32;
        }

        .status-checking {
            background: rgba(33, 150, 243, 0.1);
            border: 2px solid var(--info-color);
            color: #1565c0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .weekdays-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .weekday-btn {
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .weekday-btn.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .weekday-btn:hover {
            border-color: var(--primary-color);
        }

        .button {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .button-primary {
            background: linear-gradient(45deg, var(--success-color), #45a049);
            color: white;
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.3);
        }

        .button-secondary {
            background: linear-gradient(45deg, var(--info-color), #1976D2);
            color: white;
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.3);
        }

        .button-warning {
            background: linear-gradient(45deg, var(--warning-color), #f57c00);
            color: white;
            box-shadow: 0 6px 25px rgba(255, 152, 0, 0.3);
        }

        .button:active {
            transform: translateY(2px);
        }

        .button:disabled {
            background: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .automation-controls {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .automation-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .automation-title::before {
            content: "ğŸ¤–";
            margin-right: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: auto;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .status-message {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success-color);
            color: #2e7d32;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--error-color);
            color: #c62828;
        }

        .status-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid var(--info-color);
            color: #1565c0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--success-color), #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .automation-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            margin: 12px 0;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-warning { color: var(--warning-color); }
        .log-info { color: var(--info-color); }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulsing {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="card header">
            <h1>ğŸ¤– Mphasis é€²éšæ‰“å¡ç³»çµ±</h1>
            <div style="color: var(--text-light); font-size: 1rem;">å…·å‚™å®Œæ•´è‡ªå‹•åŒ–åŠŸèƒ½</div>
            <div class="advanced-badge">é€²éšç‰ˆ</div>
        </div>

        <!-- æ™‚é–“é¡¯ç¤º -->
        <div class="card time-card">
            <div class="current-time" id="currentTime">--:--</div>
            <div class="current-date" id="currentDate">è¼‰å…¥ä¸­...</div>
            <div class="checkin-status status-not-checked" id="checkinStatus">
                ğŸ” æª¢æŸ¥æ‰“å¡ç‹€æ…‹ä¸­...
            </div>
        </div>

        <!-- åŸºæœ¬è¨­å®š -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">âš™ï¸ åŸºæœ¬è¨­å®š</h3>
            
            <div class="form-group">
                <label for="checkinUrl">ğŸŒ æ‰“å¡ç¶²å€ï¼š</label>
                <input type="url" id="checkinUrl" value="https://enterprise-apps.mphasis.com/ess/v1/#/home" placeholder="è«‹è¼¸å…¥å®Œæ•´çš„æ‰“å¡ç¶²å€">
            </div>

            <div class="form-group">
                <label for="checkinTime">â° æ‰“å¡æ™‚é–“ï¼š</label>
                <input type="time" id="checkinTime" value="09:00">
            </div>

            <div class="form-group">
                <label for="companyName">ğŸ¢ å…¬å¸åç¨±ï¼š</label>
                <input type="text" id="companyName" value="Mphasis" placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±">
            </div>
        </div>

        <!-- æ‰“å¡æ—¥æœŸè¨­å®š -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ“… æ‰“å¡æ—¥æœŸè¨­å®š</h3>
            
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">é¸æ“‡æ‰“å¡æ—¥æœŸï¼š</label>
            <div class="weekdays-selector">
                <div class="weekday-btn" data-day="monday">ä¸€</div>
                <div class="weekday-btn" data-day="tuesday">äºŒ</div>
                <div class="weekday-btn" data-day="wednesday">ä¸‰</div>
                <div class="weekday-btn" data-day="thursday">å››</div>
                <div class="weekday-btn" data-day="friday">äº”</div>
                <div class="weekday-btn" data-day="saturday">å…­</div>
                <div class="weekday-btn" data-day="sunday">æ—¥</div>
            </div>

            <div class="form-group">
                <label for="excludeDates">ğŸš« æ’é™¤æ—¥æœŸï¼š</label>
                <input type="text" id="excludeDates" placeholder="ä¾‹å¦‚ï¼š2024-12-25,2024-01-01" 
                       title="ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD">
            </div>
        </div>

        <!-- è‡ªå‹•åŒ–æ§åˆ¶ -->
        <div class="card">
            <div class="automation-controls">
                <div class="automation-title">
                    è‡ªå‹•åŒ–æ‰“å¡
                    <label class="toggle-switch">
                        <input type="checkbox" id="automationToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="automationOptions" class="hidden">
                    <div class="form-group">
                        <label for="retryAttempts">ğŸ”„ é‡è©¦æ¬¡æ•¸ï¼š</label>
                        <select id="retryAttempts">
                            <option value="1">1 æ¬¡</option>
                            <option value="3" selected>3 æ¬¡</option>
                            <option value="5">5 æ¬¡</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="waitTimeout">â±ï¸ ç­‰å¾…è¶…æ™‚ï¼ˆç§’ï¼‰ï¼š</label>
                        <select id="waitTimeout">
                            <option value="10">10 ç§’</option>
                            <option value="15" selected>15 ç§’</option>
                            <option value="30">30 ç§’</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰“å¡æ§åˆ¶ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ¯ æ‰“å¡æ§åˆ¶</h3>
            
            <button class="button button-primary" onclick="executeAdvancedCheckin()">
                ğŸ¤– æ™ºèƒ½è‡ªå‹•æ‰“å¡
            </button>

            <button class="button button-secondary" onclick="checkCurrentStatus()">
                ğŸ” æª¢æŸ¥æ‰“å¡ç‹€æ…‹
            </button>

            <button class="button button-warning" onclick="testAutomation()">
                ğŸ§ª æ¸¬è©¦è‡ªå‹•åŒ–åŠŸèƒ½
            </button>

            <div class="progress-bar hidden" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- è‡ªå‹•åŒ–æ—¥èªŒ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ“‹ è‡ªå‹•åŒ–æ—¥èªŒ</h3>
            
            <div class="automation-log" id="automationLog">
                <div class="log-entry log-info">[INFO] é€²éšæ‰“å¡ç³»çµ±å·²å•Ÿå‹•</div>
            </div>

            <button class="button button-secondary" onclick="clearLog()">
                ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ
            </button>

            <button class="button button-secondary" onclick="exportLog()">
                ğŸ“¤ åŒ¯å‡ºæ—¥èªŒ
            </button>
        </div>

        <!-- è¨­å®šç®¡ç† -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ’¾ è¨­å®šç®¡ç†</h3>
            
            <button class="button button-secondary" onclick="saveAllSettings()">
                ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š
            </button>

            <button class="button button-secondary" onclick="resetToDefaults()">
                ğŸ”„ é‡ç½®ç‚ºé è¨­å€¼
            </button>

            <button class="button button-secondary" onclick="showAdvancedHelp()">
                â“ é€²éšåŠŸèƒ½èªªæ˜
            </button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let settings = {
            checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
            checkinTime: '09:00',
            companyName: 'Mphasis',
            scheduleDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
            excludeDates: [],
            automationEnabled: false,
            retryAttempts: 3,
            waitTimeout: 15
        };

        let automationLog = [];
        let isAutomationRunning = false;
        let checkinWindow = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAllSettings();
            updateTime();
            setInterval(updateTime, 1000);
            setupEventListeners();
            
            addLog('é€²éšæ‰“å¡ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'success');
            console.log('ğŸ¤– Mphasis é€²éšæ‰“å¡ç³»çµ±å·²å•Ÿå‹•');
        });

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è‡ªå‹•åŒ–é–‹é—œ
            document.getElementById('automationToggle').addEventListener('change', function() {
                const options = document.getElementById('automationOptions');
                if (this.checked) {
                    options.classList.remove('hidden');
                    settings.automationEnabled = true;
                    addLog('è‡ªå‹•åŒ–åŠŸèƒ½å·²å•Ÿç”¨', 'info');
                } else {
                    options.classList.add('hidden');
                    settings.automationEnabled = false;
                    addLog('è‡ªå‹•åŒ–åŠŸèƒ½å·²åœç”¨', 'info');
                }
            });

            // é€±æ—¥é¸æ“‡å™¨
            document.querySelectorAll('.weekday-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const day = this.dataset.day;
                    this.classList.toggle('selected');
                    
                    if (this.classList.contains('selected')) {
                        if (!settings.scheduleDays.includes(day)) {
                            settings.scheduleDays.push(day);
                        }
                    } else {
                        settings.scheduleDays = settings.scheduleDays.filter(d => d !== day);
                    }
                    
                    addLog(`æ‰“å¡æ—¥æœŸå·²æ›´æ–°: ${settings.scheduleDays.join(', ')}`, 'info');
                });
            });
        }

        // è¼‰å…¥æ‰€æœ‰è¨­å®š
        function loadAllSettings() {
            try {
                const saved = localStorage.getItem('mphasis_advanced_settings');
                if (saved) {
                    const savedSettings = JSON.parse(saved);
                    settings = { ...settings, ...savedSettings };
                }
                
                updateSettingsUI();
                addLog('è¨­å®šè¼‰å…¥å®Œæˆ', 'success');
            } catch (error) {
                addLog('è¼‰å…¥è¨­å®šå¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ›´æ–°è¨­å®š UI
        function updateSettingsUI() {
            document.getElementById('checkinUrl').value = settings.checkinUrl;
            document.getElementById('checkinTime').value = settings.checkinTime;
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('excludeDates').value = settings.excludeDates.join(',');
            document.getElementById('automationToggle').checked = settings.automationEnabled;
            document.getElementById('retryAttempts').value = settings.retryAttempts;
            document.getElementById('waitTimeout').value = settings.waitTimeout;

            // æ›´æ–°é€±æ—¥é¸æ“‡å™¨
            document.querySelectorAll('.weekday-btn').forEach(btn => {
                const day = btn.dataset.day;
                if (settings.scheduleDays.includes(day)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            // æ›´æ–°è‡ªå‹•åŒ–é¸é …é¡¯ç¤º
            const options = document.getElementById('automationOptions');
            if (settings.automationEnabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('currentDate').textContent = dateStr;
        }

        // åŸ·è¡Œé€²éšæ‰“å¡
        async function executeAdvancedCheckin() {
            if (isAutomationRunning) {
                showMessage('âš ï¸ è‡ªå‹•åŒ–æ‰“å¡æ­£åœ¨åŸ·è¡Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
                return;
            }

            isAutomationRunning = true;
            showProgress(true);
            addLog('é–‹å§‹åŸ·è¡Œé€²éšè‡ªå‹•æ‰“å¡', 'info');

            try {
                // æª¢æŸ¥ä»Šå¤©æ˜¯å¦ç‚ºæ‰“å¡æ—¥
                if (!isTodayScheduled()) {
                    showMessage('â„¹ï¸ ä»Šå¤©ä¸åœ¨æ‰“å¡æ’ç¨‹ä¸­', 'info');
                    addLog('ä»Šå¤©ä¸åœ¨æ‰“å¡æ’ç¨‹ä¸­ï¼Œè·³éæ‰“å¡', 'info');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦ç‚ºæ’é™¤æ—¥æœŸ
                if (isTodayExcluded()) {
                    showMessage('â„¹ï¸ ä»Šå¤©æ˜¯æ’é™¤æ—¥æœŸ', 'info');
                    addLog('ä»Šå¤©æ˜¯æ’é™¤æ—¥æœŸï¼Œè·³éæ‰“å¡', 'info');
                    return;
                }

                // é–‹å•Ÿæ‰“å¡ç¶²ç«™
                addLog('æ­£åœ¨é–‹å•Ÿæ‰“å¡ç¶²ç«™...', 'info');
                checkinWindow = window.open(settings.checkinUrl, 'checkinWindow', 'width=800,height=600');
                
                if (!checkinWindow) {
                    throw new Error('ç„¡æ³•é–‹å•Ÿæ‰“å¡ç¶²ç«™ï¼Œè«‹æª¢æŸ¥å½ˆçª—è¨­å®š');
                }

                // ç­‰å¾…é é¢è¼‰å…¥
                await waitForPageLoad();

                // åŸ·è¡Œè‡ªå‹•åŒ–æ‰“å¡æµç¨‹
                if (settings.automationEnabled) {
                    await executeAutomatedCheckin();
                } else {
                    showMessage('âœ… æ‰“å¡ç¶²ç«™å·²é–‹å•Ÿï¼Œè«‹æ‰‹å‹•å®Œæˆæ‰“å¡', 'success');
                    addLog('æ‰“å¡ç¶²ç«™å·²é–‹å•Ÿï¼Œç­‰å¾…æ‰‹å‹•æ“ä½œ', 'info');
                }

            } catch (error) {
                addLog('è‡ªå‹•æ‰“å¡åŸ·è¡Œå¤±æ•—: ' + error.message, 'error');
                showMessage('âŒ è‡ªå‹•æ‰“å¡å¤±æ•—: ' + error.message, 'error');
            } finally {
                isAutomationRunning = false;
                showProgress(false);
            }
        }

        // åŸ·è¡Œè‡ªå‹•åŒ–æ‰“å¡æµç¨‹
        async function executeAutomatedCheckin() {
            addLog('é–‹å§‹åŸ·è¡Œè‡ªå‹•åŒ–æ‰“å¡æµç¨‹', 'info');
            
            for (let attempt = 1; attempt <= settings.retryAttempts; attempt++) {
                try {
                    addLog(`ç¬¬ ${attempt} æ¬¡å˜—è©¦è‡ªå‹•æ‰“å¡`, 'info');
                    
                    // æª¢æŸ¥æ˜¯å¦å·²æ‰“å¡
                    const alreadyCheckedIn = await checkIfAlreadyCheckedIn();
                    if (alreadyCheckedIn) {
                        showMessage('âœ… æª¢æ¸¬åˆ°å·²æ‰“å¡ï¼Œç„¡éœ€é‡è¤‡æ“ä½œ', 'success');
                        addLog('æª¢æ¸¬åˆ°å·²æ‰“å¡ç‹€æ…‹', 'success');
                        return;
                    }

                    // å°‹æ‰¾ä¸¦é»æ“Šæ‰“å¡æŒ‰éˆ•
                    const success = await findAndClickCheckinButton();
                    if (success) {
                        showMessage('âœ… è‡ªå‹•æ‰“å¡åŸ·è¡ŒæˆåŠŸï¼', 'success');
                        addLog('è‡ªå‹•æ‰“å¡åŸ·è¡ŒæˆåŠŸ', 'success');
                        
                        // è¨˜éŒ„æ‰“å¡æ™‚é–“
                        recordCheckinTime();
                        return;
                    }

                } catch (error) {
                    addLog(`ç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—: ${error.message}`, 'warning');
                    
                    if (attempt < settings.retryAttempts) {
                        addLog(`ç­‰å¾… 3 ç§’å¾Œé‡è©¦...`, 'info');
                        await sleep(3000);
                    }
                }
            }

            throw new Error(`æ‰€æœ‰ ${settings.retryAttempts} æ¬¡å˜—è©¦éƒ½å¤±æ•—äº†`);
        }

        // ç­‰å¾…é é¢è¼‰å…¥
        async function waitForPageLoad() {
            addLog('ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ...', 'info');
            
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = settings.waitTimeout;
                
                const checkLoad = () => {
                    attempts++;
                    
                    if (!checkinWindow || checkinWindow.closed) {
                        reject(new Error('æ‰“å¡è¦–çª—å·²é—œé–‰'));
                        return;
                    }

                    try {
                        // æª¢æŸ¥é é¢æ˜¯å¦è¼‰å…¥å®Œæˆ
                        if (checkinWindow.document && checkinWindow.document.readyState === 'complete') {
                            addLog('é é¢è¼‰å…¥å®Œæˆ', 'success');
                            resolve();
                            return;
                        }
                    } catch (e) {
                        // è·¨åŸŸé™åˆ¶ï¼Œå‡è¨­é é¢å·²è¼‰å…¥
                        if (attempts >= 5) {
                            addLog('å‡è¨­é é¢å·²è¼‰å…¥å®Œæˆï¼ˆè·¨åŸŸé™åˆ¶ï¼‰', 'info');
                            resolve();
                            return;
                        }
                    }

                    if (attempts >= maxAttempts) {
                        reject(new Error('é é¢è¼‰å…¥è¶…æ™‚'));
                        return;
                    }

                    setTimeout(checkLoad, 1000);
                };

                setTimeout(checkLoad, 2000); // åˆå§‹å»¶é²
            });
        }

        // æª¢æŸ¥æ˜¯å¦å·²æ‰“å¡
        async function checkIfAlreadyCheckedIn() {
            addLog('æª¢æŸ¥æ‰“å¡ç‹€æ…‹...', 'info');
            
            try {
                if (!checkinWindow || checkinWindow.closed) {
                    throw new Error('æ‰“å¡è¦–çª—ä¸å¯ç”¨');
                }

                // ç”±æ–¼è·¨åŸŸé™åˆ¶ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥æª¢æŸ¥é é¢å…§å®¹
                // é€™è£¡æä¾›ä¸€å€‹æ¨¡æ“¬çš„æª¢æŸ¥é‚è¼¯
                addLog('ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•è‡ªå‹•æª¢æŸ¥æ‰“å¡ç‹€æ…‹', 'warning');
                addLog('è«‹æ‰‹å‹•ç¢ºèªæ˜¯å¦å·²æ‰“å¡', 'info');
                
                return false; // å‡è¨­æœªæ‰“å¡ï¼Œç¹¼çºŒåŸ·è¡Œ
                
            } catch (error) {
                addLog('æª¢æŸ¥æ‰“å¡ç‹€æ…‹å¤±æ•—: ' + error.message, 'warning');
                return false;
            }
        }

        // å°‹æ‰¾ä¸¦é»æ“Šæ‰“å¡æŒ‰éˆ•
        async function findAndClickCheckinButton() {
            addLog('å°‹æ‰¾æ‰“å¡æŒ‰éˆ•...', 'info');
            
            try {
                if (!checkinWindow || checkinWindow.closed) {
                    throw new Error('æ‰“å¡è¦–çª—ä¸å¯ç”¨');
                }

                // ç”±æ–¼è·¨åŸŸé™åˆ¶ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥æ“ä½œé é¢å…ƒç´ 
                // é€™è£¡æä¾›æŒ‡å°è¨Šæ¯çµ¦ç”¨æˆ¶
                addLog('ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•è‡ªå‹•é»æ“ŠæŒ‰éˆ•', 'warning');
                addLog('è«‹åœ¨é–‹å•Ÿçš„è¦–çª—ä¸­æ‰‹å‹•é»æ“Š CHECK-IN æŒ‰éˆ•', 'info');
                
                showMessage('ğŸ” è«‹åœ¨æ‰“å¡è¦–çª—ä¸­å°‹æ‰¾ä¸¦é»æ“Š "CHECK-IN" æŒ‰éˆ•', 'info');
                
                // ç›£æ§è¦–çª—ç‹€æ…‹
                return await monitorCheckinWindow();
                
            } catch (error) {
                addLog('å°‹æ‰¾æ‰“å¡æŒ‰éˆ•å¤±æ•—: ' + error.message, 'error');
                return false;
            }
        }

        // ç›£æ§æ‰“å¡è¦–çª—
        async function monitorCheckinWindow() {
            return new Promise((resolve) => {
                let monitorCount = 0;
                const maxMonitor = 60; // ç›£æ§ 60 ç§’
                
                const monitor = () => {
                    monitorCount++;
                    
                    if (!checkinWindow || checkinWindow.closed) {
                        addLog('æ‰“å¡è¦–çª—å·²é—œé–‰ï¼Œå‡è¨­æ‰“å¡å®Œæˆ', 'info');
                        resolve(true);
                        return;
                    }

                    if (monitorCount >= maxMonitor) {
                        addLog('ç›£æ§è¶…æ™‚ï¼Œè«‹ç¢ºèªæ‰“å¡æ˜¯å¦å®Œæˆ', 'warning');
                        resolve(false);
                        return;
                    }

                    setTimeout(monitor, 1000);
                };

                setTimeout(monitor, 1000);
            });
        }

        // æª¢æŸ¥ä»Šå¤©æ˜¯å¦ç‚ºæ‰“å¡æ—¥
        function isTodayScheduled() {
            const today = new Date();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayName = dayNames[today.getDay()];
            
            return settings.scheduleDays.includes(todayName);
        }

        // æª¢æŸ¥ä»Šå¤©æ˜¯å¦ç‚ºæ’é™¤æ—¥æœŸ
        function isTodayExcluded() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼
            return settings.excludeDates.includes(today);
        }

        // æª¢æŸ¥ç•¶å‰ç‹€æ…‹
        async function checkCurrentStatus() {
            addLog('æª¢æŸ¥ç•¶å‰æ‰“å¡ç‹€æ…‹', 'info');
            showProgress(true);

            try {
                const today = new Date();
                const isScheduled = isTodayScheduled();
                const isExcluded = isTodayExcluded();
                
                let statusText = '';
                let statusClass = '';

                if (isExcluded) {
                    statusText = 'ğŸš« ä»Šå¤©æ˜¯æ’é™¤æ—¥æœŸï¼Œä¸éœ€è¦æ‰“å¡';
                    statusClass = 'status-info';
                } else if (!isScheduled) {
                    statusText = 'ğŸ“… ä»Šå¤©ä¸åœ¨æ‰“å¡æ’ç¨‹ä¸­';
                    statusClass = 'status-info';
                } else {
                    statusText = 'â° ä»Šå¤©éœ€è¦æ‰“å¡';
                    statusClass = 'status-not-checked';
                }

                document.getElementById('checkinStatus').textContent = statusText;
                document.getElementById('checkinStatus').className = `checkin-status ${statusClass}`;
                
                addLog(`ç‹€æ…‹æª¢æŸ¥å®Œæˆ: ${statusText}`, 'info');
                showMessage('âœ… ç‹€æ…‹æª¢æŸ¥å®Œæˆ', 'success');

            } catch (error) {
                addLog('ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ' + error.message, 'error');
                showMessage('âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—', 'error');
            } finally {
                showProgress(false);
            }
        }

        // æ¸¬è©¦è‡ªå‹•åŒ–åŠŸèƒ½
        async function testAutomation() {
            addLog('é–‹å§‹æ¸¬è©¦è‡ªå‹•åŒ–åŠŸèƒ½', 'info');
            showProgress(true);

            try {
                // æ¸¬è©¦è¨­å®šè¼‰å…¥
                addLog('âœ“ è¨­å®šè¼‰å…¥æ¸¬è©¦é€šé', 'success');
                
                // æ¸¬è©¦æ—¥æœŸæª¢æŸ¥
                const isScheduled = isTodayScheduled();
                const isExcluded = isTodayExcluded();
                addLog(`âœ“ æ—¥æœŸæª¢æŸ¥æ¸¬è©¦é€šé - æ’ç¨‹: ${isScheduled}, æ’é™¤: ${isExcluded}`, 'success');
                
                // æ¸¬è©¦è¦–çª—é–‹å•Ÿ
                const testWindow = window.open('about:blank', 'testWindow', 'width=400,height=300');
                if (testWindow) {
                    addLog('âœ“ è¦–çª—é–‹å•Ÿæ¸¬è©¦é€šé', 'success');
                    setTimeout(() => testWindow.close(), 2000);
                } else {
                    addLog('âœ— è¦–çª—é–‹å•Ÿæ¸¬è©¦å¤±æ•— - è«‹æª¢æŸ¥å½ˆçª—è¨­å®š', 'error');
                }
                
                // æ¸¬è©¦å„²å­˜åŠŸèƒ½
                const testData = { test: 'automation_test' };
                localStorage.setItem('mphasis_test', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('mphasis_test'));
                if (retrieved.test === 'automation_test') {
                    addLog('âœ“ å„²å­˜åŠŸèƒ½æ¸¬è©¦é€šé', 'success');
                    localStorage.removeItem('mphasis_test');
                } else {
                    addLog('âœ— å„²å­˜åŠŸèƒ½æ¸¬è©¦å¤±æ•—', 'error');
                }

                showMessage('âœ… è‡ªå‹•åŒ–åŠŸèƒ½æ¸¬è©¦å®Œæˆ', 'success');
                
            } catch (error) {
                addLog('è‡ªå‹•åŒ–åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ' + error.message, 'error');
                showMessage('âŒ è‡ªå‹•åŒ–åŠŸèƒ½æ¸¬è©¦å¤±æ•—', 'error');
            } finally {
                showProgress(false);
            }
        }

        // å„²å­˜æ‰€æœ‰è¨­å®š
        function saveAllSettings() {
            try {
                // å¾ UI ç²å–æœ€æ–°è¨­å®š
                settings.checkinUrl = document.getElementById('checkinUrl').value.trim();
                settings.checkinTime = document.getElementById('checkinTime').value;
                settings.companyName = document.getElementById('companyName').value.trim();
                settings.excludeDates = document.getElementById('excludeDates').value
                    .split(',')
                    .map(date => date.trim())
                    .filter(date => date);
                settings.automationEnabled = document.getElementById('automationToggle').checked;
                settings.retryAttempts = parseInt(document.getElementById('retryAttempts').value);
                settings.waitTimeout = parseInt(document.getElementById('waitTimeout').value);

                // å„²å­˜åˆ° localStorage
                localStorage.setItem('mphasis_advanced_settings', JSON.stringify(settings));
                
                addLog('æ‰€æœ‰è¨­å®šå·²å„²å­˜', 'success');
                showMessage('âœ… æ‰€æœ‰è¨­å®šå·²æˆåŠŸå„²å­˜', 'success');
                
            } catch (error) {
                addLog('å„²å­˜è¨­å®šå¤±æ•—: ' + error.message, 'error');
                showMessage('âŒ å„²å­˜è¨­å®šå¤±æ•—', 'error');
            }
        }

        // é‡ç½®ç‚ºé è¨­å€¼
        function resetToDefaults() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šç‚ºé è¨­å€¼å—ï¼Ÿ')) {
                settings = {
                    checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
                    checkinTime: '09:00',
                    companyName: 'Mphasis',
                    scheduleDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
                    excludeDates: [],
                    automationEnabled: false,
                    retryAttempts: 3,
                    waitTimeout: 15
                };

                updateSettingsUI();
                saveAllSettings();
                
                addLog('è¨­å®šå·²é‡ç½®ç‚ºé è¨­å€¼', 'info');
                showMessage('âœ… è¨­å®šå·²é‡ç½®ç‚ºé è¨­å€¼', 'success');
            }
        }

        // è¨˜éŒ„æ‰“å¡æ™‚é–“
        function recordCheckinTime() {
            const now = new Date();
            const record = {
                timestamp: now.toISOString(),
                time: now.toLocaleString('zh-TW'),
                type: 'advanced_auto',
                success: true
            };

            try {
                const history = JSON.parse(localStorage.getItem('mphasis_checkin_history') || '[]');
                history.unshift(record);
                
                if (history.length > 100) {
                    history.splice(100);
                }
                
                localStorage.setItem('mphasis_checkin_history', JSON.stringify(history));
                localStorage.setItem('mphasis_last_checkin', JSON.stringify(record));
                
                addLog(`æ‰“å¡è¨˜éŒ„å·²å„²å­˜: ${record.time}`, 'success');
                
            } catch (error) {
                addLog('å„²å­˜æ‰“å¡è¨˜éŒ„å¤±æ•—: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•¸
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showProgress(show) {
            const progressBar = document.getElementById('progressBar');
            if (show) {
                progressBar.classList.remove('hidden');
                animateProgress();
            } else {
                progressBar.classList.add('hidden');
            }
        }

        function animateProgress() {
            const fill = document.getElementById('progressFill');
            let width = 0;
            const interval = setInterval(() => {
                width += Math.random() * 10;
                if (width >= 90) {
                    width = 90;
                    clearInterval(interval);
                }
                fill.style.width = width + '%';
            }, 500);
        }

        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('statusMessage');
            messageContainer.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;

            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = {
                timestamp,
                message,
                type
            };
            
            automationLog.unshift(logEntry);
            
            if (automationLog.length > 100) {
                automationLog.splice(100);
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('automationLog');
            const html = automationLog.slice(0, 20).map(entry => 
                `<div class="log-entry log-${entry.type}">[${entry.type.toUpperCase()}] ${entry.timestamp} - ${entry.message}</div>`
            ).join('');
            
            logContainer.innerHTML = html;
            logContainer.scrollTop = 0;
        }

        function clearLog() {
            automationLog = [];
            updateLogDisplay();
            addLog('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        function exportLog() {
            try {
                const logData = automationLog.map(entry => 
                    `[${entry.type.toUpperCase()}] ${entry.timestamp} - ${entry.message}`
                ).join('\n');
                
                const blob = new Blob([logData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `mphasis_automation_log_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addLog('æ—¥èªŒå·²åŒ¯å‡º', 'success');
                showMessage('âœ… æ—¥èªŒå·²åŒ¯å‡º', 'success');
                
            } catch (error) {
                addLog('åŒ¯å‡ºæ—¥èªŒå¤±æ•—: ' + error.message, 'error');
                showMessage('âŒ åŒ¯å‡ºæ—¥èªŒå¤±æ•—', 'error');
            }
        }

        function showAdvancedHelp() {
            const helpText = `
ğŸ¤– é€²éšæ‰“å¡ç³»çµ±åŠŸèƒ½èªªæ˜

ğŸ“… æ‰“å¡æ—¥æœŸè¨­å®šï¼š
â€¢ é»æ“Šé€±ä¸€åˆ°é€±æ—¥é¸æ“‡æ‰“å¡æ—¥æœŸ
â€¢ æ”¯æ´æ’é™¤ç‰¹å®šæ—¥æœŸï¼ˆç¯€å‡æ—¥ç­‰ï¼‰

ğŸ”§ è‡ªå‹•åŒ–åŠŸèƒ½ï¼š
â€¢ æ™ºèƒ½æª¢æ¸¬æ‰“å¡ç‹€æ…‹
â€¢ è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
â€¢ å¯èª¿æ•´ç­‰å¾…è¶…æ™‚æ™‚é–“

âš ï¸ é‡è¦æé†’ï¼š
â€¢ ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼ŒæŸäº›è‡ªå‹•åŒ–åŠŸèƒ½éœ€è¦æ‰‹å‹•é…åˆ
â€¢ å»ºè­°å…ˆä½¿ç”¨æ¸¬è©¦åŠŸèƒ½ç¢ºèªç³»çµ±æ­£å¸¸
â€¢ è«‹ç¢ºä¿å½ˆçª—è¨­å®šå…è¨±é–‹å•Ÿæ–°è¦–çª—

ğŸ› ï¸ æ•…éšœæ’é™¤ï¼š
â€¢ å¦‚æœè‡ªå‹•åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š
â€¢ ç¢ºèªæ‰“å¡ç¶²å€æ­£ç¢º
â€¢ æª¢æŸ¥ç€è¦½å™¨å½ˆçª—è¨­å®š
            `;
            
            alert(helpText);
        }

        // é é¢è¼‰å…¥å®Œæˆ
        addLog('é€²éšæ‰“å¡ç³»çµ±è¼‰å…¥å®Œæˆ', 'success');
    </script>
</body>
</html>
