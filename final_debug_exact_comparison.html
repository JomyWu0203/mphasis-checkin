<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最終對比診斷</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .side-by-side {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .version-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
        }
        
        .working { border-color: #28a745; background: #f8fff8; }
        .broken { border-color: #dc3545; background: #fff8f8; }
        
        .test-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-primary { background: #007bff; color: white; }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 8px 0;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        h2 {
            text-align: center;
            color: #333;
        }
        
        .exact-diff {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>🔍 最終對比診斷：找出確切差異</h2>
        
        <div class="exact-diff">
            <strong>目標：</strong>完全複製測試版的成功邏輯到正式版<br>
            <strong>方法：</strong>逐行對比，找出每一個細微差異
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <label>測試時間：</label>
            <input type="time" id="testTime" value="15:05">
            
            <label>提前提醒：</label>
            <select id="testMinutes">
                <option value="5">5 分鐘</option>
                <option value="10">10 分鐘</option>
                <option value="15">15 分鐘</option>
            </select>
        </div>
        
        <div class="side-by-side">
            <div class="version-box working">
                <h3>✅ 測試版 (確實能用)</h3>
                <button class="test-btn btn-success" onclick="runTestVersion()">
                    🧪 執行測試版邏輯
                </button>
                <div class="log-area" id="testLog">
                    準備執行測試版...
                </div>
            </div>
            
            <div class="version-box broken">
                <h3>❌ 正式版 (不能用)</h3>
                <button class="test-btn btn-danger" onclick="runFormalVersion()">
                    📱 執行正式版邏輯
                </button>
                <div class="log-area" id="formalLog">
                    準備執行正式版...
                </div>
            </div>
        </div>
        
        <button class="test-btn btn-primary" onclick="compareExactly()">
            🔍 精確對比差異
        </button>
        
        <div id="differenceAnalysis" style="display: none; background: #e3f2fd; padding: 16px; border-radius: 8px; margin: 16px 0;">
            <h4>差異分析結果：</h4>
            <div id="diffContent"></div>
        </div>
        
        <button class="test-btn" onclick="generateFixedVersion()" style="background: #ff9800; color: white;">
            🔧 生成修復版本
        </button>
    </div>

    <script>
        function log(area, message, type = 'info') {
            const logElement = document.getElementById(area);
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : '📝';
            
            logElement.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog(area) {
            document.getElementById(area).innerHTML = '';
        }
        
        // 測試版的確切實現 (完全複製)
        function runTestVersion() {
            clearLog('testLog');
            log('testLog', '🧪 開始執行測試版邏輯...');
            
            try {
                // 測試版的設定
                var settings = {
                    checkinTime: document.getElementById('testTime').value,
                    reminderMinutes: parseInt(document.getElementById('testMinutes').value),
                    weeklyDays: [1, 2, 3, 4, 5],
                    excludeHolidays: true
                };
                
                log('testLog', `📋 設定: ${JSON.stringify(settings)}`);
                
                // 測試版的時間計算
                var timeParts = settings.checkinTime.split(':');
                var reminderHour = parseInt(timeParts[0]);
                var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
                
                if (reminderMinute < 0) {
                    reminderMinute += 60;
                    reminderHour -= 1;
                }
                
                log('testLog', `⏰ 提醒時間: ${reminderHour}:${reminderMinute.toString().padStart(2, '0')}`);
                
                // 測試版的週間格式
                var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
                
                log('testLog', `📅 週間格式: ${selectedDays}`);
                
                // 測試版的 iCal 內容 (確切複製)
                var icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasis打卡系統//NONSGML//EN
BEGIN:VEVENT
SUMMARY:🎯 Mphasis 自動打卡提醒 (測試)
DESCRIPTION:📱 Safari 直接測試版本
DTSTART:20250101T${reminderHour.toString().padStart(2, '0')}${reminderMinute.toString().padStart(2, '0')}00Z
DTEND:20250101T${reminderHour.toString().padStart(2, '0')}${(reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=${selectedDays}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:🚀 立即打卡！測試提醒
END:VALARM
END:VEVENT
END:VCALENDAR`;
                
                log('testLog', '📋 iCal 內容已生成');
                log('testLog', `內容長度: ${icalContent.length} 字元`);
                
                // 測試版的下載方法 (確切複製)
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    log('testLog', '✅ Data URL 成功開啟新視窗', 'success');
                    log('testLog', '✅ 測試版執行完成', 'success');
                } else {
                    log('testLog', '❌ Data URL 失敗：彈出視窗被阻擋', 'error');
                }
                
                // 儲存測試版結果
                window.testVersionResult = {
                    success: !!newWindow,
                    icalContent: icalContent,
                    dataUrl: dataUrl
                };
                
            } catch (error) {
                log('testLog', `❌ 測試版錯誤: ${error.message}`, 'error');
                console.error('測試版錯誤詳情:', error);
            }
        }
        
        // 正式版的當前實現 (模擬)
        function runFormalVersion() {
            clearLog('formalLog');
            log('formalLog', '📱 開始執行正式版邏輯...');
            
            try {
                // 正式版的設定 (可能的差異點 1)
                var settings = {
                    checkinTime: document.getElementById('testTime').value,
                    reminderMinutes: parseInt(document.getElementById('testMinutes').value),
                    weeklyDays: [1, 2, 3, 4, 5],
                    excludeHolidays: true
                };
                
                log('formalLog', `📋 設定: ${JSON.stringify(settings)}`);
                
                // 正式版的時間計算 (可能的差異點 2)
                var timeParts = settings.checkinTime.split(':');
                var reminderHour = parseInt(timeParts[0]);
                var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
                
                if (reminderMinute < 0) {
                    reminderMinute += 60;
                    reminderHour -= 1;
                }
                
                log('formalLog', `⏰ 提醒時間: ${reminderHour}:${reminderMinute.toString().padStart(2, '0')}`);
                
                // 正式版的週間格式 (可能的差異點 3)
                var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
                
                log('formalLog', `📅 週間格式: ${selectedDays}`);
                
                // 正式版的額外變數 (可能的差異點 4)
                var wakeupUrl = window.location.href.split('?')[0] + '?wakeup=calendar&time=' + 
                               reminderHour.toString().padStart(2, '0') + 
                               reminderMinute.toString().padStart(2, '0');
                
                log('formalLog', `🔗 喚醒 URL: ${wakeupUrl.substring(0, 50)}...`);
                
                // 正式版的 iCal 內容 (可能的差異點 5)
                var icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasis打卡系統//NONSGML//EN
BEGIN:VEVENT
SUMMARY:🎯 Mphasis 自動打卡提醒
DESCRIPTION:📱 智慧打卡系統啟動！點擊此提醒將自動開啟打卡應用
DTSTART:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute).toString().padStart(2, '0')}00Z
DTEND:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=${selectedDays}
URL:${wakeupUrl}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:🚀 立即打卡！點擊開啟智慧打卡系統
URL:${wakeupUrl}
END:VALARM
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:⏰ 5分鐘後需要打卡！準備開始
END:VALARM
END:VEVENT
END:VCALENDAR`;
                
                log('formalLog', '📋 iCal 內容已生成');
                log('formalLog', `內容長度: ${icalContent.length} 字元`);
                
                // 正式版的下載方法 (可能的差異點 6)
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    log('formalLog', '✅ Data URL 成功開啟新視窗', 'success');
                    log('formalLog', '✅ 正式版執行完成', 'success');
                } else {
                    log('formalLog', '❌ Data URL 失敗：彈出視窗被阻擋', 'error');
                }
                
                // 儲存正式版結果
                window.formalVersionResult = {
                    success: !!newWindow,
                    icalContent: icalContent,
                    dataUrl: dataUrl
                };
                
            } catch (error) {
                log('formalLog', `❌ 正式版錯誤: ${error.message}`, 'error');
                console.error('正式版錯誤詳情:', error);
            }
        }
        
        function compareExactly() {
            if (!window.testVersionResult || !window.formalVersionResult) {
                alert('請先執行兩個版本的測試');
                return;
            }
            
            const analysisDiv = document.getElementById('differenceAnalysis');
            const diffContent = document.getElementById('diffContent');
            
            let differences = [];
            
            // 比較成功狀態
            if (window.testVersionResult.success !== window.formalVersionResult.success) {
                differences.push(`執行結果: 測試版${window.testVersionResult.success ? '成功' : '失敗'}, 正式版${window.formalVersionResult.success ? '成功' : '失敗'}`);
            }
            
            // 比較 iCal 內容長度
            const testLen = window.testVersionResult.icalContent.length;
            const formalLen = window.formalVersionResult.icalContent.length;
            if (testLen !== formalLen) {
                differences.push(`iCal 長度: 測試版${testLen}字元, 正式版${formalLen}字元`);
            }
            
            // 比較具體內容差異
            const testLines = window.testVersionResult.icalContent.split('\n');
            const formalLines = window.formalVersionResult.icalContent.split('\n');
            
            const maxLines = Math.max(testLines.length, formalLines.length);
            for (let i = 0; i < maxLines; i++) {
                const testLine = testLines[i] || '';
                const formalLine = formalLines[i] || '';
                
                if (testLine !== formalLine) {
                    differences.push(`第${i+1}行: 測試版"${testLine}" vs 正式版"${formalLine}"`);
                }
            }
            
            if (differences.length === 0) {
                diffContent.innerHTML = '✅ 沒有發現差異！兩個版本的邏輯完全相同。';
            } else {
                diffContent.innerHTML = `❌ 發現 ${differences.length} 個差異：<br><br>` + 
                                       differences.map((diff, index) => `${index + 1}. ${diff}`).join('<br>');
            }
            
            analysisDiv.style.display = 'block';
            
            // 詳細輸出到 console
            console.log('=== 測試版 iCal 內容 ===');
            console.log(window.testVersionResult.icalContent);
            console.log('=== 正式版 iCal 內容 ===');
            console.log(window.formalVersionResult.icalContent);
            console.log('=== 差異列表 ===');
            console.log(differences);
        }
        
        function generateFixedVersion() {
            if (!window.testVersionResult) {
                alert('請先執行測試版以獲取正確的實現');
                return;
            }
            
            // 生成修復後的程式碼
            const fixedCode = `
// 修復後的正式版 - 完全複製測試版的成功邏輯
function setupIOSCalendar() {
    console.log('📅 setupIOSCalendar() 開始執行 (修復版)');
    
    try {
        // 使用測試版相同的設定結構
        var timeParts = settings.checkinTime.split(':');
        var reminderHour = parseInt(timeParts[0]);
        var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
        
        if (reminderMinute < 0) {
            reminderMinute += 60;
            reminderHour -= 1;
        }
        
        // 使用測試版相同的週間轉換
        var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
        var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
        
        // 使用測試版確切相同的 iCal 內容
        var icalContent = \`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasis打卡系統//NONSGML//EN
BEGIN:VEVENT
SUMMARY:🎯 Mphasis 自動打卡提醒
DESCRIPTION:📱 智慧打卡系統提醒
DTSTART:20250101T\${reminderHour.toString().padStart(2, '0')}\${reminderMinute.toString().padStart(2, '0')}00Z
DTEND:20250101T\${reminderHour.toString().padStart(2, '0')}\${(reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=\${selectedDays}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:🚀 立即打卡！
END:VALARM
END:VEVENT
END:VCALENDAR\`;
        
        // 使用測試版確切相同的下載方法
        var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
        var newWindow = window.open(dataUrl, '_blank');
        
        if (newWindow) {
            console.log('✅ 修復版成功');
            showMessage('📅 行事曆檔案已開啟！請在新視窗中點擊「分享」→「加入行事曆」', 'success');
        } else {
            console.log('❌ 修復版失敗：彈出視窗被阻擋');
            showMessage('❌ 彈出視窗被阻擋，請檢查瀏覽器設定', 'error');
        }
        
    } catch (error) {
        console.error('修復版錯誤:', error);
        showMessage('❌ 執行錯誤: ' + error.message, 'error');
    }
}`;
            
            console.log('=== 修復後的程式碼 ===');
            console.log(fixedCode);
            
            alert('修復版程式碼已生成！\n請查看瀏覽器 Console (F12) 獲取完整程式碼。\n\n這個版本完全複製了測試版的成功邏輯。');
        }
        
        // 初始化
        window.addEventListener('load', function() {
            console.log('🔍 最終診斷工具已載入');
        });
    </script>
</body>
</html>
