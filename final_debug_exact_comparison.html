<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€çµ‚å°æ¯”è¨ºæ–·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .side-by-side {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .version-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 16px;
        }
        
        .working { border-color: #28a745; background: #f8fff8; }
        .broken { border-color: #dc3545; background: #fff8f8; }
        
        .test-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-primary { background: #007bff; color: white; }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 8px 0;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        h2 {
            text-align: center;
            color: #333;
        }
        
        .exact-diff {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ” æœ€çµ‚å°æ¯”è¨ºæ–·ï¼šæ‰¾å‡ºç¢ºåˆ‡å·®ç•°</h2>
        
        <div class="exact-diff">
            <strong>ç›®æ¨™ï¼š</strong>å®Œå…¨è¤‡è£½æ¸¬è©¦ç‰ˆçš„æˆåŠŸé‚è¼¯åˆ°æ­£å¼ç‰ˆ<br>
            <strong>æ–¹æ³•ï¼š</strong>é€è¡Œå°æ¯”ï¼Œæ‰¾å‡ºæ¯ä¸€å€‹ç´°å¾®å·®ç•°
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <label>æ¸¬è©¦æ™‚é–“ï¼š</label>
            <input type="time" id="testTime" value="15:05">
            
            <label>æå‰æé†’ï¼š</label>
            <select id="testMinutes">
                <option value="5">5 åˆ†é˜</option>
                <option value="10">10 åˆ†é˜</option>
                <option value="15">15 åˆ†é˜</option>
            </select>
        </div>
        
        <div class="side-by-side">
            <div class="version-box working">
                <h3>âœ… æ¸¬è©¦ç‰ˆ (ç¢ºå¯¦èƒ½ç”¨)</h3>
                <button class="test-btn btn-success" onclick="runTestVersion()">
                    ğŸ§ª åŸ·è¡Œæ¸¬è©¦ç‰ˆé‚è¼¯
                </button>
                <div class="log-area" id="testLog">
                    æº–å‚™åŸ·è¡Œæ¸¬è©¦ç‰ˆ...
                </div>
            </div>
            
            <div class="version-box broken">
                <h3>âŒ æ­£å¼ç‰ˆ (ä¸èƒ½ç”¨)</h3>
                <button class="test-btn btn-danger" onclick="runFormalVersion()">
                    ğŸ“± åŸ·è¡Œæ­£å¼ç‰ˆé‚è¼¯
                </button>
                <div class="log-area" id="formalLog">
                    æº–å‚™åŸ·è¡Œæ­£å¼ç‰ˆ...
                </div>
            </div>
        </div>
        
        <button class="test-btn btn-primary" onclick="compareExactly()">
            ğŸ” ç²¾ç¢ºå°æ¯”å·®ç•°
        </button>
        
        <div id="differenceAnalysis" style="display: none; background: #e3f2fd; padding: 16px; border-radius: 8px; margin: 16px 0;">
            <h4>å·®ç•°åˆ†æçµæœï¼š</h4>
            <div id="diffContent"></div>
        </div>
        
        <button class="test-btn" onclick="generateFixedVersion()" style="background: #ff9800; color: white;">
            ğŸ”§ ç”Ÿæˆä¿®å¾©ç‰ˆæœ¬
        </button>
    </div>

    <script>
        function log(area, message, type = 'info') {
            const logElement = document.getElementById(area);
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
            
            logElement.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog(area) {
            document.getElementById(area).innerHTML = '';
        }
        
        // æ¸¬è©¦ç‰ˆçš„ç¢ºåˆ‡å¯¦ç¾ (å®Œå…¨è¤‡è£½)
        function runTestVersion() {
            clearLog('testLog');
            log('testLog', 'ğŸ§ª é–‹å§‹åŸ·è¡Œæ¸¬è©¦ç‰ˆé‚è¼¯...');
            
            try {
                // æ¸¬è©¦ç‰ˆçš„è¨­å®š
                var settings = {
                    checkinTime: document.getElementById('testTime').value,
                    reminderMinutes: parseInt(document.getElementById('testMinutes').value),
                    weeklyDays: [1, 2, 3, 4, 5],
                    excludeHolidays: true
                };
                
                log('testLog', `ğŸ“‹ è¨­å®š: ${JSON.stringify(settings)}`);
                
                // æ¸¬è©¦ç‰ˆçš„æ™‚é–“è¨ˆç®—
                var timeParts = settings.checkinTime.split(':');
                var reminderHour = parseInt(timeParts[0]);
                var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
                
                if (reminderMinute < 0) {
                    reminderMinute += 60;
                    reminderHour -= 1;
                }
                
                log('testLog', `â° æé†’æ™‚é–“: ${reminderHour}:${reminderMinute.toString().padStart(2, '0')}`);
                
                // æ¸¬è©¦ç‰ˆçš„é€±é–“æ ¼å¼
                var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
                
                log('testLog', `ğŸ“… é€±é–“æ ¼å¼: ${selectedDays}`);
                
                // æ¸¬è©¦ç‰ˆçš„ iCal å…§å®¹ (ç¢ºåˆ‡è¤‡è£½)
                var icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasisæ‰“å¡ç³»çµ±//NONSGML//EN
BEGIN:VEVENT
SUMMARY:ğŸ¯ Mphasis è‡ªå‹•æ‰“å¡æé†’ (æ¸¬è©¦)
DESCRIPTION:ğŸ“± Safari ç›´æ¥æ¸¬è©¦ç‰ˆæœ¬
DTSTART:20250101T${reminderHour.toString().padStart(2, '0')}${reminderMinute.toString().padStart(2, '0')}00Z
DTEND:20250101T${reminderHour.toString().padStart(2, '0')}${(reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=${selectedDays}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:ğŸš€ ç«‹å³æ‰“å¡ï¼æ¸¬è©¦æé†’
END:VALARM
END:VEVENT
END:VCALENDAR`;
                
                log('testLog', 'ğŸ“‹ iCal å…§å®¹å·²ç”Ÿæˆ');
                log('testLog', `å…§å®¹é•·åº¦: ${icalContent.length} å­—å…ƒ`);
                
                // æ¸¬è©¦ç‰ˆçš„ä¸‹è¼‰æ–¹æ³• (ç¢ºåˆ‡è¤‡è£½)
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    log('testLog', 'âœ… Data URL æˆåŠŸé–‹å•Ÿæ–°è¦–çª—', 'success');
                    log('testLog', 'âœ… æ¸¬è©¦ç‰ˆåŸ·è¡Œå®Œæˆ', 'success');
                } else {
                    log('testLog', 'âŒ Data URL å¤±æ•—ï¼šå½ˆå‡ºè¦–çª—è¢«é˜»æ“‹', 'error');
                }
                
                // å„²å­˜æ¸¬è©¦ç‰ˆçµæœ
                window.testVersionResult = {
                    success: !!newWindow,
                    icalContent: icalContent,
                    dataUrl: dataUrl
                };
                
            } catch (error) {
                log('testLog', `âŒ æ¸¬è©¦ç‰ˆéŒ¯èª¤: ${error.message}`, 'error');
                console.error('æ¸¬è©¦ç‰ˆéŒ¯èª¤è©³æƒ…:', error);
            }
        }
        
        // æ­£å¼ç‰ˆçš„ç•¶å‰å¯¦ç¾ (æ¨¡æ“¬)
        function runFormalVersion() {
            clearLog('formalLog');
            log('formalLog', 'ğŸ“± é–‹å§‹åŸ·è¡Œæ­£å¼ç‰ˆé‚è¼¯...');
            
            try {
                // æ­£å¼ç‰ˆçš„è¨­å®š (å¯èƒ½çš„å·®ç•°é» 1)
                var settings = {
                    checkinTime: document.getElementById('testTime').value,
                    reminderMinutes: parseInt(document.getElementById('testMinutes').value),
                    weeklyDays: [1, 2, 3, 4, 5],
                    excludeHolidays: true
                };
                
                log('formalLog', `ğŸ“‹ è¨­å®š: ${JSON.stringify(settings)}`);
                
                // æ­£å¼ç‰ˆçš„æ™‚é–“è¨ˆç®— (å¯èƒ½çš„å·®ç•°é» 2)
                var timeParts = settings.checkinTime.split(':');
                var reminderHour = parseInt(timeParts[0]);
                var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
                
                if (reminderMinute < 0) {
                    reminderMinute += 60;
                    reminderHour -= 1;
                }
                
                log('formalLog', `â° æé†’æ™‚é–“: ${reminderHour}:${reminderMinute.toString().padStart(2, '0')}`);
                
                // æ­£å¼ç‰ˆçš„é€±é–“æ ¼å¼ (å¯èƒ½çš„å·®ç•°é» 3)
                var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
                var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
                
                log('formalLog', `ğŸ“… é€±é–“æ ¼å¼: ${selectedDays}`);
                
                // æ­£å¼ç‰ˆçš„é¡å¤–è®Šæ•¸ (å¯èƒ½çš„å·®ç•°é» 4)
                var wakeupUrl = window.location.href.split('?')[0] + '?wakeup=calendar&time=' + 
                               reminderHour.toString().padStart(2, '0') + 
                               reminderMinute.toString().padStart(2, '0');
                
                log('formalLog', `ğŸ”— å–šé†’ URL: ${wakeupUrl.substring(0, 50)}...`);
                
                // æ­£å¼ç‰ˆçš„ iCal å…§å®¹ (å¯èƒ½çš„å·®ç•°é» 5)
                var icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasisæ‰“å¡ç³»çµ±//NONSGML//EN
BEGIN:VEVENT
SUMMARY:ğŸ¯ Mphasis è‡ªå‹•æ‰“å¡æé†’
DESCRIPTION:ğŸ“± æ™ºæ…§æ‰“å¡ç³»çµ±å•Ÿå‹•ï¼é»æ“Šæ­¤æé†’å°‡è‡ªå‹•é–‹å•Ÿæ‰“å¡æ‡‰ç”¨
DTSTART:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute).toString().padStart(2, '0')}00Z
DTEND:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=${selectedDays}
URL:${wakeupUrl}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:ğŸš€ ç«‹å³æ‰“å¡ï¼é»æ“Šé–‹å•Ÿæ™ºæ…§æ‰“å¡ç³»çµ±
URL:${wakeupUrl}
END:VALARM
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:â° 5åˆ†é˜å¾Œéœ€è¦æ‰“å¡ï¼æº–å‚™é–‹å§‹
END:VALARM
END:VEVENT
END:VCALENDAR`;
                
                log('formalLog', 'ğŸ“‹ iCal å…§å®¹å·²ç”Ÿæˆ');
                log('formalLog', `å…§å®¹é•·åº¦: ${icalContent.length} å­—å…ƒ`);
                
                // æ­£å¼ç‰ˆçš„ä¸‹è¼‰æ–¹æ³• (å¯èƒ½çš„å·®ç•°é» 6)
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    log('formalLog', 'âœ… Data URL æˆåŠŸé–‹å•Ÿæ–°è¦–çª—', 'success');
                    log('formalLog', 'âœ… æ­£å¼ç‰ˆåŸ·è¡Œå®Œæˆ', 'success');
                } else {
                    log('formalLog', 'âŒ Data URL å¤±æ•—ï¼šå½ˆå‡ºè¦–çª—è¢«é˜»æ“‹', 'error');
                }
                
                // å„²å­˜æ­£å¼ç‰ˆçµæœ
                window.formalVersionResult = {
                    success: !!newWindow,
                    icalContent: icalContent,
                    dataUrl: dataUrl
                };
                
            } catch (error) {
                log('formalLog', `âŒ æ­£å¼ç‰ˆéŒ¯èª¤: ${error.message}`, 'error');
                console.error('æ­£å¼ç‰ˆéŒ¯èª¤è©³æƒ…:', error);
            }
        }
        
        function compareExactly() {
            if (!window.testVersionResult || !window.formalVersionResult) {
                alert('è«‹å…ˆåŸ·è¡Œå…©å€‹ç‰ˆæœ¬çš„æ¸¬è©¦');
                return;
            }
            
            const analysisDiv = document.getElementById('differenceAnalysis');
            const diffContent = document.getElementById('diffContent');
            
            let differences = [];
            
            // æ¯”è¼ƒæˆåŠŸç‹€æ…‹
            if (window.testVersionResult.success !== window.formalVersionResult.success) {
                differences.push(`åŸ·è¡Œçµæœ: æ¸¬è©¦ç‰ˆ${window.testVersionResult.success ? 'æˆåŠŸ' : 'å¤±æ•—'}, æ­£å¼ç‰ˆ${window.formalVersionResult.success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
            }
            
            // æ¯”è¼ƒ iCal å…§å®¹é•·åº¦
            const testLen = window.testVersionResult.icalContent.length;
            const formalLen = window.formalVersionResult.icalContent.length;
            if (testLen !== formalLen) {
                differences.push(`iCal é•·åº¦: æ¸¬è©¦ç‰ˆ${testLen}å­—å…ƒ, æ­£å¼ç‰ˆ${formalLen}å­—å…ƒ`);
            }
            
            // æ¯”è¼ƒå…·é«”å…§å®¹å·®ç•°
            const testLines = window.testVersionResult.icalContent.split('\n');
            const formalLines = window.formalVersionResult.icalContent.split('\n');
            
            const maxLines = Math.max(testLines.length, formalLines.length);
            for (let i = 0; i < maxLines; i++) {
                const testLine = testLines[i] || '';
                const formalLine = formalLines[i] || '';
                
                if (testLine !== formalLine) {
                    differences.push(`ç¬¬${i+1}è¡Œ: æ¸¬è©¦ç‰ˆ"${testLine}" vs æ­£å¼ç‰ˆ"${formalLine}"`);
                }
            }
            
            if (differences.length === 0) {
                diffContent.innerHTML = 'âœ… æ²’æœ‰ç™¼ç¾å·®ç•°ï¼å…©å€‹ç‰ˆæœ¬çš„é‚è¼¯å®Œå…¨ç›¸åŒã€‚';
            } else {
                diffContent.innerHTML = `âŒ ç™¼ç¾ ${differences.length} å€‹å·®ç•°ï¼š<br><br>` + 
                                       differences.map((diff, index) => `${index + 1}. ${diff}`).join('<br>');
            }
            
            analysisDiv.style.display = 'block';
            
            // è©³ç´°è¼¸å‡ºåˆ° console
            console.log('=== æ¸¬è©¦ç‰ˆ iCal å…§å®¹ ===');
            console.log(window.testVersionResult.icalContent);
            console.log('=== æ­£å¼ç‰ˆ iCal å…§å®¹ ===');
            console.log(window.formalVersionResult.icalContent);
            console.log('=== å·®ç•°åˆ—è¡¨ ===');
            console.log(differences);
        }
        
        function generateFixedVersion() {
            if (!window.testVersionResult) {
                alert('è«‹å…ˆåŸ·è¡Œæ¸¬è©¦ç‰ˆä»¥ç²å–æ­£ç¢ºçš„å¯¦ç¾');
                return;
            }
            
            // ç”Ÿæˆä¿®å¾©å¾Œçš„ç¨‹å¼ç¢¼
            const fixedCode = `
// ä¿®å¾©å¾Œçš„æ­£å¼ç‰ˆ - å®Œå…¨è¤‡è£½æ¸¬è©¦ç‰ˆçš„æˆåŠŸé‚è¼¯
function setupIOSCalendar() {
    console.log('ğŸ“… setupIOSCalendar() é–‹å§‹åŸ·è¡Œ (ä¿®å¾©ç‰ˆ)');
    
    try {
        // ä½¿ç”¨æ¸¬è©¦ç‰ˆç›¸åŒçš„è¨­å®šçµæ§‹
        var timeParts = settings.checkinTime.split(':');
        var reminderHour = parseInt(timeParts[0]);
        var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
        
        if (reminderMinute < 0) {
            reminderMinute += 60;
            reminderHour -= 1;
        }
        
        // ä½¿ç”¨æ¸¬è©¦ç‰ˆç›¸åŒçš„é€±é–“è½‰æ›
        var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
        var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
        
        // ä½¿ç”¨æ¸¬è©¦ç‰ˆç¢ºåˆ‡ç›¸åŒçš„ iCal å…§å®¹
        var icalContent = \`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasisæ‰“å¡ç³»çµ±//NONSGML//EN
BEGIN:VEVENT
SUMMARY:ğŸ¯ Mphasis è‡ªå‹•æ‰“å¡æé†’
DESCRIPTION:ğŸ“± æ™ºæ…§æ‰“å¡ç³»çµ±æé†’
DTSTART:20250101T\${reminderHour.toString().padStart(2, '0')}\${reminderMinute.toString().padStart(2, '0')}00Z
DTEND:20250101T\${reminderHour.toString().padStart(2, '0')}\${(reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=\${selectedDays}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:ğŸš€ ç«‹å³æ‰“å¡ï¼
END:VALARM
END:VEVENT
END:VCALENDAR\`;
        
        // ä½¿ç”¨æ¸¬è©¦ç‰ˆç¢ºåˆ‡ç›¸åŒçš„ä¸‹è¼‰æ–¹æ³•
        var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
        var newWindow = window.open(dataUrl, '_blank');
        
        if (newWindow) {
            console.log('âœ… ä¿®å¾©ç‰ˆæˆåŠŸ');
            showMessage('ğŸ“… è¡Œäº‹æ›†æª”æ¡ˆå·²é–‹å•Ÿï¼è«‹åœ¨æ–°è¦–çª—ä¸­é»æ“Šã€Œåˆ†äº«ã€â†’ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€', 'success');
        } else {
            console.log('âŒ ä¿®å¾©ç‰ˆå¤±æ•—ï¼šå½ˆå‡ºè¦–çª—è¢«é˜»æ“‹');
            showMessage('âŒ å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
        }
        
    } catch (error) {
        console.error('ä¿®å¾©ç‰ˆéŒ¯èª¤:', error);
        showMessage('âŒ åŸ·è¡ŒéŒ¯èª¤: ' + error.message, 'error');
    }
}`;
            
            console.log('=== ä¿®å¾©å¾Œçš„ç¨‹å¼ç¢¼ ===');
            console.log(fixedCode);
            
            alert('ä¿®å¾©ç‰ˆç¨‹å¼ç¢¼å·²ç”Ÿæˆï¼\nè«‹æŸ¥çœ‹ç€è¦½å™¨ Console (F12) ç²å–å®Œæ•´ç¨‹å¼ç¢¼ã€‚\n\né€™å€‹ç‰ˆæœ¬å®Œå…¨è¤‡è£½äº†æ¸¬è©¦ç‰ˆçš„æˆåŠŸé‚è¼¯ã€‚');
        }
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ” æœ€çµ‚è¨ºæ–·å·¥å…·å·²è¼‰å…¥');
        });
    </script>
</body>
</html>
