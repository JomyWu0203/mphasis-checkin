<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“± Mphasisæ‰“å¡</title>
    
    <!-- iOS PWA å„ªåŒ– -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mphasisæ‰“å¡">
    <meta name="theme-color" content="#FF6B35">
    
    <style>
        :root {
            --primary-color: #FF6B35;
            --secondary-color: #F7931E;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --info-color: #007AFF;
            --warning-color: #FF9500;
            --gray-color: #8E8E93;
            --light-gray: #F2F2F7;
            --gold-color: #FFD700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* åªå°éè¼¸å…¥å…ƒç´ ç¦ç”¨é¸å– */
        body, div, p, h1, h2, h3, button {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* è¼¸å…¥å…ƒç´ å…è¨±é¸å–å’Œç·¨è¼¯ */
        input, textarea, select {
            -webkit-user-select: text;
            -webkit-touch-callout: default;
            user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--light-gray);
            color: #000;
            min-height: 100vh;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
        }

        .container {
            max-width: 390px;
            margin: 0 auto;
        }

        /* æ¨™é¡Œå€åŸŸ */
        .header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 24px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 107, 53, 0.3);
            position: relative;
        }

        .header::before {
            content: 'ğŸ†';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 30px;
            background: var(--gold-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #000;
            display: flex;
            align-items: center;
        }

        .card-title .icon {
            margin-right: 8px;
            font-size: 22px;
        }

        /* æ™‚é–“é¡¯ç¤º */
        .time-display {
            text-align: center;
            padding: 20px;
        }

        .current-time {
            font-size: 36px;
            font-weight: 200;
            color: #000;
            margin-bottom: 6px;
            font-feature-settings: "tnum";
        }

        .current-date {
            font-size: 15px;
            color: var(--gray-color);
            margin-bottom: 12px;
        }

        .next-checkin {
            background: var(--info-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        /* å‰æ™¯ä¿æŒç‹€æ…‹ */
        .foreground-status {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: center;
            border: 2px solid;
            position: relative;
        }

        .foreground-active {
            background: #E8F5E8;
            color: #1B5E20;
            border-color: var(--success-color);
            animation: pulse-green 2s infinite;
        }

        .foreground-inactive {
            background: #FFEBEE;
            color: #C62828;
            border-color: var(--danger-color);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 199, 89, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); }
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            display: block;
            width: 100%;
            padding: 16px 20px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            margin: 12px 0;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-appearance: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
        }

        .btn-info {
            background: var(--info-color);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);
        }

        .btn-gold {
            background: linear-gradient(45deg, var(--gold-color), #FFA500);
            color: #000;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        /* ç³»çµ±è§£æ±ºæ–¹æ¡ˆç¶²æ ¼ */
        .solution-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        .solution-card {
            background: #F8F9FA;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .solution-card:hover {
            border-color: var(--primary-color);
            background: rgba(255, 107, 53, 0.05);
        }

        .solution-card .icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .solution-card .title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .solution-card .desc {
            font-size: 11px;
            color: var(--gray-color);
            line-height: 1.2;
        }

        /* ç³»çµ±æ•´åˆèªªæ˜ */
        .limitation-warning {
            background: linear-gradient(45deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warning-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .limitation-warning h3 {
            color: #E65100;
            margin-bottom: 12px;
        }

        .limitation-warning p {
            color: #BF360C;
            line-height: 1.5;
            font-size: 14px;
        }

        /* å‰æ™¯ä¿æŒè¨ˆæ™‚å™¨ */
        .stay-active-timer {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #E3F2FD, #BBDEFB);
            border-radius: 12px;
            border: 2px solid var(--info-color);
            margin: 16px 0;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 200;
            color: var(--info-color);
            margin-bottom: 8px;
            font-family: monospace;
        }

        .timer-label {
            color: #0D47A1;
            font-weight: 600;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .status {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #E8F5E8;
            color: #1B5E20;
            border: 2px solid var(--success-color);
        }

        .status-info {
            background: #E3F2FD;
            color: #0D47A1;
            border: 2px solid var(--info-color);
        }

        .status-warning {
            background: #FFF3E0;
            color: #E65100;
            border: 2px solid var(--warning-color);
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid var(--danger-color);
        }

        /* å¿«é€Ÿè¨­å®šé¢æ¿ */
        .quick-setup {
            background: linear-gradient(45deg, #F3E5F5, #E1BEE7);
            border: 2px solid #8A2BE2;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .quick-setup h3 {
            color: #4A148C;
            margin-bottom: 16px;
            text-align: center;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
        }

        .time-input-group label {
            font-weight: 600;
            color: #6A1B9A;
            flex: 1;
        }

        .time-input-group input,
        .time-input-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #BA68C8;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
        }

        /* å¿«é€Ÿé€±é–“é¸æ“‡å™¨ */
        .quick-week-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin: 8px 0;
        }

        .quick-day-btn {
            padding: 10px 6px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #BA68C8;
            border-radius: 8px;
            background: white;
            color: #6A1B9A;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .quick-day-btn.selected {
            background: #8A2BE2;
            color: white;
            border-color: #8A2BE2;
            transform: scale(1.05);
        }

        .quick-day-btn:active {
            transform: scale(0.95);
        }

        .btn-link {
            background: none !important;
            border: none !important;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
            color: #8A2BE2;
            padding: 4px 8px;
        }

        .btn-link:hover {
            opacity: 0.8;
        }

        /* è‡ªå‹•æ‰“å¡ä»‹é¢æ¨£å¼ */
        .auto-checkin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auto-checkin-modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auto-checkin-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .auto-checkin-header h2 {
            color: #6A1B9A;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .auto-checkin-source {
            color: #8A2BE2;
            font-size: 14px;
            font-weight: 500;
        }

        .auto-checkin-content {
            text-align: center;
        }

        .auto-checkin-status {
            color: #333;
            font-size: 16px;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auto-checkin-progress {
            background: #F0F0F0;
            border-radius: 8px;
            height: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #8A2BE2, #BA68C8);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 8px;
        }

        .auto-checkin-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        .auto-checkin-actions .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auto-checkin-actions .btn-primary {
            background: linear-gradient(135deg, #8A2BE2, #BA68C8);
            color: white;
        }

        .auto-checkin-actions .btn-primary:active {
            transform: scale(0.98);
        }

        .auto-checkin-actions .btn-secondary {
            background: #F0F0F0;
            color: #666;
        }

        #autoCheckinInterface {
            display: none;
        }

        /* éš±è—é¡ */
        .hidden {
            display: none !important;
        }

        /* å‹•ç•«æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* å…¨å±æé†’æ¨£å¼ */
        .fullscreen-reminder {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }

        .reminder-clock {
            font-size: 120px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        .reminder-text {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .reminder-actions {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .reminder-btn {
            padding: 20px 40px;
            font-size: 20px;
            font-weight: 700;
            border: 3px solid white;
            border-radius: 15px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reminder-btn.primary {
            background: white;
            color: var(--primary-color);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <h1>ğŸ“± Mphasisæ‰“å¡</h1>
            <p>ä¼æ¥­æ™ºæ…§æ‰“å¡ç³»çµ±</p>
        </div>

        <!-- æ™‚é–“é¡¯ç¤º -->
        <div class="card">
            <div class="time-display">
                <div class="current-time" id="timeDisplay">--:--</div>
                <div class="current-date" id="dateDisplay">è¼‰å…¥ä¸­...</div>
                <div class="next-checkin" id="nextCheckin">ä¸‹æ¬¡æ‰“å¡ï¼šæœªè¨­å®š</div>
            </div>
        </div>

        <!-- å‰æ™¯ç‹€æ…‹ç›£æ§ -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ“±</span>
                æ‡‰ç”¨ç‹€æ…‹ç›£æ§
            </div>
            
            <div id="foregroundStatus" class="foreground-status foreground-inactive">
                ğŸ” æ­£åœ¨æª¢æ¸¬æ‡‰ç”¨ç‹€æ…‹...
            </div>
            
            <div class="stay-active-timer">
                <div class="timer-display" id="activeTimer">--:--</div>
                <div class="timer-label">å‰æ™¯æ´»èºæ™‚é–“</div>
            </div>
        </div>

        <!-- æ™ºæ…§é€£å‹•èªªæ˜ -->
        <div class="card" style="background: linear-gradient(135deg, #E8F5E8, #C8E6C9); border: 2px solid #4CAF50; margin-bottom: 16px;">
            <div class="card-title" style="color: #2E7D32;">
                <span class="icon">ğŸ”—</span>
                æ™ºæ…§è¡Œäº‹æ›†é€£å‹•ç³»çµ±
            </div>
            <div style="color: #1B5E20; line-height: 1.6;">
                <p><strong>ğŸ¯ å®Œæ•´è‡ªå‹•åŒ–æµç¨‹ï¼š</strong></p>
                <div style="margin: 12px 0; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; font-size: 14px;">
                    <strong>1ï¸âƒ£ å¿«é€Ÿè¨­å®š</strong> â†’ é¸æ“‡æ‰“å¡æ™‚é–“å’Œé€±é–“æ’ç¨‹<br>
                    <strong>2ï¸âƒ£ iOS è¡Œäº‹æ›†</strong> â†’ è‡ªå‹•ç”Ÿæˆç³»çµ±ç´šæé†’äº‹ä»¶<br>
                    <strong>3ï¸âƒ£ æé†’è§¸ç™¼</strong> â†’ é»æ“Šé€šçŸ¥è‡ªå‹•å–šé†’æ‡‰ç”¨<br>
                    <strong>4ï¸âƒ£ é–‹å•Ÿæ‰“å¡</strong> â†’ æ™ºæ…§æª¢æ¸¬ä¸¦é–‹å•Ÿæ‰“å¡é é¢<br>
                    <strong>5ï¸âƒ£ Teams é€šçŸ¥</strong> â†’ è‡ªå‹•å›å ±åŸ·è¡Œç‹€æ…‹
                </div>
                <p><strong>ğŸš€ æ ¸å¿ƒå„ªå‹¢ï¼š</strong></p>
                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                    <li>âœ… ç²¾ç°¡é«˜æ•ˆï¼šåªä¿ç•™æ ¸å¿ƒåŠŸèƒ½</li>
                    <li>âœ… iOS è¡Œäº‹æ›†ï¼šç³»çµ±ç´šå¯é æé†’</li>
                    <li>âœ… Teams é€šçŸ¥ï¼šä¼æ¥­ç´šç‹€æ…‹è¿½è¹¤</li>
                    <li>âœ… æ™ºæ…§æ’ç¨‹ï¼šé€±é–“è‡ªå‹•åŒ–ç®¡ç†</li>
                    <li>âœ… è‡ªå‹•å–šé†’ï¼šé»æ“Šå³ç”¨ç„¡éœ€è¨˜æ†¶</li>
                </ul>
            </div>
        </div>

        <!-- iOS ç³»çµ±æ•´åˆèªªæ˜ -->
        <div class="limitation-warning">
            <h3>âš¡ ç‚ºä»€éº¼ä½¿ç”¨è¡Œäº‹æ›†é€£å‹•ï¼Ÿ</h3>
            <p>
                <strong>æ™ºæ…§è¨­è¨ˆï¼š</strong>æ•´åˆ iOS åŸç”Ÿç³»çµ±åŠŸèƒ½ï¼Œæä¾›æœ€å¯é çš„æé†’é«”é©—ã€‚<br><br>
                
                <strong>ç³»çµ±æ•´åˆå„ªå‹¢ï¼š</strong><br>
                â€¢ â° ä½¿ç”¨ iOS åŸç”Ÿè¡Œäº‹æ›†æé†’<br>
                â€¢ ğŸ”” ç³»çµ±ç´šé€šçŸ¥ä¿è­‰é€é”<br>
                â€¢ ğŸ’¯ ä¸å—ç¶²é é™åˆ¶å½±éŸ¿<br>
                â€¢ ğŸš€ ä¸€éµå–šé†’æ‰“å¡æ‡‰ç”¨<br><br>
                
                <strong>æ™ºæ…§æµç¨‹ï¼š</strong>è¡Œäº‹æ›†æé†’ â†’ é»æ“Šé€šçŸ¥ â†’ è‡ªå‹•é–‹å•Ÿæ‡‰ç”¨ â†’ åŸ·è¡Œæ‰“å¡ï¼
            </p>
        </div>

        <!-- å¿«é€Ÿè¨­å®š -->
        <div class="quick-setup">
            <h3>âš¡ å¿«é€Ÿè¨­å®šæ‰“å¡æ™‚é–“</h3>
            
            <div class="time-input-group">
                <label>æ‰“å¡æ™‚é–“ï¼š</label>
                <input type="time" id="quickCheckinTime" value="09:00">
            </div>
            
            <div class="time-input-group">
                <label>æå‰æé†’ï¼š</label>
                <select id="quickReminderTime">
                    <option value="5">5 åˆ†é˜</option>
                    <option value="10">10 åˆ†é˜</option>
                    <option value="15">15 åˆ†é˜</option>
                    <option value="30">30 åˆ†é˜</option>
                </select>
            </div>
            
            <!-- é€±é–“é¸æ“‡ -->
            <div style="margin: 16px 0;">
                <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">æ‰“å¡æ—¥æœŸï¼š</label>
                <div class="quick-week-selector">
                    <div class="quick-day-btn" data-day="1" onclick="toggleQuickDay(1)">ä¸€</div>
                    <div class="quick-day-btn" data-day="2" onclick="toggleQuickDay(2)">äºŒ</div>
                    <div class="quick-day-btn" data-day="3" onclick="toggleQuickDay(3)">ä¸‰</div>
                    <div class="quick-day-btn" data-day="4" onclick="toggleQuickDay(4)">å››</div>
                    <div class="quick-day-btn" data-day="5" onclick="toggleQuickDay(5)">äº”</div>
                    <div class="quick-day-btn" data-day="6" onclick="toggleQuickDay(6)">å…­</div>
                    <div class="quick-day-btn" data-day="0" onclick="toggleQuickDay(0)">æ—¥</div>
                </div>
                <div style="margin-top: 8px;">
                    <button class="btn-link" onclick="selectWorkdays()" style="font-size: 12px; color: #8A2BE2; background: none; border: none; text-decoration: underline; cursor: pointer;">
                        ğŸ“… é¸æ“‡å·¥ä½œæ—¥ (ä¸€~äº”)
                    </button>
                    <button class="btn-link" onclick="selectAllDays()" style="font-size: 12px; color: #8A2BE2; background: none; border: none; text-decoration: underline; cursor: pointer; margin-left: 16px;">
                        ğŸ—“ï¸ é¸æ“‡å…¨éƒ¨ (ä¸€~æ—¥)
                    </button>
                </div>
            </div>
            
            <!-- å¸¸è¦‹å‡æ—¥æ’é™¤ -->
            <div style="margin: 16px 0;">
                <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">
                    <input type="checkbox" id="quickExcludeHolidays" checked style="margin-right: 8px;">
                    è‡ªå‹•æ’é™¤åœ‹å®šå‡æ—¥
                </label>
                <div style="font-size: 12px; color: #8A2BE2; opacity: 0.8;">
                    åŒ…å«ï¼šå…ƒæ—¦ã€æ˜¥ç¯€ã€æ¸…æ˜ã€å‹å‹•ç¯€ã€ç«¯åˆã€ä¸­ç§‹ã€åœ‹æ…¶ç­‰
                </div>
            </div>
            
            <button class="btn btn-gold" onclick="quickSetup()">
                âš¡ ä¸€éµè¨­å®šæ‰€æœ‰æé†’
            </button>
            
            <div style="margin-top: 12px; font-size: 13px; color: #6A1B9A; text-align: center; opacity: 0.9;">
                ğŸ“… å°‡è‡ªå‹•è¨­å®šï¼šiOS è¡Œäº‹æ›†æ™ºæ…§æé†’
            </div>
            
            <!-- æ¸¬è©¦è¡Œäº‹æ›†å–šé†’ -->
            <div style="margin-top: 16px; text-align: center;">
                <button class="btn btn-secondary" onclick="testCalendarWakeup()" style="font-size: 14px; padding: 8px 16px;">
                    ğŸ§ª æ¸¬è©¦è¡Œäº‹æ›†å–šé†’åŠŸèƒ½
                </button>
            </div>
        </div>

        <!-- ç³»çµ±ç´šè§£æ±ºæ–¹æ¡ˆ -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ¯</span>
                æ ¸å¿ƒåŠŸèƒ½ (ç°¡åŒ–ç‰ˆ)
            </div>
            
            <div class="status status-info">
                <strong>ğŸ’¡ ç²¾ç°¡ç­–ç•¥ï¼š</strong>åªä¿ç•™æœ€æ ¸å¿ƒçš„å…©å¤§åŠŸèƒ½ï¼Œç°¡æ½”é«˜æ•ˆï¼
            </div>
            
            <div class="solution-grid" style="grid-template-columns: 1fr 1fr; max-width: 400px; margin: 0 auto;">
                <div class="solution-card" onclick="console.log('ğŸ“± iOSè¡Œäº‹æ›†æŒ‰éˆ•è¢«é»æ“Š'); setupIOSCalendar()">
                    <span class="icon">ğŸ“…</span>
                    <div class="title">iOS è¡Œäº‹æ›†</div>
                    <div class="desc">ç³»çµ±æé†’<br>è‡ªå‹•å–šé†’</div>
                </div>
                
                <div class="solution-card" onclick="toggleTeamsSettings()">
                    <span class="icon">ğŸ“¤</span>
                    <div class="title">Teams é€šçŸ¥</div>
                    <div class="desc">ç‹€æ…‹è¿½è¹¤<br>ä¼æ¥­æ•´åˆ</div>
                </div>
            </div>
            
            <!-- è¡Œäº‹æ›†ç®¡ç†å·¥å…· -->
            <div style="margin-top: 16px; text-align: center;">
                <button class="btn btn-secondary" onclick="showCalendarManagement()" style="background: #FF9800; margin: 4px;">
                    ğŸ—‘ï¸ ç®¡ç†è¡Œäº‹æ›†æ’ç¨‹
                </button>
                <button class="btn btn-secondary" onclick="openIOSCalendarApp()" style="background: #9C27B0; margin: 4px;">
                    ğŸ“± é–‹å•Ÿè¡Œäº‹æ›† App
                </button>
            </div>
            
            <div style="margin-top: 16px; text-align: center; font-size: 14px; color: #6A1B9A; background: rgba(106, 27, 154, 0.1); padding: 12px; border-radius: 8px;">
                âœ¨ <strong>å®Œç¾çµ„åˆ</strong>ï¼šiOS è¡Œäº‹æ›†è² è²¬æé†’å–šé†’ï¼ŒTeams é€šçŸ¥è² è²¬ç‹€æ…‹å›å ±
            </div>
        </div>

        <!-- Teams é€šçŸ¥è¨­å®š -->
        <div class="card" id="teamsSettings" style="display: none; margin-top: 16px;">
            <div class="card-title">
                <span class="icon">ğŸ“¤</span>
                Teams é€šçŸ¥è¨­å®š
            </div>
            
            <div style="margin: 16px 0;">
                <label style="display: flex; align-items: center; margin-bottom: 16px;">
                    <input type="checkbox" id="teamsEnabled" onchange="updateTeamsSettings()" style="margin-right: 8px;">
                    <span style="font-weight: 600; color: #6A1B9A;">å•Ÿç”¨ Teams é€šçŸ¥</span>
                </label>
                
                <div id="teamsWebhookSettings" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">
                            ä¸»è¦ Webhook URL:
                        </label>
                        <input type="url" id="teamsWebhook" placeholder="https://outlook.office.com/webhook/..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #BA68C8; border-radius: 8px; font-size: 16px; -webkit-appearance: none; appearance: none;"
                               oninput="onTeamsWebhookInput()">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">
                            å‚™ç”¨ Webhook URL (é¸å¡«):
                        </label>
                        <input type="url" id="teamsBackupWebhook" placeholder="https://outlook.office.com/webhook/..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #BA68C8; border-radius: 8px; font-size: 16px; -webkit-appearance: none; appearance: none;"
                               oninput="onTeamsWebhookInput()">
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="saveTeamsSettings()" style="flex: 1;">
                            ğŸ’¾ å„²å­˜è¨­å®š
                        </button>
                        <button class="btn btn-secondary" onclick="testTeamsNotification()" style="flex: 1;">
                            ğŸ§ª æ¸¬è©¦é€šçŸ¥
                        </button>
                    </div>
                    
                    <div style="margin-top: 8px; text-align: center;">
                        <button class="btn" onclick="openTeamsTestTool()" style="background: #ff9800; color: white; font-size: 12px; padding: 6px 12px; margin: 4px;">
                            ğŸ”§ æ¸¬è©¦å·¥å…·
                        </button>
                        <button class="btn" onclick="openWebhookValidator()" style="background: #9c27b0; color: white; font-size: 12px; padding: 6px 12px; margin: 4px;">
                            ğŸ” æ·±åº¦é©—è­‰
                        </button>
                        <button class="btn" onclick="testMinimalMessage()" style="background: #4caf50; color: white; font-size: 12px; padding: 6px 12px; margin: 4px;">
                            ğŸ“ ç°¡å–®æ¸¬è©¦
                        </button>
                    </div>
                    
                    <div style="margin-top: 12px; padding: 12px; background: rgba(106, 27, 154, 0.1); border-radius: 8px; font-size: 13px; color: #6A1B9A;">
                        <strong>ğŸ’¡ å¦‚ä½•å–å¾— Teams Webhook URLï¼š</strong><br>
                        1. åœ¨ Teams é »é“ä¸­é»æ“Šã€Œ...ã€â†’ã€Œé€£æ¥å™¨ã€<br>
                        2. æœå°‹ã€ŒIncoming Webhookã€ä¸¦è¨­å®š<br>
                        3. è¼¸å…¥åç¨±ï¼šã€ŒMphasis æ‰“å¡é€šçŸ¥ã€<br>
                        4. è¤‡è£½ç”¢ç”Ÿçš„ Webhook URL
                    </div>
                </div>
            </div>
        </div>

        <!-- å‰æ™¯ä¿æŒæ–¹æ¡ˆ -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ”„</span>
                å‰æ™¯ä¿æŒæ–¹æ¡ˆ
            </div>
            
            <div class="status status-warning">
                <strong>âš ï¸ å¯¦é©—æ€§æ–¹æ¡ˆï¼š</strong>å˜—è©¦ä¿æŒæ‡‰ç”¨åœ¨å‰æ™¯ï¼Œä½†ä¸ä¿è­‰æˆåŠŸï¼
            </div>
            
            <button class="btn btn-warning" onclick="startForegroundMode()">
                ğŸ”„ å•Ÿå‹•å‰æ™¯ä¿æŒæ¨¡å¼
            </button>
            
            <button class="btn btn-info" onclick="testForegroundReminder()">
                ğŸ§ª æ¸¬è©¦å‰æ™¯æé†’
            </button>
        </div>

        <!-- æ‰‹å‹•æ“ä½œ -->
        <div class="card">
            <div class="card-title">
                <span class="icon">ğŸ¯</span>
                ç«‹å³æ‰“å¡
            </div>
            
            <button class="btn btn-success" onclick="openCheckinPage()">
                ğŸ¯ é–‹å•Ÿæ‰“å¡é é¢
            </button>
            
            <div style="margin-top: 16px;">
                <button class="btn btn-primary" onclick="showCheckinReminder()">
                    ğŸ“¢ æ¨¡æ“¬æ‰“å¡æé†’
                </button>
            </div>
        </div>

        <!-- ç‹€æ…‹è¨Šæ¯å€åŸŸ -->
        <div id="statusArea"></div>
    </div>

    <!-- å…¨å±æé†’è¦†è“‹å±¤ -->
    <div class="fullscreen-reminder hidden" id="fullscreenReminder">
        <div class="reminder-clock">ğŸ•˜</div>
        <div class="reminder-text">æ‰“å¡æ™‚é–“åˆ°äº†ï¼</div>
        <div style="font-size: 18px; opacity: 0.9;">
            ç¾åœ¨æ˜¯ <span id="reminderTime">09:00</span>ï¼Œè©²å»æ‰“å¡äº†ï¼
        </div>
        <div class="reminder-actions">
            <button class="reminder-btn primary" onclick="openCheckinPage(); hideFullscreenReminder();">
                ç«‹å³æ‰“å¡
            </button>
            <button class="reminder-btn" onclick="snoozeReminder()">
                ç¨å¾Œæé†’
            </button>
            <button class="reminder-btn" onclick="hideFullscreenReminder()">
                é—œé–‰
            </button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        var settings = {
            checkinTime: '09:00',
            reminderMinutes: 5,
            checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
            weeklyDays: [1, 2, 3, 4, 5], // é è¨­é€±ä¸€åˆ°é€±äº”
            excludeHolidays: true,
            teamsWebhook: '', // Teams Webhook URL
            teamsBackupWebhook: '', // å‚™ç”¨ Teams Webhook URL
            teamsEnabled: false // æ˜¯å¦å•Ÿç”¨ Teams é€šçŸ¥
        };
        
        var quickWeeklyDays = [1, 2, 3, 4, 5]; // å¿«é€Ÿè¨­å®šçš„é€±é–“é¸æ“‡

        var foregroundTimer = null;
        var activeStartTime = null;
        var visibilityChangeCount = 0;
        var reminderInterval = null;

        // åˆå§‹åŒ–
        function initApp() {
            console.log('ğŸ“± Mphasisæ‰“å¡ç³»çµ±å•Ÿå‹•');
            loadSettings();
            updateTime();
            setInterval(updateTime, 1000);
            
            setupVisibilityMonitoring();
            startActiveTimer();
            updateQuickWeeklyDisplay();
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè¡Œäº‹æ›†å–šé†’
            checkCalendarWakeup();
            
            // è¨­å®š URL Scheme è™•ç†å™¨
            setupURLSchemeHandler();
            
            showMessage('âœ… Mphasisæ‰“å¡ç³»çµ±å·²å°±ç·’ï¼å»ºè­°ä½¿ç”¨ç³»çµ±ç´šæé†’æ–¹æ¡ˆã€‚', 'success');
        }

        // è¨­å®šå¯è¦‹æ€§ç›£æ§
        function setupVisibilityMonitoring() {
            // ç›£æ§é é¢å¯è¦‹æ€§è®ŠåŒ–
            document.addEventListener('visibilitychange', function() {
                visibilityChangeCount++;
                updateForegroundStatus();
                
                if (document.hidden) {
                    console.log('ğŸ“± æ‡‰ç”¨åˆ‡æ›åˆ°éæ´»èºç‹€æ…‹');
                    handleBackgroundMode();
                } else {
                    console.log('âœ… æ‡‰ç”¨å›åˆ°å‰æ™¯æ¨¡å¼');
                    handleForegroundMode();
                }
            });

            // ç›£æ§çª—å£ç„¦é»è®ŠåŒ–
            window.addEventListener('focus', function() {
                console.log('ğŸ¯ çª—å£ç²å¾—ç„¦é»');
                handleForegroundMode();
                checkCalendarWakeup(); // åŒæ™‚æª¢æŸ¥æ˜¯å¦ç‚ºè¡Œäº‹æ›†å–šé†’
            });

            window.addEventListener('blur', function() {
                console.log('ğŸ˜´ çª—å£å¤±å»ç„¦é»');
                handleBackgroundMode();
            });

            // åˆå§‹ç‹€æ…‹æª¢æŸ¥
            updateForegroundStatus();
        }

        // è™•ç†éæ´»èºç‹€æ…‹
        function handleBackgroundMode() {
            updateForegroundStatus();
            
            // å˜—è©¦ä¿æŒæœ€ä½é™åº¦çš„æ´»å‹•
            if (reminderInterval) {
                // ä½¿ç”¨ setTimeout è€Œä¸æ˜¯ setInterval ä¾†é¿å…è¢«æš«åœ
                scheduleNextCheck();
            }
        }

        // è™•ç†å‰æ™¯æ¨¡å¼
        function handleForegroundMode() {
            activeStartTime = Date.now();
            updateForegroundStatus();
            
            // é‡æ–°å•Ÿå‹•æ­£å¸¸çš„æª¢æŸ¥æ©Ÿåˆ¶
            if (reminderInterval) {
                clearInterval(reminderInterval);
                startForegroundReminderCheck();
            }
        }

        // æ›´æ–°å‰æ™¯ç‹€æ…‹é¡¯ç¤º
        function updateForegroundStatus() {
            var statusElement = document.getElementById('foregroundStatus');
            var isActive = !document.hidden && document.hasFocus();
            
            if (isActive) {
                statusElement.className = 'foreground-status foreground-active';
                statusElement.innerHTML = 'âœ… æ‡‰ç”¨åœ¨å‰æ™¯é‹è¡Œä¸­<br><small>åˆ‡æ›æ¬¡æ•¸ï¼š' + visibilityChangeCount + '</small>';
            } else {
                statusElement.className = 'foreground-status foreground-inactive';
                statusElement.innerHTML = 'ğŸ“± æ‡‰ç”¨åœ¨éæ´»èºç‹€æ…‹<br><small>å»ºè­°ä½¿ç”¨ç³»çµ±ç´šæé†’</small>';
            }
        }

        // å•Ÿå‹•æ´»èºè¨ˆæ™‚å™¨
        function startActiveTimer() {
            activeStartTime = Date.now();
            
            setInterval(function() {
                updateActiveTimer();
            }, 1000);
        }

        // æ›´æ–°æ´»èºè¨ˆæ™‚å™¨
        function updateActiveTimer() {
            if (!activeStartTime) {
                document.getElementById('activeTimer').textContent = '--:--';
                return;
            }
            
            var elapsed = Date.now() - activeStartTime;
            var minutes = Math.floor(elapsed / 60000);
            var seconds = Math.floor((elapsed % 60000) / 1000);
            
            var timeString = minutes.toString().padStart(2, '0') + ':' + 
                           seconds.toString().padStart(2, '0');
            
            document.getElementById('activeTimer').textContent = timeString;
            
            // è¶…é 5 åˆ†é˜é¡¯ç¤ºè­¦å‘Š
            if (minutes >= 5) {
                document.getElementById('activeTimer').style.color = 'var(--danger-color)';
            } else if (minutes >= 3) {
                document.getElementById('activeTimer').style.color = 'var(--warning-color)';
            } else {
                document.getElementById('activeTimer').style.color = 'var(--info-color)';
            }
        }

        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        function updateTime() {
            try {
                var now = new Date();
                var hours = now.getHours().toString().padStart(2, '0');
                var minutes = now.getMinutes().toString().padStart(2, '0');
                var timeString = hours + ':' + minutes;
                
                var options = { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                };
                var dateString = now.toLocaleDateString('zh-TW', options);
                
                document.getElementById('timeDisplay').textContent = timeString;
                document.getElementById('dateDisplay').textContent = dateString;
                
                updateNextCheckinTime();
                checkForReminder();
            } catch (error) {
                console.error('æ™‚é–“æ›´æ–°å¤±æ•—:', error);
            }
        }

        // æ›´æ–°ä¸‹æ¬¡æ‰“å¡æ™‚é–“
        function updateNextCheckinTime() {
            var now = new Date();
            var today = new Date();
            var timeParts = settings.checkinTime.split(':');
            today.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
            
            var nextCheckinElement = document.getElementById('nextCheckin');
            
            if (now < today) {
                nextCheckinElement.textContent = 'ä»Šæ—¥æ‰“å¡ï¼š' + settings.checkinTime;
                nextCheckinElement.style.background = 'var(--success-color)';
            } else {
                var tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                nextCheckinElement.textContent = 'æ˜æ—¥æ‰“å¡ï¼š' + settings.checkinTime;
                nextCheckinElement.style.background = 'var(--gray-color)';
            }
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦æé†’
        function checkForReminder() {
            var now = new Date();
            var today = new Date();
            var timeParts = settings.checkinTime.split(':');
            today.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]) - settings.reminderMinutes, 0, 0);
            
            // æª¢æŸ¥æ˜¯å¦åˆ°äº†æé†’æ™‚é–“ï¼ˆç²¾ç¢ºåˆ°åˆ†é˜ï¼‰
            if (Math.abs(now.getTime() - today.getTime()) < 30000) { // 30ç§’å…§
                triggerCheckinReminder();
            }
        }

        // è§¸ç™¼æ‰“å¡æé†’
        function triggerCheckinReminder() {
            console.log('ğŸ”” è§¸ç™¼æ‰“å¡æé†’');
            
            // å¦‚æœåœ¨å‰æ™¯ï¼Œé¡¯ç¤ºå…¨å±æé†’
            if (!document.hidden) {
                showFullscreenReminder();
            }
            
            // å˜—è©¦å¤šç¨®æé†’æ–¹å¼
            try {
                // èªéŸ³æé†’
                if ('speechSynthesis' in window) {
                    var utterance = new SpeechSynthesisUtterance('æ‰“å¡æ™‚é–“åˆ°äº†ï¼');
                    utterance.lang = 'zh-TW';
                    speechSynthesis.speak(utterance);
                }
                
                // æŒ¯å‹•æé†’
                if ('vibrate' in navigator) {
                    navigator.vibrate([500, 200, 500, 200, 500]);
                }
                
                // å˜—è©¦éŸ³æ•ˆ
                playAlertSound();
                
            } catch (error) {
                console.error('æé†’å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºå…¨å±æé†’
        function showFullscreenReminder() {
            var reminderElement = document.getElementById('fullscreenReminder');
            document.getElementById('reminderTime').textContent = settings.checkinTime;
            reminderElement.classList.remove('hidden');
            
            // å˜—è©¦é€²å…¥å…¨è¢å¹•
            try {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
            } catch (error) {
                console.log('ç„¡æ³•é€²å…¥å…¨è¢å¹•:', error);
            }
        }

        // éš±è—å…¨å±æé†’
        function hideFullscreenReminder() {
            document.getElementById('fullscreenReminder').classList.add('hidden');
            
            // é€€å‡ºå…¨è¢å¹•
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            } catch (error) {
                console.log('ç„¡æ³•é€€å‡ºå…¨è¢å¹•:', error);
            }
        }

        // å»¶é²æé†’
        function snoozeReminder() {
            hideFullscreenReminder();
            showMessage('â° å°‡åœ¨ 5 åˆ†é˜å¾Œå†æ¬¡æé†’', 'info');
            
            setTimeout(function() {
                if (!document.hidden) {
                    triggerCheckinReminder();
                }
            }, 5 * 60 * 1000);
        }

        // æ’­æ”¾æé†’éŸ³æ•ˆ
        function playAlertSound() {
            try {
                var audioContext = new (window.AudioContext || window.webkitAudioContext)();
                var oscillator = audioContext.createOscillator();
                var gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // æ’­æ”¾ä¸€å€‹éŸ¿äº®çš„æé†’éŸ³
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1046, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.4);
                
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.error('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
            }
        }

        // æª¢æŸ¥è¡Œäº‹æ›†å–šé†’
        function checkCalendarWakeup() {
            var urlParams = new URLSearchParams(window.location.search);
            var wakeupSource = urlParams.get('wakeup');
            var wakeupTime = urlParams.get('time');
            
            if (wakeupSource === 'calendar') {
                console.log('ğŸ”” è¡Œäº‹æ›†å–šé†’æª¢æ¸¬:', wakeupTime);
                showMessage('ğŸ”” è¡Œäº‹æ›†æé†’å–šé†’ï¼æº–å‚™è‡ªå‹•æ‰“å¡...', 'info');
                
                // å»¶é²åŸ·è¡Œè‡ªå‹•æ‰“å¡æµç¨‹ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æé†’
                setTimeout(() => {
                    executeAutoCheckin('calendar');
                }, 2000);
                
                return true;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚º Siri æ·å¾‘å–šé†’
            if (wakeupSource === 'siri') {
                console.log('ğŸ—£ï¸ Siri æ·å¾‘å–šé†’æª¢æ¸¬');
                showMessage('ğŸ—£ï¸ Siri æ·å¾‘å–šé†’ï¼ç«‹å³åŸ·è¡Œæ‰“å¡...', 'info');
                setTimeout(() => {
                    executeAutoCheckin('siri');
                }, 1000);
                return true;
            }
            
            return false;
        }

        // è¨­å®š URL Scheme è™•ç†å™¨
        function setupURLSchemeHandler() {
            // ç›£è½ popstate äº‹ä»¶ï¼ˆè¿”å›æŒ‰éˆ•æˆ– URL è®ŠåŒ–ï¼‰
            window.addEventListener('popstate', function(event) {
                checkCalendarWakeup();
            });
            
            // focus äº‹ä»¶å·²åœ¨ setupVisibilityMonitoring() ä¸­è¨­å®šï¼Œé€™è£¡åªéœ€æª¢æŸ¥ wakeup
            
            // ç›£è½ pageshow äº‹ä»¶ï¼ˆé é¢é¡¯ç¤ºï¼‰
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    console.log('ğŸ“„ é é¢å¾ç·©å­˜æ¢å¾©');
                    checkCalendarWakeup();
                }
            });
        }

        // åŸ·è¡Œè‡ªå‹•æ‰“å¡æµç¨‹
        function executeAutoCheckin(source) {
            showMessage(`ğŸ¯ ${source === 'calendar' ? 'è¡Œäº‹æ›†' : 'Siri'} è§¸ç™¼è‡ªå‹•æ‰“å¡æµç¨‹...`, 'info');
            
            // é¡¯ç¤ºè‡ªå‹•æ‰“å¡ä»‹é¢
            showAutoCheckinInterface(source);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ‰“å¡æ™‚é–“
            if (isValidCheckinTime()) {
                // åŸ·è¡Œè‡ªå‹•æ‰“å¡é‚è¼¯
                performSmartCheckin(source);
            } else {
                showMessage('â° ç•¶å‰ä¸åœ¨è¨­å®šçš„æ‰“å¡æ™‚é–“ç¯„åœå…§', 'warning');
            }
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ‰“å¡æ™‚é–“
        function isValidCheckinTime() {
            var now = new Date();
            var currentDay = now.getDay();
            var currentTime = now.getHours() * 60 + now.getMinutes();
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè¨­å®šçš„æ‰“å¡æ—¥æœŸ
            if (!settings.weeklyDays.includes(currentDay)) {
                console.log('ä»Šå¤©ä¸æ˜¯è¨­å®šçš„æ‰“å¡æ—¥æœŸ');
                return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æ‰“å¡æ™‚é–“ç¯„åœå…§ï¼ˆå‰å¾Œ30åˆ†é˜ï¼‰
            var checkinTimeParts = settings.checkinTime.split(':');
            var checkinTimeMinutes = parseInt(checkinTimeParts[0]) * 60 + parseInt(checkinTimeParts[1]);
            var timeDiff = Math.abs(currentTime - checkinTimeMinutes);
            
            if (timeDiff <= 30) {
                console.log('åœ¨æœ‰æ•ˆæ‰“å¡æ™‚é–“ç¯„åœå…§');
                return true;
            }
            
            console.log(`æ™‚é–“å·®ç•°: ${timeDiff} åˆ†é˜ï¼Œè¶…å‡ºç¯„åœ`);
            return false;
        }

        // é¡¯ç¤ºè‡ªå‹•æ‰“å¡ä»‹é¢
        function showAutoCheckinInterface(source) {
            var autoCheckinDiv = document.getElementById('autoCheckinInterface');
            if (!autoCheckinDiv) {
                autoCheckinDiv = document.createElement('div');
                autoCheckinDiv.id = 'autoCheckinInterface';
                autoCheckinDiv.innerHTML = `
                    <div class="auto-checkin-overlay">
                        <div class="auto-checkin-modal">
                            <div class="auto-checkin-header">
                                <h2>ğŸ¯ è‡ªå‹•æ‰“å¡åŸ·è¡Œä¸­</h2>
                                <div class="auto-checkin-source">
                                    ä¾†æºï¼š${source === 'calendar' ? 'ğŸ“… iOS è¡Œäº‹æ›†' : 'ğŸ—£ï¸ Siri æ·å¾‘'}
                                </div>
                            </div>
                            <div class="auto-checkin-content">
                                <div class="auto-checkin-status" id="autoCheckinStatus">
                                    æ­£åœ¨æº–å‚™æ‰“å¡...
                                </div>
                                <div class="auto-checkin-progress">
                                    <div class="progress-bar" id="autoCheckinProgress"></div>
                                </div>
                                <div class="auto-checkin-actions">
                                    <button class="btn btn-primary" onclick="proceedToCheckin()" id="proceedBtn">
                                        ğŸš€ ç«‹å³å‰å¾€æ‰“å¡
                                    </button>
                                    <button class="btn btn-secondary" onclick="closeAutoCheckin()" id="cancelBtn">
                                        âŒ å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(autoCheckinDiv);
            }
            
            autoCheckinDiv.style.display = 'block';
        }

        // åŸ·è¡Œæ™ºæ…§æ‰“å¡
        function performSmartCheckin(source) {
            var statusElement = document.getElementById('autoCheckinStatus');
            var progressElement = document.getElementById('autoCheckinProgress');
            
            var steps = [
                { text: 'ğŸ” æª¢æŸ¥æ‰“å¡è¨­å®š...', progress: 25 },
                { text: 'ğŸ“± æº–å‚™é–‹å•Ÿæ‰“å¡é é¢...', progress: 50 },
                { text: 'ğŸ“¤ æº–å‚™ç™¼é€ Teams é€šçŸ¥...', progress: 75 },
                { text: 'ğŸ‰ è‡ªå‹•æ‰“å¡æµç¨‹å®Œæˆï¼', progress: 100 }
            ];
            
            var currentStep = 0;
            
            var stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    var step = steps[currentStep];
                    statusElement.textContent = step.text;
                    progressElement.style.width = step.progress + '%';
                    currentStep++;
                } else {
                    clearInterval(stepInterval);
                    // æº–å‚™å®Œæˆï¼Œç›´æ¥åŸ·è¡Œæ‰“å¡
                    document.getElementById('proceedBtn').style.display = 'block';
                    document.getElementById('proceedBtn').textContent = 'ğŸš€ é–‹å•Ÿæ‰“å¡é é¢';
                }
            }, 800);
        }

        // å‰å¾€æ‰“å¡
        function proceedToCheckin() {
            closeAutoCheckin();
            
            // è¨˜éŒ„è‡ªå‹•æ‰“å¡äº‹ä»¶
            logAutoCheckinEvent();
            
            // ç™¼é€ Teams é–‹å§‹æ‰“å¡é€šçŸ¥
            sendTeamsNotification(
                'ğŸš€ è‡ªå‹•æ‰“å¡åŸ·è¡Œ',
                `è¡Œäº‹æ›†æé†’è§¸ç™¼è‡ªå‹•æ‰“å¡\næ™‚é–“ï¼š${new Date().toLocaleString()}\nå³å°‡é–‹å•Ÿæ‰“å¡é é¢`,
                'æé†’'
            );
            
            // é–‹å•Ÿæ‰“å¡é é¢
            window.open(settings.checkinUrl, '_blank');
            
            showMessage('ğŸš€ å·²é–‹å•Ÿæ‰“å¡é é¢ï¼Teams é€šçŸ¥å·²ç™¼é€ã€‚', 'success');
            
            // å»¶é²æª¢æŸ¥æ‰“å¡çµæœï¼ˆçµ¦ç”¨æˆ¶æ™‚é–“å®Œæˆæ‰“å¡ï¼‰
            setTimeout(() => {
                checkCheckinResult();
            }, 30000); // 30ç§’å¾Œæª¢æŸ¥
        }

        // é—œé–‰è‡ªå‹•æ‰“å¡ä»‹é¢
        function closeAutoCheckin() {
            var autoCheckinDiv = document.getElementById('autoCheckinInterface');
            if (autoCheckinDiv) {
                autoCheckinDiv.style.display = 'none';
            }
        }

        // è¨˜éŒ„è‡ªå‹•æ‰“å¡äº‹ä»¶
        function logAutoCheckinEvent() {
            var event = {
                timestamp: new Date().toISOString(),
                source: 'auto',
                checkinTime: settings.checkinTime,
                actualTime: new Date().toTimeString().substr(0, 5)
            };
            
            var logs = JSON.parse(localStorage.getItem('checkin_logs') || '[]');
            logs.push(event);
            
            // åªä¿ç•™æœ€è¿‘ 30 ç­†è¨˜éŒ„
            if (logs.length > 30) {
                logs = logs.slice(-30);
            }
            
            localStorage.setItem('checkin_logs', JSON.stringify(logs));
            console.log('ğŸ“ è‡ªå‹•æ‰“å¡äº‹ä»¶å·²è¨˜éŒ„:', event);
        }

        // æ¸¬è©¦è¡Œäº‹æ›†å–šé†’åŠŸèƒ½
        function testCalendarWakeup() {
            showMessage('ğŸ§ª æ¨¡æ“¬è¡Œäº‹æ›†å–šé†’æ¸¬è©¦...', 'info');
            
            // æ›´æ–° URL åŒ…å«æ¸¬è©¦åƒæ•¸
            var testUrl = window.location.href.split('?')[0] + '?wakeup=calendar&time=' + 
                         new Date().toTimeString().substr(0, 5).replace(':', '') + '&test=true';
            
            // å»¶é²åŸ·è¡Œï¼Œæ¨¡æ“¬çœŸå¯¦å–šé†’æƒ…å¢ƒ
            setTimeout(() => {
                history.pushState({}, '', testUrl);
                executeAutoCheckin('calendar');
            }, 1000);
        }

        // Teams é€šçŸ¥åŠŸèƒ½
        function sendTeamsNotification(title, message, level) {
            if (!settings.teamsEnabled || !settings.teamsWebhook) {
                console.log('Teams é€šçŸ¥å·²åœç”¨æˆ–æœªè¨­å®š Webhook');
                return Promise.resolve();
            }

            var levelColors = {
                "æˆåŠŸ": "00FF00",  // ç¶ è‰²
                "éŒ¯èª¤": "FF0000",  // ç´…è‰²
                "æé†’": "FFFF00"   // é»ƒè‰²
            };

            var currentTime = new Date().toLocaleString('zh-TW');
            var deviceName = navigator.userAgent.includes('iPhone') ? 'iPhone' : 
                           navigator.userAgent.includes('iPad') ? 'iPad' : 'iOS è£ç½®';
            var color = levelColors[level] || "00FF00";

            var payload = {
                "@type": "MessageCard",
                "@context": "http://schema.org/extensions",
                "themeColor": color,
                "title": title,
                "text": message,
                "sections": [{
                    "facts": [
                        {"name": "è£ç½®åç¨±", "value": deviceName},
                        {"name": "åŸ·è¡Œæ™‚é–“", "value": currentTime},
                        {"name": "ä¾†æº", "value": "Mphasisæ‰“å¡ç³»çµ±"}
                    ]
                }]
            };

            return sendTeamsWebhook(payload, settings.teamsWebhook)
                .catch(error => {
                    console.error('ä¸»è¦ Webhook ç™¼é€å¤±æ•—:', error);
                    if (settings.teamsBackupWebhook) {
                        console.log('å˜—è©¦å‚™ç”¨ Webhook...');
                        return sendTeamsWebhook(payload, settings.teamsBackupWebhook);
                    }
                    throw error;
                });
        }

        // ç™¼é€ Teams Webhook
        function sendTeamsWebhook(payload, webhookUrl) {
            console.log('ğŸ“¤ ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€ Teams é€šçŸ¥...');
            
            return fetch(webhookUrl, {
                method: 'POST',
                mode: 'no-cors',  // ğŸ¯ é—œéµï¼ä½¿ç”¨ no-cors æ¨¡å¼ç¹é CORS é™åˆ¶
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                // no-cors æ¨¡å¼ä¸‹ response.type æœƒæ˜¯ 'opaque'ï¼Œç„¡æ³•è®€å–ç‹€æ…‹ç¢¼
                console.log('âœ… Teams é€šçŸ¥ç™¼é€æˆåŠŸ (no-cors æ¨¡å¼)');
                console.log('ğŸ“¡ å›æ‡‰é¡å‹:', response.type);
                showMessage('ğŸ“¤ Teams é€šçŸ¥ç™¼é€æˆåŠŸï¼', 'success');
                return response;
            })
            .catch(error => {
                console.error('âŒ no-cors ç™¼é€å¤±æ•—:', error.message);
                console.log('ğŸ”„ å˜—è©¦ä½¿ç”¨ CORS ä»£ç†ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ...');
                
                // å¦‚æœ no-cors ä¹Ÿå¤±æ•—ï¼Œæ‰ä½¿ç”¨ä»£ç†
                showMessage('âš ï¸ ç›´æ¥ç™¼é€å¤±æ•—ï¼Œå˜—è©¦ä»£ç†æ–¹æ¡ˆ...', 'warning');
                return sendTeamsWebhookWithProxy(payload, webhookUrl);
            });
        }

        // ä½¿ç”¨ CORS ä»£ç†ç™¼é€ Teams Webhook
        function sendTeamsWebhookWithProxy(payload, webhookUrl) {
            var proxyUrl = 'https://api.allorigins.win/raw?url=';
            var fullUrl = proxyUrl + encodeURIComponent(webhookUrl);
            
            console.log('ğŸ”„ ä½¿ç”¨ä»£ç† URL:', proxyUrl);
            
            return fetch(fullUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    console.log('âœ… ä»£ç†ç™¼é€æˆåŠŸ');
                    showMessage('ğŸ“¤ Teams é€šçŸ¥ç™¼é€æˆåŠŸ (é€éä»£ç†)', 'success');
                } else {
                    throw new Error(`ä»£ç†å›æ‡‰éŒ¯èª¤: HTTP ${response.status}`);
                }
            })
            .catch(error => {
                console.error('âŒ ä»£ç†ç™¼é€ä¹Ÿå¤±æ•—:', error.message);
                showMessage('âŒ Teams é€šçŸ¥ç™¼é€å¤±æ•— (ç›´æ¥å’Œä»£ç†éƒ½å¤±æ•—)', 'error');
                
                // æä¾›æ‰‹å‹•è§£æ±ºæ–¹æ¡ˆ
                showManualSolution(webhookUrl, payload);
                throw error;
            });
        }

        // é¡¯ç¤ºæ‰‹å‹•è§£æ±ºæ–¹æ¡ˆ
        function showManualSolution(webhookUrl, payload) {
            var solutionMessage = `
ğŸ”§ è‡ªå‹•ç™¼é€å¤±æ•—ï¼Œè«‹å˜—è©¦ä»¥ä¸‹è§£æ±ºæ–¹æ¡ˆï¼š

1. ğŸ“± ä½¿ç”¨ iOS æ·å¾‘ï¼š
   - é–‹å•Ÿã€Œæ·å¾‘ã€æ‡‰ç”¨
   - å»ºç«‹æ–°æ·å¾‘ç™¼é€ Teams é€šçŸ¥
   
2. ğŸŒ æª¢æŸ¥ç¶²è·¯é€£ç·šï¼š
   - ç¢ºèªå¯ä»¥æ­£å¸¸ä¸Šç¶²
   - å˜—è©¦é‡æ–°æ•´ç†é é¢
   
3. ğŸ”— é©—è­‰ Webhook URLï¼š
   - ç¢ºèª URL æ­£ç¢ºä¸”æœªéæœŸ
   - åœ¨ Teams ä¸­é‡æ–°ç”Ÿæˆ Webhook

4. ğŸ”§ ä½¿ç”¨è¨ºæ–·å·¥å…·ï¼š
   - é»æ“Šã€Œé–‹å•Ÿç¨ç«‹æ¸¬è©¦å·¥å…·ã€é€²è¡Œè©³ç´°è¨ºæ–·
            `;
            
            console.log(solutionMessage);
            
            // å¯ä»¥é¸æ“‡æ€§åœ°é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
            setTimeout(() => {
                if (confirm('Teams é€šçŸ¥è‡ªå‹•ç™¼é€å¤±æ•—ã€‚æ˜¯å¦è¦é–‹å•Ÿé€²éšè¨ºæ–·å·¥å…·ï¼Ÿ')) {
                    window.open('teams_advanced_test.html?webhook=' + encodeURIComponent(webhookUrl), '_blank');
                }
            }, 2000);
        }

        // æª¢æŸ¥æ‰“å¡çµæœ
        function checkCheckinResult() {
            // ç°¡å–®çš„æ‰“å¡çµæœæª¢æŸ¥é‚è¼¯
            // å¯¦éš›ä¸Šï¼Œç”±æ–¼è·¨åŸŸé™åˆ¶ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥æª¢æŸ¥æ‰“å¡ç¶²ç«™çš„ç‹€æ…‹
            // æ‰€ä»¥é€™è£¡ä¸»è¦æ˜¯ç™¼é€ä¸€å€‹å®Œæˆé€šçŸ¥
            
            sendTeamsNotification(
                'âœ… è‡ªå‹•æ‰“å¡æµç¨‹å®Œæˆ',
                `æ‰“å¡é é¢å·²é–‹å•Ÿ\næ™‚é–“ï¼š${new Date().toLocaleString()}\nè«‹ç¢ºèªæ‰“å¡æ˜¯å¦æˆåŠŸ\n\nğŸ’¡ ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•è‡ªå‹•æª¢æ¸¬æ‰“å¡çµæœï¼Œè«‹æ‰‹å‹•ç¢ºèªæ‰“å¡ç‹€æ…‹ã€‚`,
                'æˆåŠŸ'
            );
        }

        // å¿«é€Ÿé€±é–“æ—¥æœŸåˆ‡æ›
        function toggleQuickDay(day) {
            var dayBtn = document.querySelector('.quick-day-btn[data-day="' + day + '"]');
            var index = quickWeeklyDays.indexOf(day);
            
            if (index > -1) {
                quickWeeklyDays.splice(index, 1);
                dayBtn.classList.remove('selected');
            } else {
                quickWeeklyDays.push(day);
                dayBtn.classList.add('selected');
            }
            
            console.log('å¿«é€Ÿè¨­å®šé€±é–“é¸æ“‡:', quickWeeklyDays);
        }

        // é¸æ“‡å·¥ä½œæ—¥ (é€±ä¸€åˆ°é€±äº”)
        function selectWorkdays() {
            quickWeeklyDays = [1, 2, 3, 4, 5];
            updateQuickWeeklyDisplay();
            showMessage('ğŸ“… å·²é¸æ“‡å·¥ä½œæ—¥ (é€±ä¸€åˆ°é€±äº”)', 'info');
        }

        // é¸æ“‡å…¨éƒ¨æ—¥æœŸ
        function selectAllDays() {
            quickWeeklyDays = [0, 1, 2, 3, 4, 5, 6];
            updateQuickWeeklyDisplay();
            showMessage('ğŸ—“ï¸ å·²é¸æ“‡å…¨éƒ¨æ—¥æœŸ (é€±ä¸€åˆ°é€±æ—¥)', 'info');
        }

        // æ›´æ–°å¿«é€Ÿé€±é–“é¡¯ç¤º
        function updateQuickWeeklyDisplay() {
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.quick-day-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            
            // è¨­å®šé¸ä¸­ç‹€æ…‹
            quickWeeklyDays.forEach(function(day) {
                var dayBtn = document.querySelector('.quick-day-btn[data-day="' + day + '"]');
                if (dayBtn) {
                    dayBtn.classList.add('selected');
                }
            });
        }

        // å¿«é€Ÿè¨­å®š
        function quickSetup() {
            console.log('ğŸ”§ quickSetup() å‡½æ•¸è¢«å‘¼å«');
            
            var checkinTime = document.getElementById('quickCheckinTime').value;
            var reminderMinutes = parseInt(document.getElementById('quickReminderTime').value);
            var excludeHolidays = document.getElementById('quickExcludeHolidays').checked;
            
            console.log('ğŸ“‹ è¨­å®šå€¼:', {
                checkinTime: checkinTime,
                reminderMinutes: reminderMinutes,
                excludeHolidays: excludeHolidays,
                quickWeeklyDays: quickWeeklyDays
            });
            
            if (!checkinTime) {
                console.log('âŒ æ‰“å¡æ™‚é–“æœªè¨­å®š');
                showMessage('âŒ è«‹è¨­å®šæ‰“å¡æ™‚é–“', 'error');
                return;
            }
            
            if (quickWeeklyDays.length === 0) {
                console.log('âŒ æœªé¸æ“‡æ‰“å¡æ—¥æœŸ');
                showMessage('âŒ è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ‰“å¡æ—¥æœŸ', 'error');
                return;
            }
            
            // æ›´æ–°è¨­å®š
            settings.checkinTime = checkinTime;
            settings.reminderMinutes = reminderMinutes;
            settings.weeklyDays = quickWeeklyDays.slice(); // è¤‡è£½é™£åˆ—
            settings.excludeHolidays = excludeHolidays;
            saveSettings();
            
            var dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            var selectedDaysText = quickWeeklyDays.map(day => 'é€±' + dayNames[day]).join('ã€');
            
            showMessage('âš¡ å¿«é€Ÿè¨­å®šå®Œæˆï¼\n' +
                       'ğŸ• æ™‚é–“ï¼š' + checkinTime + '\n' +
                       'ğŸ“… æ—¥æœŸï¼š' + selectedDaysText + '\n' +
                       'â° æé†’ï¼šæå‰' + reminderMinutes + 'åˆ†é˜\n' +
                       'ğŸ–ï¸ å‡æ—¥ï¼š' + (excludeHolidays ? 'è‡ªå‹•æ’é™¤' : 'ä¸æ’é™¤') + '\n' +
                       'ğŸ“… æ­£åœ¨è¨­å®š iOS è¡Œäº‹æ›†æé†’...', 'success');
            
            // åªè¨­å®š iOS è¡Œäº‹æ›†
            setTimeout(() => setupIOSCalendar(), 1000);
        }

        // è¨­å®š iOS æ—¥æ›†
        function setupIOSCalendar() {
            console.log('ğŸ“… setupIOSCalendar() å‡½æ•¸è¢«å‘¼å«');
            console.log('ğŸ“‹ ç›®å‰ settings:', settings);
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºé‡è¤‡è¨­å®š
            var lastCalendarSetup = localStorage.getItem('lastCalendarSetup');
            var currentSetup = JSON.stringify({
                time: settings.checkinTime,
                days: settings.weeklyDays,
                holidays: settings.excludeHolidays
            });
            
            if (lastCalendarSetup && lastCalendarSetup === currentSetup) {
                showMessage('âš ï¸ ç›¸åŒçš„è¡Œäº‹æ›†è¨­å®šå·²å­˜åœ¨ï¼\n\nå¦‚æœéœ€è¦é‡æ–°ä¸‹è¼‰ï¼Œè«‹ç¹¼çºŒã€‚', 'warning');
                if (!confirm('ç›¸åŒçš„è¡Œäº‹æ›†è¨­å®šå·²å­˜åœ¨ï¼Œæ˜¯å¦é‡æ–°ä¸‹è¼‰ï¼Ÿ')) {
                    return;
                }
            } else if (lastCalendarSetup) {
                var lastSettings = JSON.parse(lastCalendarSetup);
                showMessage(`âš ï¸ åµæ¸¬åˆ°èˆŠçš„è¡Œäº‹æ›†è¨­å®šï¼\n\n` +
                           `èˆŠè¨­å®šï¼š${lastSettings.time}\n` +
                           `æ–°è¨­å®šï¼š${settings.checkinTime}\n\n` +
                           `â— é‡è¦ï¼šè«‹æ‰‹å‹•åˆªé™¤èˆŠçš„è¡Œäº‹æ›†æé†’ï¼Œé¿å…é‡è¤‡é€šçŸ¥ï¼`, 'warning');
                
                // å»¶é²é¡¯ç¤ºæ¸…ç†èªªæ˜
                setTimeout(() => {
                    showCalendarCleanupInstructions(lastSettings);
                }, 2000);
            }
            
            var timeParts = settings.checkinTime.split(':');
            var reminderHour = parseInt(timeParts[0]);
            var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
            
            if (reminderMinute < 0) {
                reminderMinute += 60;
                reminderHour -= 1;
            }
            
            // è½‰æ›é€±é–“é¸æ“‡ç‚º iCal æ ¼å¼
            var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
            var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
            
            // ç”Ÿæˆå–šé†’ URLï¼ˆç•¶å‰é é¢ + è¡Œäº‹æ›†å–šé†’åƒæ•¸ï¼‰
            var wakeupUrl = window.location.href.split('?')[0] + '?wakeup=calendar&time=' + 
                           reminderHour.toString().padStart(2, '0') + 
                           reminderMinute.toString().padStart(2, '0');
            
            // ä½¿ç”¨æ¸¬è©¦ç‰ˆç¢ºå¯¦æœ‰æ•ˆçš„ç°¡å–®æ ¼å¼
            var icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Mphasisæ‰“å¡ç³»çµ±//NONSGML//EN
BEGIN:VEVENT
SUMMARY:ğŸ¯ Mphasis è‡ªå‹•æ‰“å¡æé†’
DESCRIPTION:ğŸ“± æ™ºæ…§æ‰“å¡ç³»çµ±å•Ÿå‹•ï¼é»æ“Šæ­¤æé†’å°‡è‡ªå‹•é–‹å•Ÿæ‰“å¡æ‡‰ç”¨
DTSTART:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute).toString().padStart(2, '0')}00Z
DTEND:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=${selectedDays}
URL:${wakeupUrl}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:ğŸš€ ç«‹å³æ‰“å¡ï¼é»æ“Šé–‹å•Ÿæ™ºæ…§æ‰“å¡ç³»çµ±
URL:${wakeupUrl}
END:VALARM
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:â° 5åˆ†é˜å¾Œéœ€è¦æ‰“å¡ï¼æº–å‚™é–‹å§‹
END:VALARM
END:VEVENT`;

            // å¦‚æœå•Ÿç”¨å‡æ—¥æ’é™¤ï¼ŒåŠ å…¥å‡æ—¥ä¾‹å¤– (ä½¿ç”¨ 2025 å¹´ä½œç‚ºåŸºæº–)
            if (settings.excludeHolidays) {
                var holidays = [
                    '20250101', // å…ƒæ—¦
                    '20250128', // è¾²æ›†æ–°å¹´ (2025å¹´ç¯„ä¾‹)
                    '20250129',
                    '20250130',
                    '20250404', // å…’ç«¥ç¯€
                    '20250405', // æ¸…æ˜ç¯€
                    '20250501', // å‹å‹•ç¯€
                    '20250531', // ç«¯åˆç¯€ (2025å¹´ç¯„ä¾‹)
                    '20250906', // ä¸­ç§‹ç¯€ (2025å¹´ç¯„ä¾‹)
                    '20251010'  // åœ‹æ…¶æ—¥
                ];
                
                // ä½¿ç”¨èˆ‡ DTSTART ç›¸åŒçš„å›ºå®šæ™‚é–“æ ¼å¼
                icalContent += '\nEXDATE:' + holidays.map(date => date + 'T' + 
                    reminderHour.toString().padStart(2, '0') + 
                    Math.max(0, reminderMinute).toString().padStart(2, '0') + '00Z').join(',');
            }

            icalContent += '\nEND:VEVENT\nEND:VCALENDAR';
            
            // å…ˆå„²å­˜å…§å®¹ä¾›å¾ŒçºŒä½¿ç”¨
            window.tempCalendarContent = icalContent;
            
            // iOS Safari å°ˆç”¨ä¸‹è¼‰ç­–ç•¥
            var isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            var downloadSuccess = false;
            
            // è¨ˆç®—é¸æ“‡çš„å¤©æ•¸æ–‡å­—
            var dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            var selectedDaysText = settings.weeklyDays.map(day => 'é€±' + dayNames[day]).join('ã€');
            
            // ä½¿ç”¨æ¸¬è©¦ç‰ˆç¢ºå¯¦æœ‰æ•ˆçš„æ–¹æ³•
            console.log('ğŸ“± ä½¿ç”¨æ¸¬è©¦ç‰ˆé©—è­‰æˆåŠŸçš„ä¸‹è¼‰æ–¹æ³•');
            
            try {
                // æ¸¬è©¦ç‰ˆçš„æˆåŠŸæ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ data URL + window.open
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    console.log('âœ… Data URL æˆåŠŸé–‹å•Ÿæ–°è¦–çª—');
                    showMessage('ğŸ“… è¡Œäº‹æ›†æª”æ¡ˆå·²åœ¨æ–°è¦–çª—é–‹å•Ÿï¼\n\nğŸ“± iOS æ“ä½œæ­¥é©Ÿï¼š\n1. åœ¨æ–°è¦–çª—ä¸­é»æ“Šå³ä¸Šè§’ã€Œåˆ†äº«ã€\n2. é¸æ“‡ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€\n3. ç¢ºèªåŒ¯å…¥è¨­å®š\n\nâœ… ä½¿ç”¨æ¸¬è©¦ç‰ˆé©—è­‰æˆåŠŸçš„æ–¹æ³•', 'success');
                    downloadSuccess = true;
                } else {
                    console.log('âŒ Data URL å¤±æ•—ï¼šå½ˆå‡ºè¦–çª—è¢«é˜»æ“‹');
                    // å‚™ç”¨æ–¹æ¡ˆï¼šé¡¯ç¤º iOS å°ˆç”¨é¸é …
                    showIOSCalendarHelp(icalContent, selectedDaysText);
                    downloadSuccess = true;
                }
            } catch (error) {
                console.error('Data URL æ–¹æ³•å¤±æ•—:', error);
                // æœ€çµ‚å‚™ç”¨æ–¹æ¡ˆ
                showIOSCalendarHelp(icalContent, selectedDaysText);
                downloadSuccess = true;
            }
            
            // å„²å­˜ç•¶å‰è¨­å®šï¼Œç”¨æ–¼é‡è¤‡åµæ¸¬
            localStorage.setItem('lastCalendarSetup', currentSetup);
        }

        // iOS å°ˆç”¨è¡Œäº‹æ›†å¹«åŠ©
        function showIOSCalendarHelp(icalContent, selectedDaysText) {
            var dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            // å¦‚æœæ²’æœ‰å‚³å…¥ selectedDaysTextï¼Œå‰‡ç”Ÿæˆä¸€å€‹
            if (!selectedDaysText) {
                selectedDaysText = settings.weeklyDays.map(day => 'é€±' + dayNames[day]).join('ã€');
            }
            
            showMessage('ğŸ“… iOS è¡Œäº‹æ›†è¨­å®šå®Œæˆï¼\n\n' +
                       'ğŸ“‹ è¨­å®šå…§å®¹ï¼š\n' +
                       'ğŸ• ' + settings.checkinTime + ' æ‰“å¡æé†’\n' +
                       'ğŸ“… ' + selectedDaysText + '\n' +
                       'ğŸ–ï¸ ' + (settings.excludeHolidays ? 'å·²æ’é™¤å‡æ—¥' : 'åŒ…å«å‡æ—¥') + '\n\n' +
                       'â¬‡ï¸ è«‹ä½¿ç”¨ä¸‹æ–¹é¸é …å®Œæˆè¨­å®š', 'success');
            
            // ç«‹å³é¡¯ç¤º iOS å°ˆç”¨é¸é …
            setTimeout(() => {
                showIOSCalendarOptions(icalContent, selectedDaysText);
            }, 500);
        }

        // iOS å°ˆç”¨è¡Œäº‹æ›†é¸é …
        function showIOSCalendarOptions(icalContent, selectedDaysText) {
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 420px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF6B35; margin-bottom: 16px; text-align: center;">ğŸ“… iOS è¡Œäº‹æ›†è¨­å®š</h3>
                    
                    <div style="background: #e3f2fd; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #2196F3;">
                        <p style="margin: 0; color: #1565C0; font-size: 14px; line-height: 1.5;">
                            <strong>ğŸ’¡ iOS Safari é™åˆ¶ï¼š</strong>ç”±æ–¼å®‰å…¨æ”¿ç­–ï¼Œç„¡æ³•è‡ªå‹•ä¸‹è¼‰æª”æ¡ˆã€‚è«‹é¸æ“‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š
                        </p>
                    </div>
                    
                    <button onclick="tryDataURLMethod()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ğŸš€ æ–¹æ³•ä¸€ï¼šç›´æ¥é–‹å•Ÿè¡Œäº‹æ›†
                    </button>
                    
                    <button onclick="tryDownloadMethod()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ğŸ“¥ æ–¹æ³•äºŒï¼šä¸‹è¼‰ .ics æª”æ¡ˆ
                    </button>
                    
                    <button onclick="copyCalendarContent()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #FF9800; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ğŸ“‹ æ–¹æ³•ä¸‰ï¼šè¤‡è£½å…§å®¹æ‰‹å‹•å»ºç«‹
                    </button>
                    
                    <button onclick="showDetailedIOSSteps()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #9C27B0; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
                        ğŸ“– è©³ç´°è¨­å®šæ­¥é©Ÿèªªæ˜
                    </button>
                    
                    <button onclick="closeIOSCalendarOptions()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        é—œé–‰
                    </button>
                </div>
            `;
            
            // å‰µå»ºæ¨¡æ…‹æ¡†
            var modal = document.createElement('div');
            modal.id = 'iosCalendarOptionsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // å„²å­˜å…§å®¹ä¾›å¾ŒçºŒä½¿ç”¨
            window.tempCalendarContent = icalContent;
            window.tempCalendarInfo = selectedDaysText;
        }

        // æ–¹æ³•ä¸€ï¼šData URL ç›´æ¥é–‹å•Ÿ
        function tryDataURLMethod() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            try {
                // ä½¿ç”¨ data URL ä¸¦å˜—è©¦åœ¨æ–°è¦–çª—é–‹å•Ÿ
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    showMessage('âœ… å·²åœ¨æ–°è¦–çª—é–‹å•Ÿè¡Œäº‹æ›†æª”æ¡ˆï¼\n\nğŸ“± è«‹åœ¨æ–°è¦–çª—ä¸­ï¼š\n1. é»æ“Šå³ä¸Šè§’ã€Œåˆ†äº«ã€æŒ‰éˆ•\n2. é¸æ“‡ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€\n3. ç¢ºèªåŒ¯å…¥è¨­å®š', 'success');
                } else {
                    showMessage('âŒ å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œè«‹å˜—è©¦å…¶ä»–æ–¹æ³•', 'error');
                    tryDownloadMethod();
                }
            } catch (error) {
                console.log('Data URL æ–¹æ³•å¤±æ•—:', error);
                tryDownloadMethod();
            }
        }

        // æ–¹æ³•äºŒï¼šå¼·åˆ¶ä¸‹è¼‰
        function tryDownloadMethod() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            try {
                // å‰µå»ºéš±è—çš„ä¸‹è¼‰é€£çµ
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent));
                element.setAttribute('download', 'mphasis-checkin-calendar.ics');
                element.style.display = 'none';
                
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                showMessage('ğŸ“¥ è¡Œäº‹æ›†æª”æ¡ˆæº–å‚™ä¸‹è¼‰ä¸­...\n\nğŸ“± å¦‚æœæ²’æœ‰è‡ªå‹•ä¸‹è¼‰ï¼š\n1. é•·æŒ‰ã€ŒğŸ“¥ æ–¹æ³•äºŒã€æŒ‰éˆ•\n2. é¸æ“‡ã€Œä¸‹è¼‰é€£çµæª”æ¡ˆã€\n3. æ‰¾åˆ°ä¸‹è¼‰çš„ .ics æª”æ¡ˆä¸¦é–‹å•Ÿ\n4. é¸æ“‡ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€', 'info');
                
            } catch (error) {
                console.log('ä¸‹è¼‰æ–¹æ³•å¤±æ•—:', error);
                showMessage('âŒ è‡ªå‹•ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ä½¿ç”¨è¤‡è£½å…§å®¹æ–¹æ³•', 'error');
            }
        }

        // é¡¯ç¤ºè¡Œäº‹æ›†æ¸…ç†èªªæ˜
        function showCalendarCleanupInstructions(oldSettings) {
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 450px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF9800; margin-bottom: 16px; text-align: center;">âš ï¸ æ¸…ç†èˆŠçš„è¡Œäº‹æ›†æé†’</h3>
                    
                    <div style="background: #fff3e0; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #FF9800;">
                        <p style="margin: 0; color: #E65100; font-size: 14px; line-height: 1.5;">
                            <strong>é‡è¦ï¼š</strong>æ‚¨éœ€è¦æ‰‹å‹•åˆªé™¤èˆŠçš„æé†’ï¼Œé¿å…æ”¶åˆ°é‡è¤‡é€šçŸ¥ï¼
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <p style="margin: 0 0 8px 0; font-weight: 600;">èˆŠè¨­å®šè³‡è¨Šï¼š</p>
                        <p style="margin: 0; font-family: monospace; font-size: 14px;">
                            â° æ™‚é–“ï¼š${oldSettings.time}<br>
                            ğŸ“… é€±é–“ï¼š${oldSettings.days ? oldSettings.days.map(d => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d]).join('ã€') : 'æœªè¨­å®š'}
                        </p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #4CAF50;">
                        <p style="margin: 0 0 12px 0; font-weight: 600; color: #2E7D32;">ğŸ“± iOS è¡Œäº‹æ›†æ¸…ç†æ­¥é©Ÿï¼š</p>
                        <ol style="margin: 0; padding-left: 16px; color: #2E7D32; font-size: 14px; line-height: 1.6;">
                            <li>é–‹å•Ÿã€Œè¡Œäº‹æ›†ã€app</li>
                            <li>æ‰¾åˆ°ã€ŒMphasis è‡ªå‹•æ‰“å¡æé†’ã€äº‹ä»¶</li>
                            <li>é»æ“ŠèˆŠæ™‚é–“çš„æé†’äº‹ä»¶</li>
                            <li>é¸æ“‡ã€Œåˆªé™¤äº‹ä»¶ã€æˆ–ã€Œåˆªé™¤é‡è¤‡äº‹ä»¶ã€</li>
                            <li>ç¢ºèªåˆªé™¤æ‰€æœ‰èˆŠçš„é‡è¤‡äº‹ä»¶</li>
                        </ol>
                    </div>
                    
                    <button onclick="openCalendarApp()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        ğŸ“… é–‹å•Ÿè¡Œäº‹æ›† App
                    </button>
                    
                    <button onclick="showDetailedCleanupSteps()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        ğŸ“– è©³ç´°æ¸…ç†èªªæ˜
                    </button>
                    
                    <button onclick="closeCleanupInstructions()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            `;
            
            // å‰µå»ºæ¨¡æ…‹æ¡†
            var modal = document.createElement('div');
            modal.id = 'cleanupInstructionsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        function openCalendarApp() {
            // å˜—è©¦é–‹å•Ÿ iOS è¡Œäº‹æ›† app
            try {
                window.location.href = 'calshow://';
                showMessage('ğŸ“… æ­£åœ¨é–‹å•Ÿè¡Œäº‹æ›† App...', 'info');
            } catch (error) {
                showMessage('âš ï¸ ç„¡æ³•è‡ªå‹•é–‹å•Ÿï¼Œè«‹æ‰‹å‹•é–‹å•Ÿè¡Œäº‹æ›† App', 'warning');
            }
        }

        function showDetailedCleanupSteps() {
            var detailedSteps = `ğŸ“… è©³ç´°æ¸…ç†èˆŠè¡Œäº‹æ›†æé†’æ­¥é©Ÿï¼š

ğŸ” æ‰¾åˆ°èˆŠæé†’ï¼š
1. é–‹å•Ÿ iOSã€Œè¡Œäº‹æ›†ã€app
2. åˆ‡æ›åˆ°ã€Œåˆ—è¡¨ã€æª¢è¦–ï¼ˆåº•éƒ¨é¸é …ï¼‰
3. æœå°‹ã€ŒMphasisã€æˆ–ã€Œæ‰“å¡ã€
4. æ‰¾åˆ°èˆŠæ™‚é–“çš„æé†’äº‹ä»¶

âŒ åˆªé™¤èˆŠæé†’ï¼š
1. é»æ“ŠèˆŠçš„æé†’äº‹ä»¶
2. é»æ“Šå³ä¸Šè§’ã€Œç·¨è¼¯ã€
3. æ‹‰åˆ°æœ€ä¸‹æ–¹é»æ“Šã€Œåˆªé™¤äº‹ä»¶ã€
4. é¸æ“‡ã€Œåˆªé™¤æ‰€æœ‰é‡è¤‡äº‹ä»¶ã€
5. ç¢ºèªåˆªé™¤

âœ… ç¢ºèªæ¸…ç†å®Œæˆï¼š
1. æœå°‹ç¢ºèªæ²’æœ‰èˆŠæ™‚é–“çš„æé†’
2. ç¢ºèªåªæœ‰æ–°æ™‚é–“çš„æé†’å­˜åœ¨
3. æ¸¬è©¦æ–°æé†’æ˜¯å¦æ­£å¸¸

ğŸ’¡ å°æç¤ºï¼š
- å¦‚æœæœ‰å¤šå€‹è¡Œäº‹æ›†ï¼Œè«‹æª¢æŸ¥æ‰€æœ‰è¡Œäº‹æ›†
- å¯ä»¥æŒ‰æ™‚é–“æ’åºä¾†å¿«é€Ÿæ‰¾åˆ°èˆŠæé†’
- åˆªé™¤å¾Œå¯èƒ½éœ€è¦ç­‰å¾…å¹¾åˆ†é˜æ‰æœƒå®Œå…¨æ¶ˆå¤±`;

            alert(detailedSteps);
        }

        function closeCleanupInstructions() {
            var modal = document.getElementById('cleanupInstructionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // è©³ç´° iOS è¨­å®šæ­¥é©Ÿ
        function showDetailedIOSSteps() {
            var steps = `ğŸ“… iOS è¡Œäº‹æ›†è©³ç´°è¨­å®šæ­¥é©Ÿï¼š

ğŸ”¥ æ¨è–¦æ–¹æ³•ï¼šç›´æ¥é–‹å•Ÿè¡Œäº‹æ›†æª”æ¡ˆ
1. é»æ“Šã€ŒğŸš€ æ–¹æ³•ä¸€ï¼šç›´æ¥é–‹å•Ÿè¡Œäº‹æ›†ã€
2. åœ¨æ–°é–‹å•Ÿçš„é é¢ä¸­é»æ“Šå³ä¸Šè§’ã€Œåˆ†äº«ã€åœ–ç¤º
3. é¸æ“‡ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€æˆ–ã€Œè¡Œäº‹æ›†ã€
4. ç¢ºèªåŒ¯å…¥åˆ°é è¨­è¡Œäº‹æ›†
5. å®Œæˆï¼

ğŸ“¥ æ›¿ä»£æ–¹æ³•ï¼šä¸‹è¼‰æª”æ¡ˆ
1. é»æ“Šã€ŒğŸ“¥ æ–¹æ³•äºŒï¼šä¸‹è¼‰ .ics æª”æ¡ˆã€
2. å¦‚æœæ²’æœ‰è‡ªå‹•ä¸‹è¼‰ï¼Œé•·æŒ‰è©²æŒ‰éˆ•é¸æ“‡ã€Œä¸‹è¼‰é€£çµæª”æ¡ˆã€
3. åˆ° Safari ä¸‹è¼‰é …ç›®ä¸­æ‰¾åˆ° .ics æª”æ¡ˆ
4. é»æ“Šæª”æ¡ˆé–‹å•Ÿï¼Œé¸æ“‡ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€
5. ç¢ºèªåŒ¯å…¥è¨­å®š

ğŸ“‹ æ‰‹å‹•æ–¹æ³•ï¼šè¤‡è£½å…§å®¹
1. é»æ“Šã€ŒğŸ“‹ æ–¹æ³•ä¸‰ï¼šè¤‡è£½å…§å®¹æ‰‹å‹•å»ºç«‹ã€
2. è¤‡è£½é¡¯ç¤ºçš„ iCal å…§å®¹
3. é–‹å•Ÿã€Œè¡Œäº‹æ›†ã€appï¼Œé»æ“Šå³ä¸Šè§’ã€Œ+ã€
4. é¸æ“‡ã€Œå…¶ä»–ã€â†’ã€ŒåŒ¯å…¥è¡Œäº‹æ›†ã€
5. è²¼ä¸Šè¤‡è£½çš„å…§å®¹ä¸¦å„²å­˜

âœ… è¨­å®šå®Œæˆå¾Œï¼š
- æª¢æŸ¥è¡Œäº‹æ›†ä¸­æ˜¯å¦å‡ºç¾ã€ŒMphasis è‡ªå‹•æ‰“å¡æé†’ã€
- ç¢ºèªæé†’æ™‚é–“æ­£ç¢º
- æ¸¬è©¦é»æ“Šæé†’æ˜¯å¦èƒ½é–‹å•Ÿæ‰“å¡æ‡‰ç”¨`;

            alert(steps);
        }

        function closeIOSCalendarOptions() {
            var modal = document.getElementById('iosCalendarOptionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // é¡¯ç¤ºè¡Œäº‹æ›†ç®¡ç†ä»‹é¢
        function showCalendarManagement() {
            console.log('ğŸ—‘ï¸ é–‹å•Ÿè¡Œäº‹æ›†ç®¡ç†ä»‹é¢');
            
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 480px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF9800; margin-bottom: 16px; text-align: center;">ğŸ—‘ï¸ è¡Œäº‹æ›†æ’ç¨‹ç®¡ç†</h3>
                    
                    <div style="background: #fff3e0; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #FF9800;">
                        <p style="margin: 0; color: #E65100; font-size: 14px; line-height: 1.5;">
                            <strong>ç®¡ç†æ‚¨çš„æ‰“å¡æé†’æ’ç¨‹</strong><br>
                            å¯ä»¥æŸ¥çœ‹ã€åˆªé™¤æˆ–ä¿®æ”¹ç¾æœ‰çš„è¡Œäº‹æ›†æ’ç¨‹
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: #333;">ğŸ“‹ ç›®å‰è¨­å®šç‹€æ…‹</h4>
                        <div id="currentCalendarSettings" style="font-family: monospace; font-size: 14px; line-height: 1.6;">
                            è¼‰å…¥ä¸­...
                        </div>
                    </div>
                    
                    <button onclick="openIOSCalendarApp()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ğŸ“± é–‹å•Ÿ iOS è¡Œäº‹æ›† App
                    </button>
                    
                    <button onclick="showCalendarDeletionGuide()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #FF5722; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ğŸ—‘ï¸ åˆªé™¤æ’ç¨‹æŒ‡å—
                    </button>
                    
                    <button onclick="showCalendarSearchGuide()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        ğŸ” æŸ¥æ‰¾æ’ç¨‹æŒ‡å—
                    </button>
                    
                    <button onclick="clearCalendarHistory()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #9E9E9E; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
                        ğŸ§¹ æ¸…é™¤æ­·å²è¨˜éŒ„
                    </button>
                    
                    <button onclick="closeCalendarManagement()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        é—œé–‰
                    </button>
                </div>
            `;
            
            // å‰µå»ºæ¨¡æ…‹æ¡†
            var modal = document.createElement('div');
            modal.id = 'calendarManagementModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // è¼‰å…¥ç›®å‰è¨­å®š
            loadCurrentCalendarSettings();
        }

        function loadCurrentCalendarSettings() {
            setTimeout(() => {
                var settingsDiv = document.getElementById('currentCalendarSettings');
                if (settingsDiv) {
                    var lastSetup = localStorage.getItem('lastCalendarSetup');
                    var dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                    
                    var settingsText = `ğŸ• æ‰“å¡æ™‚é–“ï¼š${settings.checkinTime}
â° æå‰æé†’ï¼š${settings.reminderMinutes} åˆ†é˜
ğŸ“… å·¥ä½œæ—¥ï¼š${settings.weeklyDays.map(d => 'é€±' + dayNames[d]).join('ã€')}
ğŸ–ï¸ æ’é™¤å‡æ—¥ï¼š${settings.excludeHolidays ? 'æ˜¯' : 'å¦'}

ğŸ“‹ æ­·å²è¨˜éŒ„ï¼š`;

                    if (lastSetup) {
                        try {
                            var lastSettings = JSON.parse(lastSetup);
                            settingsText += `
âœ… ä¸Šæ¬¡å»ºç«‹ï¼š${lastSettings.time || 'æœªçŸ¥'}
ğŸ“… ä¸Šæ¬¡å·¥ä½œæ—¥ï¼š${lastSettings.days ? lastSettings.days.map(d => 'é€±' + dayNames[d]).join('ã€') : 'æœªçŸ¥'}
ğŸ–ï¸ ä¸Šæ¬¡å‡æ—¥è¨­å®šï¼š${lastSettings.holidays ? 'æ’é™¤' : 'åŒ…å«'}`;
                        } catch (error) {
                            settingsText += `\nâŒ æ­·å²è¨˜éŒ„è§£æéŒ¯èª¤`;
                        }
                    } else {
                        settingsText += `\nğŸ“ å°šç„¡å»ºç«‹è¨˜éŒ„`;
                    }
                    
                    settingsDiv.textContent = settingsText;
                }
            }, 100);
        }

        function openIOSCalendarApp() {
            console.log('ğŸ“± å˜—è©¦é–‹å•Ÿ iOS è¡Œäº‹æ›† App');
            
            try {
                // å˜—è©¦å¤šç¨® iOS è¡Œäº‹æ›† URL schemes
                var calendarSchemes = [
                    'calshow://',           // æ¨™æº–è¡Œäº‹æ›†
                    'x-apple-calevent://',  // è¡Œäº‹æ›†äº‹ä»¶
                    'webcal://',           // ç¶²é è¡Œäº‹æ›†
                    'calendar://'          // æ›¿ä»£æ–¹æ¡ˆ
                ];
                
                var schemeIndex = 0;
                
                function tryNextScheme() {
                    if (schemeIndex < calendarSchemes.length) {
                        var scheme = calendarSchemes[schemeIndex];
                        console.log(`å˜—è©¦ URL scheme: ${scheme}`);
                        
                        window.location.href = scheme;
                        schemeIndex++;
                        
                        // å¦‚æœ 1 ç§’å¾Œé‚„æ²’æˆåŠŸï¼Œå˜—è©¦ä¸‹ä¸€å€‹
                        setTimeout(tryNextScheme, 1000);
                    } else {
                        showMessage('âš ï¸ ç„¡æ³•è‡ªå‹•é–‹å•Ÿè¡Œäº‹æ›† App\nè«‹æ‰‹å‹•é–‹å•Ÿã€Œè¡Œäº‹æ›†ã€æ‡‰ç”¨ç¨‹å¼', 'warning');
                    }
                }
                
                tryNextScheme();
                showMessage('ğŸ“± æ­£åœ¨å˜—è©¦é–‹å•Ÿè¡Œäº‹æ›† App...', 'info');
                
            } catch (error) {
                console.error('é–‹å•Ÿè¡Œäº‹æ›† App å¤±æ•—:', error);
                showMessage('âŒ é–‹å•Ÿå¤±æ•—ï¼Œè«‹æ‰‹å‹•é–‹å•Ÿè¡Œäº‹æ›† App', 'error');
            }
        }

        function showCalendarDeletionGuide() {
            var guide = `ğŸ—‘ï¸ iOS è¡Œäº‹æ›†æ’ç¨‹åˆªé™¤æŒ‡å—ï¼š

ğŸ“± æ–¹æ³•ä¸€ï¼šåœ¨è¡Œäº‹æ›† App ä¸­åˆªé™¤
1. é–‹å•Ÿ iOSã€Œè¡Œäº‹æ›†ã€App
2. åˆ‡æ›åˆ°ã€Œåˆ—è¡¨ã€æª¢è¦–æˆ–ã€Œæœˆã€æª¢è¦–
3. æœå°‹ã€ŒMphasisã€æˆ–ã€Œæ‰“å¡ã€
4. æ‰¾åˆ°æ‰“å¡æé†’äº‹ä»¶
5. é»æ“Šäº‹ä»¶ â†’ é»æ“Šã€Œç·¨è¼¯ã€
6. æ‹‰åˆ°æœ€ä¸‹æ–¹ â†’ é»æ“Šã€Œåˆªé™¤äº‹ä»¶ã€
7. é¸æ“‡ã€Œåˆªé™¤æ‰€æœ‰é‡è¤‡äº‹ä»¶ã€
8. ç¢ºèªåˆªé™¤

ğŸ” æ–¹æ³•äºŒï¼šé€éæœå°‹å¿«é€Ÿæ‰¾åˆ°
1. é–‹å•Ÿè¡Œäº‹æ›† App
2. é»æ“Šå³ä¸Šè§’ã€Œæœå°‹ã€åœ–ç¤º ğŸ”
3. è¼¸å…¥ã€ŒMphasisã€æˆ–ã€Œæ‰“å¡ã€
4. é»æ“Šæ‰¾åˆ°çš„äº‹ä»¶
5. æŒ‰ç…§ä¸Šè¿°æ­¥é©Ÿåˆªé™¤

ğŸ“… æ–¹æ³•ä¸‰ï¼šæŒ‰æ—¥æœŸæŸ¥æ‰¾
1. åˆ‡æ›åˆ°ã€Œæ—¥ã€æˆ–ã€Œé€±ã€æª¢è¦–
2. æ»‘å‹•åˆ°æœ‰è¨­å®šæé†’çš„æ—¥æœŸ
3. æ‰¾åˆ°æ‰“å¡æé†’äº‹ä»¶ï¼ˆé€šå¸¸åœ¨è¨­å®šçš„æ™‚é–“ï¼‰
4. é»æ“Šäº‹ä»¶é€²è¡Œåˆªé™¤

âš ï¸ æ³¨æ„äº‹é …ï¼š
â€¢ åˆªé™¤æ™‚é¸æ“‡ã€Œæ‰€æœ‰é‡è¤‡äº‹ä»¶ã€æ‰èƒ½å®Œå…¨æ¸…é™¤
â€¢ å¦‚æœæœ‰å¤šå€‹è¨­å®šï¼Œéœ€è¦é€ä¸€åˆªé™¤
â€¢ åˆªé™¤å¾Œå¯èƒ½éœ€è¦ç­‰å¾…å¹¾åˆ†é˜æ‰å®Œå…¨æ¶ˆå¤±
â€¢ å»ºè­°åˆªé™¤å‰å…ˆç¢ºèªæ˜¯æ­£ç¢ºçš„äº‹ä»¶

ğŸ’¡ å°æŠ€å·§ï¼š
â€¢ å¯ä»¥åœ¨äº‹ä»¶è©³æƒ…ä¸­çœ‹åˆ°ã€ŒMphasis è‡ªå‹•æ‰“å¡æé†’ã€æ¨™é¡Œ
â€¢ äº‹ä»¶æè¿°æœƒåŒ…å«ã€Œæ™ºæ…§æ‰“å¡ç³»çµ±ã€å­—æ¨£
â€¢ é‡è¤‡è¦å‰‡æœƒé¡¯ç¤ºç‚ºã€Œæ¯é€±ã€`;

            alert(guide);
        }

        function showCalendarSearchGuide() {
            var guide = `ğŸ” iOS è¡Œäº‹æ›†æ’ç¨‹æŸ¥æ‰¾æŒ‡å—ï¼š

ğŸ“ å¦‚ä½•ç¢ºèªæ’ç¨‹æ˜¯å¦å­˜åœ¨ï¼š

1ï¸âƒ£ æ¨™é¡Œæœå°‹æ³•ï¼š
â€¢ é–‹å•Ÿè¡Œäº‹æ›† App â†’ é»æ“Šæœå°‹ ğŸ”
â€¢ è¼¸å…¥ã€ŒMphasisã€
â€¢ æŸ¥çœ‹æœå°‹çµæœ

2ï¸âƒ£ é—œéµå­—æœå°‹æ³•ï¼š
â€¢ æœå°‹ã€Œæ‰“å¡ã€
â€¢ æœå°‹ã€Œæé†’ã€
â€¢ æœå°‹ã€Œæ™ºæ…§ã€

3ï¸âƒ£ æ™‚é–“æª¢è¦–æ³•ï¼š
â€¢ åˆ‡æ›åˆ°ã€Œæ—¥ã€æª¢è¦–
â€¢ æ»‘å‹•åˆ°å·¥ä½œæ—¥
â€¢ æŸ¥çœ‹è¨­å®šçš„æé†’æ™‚é–“é»

4ï¸âƒ£ åˆ—è¡¨æª¢è¦–æ³•ï¼š
â€¢ åˆ‡æ›åˆ°ã€Œåˆ—è¡¨ã€æª¢è¦–
â€¢ æŒ‰æ—¥æœŸç€è¦½
â€¢ å°‹æ‰¾é‡è¤‡çš„æ‰“å¡äº‹ä»¶

ğŸ“‹ æ’ç¨‹ç‰¹å¾µï¼š
âœ… æ¨™é¡Œï¼šğŸ¯ Mphasis è‡ªå‹•æ‰“å¡æé†’
âœ… é‡è¤‡ï¼šæ¯é€± (å·¥ä½œæ—¥)
âœ… æé†’ï¼šç«‹å³æé†’ + 5åˆ†é˜å‰æé†’
âœ… æè¿°ï¼šåŒ…å«ã€Œæ™ºæ…§æ‰“å¡ç³»çµ±ã€

ğŸ—“ï¸ ç¢ºèªæ–¹æ³•ï¼š
â€¢ é»æ“Šäº‹ä»¶æŸ¥çœ‹è©³æƒ…
â€¢ æª¢æŸ¥é‡è¤‡è¦å‰‡
â€¢ ç¢ºèªæé†’è¨­å®š
â€¢ æŸ¥çœ‹äº‹ä»¶æè¿°

âŒ å¦‚æœæ‰¾ä¸åˆ°æ’ç¨‹ï¼š
â€¢ å¯èƒ½æœªæˆåŠŸå»ºç«‹
â€¢ å¯èƒ½å·²è¢«åˆªé™¤
â€¢ å¯èƒ½åœ¨å…¶ä»–è¡Œäº‹æ›†ä¸­
â€¢ é‡æ–°åŸ·è¡Œã€ŒiOS è¡Œäº‹æ›†ã€è¨­å®š`;

            alert(guide);
        }

        function clearCalendarHistory() {
            if (confirm('ğŸ§¹ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ­·å²è¨˜éŒ„å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤ï¼š\nâ€¢ è¡Œäº‹æ›†å»ºç«‹è¨˜éŒ„\nâ€¢ è¨­å®šæ­·å²\nâ€¢ æš«å­˜è³‡æ–™\n\nâš ï¸ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                try {
                    // æ¸…é™¤ç›¸é—œçš„ localStorage é …ç›®
                    localStorage.removeItem('lastCalendarSetup');
                    localStorage.removeItem('ios_ultimate_settings');
                    
                    // æ¸…é™¤æš«å­˜å…§å®¹
                    if (window.tempCalendarContent) {
                        delete window.tempCalendarContent;
                    }
                    if (window.tempCalendarInfo) {
                        delete window.tempCalendarInfo;
                    }
                    
                    console.log('ğŸ§¹ æ­·å²è¨˜éŒ„å·²æ¸…é™¤');
                    showMessage('âœ… æ­·å²è¨˜éŒ„å·²æ¸…é™¤ï¼\nä¸‹æ¬¡è¨­å®šå°‡é‡æ–°é–‹å§‹è¨˜éŒ„ã€‚', 'success');
                    
                    // é‡æ–°è¼‰å…¥è¨­å®šé¡¯ç¤º
                    loadCurrentCalendarSettings();
                    
                } catch (error) {
                    console.error('æ¸…é™¤æ­·å²è¨˜éŒ„å¤±æ•—:', error);
                    showMessage('âŒ æ¸…é™¤å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
                }
            }
        }

        function closeCalendarManagement() {
            var modal = document.getElementById('calendarManagementModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function showCalendarContentPrompt(icalContent) {
            var shortContent = icalContent.substring(0, 500) + '...';
            alert('ğŸ“‹ ç”±æ–¼ç€è¦½å™¨é™åˆ¶ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š\n\n' + shortContent + '\n\nå®Œæ•´å…§å®¹è«‹æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å° (F12)');
            console.log('=== å®Œæ•´ iCal å…§å®¹ ===');
            console.log(icalContent);
            console.log('=== è¤‡è£½ä¸Šæ–¹å…§å®¹åˆ°è¡Œäº‹æ›† ===');
        }

        // é¡¯ç¤ºæ—¥æ›†ä¸‹è¼‰é¸é …
        function showCalendarDownloadOptions(icalContent, selectedDaysText) {
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF6B35; margin-bottom: 16px; text-align: center;">ğŸ“… è¡Œäº‹æ›†è¨­å®šé¸é …</h3>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <p style="margin: 0; color: #666; font-size: 14px; line-height: 1.5;">
                            <strong>å¦‚æœè‡ªå‹•ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</strong>
                        </p>
                    </div>
                    
                    <button onclick="manualDownloadCalendar()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        ğŸ“¥ æ‰‹å‹•ä¸‹è¼‰è¡Œäº‹æ›†æª”æ¡ˆ
                    </button>
                    
                    <button onclick="showCalendarInstructions()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        ğŸ“± æŸ¥çœ‹ iOS è¨­å®šèªªæ˜
                    </button>
                    
                    <button onclick="copyCalendarContent()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #FF9800; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        ğŸ“‹ è¤‡è£½è¡Œäº‹æ›†å…§å®¹
                    </button>
                    
                    <button onclick="closeCalendarOptions()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        é—œé–‰
                    </button>
                </div>
            `;
            
            // å‰µå»ºæ¨¡æ…‹æ¡†
            var modal = document.createElement('div');
            modal.id = 'calendarOptionsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // å„²å­˜å…§å®¹ä¾›å¾ŒçºŒä½¿ç”¨
            window.tempCalendarContent = icalContent;
            window.tempCalendarInfo = selectedDaysText;
        }

        function manualDownloadCalendar() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            // å¼·åˆ¶ä½¿ç”¨ data URL æ–¹å¼
            var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
            var link = document.createElement('a');
            link.href = dataUrl;
            link.download = 'mphasis-checkin-calendar.ics';
            link.target = '_blank';
            link.click();
            
            showMessage('ğŸ“¥ è¡Œäº‹æ›†æª”æ¡ˆå·²æº–å‚™ä¸‹è¼‰ï¼å¦‚æœæ²’æœ‰è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹é•·æŒ‰é€£çµé¸æ“‡ã€Œä¸‹è¼‰ã€', 'info');
        }

        function showCalendarInstructions() {
            var instructions = `ğŸ“± iOS è¡Œäº‹æ›†è¨­å®šå®Œæ•´èªªæ˜ï¼š

1ï¸âƒ£ ä¸‹è¼‰æª”æ¡ˆå¾Œï¼š
   â€¢ åœ¨ã€Œæª”æ¡ˆã€app ä¸­æ‰¾åˆ°ä¸‹è¼‰çš„ .ics æª”æ¡ˆ
   â€¢ é»æ“Šæª”æ¡ˆé–‹å•Ÿ
   â€¢ é¸æ“‡ã€ŒåŠ å…¥è¡Œäº‹æ›†ã€

2ï¸âƒ£ è¨­å®šæé†’ï¼š
   â€¢ ç¢ºèªåŒ¯å…¥åˆ°é è¨­è¡Œäº‹æ›†
   â€¢ æª¢æŸ¥æé†’æ™‚é–“æ˜¯å¦æ­£ç¢º
   â€¢ ç¢ºèªé‡è¤‡è¨­å®šç‚ºæ¯é€±

3ï¸âƒ£ æ¸¬è©¦åŠŸèƒ½ï¼š
   â€¢ ç­‰å¾…æé†’æ™‚é–“åˆ°é”
   â€¢ é»æ“Šè¡Œäº‹æ›†é€šçŸ¥
   â€¢ ç¢ºèªæœƒè‡ªå‹•é–‹å•Ÿæ‰“å¡æ‡‰ç”¨

4ï¸âƒ£ æ•…éšœæ’é™¤ï¼š
   â€¢ å¦‚æœæ²’æœ‰æ”¶åˆ°æé†’ï¼Œæª¢æŸ¥è¡Œäº‹æ›†æ¬Šé™
   â€¢ ç¢ºèªé€šçŸ¥è¨­å®šå·²å•Ÿç”¨
   â€¢ é‡æ–°åŒ¯å…¥è¡Œäº‹æ›†æª”æ¡ˆ`;
   
            alert(instructions);
        }

        function copyCalendarContent() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            // å˜—è©¦è¤‡è£½åˆ°å‰ªè²¼ç°¿
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(icalContent).then(() => {
                    showMessage('ğŸ“‹ è¡Œäº‹æ›†å…§å®¹å·²è¤‡è£½ï¼æ‚¨å¯ä»¥è²¼åˆ°ä»»ä½•æ–‡å­—ç·¨è¼¯å™¨ä¸­ï¼Œå„²å­˜ç‚º .ics æª”æ¡ˆ', 'success');
                }).catch(() => {
                    // é™ç´šæ–¹æ¡ˆ
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
            
            function fallbackCopy() {
                // å‰µå»ºéš±è—çš„æ–‡å­—å€åŸŸ
                var textArea = document.createElement('textarea');
                textArea.value = icalContent;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showMessage('ğŸ“‹ è¡Œäº‹æ›†å…§å®¹å·²è¤‡è£½ï¼', 'success');
                } catch (err) {
                    showMessage('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹å…§å®¹', 'error');
                    prompt('è«‹è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼Œå„²å­˜ç‚º .ics æª”æ¡ˆï¼š', icalContent);
                }
                
                document.body.removeChild(textArea);
            }
        }

        function closeCalendarOptions() {
            var modal = document.getElementById('calendarOptionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // æ¸…ç†æš«å­˜å…§å®¹
            delete window.tempCalendarContent;
            delete window.tempCalendarInfo;
        }

        // ä¸å†éœ€è¦è¤‡é›œçš„æ—¥æœŸæ ¼å¼åŒ–ï¼Œå› ç‚ºä½¿ç”¨å›ºå®šæ—¥æœŸ 20250101
        // ä¿ç•™å‡½æ•¸ä»¥é˜²ç›¸å®¹æ€§å•é¡Œï¼Œä½†ä¸å¯¦éš›ä½¿ç”¨
        
        // ç°¡åŒ–çš„å·¥ä½œæ—¥è¨ˆç®— (æ›´ç©©å®š)
        function getNextWorkdaySimplified() {
            try {
                console.log('ğŸ”§ getNextWorkdaySimplified é–‹å§‹åŸ·è¡Œ');
                
                var today = new Date();
                var currentDay = today.getDay();
                var currentHour = today.getHours();
                var currentMinute = today.getMinutes();
                
                console.log(`ğŸ“… ä»Šå¤©: ${today.toLocaleDateString('zh-TW')} (é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][currentDay]})`);
                console.log(`â° ç›®å‰æ™‚é–“: ${currentHour}:${currentMinute.toString().padStart(2, '0')}`);
                console.log(`ğŸ“‹ å·¥ä½œæ—¥è¨­å®š: ${settings.weeklyDays.map(d => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d]).join('ã€')}`);
                
                // ç°¡åŒ–é‚è¼¯ï¼šå¦‚æœä»Šå¤©æ˜¯å·¥ä½œæ—¥ä¸”æ™‚é–“é‚„æ—©ï¼Œç”¨ä»Šå¤©ï¼›å¦å‰‡ç”¨ä¸‹å€‹å·¥ä½œæ—¥
                var timeParts = settings.checkinTime.split(':');
                var checkinHour = parseInt(timeParts[0]);
                var checkinMinute = parseInt(timeParts[1]);
                
                var todayCheckinTime = new Date(today);
                todayCheckinTime.setHours(checkinHour, checkinMinute, 0, 0);
                
                // å¦‚æœä»Šå¤©æ˜¯å·¥ä½œæ—¥ä¸”é‚„æ²’åˆ°æ‰“å¡æ™‚é–“
                if (settings.weeklyDays.includes(currentDay) && today < todayCheckinTime) {
                    console.log('âœ… ä½¿ç”¨ä»Šå¤© (å·¥ä½œæ—¥ä¸”æœªåˆ°æ‰“å¡æ™‚é–“)');
                    return today;
                }
                
                // æ‰¾ä¸‹ä¸€å€‹å·¥ä½œæ—¥ (æœ€å¤šæ‰¾ 7 å¤©)
                for (var i = 1; i <= 7; i++) {
                    var nextDate = new Date(today);
                    nextDate.setDate(today.getDate() + i);
                    var dayOfWeek = nextDate.getDay();
                    
                    if (settings.weeklyDays.includes(dayOfWeek)) {
                        console.log(`âœ… æ‰¾åˆ°ä¸‹å€‹å·¥ä½œæ—¥: ${nextDate.toLocaleDateString('zh-TW')} (é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dayOfWeek]})`);
                        return nextDate;
                    }
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°å·¥ä½œæ—¥ï¼Œä½¿ç”¨æ˜å¤©ä½œç‚ºå‚™ç”¨
                var tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                console.log('âš ï¸ æœªæ‰¾åˆ°å·¥ä½œæ—¥ï¼Œä½¿ç”¨æ˜å¤©ä½œç‚ºå‚™ç”¨');
                return tomorrow;
                
            } catch (error) {
                console.error('getNextWorkdaySimplified éŒ¯èª¤:', error);
                // æœ€çµ‚å‚™ç”¨æ–¹æ¡ˆï¼šæ˜å¤©
                var fallback = new Date();
                fallback.setDate(fallback.getDate() + 1);
                console.log('ğŸ”„ ä½¿ç”¨æœ€çµ‚å‚™ç”¨æ–¹æ¡ˆ: æ˜å¤©');
                return fallback;
            }
        }
        
        // ç²å–ä¸‹ä¸€å€‹å·¥ä½œæ—¥ (ä¿ç•™åŸå‡½æ•¸ä»¥é˜²ç›¸å®¹æ€§å•é¡Œ)
        function getNextWorkday() {
            var today = new Date();
            var currentDay = today.getDay(); // 0=Sunday, 1=Monday, etc.
            var currentHour = today.getHours();
            var currentMinute = today.getMinutes();
            
            // æª¢æŸ¥ä»Šå¤©æ˜¯å¦åœ¨å·¥ä½œæ—¥å…§ä¸”é‚„æ²’åˆ°æ‰“å¡æ™‚é–“
            var timeParts = settings.checkinTime.split(':');
            var checkinHour = parseInt(timeParts[0]);
            var checkinMinute = parseInt(timeParts[1]);
            
            var todayCheckinTime = new Date(today);
            todayCheckinTime.setHours(checkinHour, checkinMinute, 0, 0);
            
            // å¦‚æœä»Šå¤©æ˜¯å·¥ä½œæ—¥ä¸”é‚„æ²’åˆ°æ‰“å¡æ™‚é–“ï¼Œä½¿ç”¨ä»Šå¤©
            if (settings.weeklyDays.includes(currentDay) && today < todayCheckinTime) {
                return today;
            }
            
            // å¦å‰‡æ‰¾ä¸‹ä¸€å€‹å·¥ä½œæ—¥
            var nextDate = new Date(today);
            nextDate.setDate(today.getDate() + 1);
            
            // æœ€å¤šæ‰¾ 7 å¤©ï¼Œç¢ºä¿èƒ½æ‰¾åˆ°ä¸‹ä¸€å€‹å·¥ä½œæ—¥
            for (var i = 0; i < 7; i++) {
                var dayOfWeek = nextDate.getDay();
                if (settings.weeklyDays.includes(dayOfWeek)) {
                    return nextDate;
                }
                nextDate.setDate(nextDate.getDate() + 1);
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°å·¥ä½œæ—¥ï¼Œè¿”å›æ˜å¤©
            var tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            return tomorrow;
        }

        // è¨­å®š iOS é¬§é˜
        function setupIOSAlarms() {
            var timeParts = settings.checkinTime.split(':');
            var reminderHour = parseInt(timeParts[0]);
            var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
            
            if (reminderMinute < 0) {
                reminderMinute += 60;
                reminderHour -= 1;
            }
            
            var reminderTime = reminderHour.toString().padStart(2, '0') + ':' + 
                             reminderMinute.toString().padStart(2, '0');
            
            var instructions = `ğŸ“± è¨­å®š iOS ç³»çµ±é¬§é˜ï¼š

ğŸ• æé†’æ™‚é–“ï¼š${reminderTime}
ğŸ·ï¸ æ¨™ç±¤ï¼šMphasisæ‰“å¡
ğŸ”„ é‡è¤‡ï¼šé€±ä¸€åˆ°é€±äº”

è¨­å®šæ­¥é©Ÿï¼š
1. é–‹å•Ÿã€Œæ™‚é˜ã€æ‡‰ç”¨
2. é»æ“Šã€Œé¬§é˜ã€æ¨™ç±¤
3. é»æ“Šå³ä¸Šè§’ã€Œ+ã€
4. è¨­å®šæ™‚é–“ï¼š${reminderTime}
5. é»æ“Šã€Œé‡è¤‡ã€é¸æ“‡é€±ä¸€åˆ°é€±äº”
6. åœ¨ã€Œæ¨™ç±¤ã€ä¸­è¼¸å…¥ï¼šMphasisæ‰“å¡
7. é»æ“Šã€Œå„²å­˜ã€

ğŸ¯ é¬§é˜éŸ¿èµ·æ™‚å°±æ˜¯æ‰“å¡æ™‚é–“ï¼`;
            
            alert(instructions);
            
            // å˜—è©¦é–‹å•Ÿæ™‚é˜æ‡‰ç”¨
            try {
                window.location.href = 'clock-alarm://';
            } catch (error) {
                console.log('ç„¡æ³•è‡ªå‹•é–‹å•Ÿæ™‚é˜æ‡‰ç”¨');
            }
        }

        // è¨­å®š Siri æ·å¾‘
        function setupSiriShortcuts() {
            var shortcutName = 'Mphasisæ™ºæ…§æ‰“å¡';
            
            // ç”Ÿæˆ Siri å–šé†’ URL
            var siriWakeupUrl = window.location.href.split('?')[0] + '?wakeup=siri&time=' + 
                               settings.checkinTime.replace(':', '');
            
            var instructions = `ğŸ—£ï¸ å»ºç«‹ Siri æ™ºæ…§æ‰“å¡æ·å¾‘ï¼š

ğŸ“± ç¬¬ä¸€æ­¥ - å»ºç«‹æ·å¾‘ï¼š
1. é–‹å•Ÿã€Œæ·å¾‘ã€æ‡‰ç”¨
2. é»æ“Šå³ä¸Šè§’ã€Œ+ã€æ–°å¢æ·å¾‘
3. æœå°‹ã€Œé–‹å•Ÿ URLã€å‹•ä½œ
4. è¼¸å…¥å–šé†’ç¶²å€ï¼š
   ${siriWakeupUrl}
5. è¨­å®šæ·å¾‘åç¨±ï¼šã€Œ${shortcutName}ã€
6. é»æ“Šã€Œå®Œæˆã€

ğŸ™ï¸ ç¬¬äºŒæ­¥ - èªéŸ³è§¸ç™¼ï¼š
1. åœ¨æ·å¾‘ä¸­æ‰¾åˆ°ã€Œ${shortcutName}ã€
2. é»æ“Šã€Œ...ã€è¨­å®š
3. é»æ“Šã€ŒåŠ åˆ° Siriã€
4. éŒ„è£½è§¸ç™¼è©ï¼šã€Œå˜¿ Siriï¼Œæ‰“å¡æ™‚é–“ã€
5. é»æ“Šã€Œå®Œæˆã€

â° ç¬¬ä¸‰æ­¥ - è‡ªå‹•åŒ–ï¼š
1. åˆ‡æ›åˆ°ã€Œè‡ªå‹•åŒ–ã€é é¢
2. é»æ“Šå³ä¸Šè§’ã€Œ+ã€
3. é¸æ“‡ã€Œå»ºç«‹å€‹äººè‡ªå‹•åŒ–ã€
4. é¸æ“‡ã€Œæ™‚é–“ã€
5. è¨­å®šæ™‚é–“ï¼š${settings.checkinTime}
6. è¨­å®šé‡è¤‡ï¼šé¸æ“‡è¦æ‰“å¡çš„æ—¥æœŸ
7. é»æ“Šã€Œä¸‹ä¸€æ­¥ã€
8. æœå°‹ã€ŒåŸ·è¡Œæ·å¾‘ã€
9. é¸æ“‡ã€Œ${shortcutName}ã€
10. é—œé–‰ã€ŒåŸ·è¡Œå‰è©¢å•ã€
11. é»æ“Šã€Œå®Œæˆã€

ğŸ¯ æ™ºæ…§åŠŸèƒ½ï¼š
âœ… è‡ªå‹•æª¢æ¸¬æ‰“å¡æ™‚é–“
âœ… æ™ºæ…§é–‹å•Ÿæ‰“å¡é é¢
âœ… æ”¯æ´èªéŸ³æ§åˆ¶
âœ… è‡ªå‹•åŒ–åŸ·è¡Œ

ğŸ”— å–šé†’ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼`;
            
            // è¤‡è£½å–šé†’ URL åˆ°å‰ªè²¼ç°¿
            try {
                navigator.clipboard.writeText(siriWakeupUrl);
            } catch (error) {
                console.log('ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼ç°¿:', error);
            }
            
            showMessage(instructions, 'info');
            
            // å˜—è©¦é–‹å•Ÿæ·å¾‘æ‡‰ç”¨
            setTimeout(() => {
                try {
                    window.location.href = 'shortcuts://';
                } catch (error) {
                    console.log('ç„¡æ³•é–‹å•Ÿæ·å¾‘æ‡‰ç”¨:', error);
                }
            }, 2000);
        }

        // è¨­å®š iOS æé†’äº‹é …
        function setupReminders() {
            var instructions = `ğŸ“ å»ºç«‹ iOS æé†’äº‹é …ï¼š

æé†’å…§å®¹ï¼šã€ŒMphasis æ‰“å¡æ™‚é–“ã€
æé†’æ™‚é–“ï¼šæ¯å¤© ${settings.checkinTime}

è¨­å®šæ­¥é©Ÿï¼š
1. é–‹å•Ÿã€Œæé†’äº‹é …ã€æ‡‰ç”¨
2. é»æ“Šå³ä¸‹è§’ã€Œ+ã€
3. è¼¸å…¥ï¼šMphasis æ‰“å¡æ™‚é–“
4. é»æ“Šã€Œiã€åœ–ç¤º
5. é–‹å•Ÿã€Œåœ¨æŸæ—¥æé†’æˆ‘ã€
6. è¨­å®šæ™‚é–“ï¼š${settings.checkinTime}
7. é–‹å•Ÿã€Œé‡è¤‡ã€é¸æ“‡ã€Œæ¯å¤©ã€
8. é»æ“Šã€Œå®Œæˆã€

ğŸ¯ ç³»çµ±æœƒåœ¨è¨­å®šæ™‚é–“è‡ªå‹•æé†’æ‚¨æ‰“å¡ï¼`;
            
            alert(instructions);
            
            // å˜—è©¦é–‹å•Ÿæé†’äº‹é …æ‡‰ç”¨
            try {
                window.location.href = 'x-apple-reminderkit://';
            } catch (error) {
                console.log('ç„¡æ³•è‡ªå‹•é–‹å•Ÿæé†’äº‹é …æ‡‰ç”¨');
            }
        }

        // å•Ÿå‹•å‰æ™¯ä¿æŒæ¨¡å¼
        function startForegroundMode() {
            showMessage('ğŸ”„ å•Ÿå‹•å‰æ™¯ä¿æŒæ¨¡å¼...', 'info');
            
            // é‡ç½®è¨ˆæ™‚å™¨
            activeStartTime = Date.now();
            
            // å•Ÿå‹•å‰æ™¯æé†’æª¢æŸ¥
            startForegroundReminderCheck();
            
            // å˜—è©¦ä¿æŒå±å¹•å–šé†’
            try {
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen').then(function(wakeLock) {
                        console.log('ğŸ”† å±å¹•ä¿æŒå–šé†’');
                    }).catch(function(error) {
                        console.log('ç„¡æ³•ä¿æŒå±å¹•å–šé†’:', error);
                    });
                }
            } catch (error) {
                console.log('ä¸æ”¯æ´å±å¹•å–šé†’ API');
            }
            
            showMessage('âœ… å‰æ™¯ä¿æŒæ¨¡å¼å·²å•Ÿå‹•ï¼è«‹ä¿æŒæ‡‰ç”¨åœ¨å‰æ™¯ã€‚', 'success');
        }

        // å•Ÿå‹•å‰æ™¯æé†’æª¢æŸ¥
        function startForegroundReminderCheck() {
            if (reminderInterval) {
                clearInterval(reminderInterval);
            }
            
            reminderInterval = setInterval(function() {
                if (!document.hidden) {
                    checkForReminder();
                }
            }, 30000); // æ¯30ç§’æª¢æŸ¥ä¸€æ¬¡
        }

        // æ’ç¨‹ä¸‹æ¬¡æª¢æŸ¥ï¼ˆéæ´»èºç‹€æ…‹ç”¨ï¼‰
        function scheduleNextCheck() {
            setTimeout(function() {
                if (document.hidden) {
                    checkForReminder();
                    scheduleNextCheck(); // éæ­¸æ’ç¨‹
                }
            }, 60000); // 1åˆ†é˜å¾Œæª¢æŸ¥
        }

        // æ¸¬è©¦å‰æ™¯æé†’
        function testForegroundReminder() {
            if (document.hidden) {
                showMessage('âš ï¸ è«‹ä¿æŒæ‡‰ç”¨åœ¨å‰æ™¯ä»¥æ¸¬è©¦æé†’', 'warning');
                return;
            }
            
            showMessage('ğŸ§ª æ¸¬è©¦æé†’ä¸­...', 'info');
            setTimeout(function() {
                triggerCheckinReminder();
            }, 2000);
        }

        // æ¨¡æ“¬æ‰“å¡æé†’
        function showCheckinReminder() {
            triggerCheckinReminder();
        }

        // é–‹å•Ÿæ‰“å¡é é¢
        function openCheckinPage() {
            var popup = window.open(settings.checkinUrl, 'checkin', 'width=414,height=736');
            
            if (popup) {
                showMessage('âœ… æ‰“å¡é é¢å·²é–‹å•Ÿï¼', 'success');
            } else {
                showMessage('âŒ ç„¡æ³•é–‹å•Ÿé é¢ï¼Œè«‹æª¢æŸ¥å½ˆçª—è¨­å®š', 'error');
            }
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            try {
                localStorage.setItem('ios_ultimate_settings', JSON.stringify(settings));
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            try {
                var saved = localStorage.getItem('ios_ultimate_settings');
                if (saved) {
                    var savedSettings = JSON.parse(saved);
                    settings = Object.assign(settings, savedSettings);
                    
                    // æ›´æ–° UI
                    document.getElementById('quickCheckinTime').value = settings.checkinTime;
                    document.getElementById('quickReminderTime').value = settings.reminderMinutes;
                    document.getElementById('quickExcludeHolidays').checked = settings.excludeHolidays !== false;
                    
                    // æ›´æ–°å¿«é€Ÿé€±é–“é¸æ“‡
                    if (settings.weeklyDays) {
                        quickWeeklyDays = settings.weeklyDays.slice();
                    }
                    
                    // æ›´æ–° Teams è¨­å®š UI (å»¶é²è¼‰å…¥ç¢ºä¿ DOM å·²å°±ç·’)
                    setTimeout(() => {
                        if (document.getElementById('teamsEnabled')) {
                            document.getElementById('teamsEnabled').checked = settings.teamsEnabled || false;
                            if (document.getElementById('teamsWebhook')) {
                                document.getElementById('teamsWebhook').value = settings.teamsWebhook || '';
                            }
                            if (document.getElementById('teamsBackupWebhook')) {
                                document.getElementById('teamsBackupWebhook').value = settings.teamsBackupWebhook || '';
                            }
                            updateTeamsSettings();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
            }
        }

        // Teams è¨­å®šç›¸é—œå‡½æ•¸
        function toggleTeamsSettings() {
            var teamsSettings = document.getElementById('teamsSettings');
            if (teamsSettings.style.display === 'none' || teamsSettings.style.display === '') {
                teamsSettings.style.display = 'block';
                
                // å»¶é²è¼‰å…¥è¨­å®šï¼Œç¢ºä¿å…ƒç´ å·²é¡¯ç¤º
                setTimeout(() => {
                    loadSettings(); // ç¢ºä¿è¼‰å…¥æœ€æ–°è¨­å®š
                    
                    // å¼·åˆ¶æ›´æ–° UI å…ƒç´ 
                    if (document.getElementById('teamsWebhook')) {
                        var webhookValue = settings.teamsWebhook || '';
                        document.getElementById('teamsWebhook').value = webhookValue;
                        console.log('ğŸ”§ è¼‰å…¥ Webhook URL:', webhookValue);
                    }
                    
                    if (document.getElementById('teamsBackupWebhook')) {
                        var backupValue = settings.teamsBackupWebhook || '';
                        document.getElementById('teamsBackupWebhook').value = backupValue;
                        console.log('ğŸ”§ è¼‰å…¥å‚™ç”¨ Webhook URL:', backupValue);
                    }
                    
                    updateTeamsSettings();
                }, 200);
                
            } else {
                teamsSettings.style.display = 'none';
            }
        }

        function updateTeamsSettings() {
            var enabled = document.getElementById('teamsEnabled').checked;
            var webhookSettings = document.getElementById('teamsWebhookSettings');
            
            if (enabled) {
                webhookSettings.style.display = 'block';
                
                // å»¶é²èšç„¦åˆ°ç¬¬ä¸€å€‹è¼¸å…¥æ¬„ä½
                setTimeout(() => {
                    var webhookInput = document.getElementById('teamsWebhook');
                    if (webhookInput) {
                        webhookInput.focus();
                        console.log('ğŸ”§ Teams Webhook è¼¸å…¥æ¬„ä½å·²ç²å¾—ç„¦é»');
                    }
                }, 100);
            } else {
                webhookSettings.style.display = 'none';
            }
        }

        function onTeamsWebhookInput(event) {
            try {
                var webhookInput = document.getElementById('teamsWebhook');
                var backupInput = document.getElementById('teamsBackupWebhook');
                
                // é˜²æ­¢äº‹ä»¶å†’æ³¡
                if (event) {
                    event.stopPropagation();
                }
                
                // æ¸›å°‘ console.log é »ç‡ï¼Œåªåœ¨ç‰¹å®šæƒ…æ³ä¸‹è¨˜éŒ„
                if (webhookInput.value.length % 10 === 0 || webhookInput.value.length < 5) {
                    console.log('ğŸ“¤ Webhook è¼¸å…¥ç‹€æ…‹:', {
                        main: `${webhookInput.value.length} å­—å…ƒ`,
                        backup: `${backupInput.value.length} å­—å…ƒ`
                    });
                }
                
                // ç°¡åŒ–é©—è­‰ï¼Œé¿å…é »ç¹åŸ·è¡Œ
                if (webhookInput.value.length > 8 && !webhookInput.value.startsWith('https://')) {
                    console.log('âš ï¸ URL æ ¼å¼æç¤º: éœ€è¦ https:// é–‹é ­');
                }
            } catch (error) {
                console.error('è¼¸å…¥è™•ç†éŒ¯èª¤:', error);
            }
        }

        function saveTeamsSettings() {
            var enabled = document.getElementById('teamsEnabled').checked;
            var webhook = document.getElementById('teamsWebhook').value.trim();
            var backupWebhook = document.getElementById('teamsBackupWebhook').value.trim();
            
            if (enabled && !webhook) {
                showMessage('âŒ è«‹è¼¸å…¥ä¸»è¦ Webhook URL', 'error');
                return;
            }
            
            // ç°¡å–®çš„ URL é©—è­‰
            if (enabled && webhook && !webhook.startsWith('https://')) {
                showMessage('âŒ Webhook URL å¿…é ˆä»¥ https:// é–‹é ­', 'error');
                return;
            }
            
            // æ›´æ–°è¨­å®š
            settings.teamsEnabled = enabled;
            settings.teamsWebhook = webhook;
            settings.teamsBackupWebhook = backupWebhook;
            
            // å„²å­˜è¨­å®š
            saveSettings();
            
            showMessage('âœ… Teams è¨­å®šå·²å„²å­˜', 'success');
        }

        function testTeamsNotification() {
            try {
                console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦ Teams é€šçŸ¥...');
                showMessage('ğŸ§ª æ­£åœ¨æ¸¬è©¦ Teams é€šçŸ¥...', 'info');
                
                // æª¢æŸ¥ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨
                var enabledElement = document.getElementById('teamsEnabled');
                var webhookElement = document.getElementById('teamsWebhook');
                var backupWebhookElement = document.getElementById('teamsBackupWebhook');
                
                if (!enabledElement) {
                    showMessage('âŒ æ‰¾ä¸åˆ°å•Ÿç”¨é–‹é—œå…ƒç´ ', 'error');
                    console.error('teamsEnabled å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                if (!webhookElement) {
                    showMessage('âŒ æ‰¾ä¸åˆ° Webhook è¼¸å…¥æ¡†', 'error');
                    console.error('teamsWebhook å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                var enabled = enabledElement.checked;
                var webhook = webhookElement.value.trim();
                
                console.log('Teams å•Ÿç”¨ç‹€æ…‹:', enabled);
                console.log('Webhook URL:', webhook ? 'å·²è¼¸å…¥' : 'æœªè¼¸å…¥');
                
                if (!enabled) {
                    showMessage('âŒ è«‹å…ˆå•Ÿç”¨ Teams é€šçŸ¥', 'error');
                    return;
                }
                
                if (!webhook) {
                    showMessage('âŒ è«‹è¼¸å…¥ Webhook URL', 'error');
                    return;
                }
                
                // ç°¡å–®çš„ URL é©—è­‰
                if (!webhook.startsWith('https://')) {
                    showMessage('âŒ Webhook URL å¿…é ˆä»¥ https:// é–‹é ­', 'error');
                    return;
                }
                
                // æš«æ™‚æ›´æ–°è¨­å®šä»¥é€²è¡Œæ¸¬è©¦
                var originalSettings = {
                    teamsEnabled: settings.teamsEnabled || false,
                    teamsWebhook: settings.teamsWebhook || '',
                    teamsBackupWebhook: settings.teamsBackupWebhook || ''
                };
                
                settings.teamsEnabled = enabled;
                settings.teamsWebhook = webhook;
                settings.teamsBackupWebhook = backupWebhookElement ? backupWebhookElement.value.trim() : '';
                
                console.log('æº–å‚™ç™¼é€æ¸¬è©¦é€šçŸ¥...');
                
                // ç™¼é€æ¸¬è©¦é€šçŸ¥
                sendTeamsNotification(
                    'ğŸ§ª Teams é€šçŸ¥æ¸¬è©¦',
                    `é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥\næ™‚é–“ï¼š${new Date().toLocaleString()}\nå¦‚æœæ‚¨æ”¶åˆ°æ­¤è¨Šæ¯ï¼Œè¡¨ç¤º Teams é€šçŸ¥è¨­å®šæˆåŠŸï¼`,
                    'æé†’'
                ).then(() => {
                    console.log('æ¸¬è©¦é€šçŸ¥ç™¼é€å®Œæˆ');
                }).catch((error) => {
                    console.error('æ¸¬è©¦é€šçŸ¥ç™¼é€å¤±æ•—:', error);
                    showMessage('âŒ æ¸¬è©¦é€šçŸ¥ç™¼é€å¤±æ•—: ' + error.message, 'error');
                }).finally(() => {
                    // æ¢å¾©åŸå§‹è¨­å®š
                    settings.teamsEnabled = originalSettings.teamsEnabled;
                    settings.teamsWebhook = originalSettings.teamsWebhook;
                    settings.teamsBackupWebhook = originalSettings.teamsBackupWebhook;
                });
                
            } catch (error) {
                console.error('testTeamsNotification å‡½æ•¸éŒ¯èª¤:', error);
                showMessage('âŒ æ¸¬è©¦å‡½æ•¸åŸ·è¡ŒéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // é–‹å•Ÿç¨ç«‹æ¸¬è©¦å·¥å…·
        function openTeamsTestTool() {
            try {
                window.open('teams_notification_test.html', '_blank');
                showMessage('ğŸ”§ å·²é–‹å•Ÿ Teams æ¸¬è©¦å·¥å…·', 'info');
            } catch (error) {
                console.error('é–‹å•Ÿæ¸¬è©¦å·¥å…·å¤±æ•—:', error);
                showMessage('âŒ ç„¡æ³•é–‹å•Ÿæ¸¬è©¦å·¥å…·', 'error');
            }
        }

        // é–‹å•Ÿ Webhook æ·±åº¦é©—è­‰å·¥å…·
        function openWebhookValidator() {
            try {
                var webhookUrl = document.getElementById('teamsWebhook').value.trim();
                var url = 'teams_webhook_validator.html';
                if (webhookUrl) {
                    url += '?webhook=' + encodeURIComponent(webhookUrl);
                }
                window.open(url, '_blank');
                showMessage('ğŸ” å·²é–‹å•Ÿæ·±åº¦é©—è­‰å·¥å…·', 'info');
            } catch (error) {
                console.error('é–‹å•Ÿé©—è­‰å·¥å…·å¤±æ•—:', error);
                showMessage('âŒ ç„¡æ³•é–‹å•Ÿé©—è­‰å·¥å…·', 'error');
            }
        }

        // æ¸¬è©¦æœ€ç°¡è¨Šæ¯æ ¼å¼
        function testMinimalMessage() {
            try {
                var enabled = document.getElementById('teamsEnabled').checked;
                var webhook = document.getElementById('teamsWebhook').value.trim();
                
                if (!enabled) {
                    showMessage('âŒ è«‹å…ˆå•Ÿç”¨ Teams é€šçŸ¥', 'error');
                    return;
                }
                
                if (!webhook) {
                    showMessage('âŒ è«‹è¼¸å…¥ Webhook URL', 'error');
                    return;
                }

                showMessage('ğŸ“ æ­£åœ¨ç™¼é€æœ€ç°¡æ ¼å¼æ¸¬è©¦...', 'info');
                console.log('ğŸ“ æ¸¬è©¦æœ€ç°¡è¨Šæ¯æ ¼å¼...');

                // ä½¿ç”¨æœ€ç°¡æ ¼å¼ï¼ŒTeams æœ€å®¹æ˜“æ¥å—
                var minimalPayload = {
                    "text": `ğŸ“ æœ€ç°¡æ¸¬è©¦è¨Šæ¯\næ™‚é–“ï¼š${new Date().toLocaleString()}\nå¦‚æœæ”¶åˆ°æ­¤è¨Šæ¯ï¼Œè¡¨ç¤º Webhook å®Œå…¨æ­£å¸¸ï¼`
                };

                // ç›´æ¥ä½¿ç”¨ä»£ç†ç™¼é€æœ€ç°¡æ ¼å¼
                var proxyUrl = 'https://api.allorigins.win/raw?url=';
                var fullUrl = proxyUrl + encodeURIComponent(webhook);

                fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(minimalPayload)
                })
                .then(response => {
                    if (response.ok) {
                        console.log('âœ… æœ€ç°¡è¨Šæ¯ç™¼é€æˆåŠŸ');
                        showMessage('âœ… æœ€ç°¡æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼è«‹æª¢æŸ¥ Teams é »é“ã€‚\nå¦‚æœä»æœªæ”¶åˆ°ï¼Œå¯èƒ½æ˜¯ Webhook URL å•é¡Œã€‚', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('âŒ æœ€ç°¡è¨Šæ¯ç™¼é€å¤±æ•—:', error);
                    showMessage('âŒ æœ€ç°¡æ¸¬è©¦å¤±æ•—: ' + error.message + '\nå»ºè­°ä½¿ç”¨æ·±åº¦é©—è­‰å·¥å…·æª¢æŸ¥ Webhookã€‚', 'error');
                });

            } catch (error) {
                console.error('testMinimalMessage å‡½æ•¸éŒ¯èª¤:', error);
                showMessage('âŒ æ¸¬è©¦å‡½æ•¸åŸ·è¡ŒéŒ¯èª¤: ' + error.message, 'error');
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            var statusArea = document.getElementById('statusArea');
            var className = 'status-' + (type || 'info');
            
            statusArea.innerHTML = '<div class="status ' + className + ' fade-in">' + message + '</div>';
            
            setTimeout(function() {
                if (statusArea.innerHTML.includes(message)) {
                    statusArea.innerHTML = '';
                }
            }, 5000);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        console.log('ğŸ“± Mphasisæ‰“å¡ç³»çµ±å·²è¼‰å…¥');
    </script>
</body>
</html>
