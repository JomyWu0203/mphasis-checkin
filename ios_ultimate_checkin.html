<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üì± MphasisÊâìÂç°</title>
    
    <!-- iOS PWA ÂÑ™Âåñ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MphasisÊâìÂç°">
    <meta name="theme-color" content="#FF6B35">
    
    <style>
        :root {
            --primary-color: #FF6B35;
            --secondary-color: #F7931E;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --info-color: #007AFF;
            --warning-color: #FF9500;
            --gray-color: #8E8E93;
            --light-gray: #F2F2F7;
            --gold-color: #FFD700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Âè™Â∞çÈùûËº∏ÂÖ•ÂÖÉÁ¥†Á¶ÅÁî®ÈÅ∏Âèñ */
        body, div, p, h1, h2, h3, button {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Ëº∏ÂÖ•ÂÖÉÁ¥†ÂÖÅË®±ÈÅ∏ÂèñÂíåÁ∑®ËºØ */
        input, textarea, select {
            -webkit-user-select: text;
            -webkit-touch-callout: default;
            user-select: text;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            background: var(--light-gray);
            color: #000;
            min-height: 100vh;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
        }

        .container {
            max-width: 390px;
            margin: 0 auto;
        }

        /* Ê®ôÈ°åÂçÄÂüü */
        .header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 24px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(255, 107, 53, 0.3);
            position: relative;
        }

        .header::before {
            content: 'üèÜ';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 30px;
            background: var(--gold-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Âç°ÁâáÊ®£Âºè */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #000;
            display: flex;
            align-items: center;
        }

        .card-title .icon {
            margin-right: 8px;
            font-size: 22px;
        }

        /* ÊôÇÈñìÈ°ØÁ§∫ */
        .time-display {
            text-align: center;
            padding: 20px;
        }

        .current-time {
            font-size: 36px;
            font-weight: 200;
            color: #000;
            margin-bottom: 6px;
            font-feature-settings: "tnum";
        }

        .current-date {
            font-size: 15px;
            color: var(--gray-color);
            margin-bottom: 12px;
        }

        .next-checkin {
            background: var(--info-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }

        /* ÂâçÊôØ‰øùÊåÅÁãÄÊÖã */
        .foreground-status {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: center;
            border: 2px solid;
            position: relative;
        }

        .foreground-active {
            background: #E8F5E8;
            color: #1B5E20;
            border-color: var(--success-color);
            animation: pulse-green 2s infinite;
        }

        .foreground-inactive {
            background: #FFEBEE;
            color: #C62828;
            border-color: var(--danger-color);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 199, 89, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); }
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }

        /* ÊåâÈàïÊ®£Âºè */
        .btn {
            display: block;
            width: 100%;
            padding: 16px 20px;
            font-size: 17px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            margin: 12px 0;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-appearance: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);
        }

        .btn-info {
            background: var(--info-color);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.3);
        }

        .btn-gold {
            background: linear-gradient(45deg, var(--gold-color), #FFA500);
            color: #000;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        /* Á≥ªÁµ±Ëß£Ê±∫ÊñπÊ°àÁ∂≤Ê†º */
        .solution-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0;
        }

        .solution-card {
            background: #F8F9FA;
            border: 2px solid #E5E5EA;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .solution-card:hover {
            border-color: var(--primary-color);
            background: rgba(255, 107, 53, 0.05);
        }

        .solution-card .icon {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .solution-card .title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .solution-card .desc {
            font-size: 11px;
            color: var(--gray-color);
            line-height: 1.2;
        }

        /* Á≥ªÁµ±Êï¥ÂêàË™™Êòé */
        .limitation-warning {
            background: linear-gradient(45deg, #FFF3E0, #FFE0B2);
            border: 2px solid var(--warning-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .limitation-warning h3 {
            color: #E65100;
            margin-bottom: 12px;
        }

        .limitation-warning p {
            color: #BF360C;
            line-height: 1.5;
            font-size: 14px;
        }

        /* ÂâçÊôØ‰øùÊåÅË®àÊôÇÂô® */
        .stay-active-timer {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #E3F2FD, #BBDEFB);
            border-radius: 12px;
            border: 2px solid var(--info-color);
            margin: 16px 0;
        }

        .timer-display {
            font-size: 48px;
            font-weight: 200;
            color: var(--info-color);
            margin-bottom: 8px;
            font-family: monospace;
        }

        .timer-label {
            color: #0D47A1;
            font-weight: 600;
        }

        /* ÁãÄÊÖãÊåáÁ§∫Âô® */
        .status {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            text-align: center;
            font-weight: 500;
        }

        .status-success {
            background: #E8F5E8;
            color: #1B5E20;
            border: 2px solid var(--success-color);
        }

        .status-info {
            background: #E3F2FD;
            color: #0D47A1;
            border: 2px solid var(--info-color);
        }

        .status-warning {
            background: #FFF3E0;
            color: #E65100;
            border: 2px solid var(--warning-color);
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid var(--danger-color);
        }

        /* Âø´ÈÄüË®≠ÂÆöÈù¢Êùø */
        .quick-setup {
            background: linear-gradient(45deg, #F3E5F5, #E1BEE7);
            border: 2px solid #8A2BE2;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .quick-setup h3 {
            color: #4A148C;
            margin-bottom: 16px;
            text-align: center;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
        }

        .time-input-group label {
            font-weight: 600;
            color: #6A1B9A;
            flex: 1;
        }

        .time-input-group input,
        .time-input-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #BA68C8;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
        }

        /* Âø´ÈÄüÈÄ±ÈñìÈÅ∏ÊìáÂô® */
        .quick-week-selector {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin: 8px 0;
        }

        .quick-day-btn {
            padding: 10px 6px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid #BA68C8;
            border-radius: 8px;
            background: white;
            color: #6A1B9A;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .quick-day-btn.selected {
            background: #8A2BE2;
            color: white;
            border-color: #8A2BE2;
            transform: scale(1.05);
        }

        .quick-day-btn:active {
            transform: scale(0.95);
        }

        .btn-link {
            background: none !important;
            border: none !important;
            text-decoration: underline;
            cursor: pointer;
            font-size: 12px;
            color: #8A2BE2;
            padding: 4px 8px;
        }

        .btn-link:hover {
            opacity: 0.8;
        }

        /* Ëá™ÂãïÊâìÂç°‰ªãÈù¢Ê®£Âºè */
        .auto-checkin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auto-checkin-modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auto-checkin-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .auto-checkin-header h2 {
            color: #6A1B9A;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .auto-checkin-source {
            color: #8A2BE2;
            font-size: 14px;
            font-weight: 500;
        }

        .auto-checkin-content {
            text-align: center;
        }

        .auto-checkin-status {
            color: #333;
            font-size: 16px;
            margin-bottom: 16px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auto-checkin-progress {
            background: #F0F0F0;
            border-radius: 8px;
            height: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #8A2BE2, #BA68C8);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 8px;
        }

        .auto-checkin-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        .auto-checkin-actions .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auto-checkin-actions .btn-primary {
            background: linear-gradient(135deg, #8A2BE2, #BA68C8);
            color: white;
        }

        .auto-checkin-actions .btn-primary:active {
            transform: scale(0.98);
        }

        .auto-checkin-actions .btn-secondary {
            background: #F0F0F0;
            color: #666;
        }

        #autoCheckinInterface {
            display: none;
        }

        /* Èö±ËóèÈ°û */
        .hidden {
            display: none !important;
        }

        /* ÂãïÁï´ÊïàÊûú */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ÂÖ®Â±èÊèêÈÜíÊ®£Âºè */
        .fullscreen-reminder {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }

        .reminder-clock {
            font-size: 120px;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        .reminder-text {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .reminder-actions {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .reminder-btn {
            padding: 20px 40px;
            font-size: 20px;
            font-weight: 700;
            border: 3px solid white;
            border-radius: 15px;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reminder-btn.primary {
            background: white;
            color: var(--primary-color);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ê®ôÈ°å -->
        <div class="header">
            <h1>üì± MphasisÊâìÂç°</h1>
            <p>‰ºÅÊ•≠Êô∫ÊÖßÊâìÂç°Á≥ªÁµ±</p>
        </div>

        <!-- ÊôÇÈñìÈ°ØÁ§∫ -->
        <div class="card">
            <div class="time-display">
                <div class="current-time" id="timeDisplay">--:--</div>
                <div class="current-date" id="dateDisplay">ËºâÂÖ•‰∏≠...</div>
                <div class="next-checkin" id="nextCheckin">‰∏ãÊ¨°ÊâìÂç°ÔºöÊú™Ë®≠ÂÆö</div>
            </div>
        </div>

        <!-- ÂâçÊôØÁãÄÊÖãÁõ£Êéß -->
        <div class="card">
            <div class="card-title">
                <span class="icon">üì±</span>
                ÊáâÁî®ÁãÄÊÖãÁõ£Êéß
            </div>
            
            <div id="foregroundStatus" class="foreground-status foreground-inactive">
                üîç Ê≠£Âú®Ê™¢Ê∏¨ÊáâÁî®ÁãÄÊÖã...
            </div>
            
            <div class="stay-active-timer">
                <div class="timer-display" id="activeTimer">--:--</div>
                <div class="timer-label">ÂâçÊôØÊ¥ªË∫çÊôÇÈñì</div>
            </div>
        </div>

        <!-- Êô∫ÊÖßÈÄ£ÂãïË™™Êòé -->
        <div class="card" style="background: linear-gradient(135deg, #E8F5E8, #C8E6C9); border: 2px solid #4CAF50; margin-bottom: 16px;">
            <div class="card-title" style="color: #2E7D32;">
                <span class="icon">üîó</span>
                Êô∫ÊÖßË°å‰∫ãÊõÜÈÄ£ÂãïÁ≥ªÁµ±
            </div>
            <div style="color: #1B5E20; line-height: 1.6;">
                <p><strong>üéØ ÂÆåÊï¥Ëá™ÂãïÂåñÊµÅÁ®ãÔºö</strong></p>
                <div style="margin: 12px 0; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; font-size: 14px;">
                    <strong>1Ô∏è‚É£ Âø´ÈÄüË®≠ÂÆö</strong> ‚Üí ÈÅ∏ÊìáÊâìÂç°ÊôÇÈñìÂíåÈÄ±ÈñìÊéíÁ®ã<br>
                    <strong>2Ô∏è‚É£ iOS Ë°å‰∫ãÊõÜ</strong> ‚Üí Ëá™ÂãïÁîüÊàêÁ≥ªÁµ±Á¥öÊèêÈÜí‰∫ã‰ª∂<br>
                    <strong>3Ô∏è‚É£ ÊèêÈÜíËß∏Áôº</strong> ‚Üí ÈªûÊìäÈÄöÁü•Ëá™ÂãïÂñöÈÜíÊáâÁî®<br>
                    <strong>4Ô∏è‚É£ ÈñãÂïüÊâìÂç°</strong> ‚Üí Êô∫ÊÖßÊ™¢Ê∏¨‰∏¶ÈñãÂïüÊâìÂç°È†ÅÈù¢<br>
                    <strong>5Ô∏è‚É£ Teams ÈÄöÁü•</strong> ‚Üí Ëá™ÂãïÂõûÂ†±Âü∑Ë°åÁãÄÊÖã
                </div>
                <p><strong>üöÄ Ê†∏ÂøÉÂÑ™Âã¢Ôºö</strong></p>
                <ul style="margin: 8px 0 0 20px; font-size: 14px;">
                    <li>‚úÖ Á≤æÁ∞°È´òÊïàÔºöÂè™‰øùÁïôÊ†∏ÂøÉÂäüËÉΩ</li>
                    <li>‚úÖ iOS Ë°å‰∫ãÊõÜÔºöÁ≥ªÁµ±Á¥öÂèØÈù†ÊèêÈÜí</li>
                    <li>‚úÖ Teams ÈÄöÁü•Ôºö‰ºÅÊ•≠Á¥öÁãÄÊÖãËøΩËπ§</li>
                    <li>‚úÖ Êô∫ÊÖßÊéíÁ®ãÔºöÈÄ±ÈñìËá™ÂãïÂåñÁÆ°ÁêÜ</li>
                    <li>‚úÖ Ëá™ÂãïÂñöÈÜíÔºöÈªûÊìäÂç≥Áî®ÁÑ°ÈúÄË®òÊÜ∂</li>
                </ul>
            </div>
        </div>

        <!-- iOS Á≥ªÁµ±Êï¥ÂêàË™™Êòé -->
        <div class="limitation-warning">
            <h3>‚ö° ÁÇ∫‰ªÄÈ∫º‰ΩøÁî®Ë°å‰∫ãÊõÜÈÄ£ÂãïÔºü</h3>
            <p>
                <strong>Êô∫ÊÖßË®≠Ë®àÔºö</strong>Êï¥Âêà iOS ÂéüÁîüÁ≥ªÁµ±ÂäüËÉΩÔºåÊèê‰æõÊúÄÂèØÈù†ÁöÑÊèêÈÜíÈ´îÈ©ó„ÄÇ<br><br>
                
                <strong>Á≥ªÁµ±Êï¥ÂêàÂÑ™Âã¢Ôºö</strong><br>
                ‚Ä¢ ‚è∞ ‰ΩøÁî® iOS ÂéüÁîüË°å‰∫ãÊõÜÊèêÈÜí<br>
                ‚Ä¢ üîî Á≥ªÁµ±Á¥öÈÄöÁü•‰øùË≠âÈÄÅÈÅî<br>
                ‚Ä¢ üíØ ‰∏çÂèóÁ∂≤È†ÅÈôêÂà∂ÂΩ±Èüø<br>
                ‚Ä¢ üöÄ ‰∏ÄÈçµÂñöÈÜíÊâìÂç°ÊáâÁî®<br><br>
                
                <strong>Êô∫ÊÖßÊµÅÁ®ãÔºö</strong>Ë°å‰∫ãÊõÜÊèêÈÜí ‚Üí ÈªûÊìäÈÄöÁü• ‚Üí Ëá™ÂãïÈñãÂïüÊáâÁî® ‚Üí Âü∑Ë°åÊâìÂç°ÔºÅ
            </p>
        </div>

        <!-- Âø´ÈÄüË®≠ÂÆö -->
        <div class="quick-setup">
            <h3>‚ö° Âø´ÈÄüË®≠ÂÆöÊâìÂç°ÊôÇÈñì</h3>
            
            <div class="time-input-group">
                <label>ÊâìÂç°ÊôÇÈñìÔºö</label>
                <input type="time" id="quickCheckinTime" value="09:00">
            </div>
            
            <div class="time-input-group">
                <label>ÊèêÂâçÊèêÈÜíÔºö</label>
                <select id="quickReminderTime">
                    <option value="5">5 ÂàÜÈêò</option>
                    <option value="10">10 ÂàÜÈêò</option>
                    <option value="15">15 ÂàÜÈêò</option>
                    <option value="30">30 ÂàÜÈêò</option>
                </select>
            </div>
            
            <!-- ÈÄ±ÈñìÈÅ∏Êìá -->
            <div style="margin: 16px 0;">
                <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">ÊâìÂç°Êó•ÊúüÔºö</label>
                <div class="quick-week-selector">
                    <div class="quick-day-btn" data-day="1" onclick="toggleQuickDay(1)">‰∏Ä</div>
                    <div class="quick-day-btn" data-day="2" onclick="toggleQuickDay(2)">‰∫å</div>
                    <div class="quick-day-btn" data-day="3" onclick="toggleQuickDay(3)">‰∏â</div>
                    <div class="quick-day-btn" data-day="4" onclick="toggleQuickDay(4)">Âõõ</div>
                    <div class="quick-day-btn" data-day="5" onclick="toggleQuickDay(5)">‰∫î</div>
                    <div class="quick-day-btn" data-day="6" onclick="toggleQuickDay(6)">ÂÖ≠</div>
                    <div class="quick-day-btn" data-day="0" onclick="toggleQuickDay(0)">Êó•</div>
                </div>
                <div style="margin-top: 8px;">
                    <button class="btn-link" onclick="selectWorkdays()" style="font-size: 12px; color: #8A2BE2; background: none; border: none; text-decoration: underline; cursor: pointer;">
                        üìÖ ÈÅ∏ÊìáÂ∑•‰ΩúÊó• (‰∏Ä~‰∫î)
                    </button>
                    <button class="btn-link" onclick="selectAllDays()" style="font-size: 12px; color: #8A2BE2; background: none; border: none; text-decoration: underline; cursor: pointer; margin-left: 16px;">
                        üóìÔ∏è ÈÅ∏ÊìáÂÖ®ÈÉ® (‰∏Ä~Êó•)
                    </button>
                </div>
            </div>
            
            <!-- Â∏∏Ë¶ãÂÅáÊó•ÊéíÈô§ -->
            <div style="margin: 16px 0;">
                <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">
                    <input type="checkbox" id="quickExcludeHolidays" checked style="margin-right: 8px;">
                    Ëá™ÂãïÊéíÈô§ÂúãÂÆöÂÅáÊó•
                </label>
                <div style="font-size: 12px; color: #8A2BE2; opacity: 0.8;">
                    ÂåÖÂê´ÔºöÂÖÉÊó¶„ÄÅÊò•ÁØÄ„ÄÅÊ∏ÖÊòé„ÄÅÂãûÂãïÁØÄ„ÄÅÁ´ØÂçà„ÄÅ‰∏≠Áßã„ÄÅÂúãÊÖ∂Á≠â
                </div>
            </div>
            
            <button class="btn btn-gold" onclick="quickSetup()">
                ‚ö° ‰∏ÄÈçµË®≠ÂÆöÊâÄÊúâÊèêÈÜí
            </button>
            
            <div style="margin-top: 12px; font-size: 13px; color: #6A1B9A; text-align: center; opacity: 0.9;">
                üìÖ Â∞áËá™ÂãïË®≠ÂÆöÔºöiOS Ë°å‰∫ãÊõÜÊô∫ÊÖßÊèêÈÜí
            </div>
            
            <!-- Ê∏¨Ë©¶Ë°å‰∫ãÊõÜÂñöÈÜí -->
            <div style="margin-top: 16px; text-align: center;">
                <button class="btn btn-secondary" onclick="testCalendarWakeup()" style="font-size: 14px; padding: 8px 16px;">
                    üß™ Ê∏¨Ë©¶Ë°å‰∫ãÊõÜÂñöÈÜíÂäüËÉΩ
                </button>
            </div>
        </div>

        <!-- Á≥ªÁµ±Á¥öËß£Ê±∫ÊñπÊ°à -->
        <div class="card">
            <div class="card-title">
                <span class="icon">üéØ</span>
                Ê†∏ÂøÉÂäüËÉΩ (Á∞°ÂåñÁâà)
            </div>
            
            <div class="status status-info">
                <strong>üí° Á≤æÁ∞°Á≠ñÁï•Ôºö</strong>Âè™‰øùÁïôÊúÄÊ†∏ÂøÉÁöÑÂÖ©Â§ßÂäüËÉΩÔºåÁ∞°ÊΩîÈ´òÊïàÔºÅ
            </div>
            
            <div class="solution-grid" style="grid-template-columns: 1fr 1fr; max-width: 400px; margin: 0 auto;">
                <div class="solution-card" onclick="console.log('üì± iOSË°å‰∫ãÊõÜÊåâÈàïË¢´ÈªûÊìä'); setupIOSCalendar()">
                    <span class="icon">üìÖ</span>
                    <div class="title">iOS Ë°å‰∫ãÊõÜ</div>
                    <div class="desc">Á≥ªÁµ±ÊèêÈÜí<br>Ëá™ÂãïÂñöÈÜí</div>
                </div>
                
                <div class="solution-card" onclick="toggleTeamsSettings()">
                    <span class="icon">üì§</span>
                    <div class="title">Teams ÈÄöÁü•</div>
                    <div class="desc">ÁãÄÊÖãËøΩËπ§<br>‰ºÅÊ•≠Êï¥Âêà</div>
                </div>
            </div>
            
            <!-- Ë°å‰∫ãÊõÜÁÆ°ÁêÜÂ∑•ÂÖ∑ -->
            <div style="margin-top: 16px; text-align: center;">
                <button class="btn btn-secondary" onclick="showCalendarManagement()" style="background: #FF9800; margin: 4px;">
                    üóëÔ∏è ÁÆ°ÁêÜË°å‰∫ãÊõÜÊéíÁ®ã
                </button>
                <button class="btn btn-secondary" onclick="openIOSCalendarApp()" style="background: #9C27B0; margin: 4px;">
                    üì± ÈñãÂïüË°å‰∫ãÊõÜ App
                </button>
            </div>
            
            <div style="margin-top: 16px; text-align: center; font-size: 14px; color: #6A1B9A; background: rgba(106, 27, 154, 0.1); padding: 12px; border-radius: 8px;">
                ‚ú® <strong>ÂÆåÁæéÁµÑÂêà</strong>ÔºöiOS Ë°å‰∫ãÊõÜË≤†Ë≤¨ÊèêÈÜíÂñöÈÜíÔºåTeams ÈÄöÁü•Ë≤†Ë≤¨ÁãÄÊÖãÂõûÂ†±
            </div>
        </div>

        <!-- Teams ÈÄöÁü•Ë®≠ÂÆö -->
        <div class="card" id="teamsSettings" style="display: none; margin-top: 16px;">
            <div class="card-title">
                <span class="icon">üì§</span>
                Teams ÈÄöÁü•Ë®≠ÂÆö
            </div>
            
            <div style="margin: 16px 0;">
                <label style="display: flex; align-items: center; margin-bottom: 16px;">
                    <input type="checkbox" id="teamsEnabled" onchange="updateTeamsSettings()" style="margin-right: 8px;">
                    <span style="font-weight: 600; color: #6A1B9A;">ÂïüÁî® Teams ÈÄöÁü•</span>
                </label>
                
                <div id="teamsWebhookSettings" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">
                            ‰∏ªË¶Å Webhook URL:
                        </label>
                        <input type="url" id="teamsWebhook" placeholder="https://outlook.office.com/webhook/..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #BA68C8; border-radius: 8px; font-size: 16px; -webkit-appearance: none; appearance: none;"
                               oninput="onTeamsWebhookInput()">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; color: #6A1B9A; margin-bottom: 8px;">
                            ÂÇôÁî® Webhook URL (ÈÅ∏Â°´):
                        </label>
                        <input type="url" id="teamsBackupWebhook" placeholder="https://outlook.office.com/webhook/..." 
                               style="width: 100%; padding: 8px 12px; border: 1px solid #BA68C8; border-radius: 8px; font-size: 16px; -webkit-appearance: none; appearance: none;"
                               oninput="onTeamsWebhookInput()">
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="saveTeamsSettings()" style="flex: 1;">
                            üíæ ÂÑ≤Â≠òË®≠ÂÆö
                        </button>
                        <button class="btn btn-secondary" onclick="testTeamsNotification()" style="flex: 1;">
                            üß™ Ê∏¨Ë©¶ÈÄöÁü•
                        </button>
                    </div>
                    
                    <div style="margin-top: 8px; text-align: center;">
                        <button class="btn" onclick="openTeamsTestTool()" style="background: #ff9800; color: white; font-size: 12px; padding: 6px 12px; margin: 4px;">
                            üîß Ê∏¨Ë©¶Â∑•ÂÖ∑
                        </button>
                        <button class="btn" onclick="openWebhookValidator()" style="background: #9c27b0; color: white; font-size: 12px; padding: 6px 12px; margin: 4px;">
                            üîç Ê∑±Â∫¶È©óË≠â
                        </button>
                        <button class="btn" onclick="testMinimalMessage()" style="background: #4caf50; color: white; font-size: 12px; padding: 6px 12px; margin: 4px;">
                            üìù Á∞°ÂñÆÊ∏¨Ë©¶
                        </button>
                    </div>
                    
                    <div style="margin-top: 12px; padding: 12px; background: rgba(106, 27, 154, 0.1); border-radius: 8px; font-size: 13px; color: #6A1B9A;">
                        <strong>üí° Â¶Ç‰ΩïÂèñÂæó Teams Webhook URLÔºö</strong><br>
                        1. Âú® Teams È†ªÈÅì‰∏≠ÈªûÊìä„Äå...„Äç‚Üí„ÄåÈÄ£Êé•Âô®„Äç<br>
                        2. ÊêúÂ∞ã„ÄåIncoming Webhook„Äç‰∏¶Ë®≠ÂÆö<br>
                        3. Ëº∏ÂÖ•ÂêçÁ®±Ôºö„ÄåMphasis ÊâìÂç°ÈÄöÁü•„Äç<br>
                        4. Ë§áË£ΩÁî¢ÁîüÁöÑ Webhook URL
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂâçÊôØ‰øùÊåÅÊñπÊ°à -->
        <div class="card">
            <div class="card-title">
                <span class="icon">üîÑ</span>
                ÂâçÊôØ‰øùÊåÅÊñπÊ°à
            </div>
            
            <div class="status status-warning">
                <strong>‚ö†Ô∏è ÂØ¶È©óÊÄßÊñπÊ°àÔºö</strong>ÂòóË©¶‰øùÊåÅÊáâÁî®Âú®ÂâçÊôØÔºå‰ΩÜ‰∏ç‰øùË≠âÊàêÂäüÔºÅ
            </div>
            
            <button class="btn btn-warning" onclick="startForegroundMode()">
                üîÑ ÂïüÂãïÂâçÊôØ‰øùÊåÅÊ®°Âºè
            </button>
            
            <button class="btn btn-info" onclick="testForegroundReminder()">
                üß™ Ê∏¨Ë©¶ÂâçÊôØÊèêÈÜí
            </button>
        </div>

        <!-- ÊâãÂãïÊìç‰Ωú -->
        <div class="card">
            <div class="card-title">
                <span class="icon">üéØ</span>
                Á´ãÂç≥ÊâìÂç°
            </div>
            
            <button class="btn btn-success" onclick="openCheckinPage()">
                üéØ ÈñãÂïüÊâìÂç°È†ÅÈù¢
            </button>
            
            <div style="margin-top: 16px;">
                <button class="btn btn-primary" onclick="showCheckinReminder()">
                    üì¢ Ê®°Êì¨ÊâìÂç°ÊèêÈÜí
                </button>
            </div>
        </div>

        <!-- ÁãÄÊÖãË®äÊÅØÂçÄÂüü -->
        <div id="statusArea"></div>
    </div>

    <!-- ÂÖ®Â±èÊèêÈÜíË¶ÜËìãÂ±§ -->
    <div class="fullscreen-reminder hidden" id="fullscreenReminder">
        <div class="reminder-clock">üïò</div>
        <div class="reminder-text">ÊâìÂç°ÊôÇÈñìÂà∞‰∫ÜÔºÅ</div>
        <div style="font-size: 18px; opacity: 0.9;">
            ÁèæÂú®ÊòØ <span id="reminderTime">09:00</span>ÔºåË©≤ÂéªÊâìÂç°‰∫ÜÔºÅ
        </div>
        <div class="reminder-actions">
            <button class="reminder-btn primary" onclick="openCheckinPage(); hideFullscreenReminder();">
                Á´ãÂç≥ÊâìÂç°
            </button>
            <button class="reminder-btn" onclick="snoozeReminder()">
                Á®çÂæåÊèêÈÜí
            </button>
            <button class="reminder-btn" onclick="hideFullscreenReminder()">
                ÈóúÈñâ
            </button>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        var settings = {
            checkinTime: '09:00',
            reminderMinutes: 5,
            checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
            weeklyDays: [1, 2, 3, 4, 5], // È†êË®≠ÈÄ±‰∏ÄÂà∞ÈÄ±‰∫î
            excludeHolidays: true,
            teamsWebhook: '', // Teams Webhook URL
            teamsBackupWebhook: '', // ÂÇôÁî® Teams Webhook URL
            teamsEnabled: false // ÊòØÂê¶ÂïüÁî® Teams ÈÄöÁü•
        };
        
        var quickWeeklyDays = [1, 2, 3, 4, 5]; // Âø´ÈÄüË®≠ÂÆöÁöÑÈÄ±ÈñìÈÅ∏Êìá

        var foregroundTimer = null;
        var activeStartTime = null;
        var visibilityChangeCount = 0;
        var reminderInterval = null;

        // ÂàùÂßãÂåñ
        function initApp() {
            console.log('üì± MphasisÊâìÂç°Á≥ªÁµ±ÂïüÂãï');
            loadSettings();
            updateTime();
            setInterval(updateTime, 1000);
            
            setupVisibilityMonitoring();
            startActiveTimer();
            updateQuickWeeklyDisplay();
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë°å‰∫ãÊõÜÂñöÈÜí
            checkCalendarWakeup();
            
            // Ë®≠ÂÆö URL Scheme ËôïÁêÜÂô®
            setupURLSchemeHandler();
            
            showMessage('‚úÖ MphasisÊâìÂç°Á≥ªÁµ±Â∑≤Â∞±Á∑íÔºÅÂª∫Ë≠∞‰ΩøÁî®Á≥ªÁµ±Á¥öÊèêÈÜíÊñπÊ°à„ÄÇ', 'success');
        }

        // Ë®≠ÂÆöÂèØË¶ãÊÄßÁõ£Êéß
        function setupVisibilityMonitoring() {
            // Áõ£ÊéßÈ†ÅÈù¢ÂèØË¶ãÊÄßËÆäÂåñ
            document.addEventListener('visibilitychange', function() {
                visibilityChangeCount++;
                updateForegroundStatus();
                
                if (document.hidden) {
                    console.log('üì± ÊáâÁî®ÂàáÊèõÂà∞ÈùûÊ¥ªË∫çÁãÄÊÖã');
                    handleBackgroundMode();
                } else {
                    console.log('‚úÖ ÊáâÁî®ÂõûÂà∞ÂâçÊôØÊ®°Âºè');
                    handleForegroundMode();
                }
            });

            // Áõ£ÊéßÁ™óÂè£ÁÑ¶ÈªûËÆäÂåñ
            window.addEventListener('focus', function() {
                console.log('üéØ Á™óÂè£Áç≤ÂæóÁÑ¶Èªû');
                handleForegroundMode();
                checkCalendarWakeup(); // ÂêåÊôÇÊ™¢Êü•ÊòØÂê¶ÁÇ∫Ë°å‰∫ãÊõÜÂñöÈÜí
            });

            window.addEventListener('blur', function() {
                console.log('üò¥ Á™óÂè£Â§±ÂéªÁÑ¶Èªû');
                handleBackgroundMode();
            });

            // ÂàùÂßãÁãÄÊÖãÊ™¢Êü•
            updateForegroundStatus();
        }

        // ËôïÁêÜÈùûÊ¥ªË∫çÁãÄÊÖã
        function handleBackgroundMode() {
            updateForegroundStatus();
            
            // ÂòóË©¶‰øùÊåÅÊúÄ‰ΩéÈôêÂ∫¶ÁöÑÊ¥ªÂãï
            if (reminderInterval) {
                // ‰ΩøÁî® setTimeout ËÄå‰∏çÊòØ setInterval ‰æÜÈÅøÂÖçË¢´Êö´ÂÅú
                scheduleNextCheck();
            }
        }

        // ËôïÁêÜÂâçÊôØÊ®°Âºè
        function handleForegroundMode() {
            activeStartTime = Date.now();
            updateForegroundStatus();
            
            // ÈáçÊñ∞ÂïüÂãïÊ≠£Â∏∏ÁöÑÊ™¢Êü•Ê©üÂà∂
            if (reminderInterval) {
                clearInterval(reminderInterval);
                startForegroundReminderCheck();
            }
        }

        // Êõ¥Êñ∞ÂâçÊôØÁãÄÊÖãÈ°ØÁ§∫
        function updateForegroundStatus() {
            var statusElement = document.getElementById('foregroundStatus');
            var isActive = !document.hidden && document.hasFocus();
            
            if (isActive) {
                statusElement.className = 'foreground-status foreground-active';
                statusElement.innerHTML = '‚úÖ ÊáâÁî®Âú®ÂâçÊôØÈÅãË°å‰∏≠<br><small>ÂàáÊèõÊ¨°Êï∏Ôºö' + visibilityChangeCount + '</small>';
            } else {
                statusElement.className = 'foreground-status foreground-inactive';
                statusElement.innerHTML = 'üì± ÊáâÁî®Âú®ÈùûÊ¥ªË∫çÁãÄÊÖã<br><small>Âª∫Ë≠∞‰ΩøÁî®Á≥ªÁµ±Á¥öÊèêÈÜí</small>';
            }
        }

        // ÂïüÂãïÊ¥ªË∫çË®àÊôÇÂô®
        function startActiveTimer() {
            activeStartTime = Date.now();
            
            setInterval(function() {
                updateActiveTimer();
            }, 1000);
        }

        // Êõ¥Êñ∞Ê¥ªË∫çË®àÊôÇÂô®
        function updateActiveTimer() {
            if (!activeStartTime) {
                document.getElementById('activeTimer').textContent = '--:--';
                return;
            }
            
            var elapsed = Date.now() - activeStartTime;
            var minutes = Math.floor(elapsed / 60000);
            var seconds = Math.floor((elapsed % 60000) / 1000);
            
            var timeString = minutes.toString().padStart(2, '0') + ':' + 
                           seconds.toString().padStart(2, '0');
            
            document.getElementById('activeTimer').textContent = timeString;
            
            // Ë∂ÖÈÅé 5 ÂàÜÈêòÈ°ØÁ§∫Ë≠¶Âëä
            if (minutes >= 5) {
                document.getElementById('activeTimer').style.color = 'var(--danger-color)';
            } else if (minutes >= 3) {
                document.getElementById('activeTimer').style.color = 'var(--warning-color)';
            } else {
                document.getElementById('activeTimer').style.color = 'var(--info-color)';
            }
        }

        // Êõ¥Êñ∞ÊôÇÈñìÈ°ØÁ§∫
        function updateTime() {
            try {
                var now = new Date();
                var hours = now.getHours().toString().padStart(2, '0');
                var minutes = now.getMinutes().toString().padStart(2, '0');
                var timeString = hours + ':' + minutes;
                
                var options = { 
                    year: 'numeric',
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                };
                var dateString = now.toLocaleDateString('zh-TW', options);
                
                document.getElementById('timeDisplay').textContent = timeString;
                document.getElementById('dateDisplay').textContent = dateString;
                
                updateNextCheckinTime();
                checkForReminder();
            } catch (error) {
                console.error('ÊôÇÈñìÊõ¥Êñ∞Â§±Êïó:', error);
            }
        }

        // Êõ¥Êñ∞‰∏ãÊ¨°ÊâìÂç°ÊôÇÈñì
        function updateNextCheckinTime() {
            var now = new Date();
            var today = new Date();
            var timeParts = settings.checkinTime.split(':');
            today.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
            
            var nextCheckinElement = document.getElementById('nextCheckin');
            
            if (now < today) {
                nextCheckinElement.textContent = '‰ªäÊó•ÊâìÂç°Ôºö' + settings.checkinTime;
                nextCheckinElement.style.background = 'var(--success-color)';
            } else {
                var tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                nextCheckinElement.textContent = 'ÊòéÊó•ÊâìÂç°Ôºö' + settings.checkinTime;
                nextCheckinElement.style.background = 'var(--gray-color)';
            }
        }

        // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÊèêÈÜí
        function checkForReminder() {
            var now = new Date();
            var today = new Date();
            var timeParts = settings.checkinTime.split(':');
            today.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]) - settings.reminderMinutes, 0, 0);
            
            // Ê™¢Êü•ÊòØÂê¶Âà∞‰∫ÜÊèêÈÜíÊôÇÈñìÔºàÁ≤æÁ¢∫Âà∞ÂàÜÈêòÔºâ
            if (Math.abs(now.getTime() - today.getTime()) < 30000) { // 30ÁßíÂÖß
                triggerCheckinReminder();
            }
        }

        // Ëß∏ÁôºÊâìÂç°ÊèêÈÜí
        function triggerCheckinReminder() {
            console.log('üîî Ëß∏ÁôºÊâìÂç°ÊèêÈÜí');
            
            // Â¶ÇÊûúÂú®ÂâçÊôØÔºåÈ°ØÁ§∫ÂÖ®Â±èÊèêÈÜí
            if (!document.hidden) {
                showFullscreenReminder();
            }
            
            // ÂòóË©¶Â§öÁ®ÆÊèêÈÜíÊñπÂºè
            try {
                // Ë™ûÈü≥ÊèêÈÜí
                if ('speechSynthesis' in window) {
                    var utterance = new SpeechSynthesisUtterance('ÊâìÂç°ÊôÇÈñìÂà∞‰∫ÜÔºÅ');
                    utterance.lang = 'zh-TW';
                    speechSynthesis.speak(utterance);
                }
                
                // ÊåØÂãïÊèêÈÜí
                if ('vibrate' in navigator) {
                    navigator.vibrate([500, 200, 500, 200, 500]);
                }
                
                // ÂòóË©¶Èü≥Êïà
                playAlertSound();
                
            } catch (error) {
                console.error('ÊèêÈÜíÂ§±Êïó:', error);
            }
        }

        // È°ØÁ§∫ÂÖ®Â±èÊèêÈÜí
        function showFullscreenReminder() {
            var reminderElement = document.getElementById('fullscreenReminder');
            document.getElementById('reminderTime').textContent = settings.checkinTime;
            reminderElement.classList.remove('hidden');
            
            // ÂòóË©¶ÈÄ≤ÂÖ•ÂÖ®Ëû¢Âπï
            try {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
            } catch (error) {
                console.log('ÁÑ°Ê≥ïÈÄ≤ÂÖ•ÂÖ®Ëû¢Âπï:', error);
            }
        }

        // Èö±ËóèÂÖ®Â±èÊèêÈÜí
        function hideFullscreenReminder() {
            document.getElementById('fullscreenReminder').classList.add('hidden');
            
            // ÈÄÄÂá∫ÂÖ®Ëû¢Âπï
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            } catch (error) {
                console.log('ÁÑ°Ê≥ïÈÄÄÂá∫ÂÖ®Ëû¢Âπï:', error);
            }
        }

        // Âª∂ÈÅ≤ÊèêÈÜí
        function snoozeReminder() {
            hideFullscreenReminder();
            showMessage('‚è∞ Â∞áÂú® 5 ÂàÜÈêòÂæåÂÜçÊ¨°ÊèêÈÜí', 'info');
            
            setTimeout(function() {
                if (!document.hidden) {
                    triggerCheckinReminder();
                }
            }, 5 * 60 * 1000);
        }

        // Êí≠ÊîæÊèêÈÜíÈü≥Êïà
        function playAlertSound() {
            try {
                var audioContext = new (window.AudioContext || window.webkitAudioContext)();
                var oscillator = audioContext.createOscillator();
                var gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Êí≠Êîæ‰∏ÄÂÄãÈüø‰∫ÆÁöÑÊèêÈÜíÈü≥
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1046, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.4);
                
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.error('Èü≥ÊïàÊí≠ÊîæÂ§±Êïó:', error);
            }
        }

        // Ê™¢Êü•Ë°å‰∫ãÊõÜÂñöÈÜí
        function checkCalendarWakeup() {
            var urlParams = new URLSearchParams(window.location.search);
            var wakeupSource = urlParams.get('wakeup');
            var wakeupTime = urlParams.get('time');
            
            if (wakeupSource === 'calendar') {
                console.log('üîî Ë°å‰∫ãÊõÜÂñöÈÜíÊ™¢Ê∏¨:', wakeupTime);
                showMessage('üîî Ë°å‰∫ãÊõÜÊèêÈÜíÂñöÈÜíÔºÅÊ∫ñÂÇôËá™ÂãïÊâìÂç°...', 'info');
                
                // Âª∂ÈÅ≤Âü∑Ë°åËá™ÂãïÊâìÂç°ÊµÅÁ®ãÔºåËÆì‰ΩøÁî®ËÄÖÁúãÂà∞ÊèêÈÜí
                setTimeout(() => {
                    executeAutoCheckin('calendar');
                }, 2000);
                
                return true;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ Siri Êç∑ÂæëÂñöÈÜí
            if (wakeupSource === 'siri') {
                console.log('üó£Ô∏è Siri Êç∑ÂæëÂñöÈÜíÊ™¢Ê∏¨');
                showMessage('üó£Ô∏è Siri Êç∑ÂæëÂñöÈÜíÔºÅÁ´ãÂç≥Âü∑Ë°åÊâìÂç°...', 'info');
                setTimeout(() => {
                    executeAutoCheckin('siri');
                }, 1000);
                return true;
            }
            
            return false;
        }

        // Ë®≠ÂÆö URL Scheme ËôïÁêÜÂô®
        function setupURLSchemeHandler() {
            // Áõ£ËÅΩ popstate ‰∫ã‰ª∂ÔºàËøîÂõûÊåâÈàïÊàñ URL ËÆäÂåñÔºâ
            window.addEventListener('popstate', function(event) {
                checkCalendarWakeup();
            });
            
            // focus ‰∫ã‰ª∂Â∑≤Âú® setupVisibilityMonitoring() ‰∏≠Ë®≠ÂÆöÔºåÈÄôË£°Âè™ÈúÄÊ™¢Êü• wakeup
            
            // Áõ£ËÅΩ pageshow ‰∫ã‰ª∂ÔºàÈ†ÅÈù¢È°ØÁ§∫Ôºâ
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    console.log('üìÑ È†ÅÈù¢ÂæûÁ∑©Â≠òÊÅ¢Âæ©');
                    checkCalendarWakeup();
                }
            });
        }

        // Âü∑Ë°åËá™ÂãïÊâìÂç°ÊµÅÁ®ã
        function executeAutoCheckin(source) {
            showMessage(`üéØ ${source === 'calendar' ? 'Ë°å‰∫ãÊõÜ' : 'Siri'} Ëß∏ÁôºËá™ÂãïÊâìÂç°ÊµÅÁ®ã...`, 'info');
            
            // È°ØÁ§∫Ëá™ÂãïÊâìÂç°‰ªãÈù¢
            showAutoCheckinInterface(source);
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊúâÊïàÊâìÂç°ÊôÇÈñì
            if (isValidCheckinTime()) {
                // Âü∑Ë°åËá™ÂãïÊâìÂç°ÈÇèËºØ
                performSmartCheckin(source);
            } else {
                showMessage('‚è∞ Áï∂Ââç‰∏çÂú®Ë®≠ÂÆöÁöÑÊâìÂç°ÊôÇÈñìÁØÑÂúçÂÖß', 'warning');
            }
        }

        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊúâÊïàÊâìÂç°ÊôÇÈñì
        function isValidCheckinTime() {
            var now = new Date();
            var currentDay = now.getDay();
            var currentTime = now.getHours() * 60 + now.getMinutes();
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë®≠ÂÆöÁöÑÊâìÂç°Êó•Êúü
            if (!settings.weeklyDays.includes(currentDay)) {
                console.log('‰ªäÂ§©‰∏çÊòØË®≠ÂÆöÁöÑÊâìÂç°Êó•Êúü');
                return false;
            }
            
            // Ê™¢Êü•ÊòØÂê¶Âú®ÊâìÂç°ÊôÇÈñìÁØÑÂúçÂÖßÔºàÂâçÂæå30ÂàÜÈêòÔºâ
            var checkinTimeParts = settings.checkinTime.split(':');
            var checkinTimeMinutes = parseInt(checkinTimeParts[0]) * 60 + parseInt(checkinTimeParts[1]);
            var timeDiff = Math.abs(currentTime - checkinTimeMinutes);
            
            if (timeDiff <= 30) {
                console.log('Âú®ÊúâÊïàÊâìÂç°ÊôÇÈñìÁØÑÂúçÂÖß');
                return true;
            }
            
            console.log(`ÊôÇÈñìÂ∑ÆÁï∞: ${timeDiff} ÂàÜÈêòÔºåË∂ÖÂá∫ÁØÑÂúç`);
            return false;
        }

        // È°ØÁ§∫Ëá™ÂãïÊâìÂç°‰ªãÈù¢
        function showAutoCheckinInterface(source) {
            var autoCheckinDiv = document.getElementById('autoCheckinInterface');
            if (!autoCheckinDiv) {
                autoCheckinDiv = document.createElement('div');
                autoCheckinDiv.id = 'autoCheckinInterface';
                autoCheckinDiv.innerHTML = `
                    <div class="auto-checkin-overlay">
                        <div class="auto-checkin-modal">
                            <div class="auto-checkin-header">
                                <h2>üéØ Ëá™ÂãïÊâìÂç°Âü∑Ë°å‰∏≠</h2>
                                <div class="auto-checkin-source">
                                    ‰æÜÊ∫êÔºö${source === 'calendar' ? 'üìÖ iOS Ë°å‰∫ãÊõÜ' : 'üó£Ô∏è Siri Êç∑Âæë'}
                                </div>
                            </div>
                            <div class="auto-checkin-content">
                                <div class="auto-checkin-status" id="autoCheckinStatus">
                                    Ê≠£Âú®Ê∫ñÂÇôÊâìÂç°...
                                </div>
                                <div class="auto-checkin-progress">
                                    <div class="progress-bar" id="autoCheckinProgress"></div>
                                </div>
                                <div class="auto-checkin-actions">
                                    <button class="btn btn-primary" onclick="proceedToCheckin()" id="proceedBtn">
                                        üöÄ Á´ãÂç≥ÂâçÂæÄÊâìÂç°
                                    </button>
                                    <button class="btn btn-secondary" onclick="closeAutoCheckin()" id="cancelBtn">
                                        ‚ùå ÂèñÊ∂à
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(autoCheckinDiv);
            }
            
            autoCheckinDiv.style.display = 'block';
        }

        // Âü∑Ë°åÊô∫ÊÖßÊâìÂç°
        function performSmartCheckin(source) {
            var statusElement = document.getElementById('autoCheckinStatus');
            var progressElement = document.getElementById('autoCheckinProgress');
            
            var steps = [
                { text: 'üîç Ê™¢Êü•ÊâìÂç°Ë®≠ÂÆö...', progress: 25 },
                { text: 'üì± Ê∫ñÂÇôÈñãÂïüÊâìÂç°È†ÅÈù¢...', progress: 50 },
                { text: 'üì§ Ê∫ñÂÇôÁôºÈÄÅ Teams ÈÄöÁü•...', progress: 75 },
                { text: 'üéâ Ëá™ÂãïÊâìÂç°ÊµÅÁ®ãÂÆåÊàêÔºÅ', progress: 100 }
            ];
            
            var currentStep = 0;
            
            var stepInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    var step = steps[currentStep];
                    statusElement.textContent = step.text;
                    progressElement.style.width = step.progress + '%';
                    currentStep++;
                } else {
                    clearInterval(stepInterval);
                    // Ê∫ñÂÇôÂÆåÊàêÔºåÁõ¥Êé•Âü∑Ë°åÊâìÂç°
                    document.getElementById('proceedBtn').style.display = 'block';
                    document.getElementById('proceedBtn').textContent = 'üöÄ ÈñãÂïüÊâìÂç°È†ÅÈù¢';
                }
            }, 800);
        }

        // ÂâçÂæÄÊâìÂç°
        function proceedToCheckin() {
            closeAutoCheckin();
            
            // Ë®òÈåÑËá™ÂãïÊâìÂç°‰∫ã‰ª∂
            logAutoCheckinEvent();
            
            // ÁôºÈÄÅ Teams ÈñãÂßãÊâìÂç°ÈÄöÁü•
            sendTeamsNotification(
                'üöÄ Ëá™ÂãïÊâìÂç°Âü∑Ë°å',
                `Ë°å‰∫ãÊõÜÊèêÈÜíËß∏ÁôºËá™ÂãïÊâìÂç°\nÊôÇÈñìÔºö${new Date().toLocaleString()}\nÂç≥Â∞áÈñãÂïüÊâìÂç°È†ÅÈù¢`,
                'ÊèêÈÜí'
            );
            
            // ÈñãÂïüÊâìÂç°È†ÅÈù¢
            window.open(settings.checkinUrl, '_blank');
            
            showMessage('üöÄ Â∑≤ÈñãÂïüÊâìÂç°È†ÅÈù¢ÔºÅTeams ÈÄöÁü•Â∑≤ÁôºÈÄÅ„ÄÇ', 'success');
            
            // Âª∂ÈÅ≤Ê™¢Êü•ÊâìÂç°ÁµêÊûúÔºàÁµ¶Áî®Êà∂ÊôÇÈñìÂÆåÊàêÊâìÂç°Ôºâ
            setTimeout(() => {
                checkCheckinResult();
            }, 30000); // 30ÁßíÂæåÊ™¢Êü•
        }

        // ÈóúÈñâËá™ÂãïÊâìÂç°‰ªãÈù¢
        function closeAutoCheckin() {
            var autoCheckinDiv = document.getElementById('autoCheckinInterface');
            if (autoCheckinDiv) {
                autoCheckinDiv.style.display = 'none';
            }
        }

        // Ë®òÈåÑËá™ÂãïÊâìÂç°‰∫ã‰ª∂
        function logAutoCheckinEvent() {
            var event = {
                timestamp: new Date().toISOString(),
                source: 'auto',
                checkinTime: settings.checkinTime,
                actualTime: new Date().toTimeString().substr(0, 5)
            };
            
            var logs = JSON.parse(localStorage.getItem('checkin_logs') || '[]');
            logs.push(event);
            
            // Âè™‰øùÁïôÊúÄËøë 30 Á≠ÜË®òÈåÑ
            if (logs.length > 30) {
                logs = logs.slice(-30);
            }
            
            localStorage.setItem('checkin_logs', JSON.stringify(logs));
            console.log('üìù Ëá™ÂãïÊâìÂç°‰∫ã‰ª∂Â∑≤Ë®òÈåÑ:', event);
        }

        // Ê∏¨Ë©¶Ë°å‰∫ãÊõÜÂñöÈÜíÂäüËÉΩ
        function testCalendarWakeup() {
            showMessage('üß™ Ê®°Êì¨Ë°å‰∫ãÊõÜÂñöÈÜíÊ∏¨Ë©¶...', 'info');
            
            // Êõ¥Êñ∞ URL ÂåÖÂê´Ê∏¨Ë©¶ÂèÉÊï∏
            var testUrl = window.location.href.split('?')[0] + '?wakeup=calendar&time=' + 
                         new Date().toTimeString().substr(0, 5).replace(':', '') + '&test=true';
            
            // Âª∂ÈÅ≤Âü∑Ë°åÔºåÊ®°Êì¨ÁúüÂØ¶ÂñöÈÜíÊÉÖÂ¢É
            setTimeout(() => {
                history.pushState({}, '', testUrl);
                executeAutoCheckin('calendar');
            }, 1000);
        }

        // Teams ÈÄöÁü•ÂäüËÉΩ
        function sendTeamsNotification(title, message, level) {
            if (!settings.teamsEnabled || !settings.teamsWebhook) {
                console.log('Teams ÈÄöÁü•Â∑≤ÂÅúÁî®ÊàñÊú™Ë®≠ÂÆö Webhook');
                return Promise.resolve();
            }

            var levelColors = {
                "ÊàêÂäü": "00FF00",  // Á∂†Ëâ≤
                "ÈåØË™§": "FF0000",  // Á¥ÖËâ≤
                "ÊèêÈÜí": "FFFF00"   // ÈªÉËâ≤
            };

            var currentTime = new Date().toLocaleString('zh-TW');
            var deviceName = navigator.userAgent.includes('iPhone') ? 'iPhone' : 
                           navigator.userAgent.includes('iPad') ? 'iPad' : 'iOS Ë£ùÁΩÆ';
            var color = levelColors[level] || "00FF00";

            var payload = {
                "@type": "MessageCard",
                "@context": "http://schema.org/extensions",
                "themeColor": color,
                "title": title,
                "text": message,
                "sections": [{
                    "facts": [
                        {"name": "Ë£ùÁΩÆÂêçÁ®±", "value": deviceName},
                        {"name": "Âü∑Ë°åÊôÇÈñì", "value": currentTime},
                        {"name": "‰æÜÊ∫ê", "value": "MphasisÊâìÂç°Á≥ªÁµ±"}
                    ]
                }]
            };

            return sendTeamsWebhook(payload, settings.teamsWebhook)
                .catch(error => {
                    console.error('‰∏ªË¶Å Webhook ÁôºÈÄÅÂ§±Êïó:', error);
                    if (settings.teamsBackupWebhook) {
                        console.log('ÂòóË©¶ÂÇôÁî® Webhook...');
                        return sendTeamsWebhook(payload, settings.teamsBackupWebhook);
                    }
                    throw error;
                });
        }

        // ÁôºÈÄÅ Teams Webhook
        function sendTeamsWebhook(payload, webhookUrl) {
            console.log('üì§ ‰ΩøÁî® no-cors Ê®°ÂºèÁôºÈÄÅ Teams ÈÄöÁü•...');
            
            return fetch(webhookUrl, {
                method: 'POST',
                mode: 'no-cors',  // üéØ ÈóúÈçµÔºÅ‰ΩøÁî® no-cors Ê®°ÂºèÁπûÈÅé CORS ÈôêÂà∂
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                // no-cors Ê®°Âºè‰∏ã response.type ÊúÉÊòØ 'opaque'ÔºåÁÑ°Ê≥ïËÆÄÂèñÁãÄÊÖãÁ¢º
                console.log('‚úÖ Teams ÈÄöÁü•ÁôºÈÄÅÊàêÂäü (no-cors Ê®°Âºè)');
                console.log('üì° ÂõûÊáâÈ°ûÂûã:', response.type);
                showMessage('üì§ Teams ÈÄöÁü•ÁôºÈÄÅÊàêÂäüÔºÅ', 'success');
                return response;
            })
            .catch(error => {
                console.error('‚ùå no-cors ÁôºÈÄÅÂ§±Êïó:', error.message);
                console.log('üîÑ ÂòóË©¶‰ΩøÁî® CORS ‰ª£ÁêÜ‰ΩúÁÇ∫ÂÇôÁî®ÊñπÊ°à...');
                
                // Â¶ÇÊûú no-cors ‰πüÂ§±ÊïóÔºåÊâç‰ΩøÁî®‰ª£ÁêÜ
                showMessage('‚ö†Ô∏è Áõ¥Êé•ÁôºÈÄÅÂ§±ÊïóÔºåÂòóË©¶‰ª£ÁêÜÊñπÊ°à...', 'warning');
                return sendTeamsWebhookWithProxy(payload, webhookUrl);
            });
        }

        // ‰ΩøÁî® CORS ‰ª£ÁêÜÁôºÈÄÅ Teams Webhook
        function sendTeamsWebhookWithProxy(payload, webhookUrl) {
            var proxyUrl = 'https://api.allorigins.win/raw?url=';
            var fullUrl = proxyUrl + encodeURIComponent(webhookUrl);
            
            console.log('üîÑ ‰ΩøÁî®‰ª£ÁêÜ URL:', proxyUrl);
            
            return fetch(fullUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    console.log('‚úÖ ‰ª£ÁêÜÁôºÈÄÅÊàêÂäü');
                    showMessage('üì§ Teams ÈÄöÁü•ÁôºÈÄÅÊàêÂäü (ÈÄèÈÅé‰ª£ÁêÜ)', 'success');
                } else {
                    throw new Error(`‰ª£ÁêÜÂõûÊáâÈåØË™§: HTTP ${response.status}`);
                }
            })
            .catch(error => {
                console.error('‚ùå ‰ª£ÁêÜÁôºÈÄÅ‰πüÂ§±Êïó:', error.message);
                showMessage('‚ùå Teams ÈÄöÁü•ÁôºÈÄÅÂ§±Êïó (Áõ¥Êé•Âíå‰ª£ÁêÜÈÉΩÂ§±Êïó)', 'error');
                
                // Êèê‰æõÊâãÂãïËß£Ê±∫ÊñπÊ°à
                showManualSolution(webhookUrl, payload);
                throw error;
            });
        }

        // È°ØÁ§∫ÊâãÂãïËß£Ê±∫ÊñπÊ°à
        function showManualSolution(webhookUrl, payload) {
            var solutionMessage = `
üîß Ëá™ÂãïÁôºÈÄÅÂ§±ÊïóÔºåË´ãÂòóË©¶‰ª•‰∏ãËß£Ê±∫ÊñπÊ°àÔºö

1. üì± ‰ΩøÁî® iOS Êç∑ÂæëÔºö
   - ÈñãÂïü„ÄåÊç∑Âæë„ÄçÊáâÁî®
   - Âª∫Á´ãÊñ∞Êç∑ÂæëÁôºÈÄÅ Teams ÈÄöÁü•
   
2. üåê Ê™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÔºö
   - Á¢∫Ë™çÂèØ‰ª•Ê≠£Â∏∏‰∏äÁ∂≤
   - ÂòóË©¶ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
   
3. üîó È©óË≠â Webhook URLÔºö
   - Á¢∫Ë™ç URL Ê≠£Á¢∫‰∏îÊú™ÈÅéÊúü
   - Âú® Teams ‰∏≠ÈáçÊñ∞ÁîüÊàê Webhook

4. üîß ‰ΩøÁî®Ë®∫Êñ∑Â∑•ÂÖ∑Ôºö
   - ÈªûÊìä„ÄåÈñãÂïüÁç®Á´ãÊ∏¨Ë©¶Â∑•ÂÖ∑„ÄçÈÄ≤Ë°åË©≥Á¥∞Ë®∫Êñ∑
            `;
            
            console.log(solutionMessage);
            
            // ÂèØ‰ª•ÈÅ∏ÊìáÊÄßÂú∞È°ØÁ§∫Êõ¥Ë©≥Á¥∞ÁöÑÈåØË™§Ë®äÊÅØ
            setTimeout(() => {
                if (confirm('Teams ÈÄöÁü•Ëá™ÂãïÁôºÈÄÅÂ§±Êïó„ÄÇÊòØÂê¶Ë¶ÅÈñãÂïüÈÄ≤ÈöéË®∫Êñ∑Â∑•ÂÖ∑Ôºü')) {
                    window.open('teams_advanced_test.html?webhook=' + encodeURIComponent(webhookUrl), '_blank');
                }
            }, 2000);
        }

        // Ê™¢Êü•ÊâìÂç°ÁµêÊûú
        function checkCheckinResult() {
            // Á∞°ÂñÆÁöÑÊâìÂç°ÁµêÊûúÊ™¢Êü•ÈÇèËºØ
            // ÂØ¶Èöõ‰∏äÔºåÁî±ÊñºË∑®ÂüüÈôêÂà∂ÔºåÊàëÂÄëÁÑ°Ê≥ïÁõ¥Êé•Ê™¢Êü•ÊâìÂç°Á∂≤Á´ôÁöÑÁãÄÊÖã
            // ÊâÄ‰ª•ÈÄôË£°‰∏ªË¶ÅÊòØÁôºÈÄÅ‰∏ÄÂÄãÂÆåÊàêÈÄöÁü•
            
            sendTeamsNotification(
                '‚úÖ Ëá™ÂãïÊâìÂç°ÊµÅÁ®ãÂÆåÊàê',
                `ÊâìÂç°È†ÅÈù¢Â∑≤ÈñãÂïü\nÊôÇÈñìÔºö${new Date().toLocaleString()}\nË´ãÁ¢∫Ë™çÊâìÂç°ÊòØÂê¶ÊàêÂäü\n\nüí° Áî±ÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÁÑ°Ê≥ïËá™ÂãïÊ™¢Ê∏¨ÊâìÂç°ÁµêÊûúÔºåË´ãÊâãÂãïÁ¢∫Ë™çÊâìÂç°ÁãÄÊÖã„ÄÇ`,
                'ÊàêÂäü'
            );
        }

        // Âø´ÈÄüÈÄ±ÈñìÊó•ÊúüÂàáÊèõ
        function toggleQuickDay(day) {
            var dayBtn = document.querySelector('.quick-day-btn[data-day="' + day + '"]');
            var index = quickWeeklyDays.indexOf(day);
            
            if (index > -1) {
                quickWeeklyDays.splice(index, 1);
                dayBtn.classList.remove('selected');
            } else {
                quickWeeklyDays.push(day);
                dayBtn.classList.add('selected');
            }
            
            console.log('Âø´ÈÄüË®≠ÂÆöÈÄ±ÈñìÈÅ∏Êìá:', quickWeeklyDays);
        }

        // ÈÅ∏ÊìáÂ∑•‰ΩúÊó• (ÈÄ±‰∏ÄÂà∞ÈÄ±‰∫î)
        function selectWorkdays() {
            quickWeeklyDays = [1, 2, 3, 4, 5];
            updateQuickWeeklyDisplay();
            showMessage('üìÖ Â∑≤ÈÅ∏ÊìáÂ∑•‰ΩúÊó• (ÈÄ±‰∏ÄÂà∞ÈÄ±‰∫î)', 'info');
        }

        // ÈÅ∏ÊìáÂÖ®ÈÉ®Êó•Êúü
        function selectAllDays() {
            quickWeeklyDays = [0, 1, 2, 3, 4, 5, 6];
            updateQuickWeeklyDisplay();
            showMessage('üóìÔ∏è Â∑≤ÈÅ∏ÊìáÂÖ®ÈÉ®Êó•Êúü (ÈÄ±‰∏ÄÂà∞ÈÄ±Êó•)', 'info');
        }

        // Êõ¥Êñ∞Âø´ÈÄüÈÄ±ÈñìÈ°ØÁ§∫
        function updateQuickWeeklyDisplay() {
            // Ê∏ÖÈô§ÊâÄÊúâÈÅ∏‰∏≠ÁãÄÊÖã
            document.querySelectorAll('.quick-day-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            
            // Ë®≠ÂÆöÈÅ∏‰∏≠ÁãÄÊÖã
            quickWeeklyDays.forEach(function(day) {
                var dayBtn = document.querySelector('.quick-day-btn[data-day="' + day + '"]');
                if (dayBtn) {
                    dayBtn.classList.add('selected');
                }
            });
        }

        // Âø´ÈÄüË®≠ÂÆö
        function quickSetup() {
            console.log('üîß quickSetup() ÂáΩÊï∏Ë¢´ÂëºÂè´');
            
            var checkinTime = document.getElementById('quickCheckinTime').value;
            var reminderMinutes = parseInt(document.getElementById('quickReminderTime').value);
            var excludeHolidays = document.getElementById('quickExcludeHolidays').checked;
            
            console.log('üìã Ë®≠ÂÆöÂÄº:', {
                checkinTime: checkinTime,
                reminderMinutes: reminderMinutes,
                excludeHolidays: excludeHolidays,
                quickWeeklyDays: quickWeeklyDays
            });
            
            if (!checkinTime) {
                console.log('‚ùå ÊâìÂç°ÊôÇÈñìÊú™Ë®≠ÂÆö');
                showMessage('‚ùå Ë´ãË®≠ÂÆöÊâìÂç°ÊôÇÈñì', 'error');
                return;
            }
            
            if (quickWeeklyDays.length === 0) {
                console.log('‚ùå Êú™ÈÅ∏ÊìáÊâìÂç°Êó•Êúü');
                showMessage('‚ùå Ë´ãÈÅ∏ÊìáËá≥Â∞ë‰∏ÄÂÄãÊâìÂç°Êó•Êúü', 'error');
                return;
            }
            
            // Êõ¥Êñ∞Ë®≠ÂÆö
            settings.checkinTime = checkinTime;
            settings.reminderMinutes = reminderMinutes;
            settings.weeklyDays = quickWeeklyDays.slice(); // Ë§áË£ΩÈô£Âàó
            settings.excludeHolidays = excludeHolidays;
            saveSettings();
            
            var dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            var selectedDaysText = quickWeeklyDays.map(day => 'ÈÄ±' + dayNames[day]).join('„ÄÅ');
            
            showMessage('‚ö° Âø´ÈÄüË®≠ÂÆöÂÆåÊàêÔºÅ\n' +
                       'üïê ÊôÇÈñìÔºö' + checkinTime + '\n' +
                       'üìÖ Êó•ÊúüÔºö' + selectedDaysText + '\n' +
                       '‚è∞ ÊèêÈÜíÔºöÊèêÂâç' + reminderMinutes + 'ÂàÜÈêò\n' +
                       'üèñÔ∏è ÂÅáÊó•Ôºö' + (excludeHolidays ? 'Ëá™ÂãïÊéíÈô§' : '‰∏çÊéíÈô§') + '\n' +
                       'üìÖ Ê≠£Âú®Ë®≠ÂÆö iOS Ë°å‰∫ãÊõÜÊèêÈÜí...', 'success');
            
            // Âè™Ë®≠ÂÆö iOS Ë°å‰∫ãÊõÜ
            setTimeout(() => setupIOSCalendar(), 1000);
        }

        // Ë®≠ÂÆö iOS Êó•ÊõÜ
        function setupIOSCalendar() {
            console.log('üìÖ setupIOSCalendar() ÂáΩÊï∏Ë¢´ÂëºÂè´');
            console.log('üìã ÁõÆÂâç settings:', settings);
            
            // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÈáçË§áË®≠ÂÆö
            var lastCalendarSetup = localStorage.getItem('lastCalendarSetup');
            var currentSetup = JSON.stringify({
                time: settings.checkinTime,
                days: settings.weeklyDays,
                holidays: settings.excludeHolidays
            });
            
            if (lastCalendarSetup && lastCalendarSetup === currentSetup) {
                showMessage('‚ö†Ô∏è Áõ∏ÂêåÁöÑË°å‰∫ãÊõÜË®≠ÂÆöÂ∑≤Â≠òÂú®ÔºÅ\n\nÂ¶ÇÊûúÈúÄË¶ÅÈáçÊñ∞‰∏ãËºâÔºåË´ãÁπºÁ∫å„ÄÇ', 'warning');
                if (!confirm('Áõ∏ÂêåÁöÑË°å‰∫ãÊõÜË®≠ÂÆöÂ∑≤Â≠òÂú®ÔºåÊòØÂê¶ÈáçÊñ∞‰∏ãËºâÔºü')) {
                    return;
                }
            } else if (lastCalendarSetup) {
                var lastSettings = JSON.parse(lastCalendarSetup);
                showMessage(`‚ö†Ô∏è ÂÅµÊ∏¨Âà∞ËàäÁöÑË°å‰∫ãÊõÜË®≠ÂÆöÔºÅ\n\n` +
                           `ËàäË®≠ÂÆöÔºö${lastSettings.time}\n` +
                           `Êñ∞Ë®≠ÂÆöÔºö${settings.checkinTime}\n\n` +
                           `‚ùó ÈáçË¶ÅÔºöË´ãÊâãÂãïÂà™Èô§ËàäÁöÑË°å‰∫ãÊõÜÊèêÈÜíÔºåÈÅøÂÖçÈáçË§áÈÄöÁü•ÔºÅ`, 'warning');
                
                // Âª∂ÈÅ≤È°ØÁ§∫Ê∏ÖÁêÜË™™Êòé
                setTimeout(() => {
                    showCalendarCleanupInstructions(lastSettings);
                }, 2000);
            }
            
            var timeParts = settings.checkinTime.split(':');
            var reminderHour = parseInt(timeParts[0]);
            var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
            
            if (reminderMinute < 0) {
                reminderMinute += 60;
                reminderHour -= 1;
            }
            
            // ËΩâÊèõÈÄ±ÈñìÈÅ∏ÊìáÁÇ∫ iCal Ê†ºÂºè
            var dayMapping = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
            var selectedDays = settings.weeklyDays.map(day => dayMapping[day]).join(',');
            
            // ÁîüÊàêÂñöÈÜí URLÔºàÁï∂ÂâçÈ†ÅÈù¢ + Ë°å‰∫ãÊõÜÂñöÈÜíÂèÉÊï∏Ôºâ
            var wakeupUrl = window.location.href.split('?')[0] + '?wakeup=calendar&time=' + 
                           reminderHour.toString().padStart(2, '0') + 
                           reminderMinute.toString().padStart(2, '0');
            
            // ‰ΩøÁî®Ê∏¨Ë©¶ÁâàÁ¢∫ÂØ¶ÊúâÊïàÁöÑÁ∞°ÂñÆÊ†ºÂºè
            var icalContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MphasisÊâìÂç°Á≥ªÁµ±//NONSGML//EN
BEGIN:VEVENT
SUMMARY:üéØ Mphasis Ëá™ÂãïÊâìÂç°ÊèêÈÜí
DESCRIPTION:üì± Êô∫ÊÖßÊâìÂç°Á≥ªÁµ±ÂïüÂãïÔºÅÈªûÊìäÊ≠§ÊèêÈÜíÂ∞áËá™ÂãïÈñãÂïüÊâìÂç°ÊáâÁî®
DTSTART:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute).toString().padStart(2, '0')}00Z
DTEND:20250101T${reminderHour.toString().padStart(2, '0')}${Math.max(0, reminderMinute + 15).toString().padStart(2, '0')}00Z
RRULE:FREQ=WEEKLY;BYDAY=${selectedDays}
URL:${wakeupUrl}
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:üöÄ Á´ãÂç≥ÊâìÂç°ÔºÅÈªûÊìäÈñãÂïüÊô∫ÊÖßÊâìÂç°Á≥ªÁµ±
URL:${wakeupUrl}
END:VALARM
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:‚è∞ 5ÂàÜÈêòÂæåÈúÄË¶ÅÊâìÂç°ÔºÅÊ∫ñÂÇôÈñãÂßã
END:VALARM
END:VEVENT`;

            // Â¶ÇÊûúÂïüÁî®ÂÅáÊó•ÊéíÈô§ÔºåÂä†ÂÖ•ÂÅáÊó•‰æãÂ§ñ (‰ΩøÁî® 2025 Âπ¥‰ΩúÁÇ∫Âü∫Ê∫ñ)
            if (settings.excludeHolidays) {
                var holidays = [
                    '20250101', // ÂÖÉÊó¶
                    '20250128', // Ëæ≤ÊõÜÊñ∞Âπ¥ (2025Âπ¥ÁØÑ‰æã)
                    '20250129',
                    '20250130',
                    '20250404', // ÂÖíÁ´•ÁØÄ
                    '20250405', // Ê∏ÖÊòéÁØÄ
                    '20250501', // ÂãûÂãïÁØÄ
                    '20250531', // Á´ØÂçàÁØÄ (2025Âπ¥ÁØÑ‰æã)
                    '20250906', // ‰∏≠ÁßãÁØÄ (2025Âπ¥ÁØÑ‰æã)
                    '20251010'  // ÂúãÊÖ∂Êó•
                ];
                
                // ‰ΩøÁî®Ëàá DTSTART Áõ∏ÂêåÁöÑÂõ∫ÂÆöÊôÇÈñìÊ†ºÂºè
                icalContent += '\nEXDATE:' + holidays.map(date => date + 'T' + 
                    reminderHour.toString().padStart(2, '0') + 
                    Math.max(0, reminderMinute).toString().padStart(2, '0') + '00Z').join(',');
            }

            icalContent += '\nEND:VEVENT\nEND:VCALENDAR';
            
            // ÂÖàÂÑ≤Â≠òÂÖßÂÆπ‰æõÂæåÁ∫å‰ΩøÁî®
            window.tempCalendarContent = icalContent;
            
            // iOS Safari Â∞àÁî®‰∏ãËºâÁ≠ñÁï•
            var isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            var downloadSuccess = false;
            
            // Ë®àÁÆóÈÅ∏ÊìáÁöÑÂ§©Êï∏ÊñáÂ≠ó
            var dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            var selectedDaysText = settings.weeklyDays.map(day => 'ÈÄ±' + dayNames[day]).join('„ÄÅ');
            
            // ‰ΩøÁî®Ê∏¨Ë©¶ÁâàÁ¢∫ÂØ¶ÊúâÊïàÁöÑÊñπÊ≥ï
            console.log('üì± ‰ΩøÁî®Ê∏¨Ë©¶ÁâàÈ©óË≠âÊàêÂäüÁöÑ‰∏ãËºâÊñπÊ≥ï');
            
            try {
                // Ê∏¨Ë©¶ÁâàÁöÑÊàêÂäüÊñπÊ°àÔºöÁõ¥Êé•‰ΩøÁî® data URL + window.open
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    console.log('‚úÖ Data URL ÊàêÂäüÈñãÂïüÊñ∞Ë¶ñÁ™ó');
                    showMessage('üìÖ Ë°å‰∫ãÊõÜÊ™îÊ°àÂ∑≤Âú®Êñ∞Ë¶ñÁ™óÈñãÂïüÔºÅ\n\nüì± iOS Êìç‰ΩúÊ≠•È©üÔºö\n1. Âú®Êñ∞Ë¶ñÁ™ó‰∏≠ÈªûÊìäÂè≥‰∏äËßí„ÄåÂàÜ‰∫´„Äç\n2. ÈÅ∏Êìá„ÄåÂä†ÂÖ•Ë°å‰∫ãÊõÜ„Äç\n3. Á¢∫Ë™çÂåØÂÖ•Ë®≠ÂÆö\n\n‚úÖ ‰ΩøÁî®Ê∏¨Ë©¶ÁâàÈ©óË≠âÊàêÂäüÁöÑÊñπÊ≥ï', 'success');
                    downloadSuccess = true;
                } else {
                    console.log('‚ùå Data URL Â§±ÊïóÔºöÂΩàÂá∫Ë¶ñÁ™óË¢´ÈòªÊìã');
                    // ÂÇôÁî®ÊñπÊ°àÔºöÈ°ØÁ§∫ iOS Â∞àÁî®ÈÅ∏È†Ö
                    showIOSCalendarHelp(icalContent, selectedDaysText);
                    downloadSuccess = true;
                }
            } catch (error) {
                console.error('Data URL ÊñπÊ≥ïÂ§±Êïó:', error);
                // ÊúÄÁµÇÂÇôÁî®ÊñπÊ°à
                showIOSCalendarHelp(icalContent, selectedDaysText);
                downloadSuccess = true;
            }
            
            // ÂÑ≤Â≠òÁï∂ÂâçË®≠ÂÆöÔºåÁî®ÊñºÈáçË§áÂÅµÊ∏¨
            localStorage.setItem('lastCalendarSetup', currentSetup);
        }

        // iOS Â∞àÁî®Ë°å‰∫ãÊõÜÂπ´Âä©
        function showIOSCalendarHelp(icalContent, selectedDaysText) {
            var dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            // Â¶ÇÊûúÊ≤íÊúâÂÇ≥ÂÖ• selectedDaysTextÔºåÂâáÁîüÊàê‰∏ÄÂÄã
            if (!selectedDaysText) {
                selectedDaysText = settings.weeklyDays.map(day => 'ÈÄ±' + dayNames[day]).join('„ÄÅ');
            }
            
            showMessage('üìÖ iOS Ë°å‰∫ãÊõÜË®≠ÂÆöÂÆåÊàêÔºÅ\n\n' +
                       'üìã Ë®≠ÂÆöÂÖßÂÆπÔºö\n' +
                       'üïê ' + settings.checkinTime + ' ÊâìÂç°ÊèêÈÜí\n' +
                       'üìÖ ' + selectedDaysText + '\n' +
                       'üèñÔ∏è ' + (settings.excludeHolidays ? 'Â∑≤ÊéíÈô§ÂÅáÊó•' : 'ÂåÖÂê´ÂÅáÊó•') + '\n\n' +
                       '‚¨áÔ∏è Ë´ã‰ΩøÁî®‰∏ãÊñπÈÅ∏È†ÖÂÆåÊàêË®≠ÂÆö', 'success');
            
            // Á´ãÂç≥È°ØÁ§∫ iOS Â∞àÁî®ÈÅ∏È†Ö
            setTimeout(() => {
                showIOSCalendarOptions(icalContent, selectedDaysText);
            }, 500);
        }

        // iOS Â∞àÁî®Ë°å‰∫ãÊõÜÈÅ∏È†Ö
        function showIOSCalendarOptions(icalContent, selectedDaysText) {
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 420px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF6B35; margin-bottom: 16px; text-align: center;">üìÖ iOS Ë°å‰∫ãÊõÜË®≠ÂÆö</h3>
                    
                    <div style="background: #e3f2fd; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #2196F3;">
                        <p style="margin: 0; color: #1565C0; font-size: 14px; line-height: 1.5;">
                            <strong>üí° iOS Safari ÈôêÂà∂Ôºö</strong>Áî±ÊñºÂÆâÂÖ®ÊîøÁ≠ñÔºåÁÑ°Ê≥ïËá™Âãï‰∏ãËºâÊ™îÊ°à„ÄÇË´ãÈÅ∏Êìá‰ª•‰∏ãÊñπÂºè‰πã‰∏ÄÔºö
                        </p>
                    </div>
                    
                    <button onclick="tryDataURLMethod()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üöÄ ÊñπÊ≥ï‰∏ÄÔºöÁõ¥Êé•ÈñãÂïüË°å‰∫ãÊõÜ
                    </button>
                    
                    <button onclick="tryDownloadMethod()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üì• ÊñπÊ≥ï‰∫åÔºö‰∏ãËºâ .ics Ê™îÊ°à
                    </button>
                    
                    <button onclick="copyCalendarContent()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #FF9800; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üìã ÊñπÊ≥ï‰∏âÔºöË§áË£ΩÂÖßÂÆπÊâãÂãïÂª∫Á´ã
                    </button>
                    
                    <button onclick="showDetailedIOSSteps()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #9C27B0; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
                        üìñ Ë©≥Á¥∞Ë®≠ÂÆöÊ≠•È©üË™™Êòé
                    </button>
                    
                    <button onclick="closeIOSCalendarOptions()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        ÈóúÈñâ
                    </button>
                </div>
            `;
            
            // ÂâµÂª∫Ê®°ÊÖãÊ°Ü
            var modal = document.createElement('div');
            modal.id = 'iosCalendarOptionsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // ÂÑ≤Â≠òÂÖßÂÆπ‰æõÂæåÁ∫å‰ΩøÁî®
            window.tempCalendarContent = icalContent;
            window.tempCalendarInfo = selectedDaysText;
        }

        // ÊñπÊ≥ï‰∏ÄÔºöData URL Áõ¥Êé•ÈñãÂïü
        function tryDataURLMethod() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            try {
                // ‰ΩøÁî® data URL ‰∏¶ÂòóË©¶Âú®Êñ∞Ë¶ñÁ™óÈñãÂïü
                var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
                var newWindow = window.open(dataUrl, '_blank');
                
                if (newWindow) {
                    showMessage('‚úÖ Â∑≤Âú®Êñ∞Ë¶ñÁ™óÈñãÂïüË°å‰∫ãÊõÜÊ™îÊ°àÔºÅ\n\nüì± Ë´ãÂú®Êñ∞Ë¶ñÁ™ó‰∏≠Ôºö\n1. ÈªûÊìäÂè≥‰∏äËßí„ÄåÂàÜ‰∫´„ÄçÊåâÈàï\n2. ÈÅ∏Êìá„ÄåÂä†ÂÖ•Ë°å‰∫ãÊõÜ„Äç\n3. Á¢∫Ë™çÂåØÂÖ•Ë®≠ÂÆö', 'success');
                } else {
                    showMessage('‚ùå ÂΩàÂá∫Ë¶ñÁ™óË¢´ÈòªÊìãÔºåË´ãÂòóË©¶ÂÖ∂‰ªñÊñπÊ≥ï', 'error');
                    tryDownloadMethod();
                }
            } catch (error) {
                console.log('Data URL ÊñπÊ≥ïÂ§±Êïó:', error);
                tryDownloadMethod();
            }
        }

        // ÊñπÊ≥ï‰∫åÔºöÂº∑Âà∂‰∏ãËºâ
        function tryDownloadMethod() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            try {
                // ÂâµÂª∫Èö±ËóèÁöÑ‰∏ãËºâÈÄ£Áµê
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent));
                element.setAttribute('download', 'mphasis-checkin-calendar.ics');
                element.style.display = 'none';
                
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                
                showMessage('üì• Ë°å‰∫ãÊõÜÊ™îÊ°àÊ∫ñÂÇô‰∏ãËºâ‰∏≠...\n\nüì± Â¶ÇÊûúÊ≤íÊúâËá™Âãï‰∏ãËºâÔºö\n1. Èï∑Êåâ„Äåüì• ÊñπÊ≥ï‰∫å„ÄçÊåâÈàï\n2. ÈÅ∏Êìá„Äå‰∏ãËºâÈÄ£ÁµêÊ™îÊ°à„Äç\n3. ÊâæÂà∞‰∏ãËºâÁöÑ .ics Ê™îÊ°à‰∏¶ÈñãÂïü\n4. ÈÅ∏Êìá„ÄåÂä†ÂÖ•Ë°å‰∫ãÊõÜ„Äç', 'info');
                
            } catch (error) {
                console.log('‰∏ãËºâÊñπÊ≥ïÂ§±Êïó:', error);
                showMessage('‚ùå Ëá™Âãï‰∏ãËºâÂ§±ÊïóÔºåË´ã‰ΩøÁî®Ë§áË£ΩÂÖßÂÆπÊñπÊ≥ï', 'error');
            }
        }

        // È°ØÁ§∫Ë°å‰∫ãÊõÜÊ∏ÖÁêÜË™™Êòé
        function showCalendarCleanupInstructions(oldSettings) {
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 450px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF9800; margin-bottom: 16px; text-align: center;">‚ö†Ô∏è Ê∏ÖÁêÜËàäÁöÑË°å‰∫ãÊõÜÊèêÈÜí</h3>
                    
                    <div style="background: #fff3e0; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #FF9800;">
                        <p style="margin: 0; color: #E65100; font-size: 14px; line-height: 1.5;">
                            <strong>ÈáçË¶ÅÔºö</strong>ÊÇ®ÈúÄË¶ÅÊâãÂãïÂà™Èô§ËàäÁöÑÊèêÈÜíÔºåÈÅøÂÖçÊî∂Âà∞ÈáçË§áÈÄöÁü•ÔºÅ
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <p style="margin: 0 0 8px 0; font-weight: 600;">ËàäË®≠ÂÆöË≥áË®äÔºö</p>
                        <p style="margin: 0; font-family: monospace; font-size: 14px;">
                            ‚è∞ ÊôÇÈñìÔºö${oldSettings.time}<br>
                            üìÖ ÈÄ±ÈñìÔºö${oldSettings.days ? oldSettings.days.map(d => ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][d]).join('„ÄÅ') : 'Êú™Ë®≠ÂÆö'}
                        </p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #4CAF50;">
                        <p style="margin: 0 0 12px 0; font-weight: 600; color: #2E7D32;">üì± iOS Ë°å‰∫ãÊõÜÊ∏ÖÁêÜÊ≠•È©üÔºö</p>
                        <ol style="margin: 0; padding-left: 16px; color: #2E7D32; font-size: 14px; line-height: 1.6;">
                            <li>ÈñãÂïü„ÄåË°å‰∫ãÊõÜ„Äçapp</li>
                            <li>ÊâæÂà∞„ÄåMphasis Ëá™ÂãïÊâìÂç°ÊèêÈÜí„Äç‰∫ã‰ª∂</li>
                            <li>ÈªûÊìäËàäÊôÇÈñìÁöÑÊèêÈÜí‰∫ã‰ª∂</li>
                            <li>ÈÅ∏Êìá„ÄåÂà™Èô§‰∫ã‰ª∂„ÄçÊàñ„ÄåÂà™Èô§ÈáçË§á‰∫ã‰ª∂„Äç</li>
                            <li>Á¢∫Ë™çÂà™Èô§ÊâÄÊúâËàäÁöÑÈáçË§á‰∫ã‰ª∂</li>
                        </ol>
                    </div>
                    
                    <button onclick="openCalendarApp()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        üìÖ ÈñãÂïüË°å‰∫ãÊõÜ App
                    </button>
                    
                    <button onclick="showDetailedCleanupSteps()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        üìñ Ë©≥Á¥∞Ê∏ÖÁêÜË™™Êòé
                    </button>
                    
                    <button onclick="closeCleanupInstructions()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        ÊàëÁü•ÈÅì‰∫Ü
                    </button>
                </div>
            `;
            
            // ÂâµÂª∫Ê®°ÊÖãÊ°Ü
            var modal = document.createElement('div');
            modal.id = 'cleanupInstructionsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        function openCalendarApp() {
            // ÂòóË©¶ÈñãÂïü iOS Ë°å‰∫ãÊõÜ app
            try {
                window.location.href = 'calshow://';
                showMessage('üìÖ Ê≠£Âú®ÈñãÂïüË°å‰∫ãÊõÜ App...', 'info');
            } catch (error) {
                showMessage('‚ö†Ô∏è ÁÑ°Ê≥ïËá™ÂãïÈñãÂïüÔºåË´ãÊâãÂãïÈñãÂïüË°å‰∫ãÊõÜ App', 'warning');
            }
        }

        function showDetailedCleanupSteps() {
            var detailedSteps = `üìÖ Ë©≥Á¥∞Ê∏ÖÁêÜËàäË°å‰∫ãÊõÜÊèêÈÜíÊ≠•È©üÔºö

üîç ÊâæÂà∞ËàäÊèêÈÜíÔºö
1. ÈñãÂïü iOS„ÄåË°å‰∫ãÊõÜ„Äçapp
2. ÂàáÊèõÂà∞„ÄåÂàóË°®„ÄçÊ™¢Ë¶ñÔºàÂ∫ïÈÉ®ÈÅ∏È†ÖÔºâ
3. ÊêúÂ∞ã„ÄåMphasis„ÄçÊàñ„ÄåÊâìÂç°„Äç
4. ÊâæÂà∞ËàäÊôÇÈñìÁöÑÊèêÈÜí‰∫ã‰ª∂

‚ùå Âà™Èô§ËàäÊèêÈÜíÔºö
1. ÈªûÊìäËàäÁöÑÊèêÈÜí‰∫ã‰ª∂
2. ÈªûÊìäÂè≥‰∏äËßí„ÄåÁ∑®ËºØ„Äç
3. ÊãâÂà∞ÊúÄ‰∏ãÊñπÈªûÊìä„ÄåÂà™Èô§‰∫ã‰ª∂„Äç
4. ÈÅ∏Êìá„ÄåÂà™Èô§ÊâÄÊúâÈáçË§á‰∫ã‰ª∂„Äç
5. Á¢∫Ë™çÂà™Èô§

‚úÖ Á¢∫Ë™çÊ∏ÖÁêÜÂÆåÊàêÔºö
1. ÊêúÂ∞ãÁ¢∫Ë™çÊ≤íÊúâËàäÊôÇÈñìÁöÑÊèêÈÜí
2. Á¢∫Ë™çÂè™ÊúâÊñ∞ÊôÇÈñìÁöÑÊèêÈÜíÂ≠òÂú®
3. Ê∏¨Ë©¶Êñ∞ÊèêÈÜíÊòØÂê¶Ê≠£Â∏∏

üí° Â∞èÊèêÁ§∫Ôºö
- Â¶ÇÊûúÊúâÂ§öÂÄãË°å‰∫ãÊõÜÔºåË´ãÊ™¢Êü•ÊâÄÊúâË°å‰∫ãÊõÜ
- ÂèØ‰ª•ÊåâÊôÇÈñìÊéíÂ∫è‰æÜÂø´ÈÄüÊâæÂà∞ËàäÊèêÈÜí
- Âà™Èô§ÂæåÂèØËÉΩÈúÄË¶ÅÁ≠âÂæÖÂπæÂàÜÈêòÊâçÊúÉÂÆåÂÖ®Ê∂àÂ§±`;

            alert(detailedSteps);
        }

        function closeCleanupInstructions() {
            var modal = document.getElementById('cleanupInstructionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Ë©≥Á¥∞ iOS Ë®≠ÂÆöÊ≠•È©ü
        function showDetailedIOSSteps() {
            var steps = `üìÖ iOS Ë°å‰∫ãÊõÜË©≥Á¥∞Ë®≠ÂÆöÊ≠•È©üÔºö

üî• Êé®Ëñ¶ÊñπÊ≥ïÔºöÁõ¥Êé•ÈñãÂïüË°å‰∫ãÊõÜÊ™îÊ°à
1. ÈªûÊìä„ÄåüöÄ ÊñπÊ≥ï‰∏ÄÔºöÁõ¥Êé•ÈñãÂïüË°å‰∫ãÊõÜ„Äç
2. Âú®Êñ∞ÈñãÂïüÁöÑÈ†ÅÈù¢‰∏≠ÈªûÊìäÂè≥‰∏äËßí„ÄåÂàÜ‰∫´„ÄçÂúñÁ§∫
3. ÈÅ∏Êìá„ÄåÂä†ÂÖ•Ë°å‰∫ãÊõÜ„ÄçÊàñ„ÄåË°å‰∫ãÊõÜ„Äç
4. Á¢∫Ë™çÂåØÂÖ•Âà∞È†êË®≠Ë°å‰∫ãÊõÜ
5. ÂÆåÊàêÔºÅ

üì• Êõø‰ª£ÊñπÊ≥ïÔºö‰∏ãËºâÊ™îÊ°à
1. ÈªûÊìä„Äåüì• ÊñπÊ≥ï‰∫åÔºö‰∏ãËºâ .ics Ê™îÊ°à„Äç
2. Â¶ÇÊûúÊ≤íÊúâËá™Âãï‰∏ãËºâÔºåÈï∑ÊåâË©≤ÊåâÈàïÈÅ∏Êìá„Äå‰∏ãËºâÈÄ£ÁµêÊ™îÊ°à„Äç
3. Âà∞ Safari ‰∏ãËºâÈ†ÖÁõÆ‰∏≠ÊâæÂà∞ .ics Ê™îÊ°à
4. ÈªûÊìäÊ™îÊ°àÈñãÂïüÔºåÈÅ∏Êìá„ÄåÂä†ÂÖ•Ë°å‰∫ãÊõÜ„Äç
5. Á¢∫Ë™çÂåØÂÖ•Ë®≠ÂÆö

üìã ÊâãÂãïÊñπÊ≥ïÔºöË§áË£ΩÂÖßÂÆπ
1. ÈªûÊìä„Äåüìã ÊñπÊ≥ï‰∏âÔºöË§áË£ΩÂÖßÂÆπÊâãÂãïÂª∫Á´ã„Äç
2. Ë§áË£ΩÈ°ØÁ§∫ÁöÑ iCal ÂÖßÂÆπ
3. ÈñãÂïü„ÄåË°å‰∫ãÊõÜ„ÄçappÔºåÈªûÊìäÂè≥‰∏äËßí„Äå+„Äç
4. ÈÅ∏Êìá„ÄåÂÖ∂‰ªñ„Äç‚Üí„ÄåÂåØÂÖ•Ë°å‰∫ãÊõÜ„Äç
5. Ë≤º‰∏äË§áË£ΩÁöÑÂÖßÂÆπ‰∏¶ÂÑ≤Â≠ò

‚úÖ Ë®≠ÂÆöÂÆåÊàêÂæåÔºö
- Ê™¢Êü•Ë°å‰∫ãÊõÜ‰∏≠ÊòØÂê¶Âá∫Áèæ„ÄåMphasis Ëá™ÂãïÊâìÂç°ÊèêÈÜí„Äç
- Á¢∫Ë™çÊèêÈÜíÊôÇÈñìÊ≠£Á¢∫
- Ê∏¨Ë©¶ÈªûÊìäÊèêÈÜíÊòØÂê¶ËÉΩÈñãÂïüÊâìÂç°ÊáâÁî®`;

            alert(steps);
        }

        function closeIOSCalendarOptions() {
            var modal = document.getElementById('iosCalendarOptionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // È°ØÁ§∫Ë°å‰∫ãÊõÜÁÆ°ÁêÜ‰ªãÈù¢
        function showCalendarManagement() {
            console.log('üóëÔ∏è ÈñãÂïüË°å‰∫ãÊõÜÁÆ°ÁêÜ‰ªãÈù¢');
            
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 480px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF9800; margin-bottom: 16px; text-align: center;">üóëÔ∏è Ë°å‰∫ãÊõÜÊéíÁ®ãÁÆ°ÁêÜ</h3>
                    
                    <div style="background: #fff3e0; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #FF9800;">
                        <p style="margin: 0; color: #E65100; font-size: 14px; line-height: 1.5;">
                            <strong>ÁÆ°ÁêÜÊÇ®ÁöÑÊâìÂç°ÊèêÈÜíÊéíÁ®ã</strong><br>
                            ÂèØ‰ª•Êü•Áúã„ÄÅÂà™Èô§Êàñ‰øÆÊîπÁèæÊúâÁöÑË°å‰∫ãÊõÜÊéíÁ®ã
                        </p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: #333;">üìã ÁõÆÂâçË®≠ÂÆöÁãÄÊÖã</h4>
                        <div id="currentCalendarSettings" style="font-family: monospace; font-size: 14px; line-height: 1.6;">
                            ËºâÂÖ•‰∏≠...
                        </div>
                    </div>
                    
                    <button onclick="openIOSCalendarApp()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üì± ÈñãÂïü iOS Ë°å‰∫ãÊõÜ App
                    </button>
                    
                    <button onclick="showCalendarDeletionGuide()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #FF5722; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üóëÔ∏è Âà™Èô§ÊéíÁ®ãÊåáÂçó
                    </button>
                    
                    <button onclick="showCalendarSearchGuide()" 
                            style="width: 100%; padding: 14px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: 600;">
                        üîç Êü•ÊâæÊéíÁ®ãÊåáÂçó
                    </button>
                    
                    <button onclick="clearCalendarHistory()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #9E9E9E; color: white; border: none; border-radius: 10px; font-size: 14px; cursor: pointer;">
                        üßπ Ê∏ÖÈô§Ê≠∑Âè≤Ë®òÈåÑ
                    </button>
                    
                    <button onclick="closeCalendarManagement()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        ÈóúÈñâ
                    </button>
                </div>
            `;
            
            // ÂâµÂª∫Ê®°ÊÖãÊ°Ü
            var modal = document.createElement('div');
            modal.id = 'calendarManagementModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // ËºâÂÖ•ÁõÆÂâçË®≠ÂÆö
            loadCurrentCalendarSettings();
        }

        function loadCurrentCalendarSettings() {
            setTimeout(() => {
                var settingsDiv = document.getElementById('currentCalendarSettings');
                if (settingsDiv) {
                    var lastSetup = localStorage.getItem('lastCalendarSetup');
                    var dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
                    
                    var settingsText = `üïê ÊâìÂç°ÊôÇÈñìÔºö${settings.checkinTime}
‚è∞ ÊèêÂâçÊèêÈÜíÔºö${settings.reminderMinutes} ÂàÜÈêò
üìÖ Â∑•‰ΩúÊó•Ôºö${settings.weeklyDays.map(d => 'ÈÄ±' + dayNames[d]).join('„ÄÅ')}
üèñÔ∏è ÊéíÈô§ÂÅáÊó•Ôºö${settings.excludeHolidays ? 'ÊòØ' : 'Âê¶'}

üìã Ê≠∑Âè≤Ë®òÈåÑÔºö`;

                    if (lastSetup) {
                        try {
                            var lastSettings = JSON.parse(lastSetup);
                            settingsText += `
‚úÖ ‰∏äÊ¨°Âª∫Á´ãÔºö${lastSettings.time || 'Êú™Áü•'}
üìÖ ‰∏äÊ¨°Â∑•‰ΩúÊó•Ôºö${lastSettings.days ? lastSettings.days.map(d => 'ÈÄ±' + dayNames[d]).join('„ÄÅ') : 'Êú™Áü•'}
üèñÔ∏è ‰∏äÊ¨°ÂÅáÊó•Ë®≠ÂÆöÔºö${lastSettings.holidays ? 'ÊéíÈô§' : 'ÂåÖÂê´'}`;
                        } catch (error) {
                            settingsText += `\n‚ùå Ê≠∑Âè≤Ë®òÈåÑËß£ÊûêÈåØË™§`;
                        }
                    } else {
                        settingsText += `\nüìù Â∞öÁÑ°Âª∫Á´ãË®òÈåÑ`;
                    }
                    
                    settingsDiv.textContent = settingsText;
                }
            }, 100);
        }

        function openIOSCalendarApp() {
            console.log('üì± ÂòóË©¶ÈñãÂïü iOS Ë°å‰∫ãÊõÜ App');
            
            try {
                // ÂòóË©¶Â§öÁ®Æ iOS Ë°å‰∫ãÊõÜ URL schemes
                var calendarSchemes = [
                    'calshow://',           // Ê®ôÊ∫ñË°å‰∫ãÊõÜ
                    'x-apple-calevent://',  // Ë°å‰∫ãÊõÜ‰∫ã‰ª∂
                    'webcal://',           // Á∂≤È†ÅË°å‰∫ãÊõÜ
                    'calendar://'          // Êõø‰ª£ÊñπÊ°à
                ];
                
                var schemeIndex = 0;
                
                function tryNextScheme() {
                    if (schemeIndex < calendarSchemes.length) {
                        var scheme = calendarSchemes[schemeIndex];
                        console.log(`ÂòóË©¶ URL scheme: ${scheme}`);
                        
                        window.location.href = scheme;
                        schemeIndex++;
                        
                        // Â¶ÇÊûú 1 ÁßíÂæåÈÇÑÊ≤íÊàêÂäüÔºåÂòóË©¶‰∏ã‰∏ÄÂÄã
                        setTimeout(tryNextScheme, 1000);
                    } else {
                        showMessage('‚ö†Ô∏è ÁÑ°Ê≥ïËá™ÂãïÈñãÂïüË°å‰∫ãÊõÜ App\nË´ãÊâãÂãïÈñãÂïü„ÄåË°å‰∫ãÊõÜ„ÄçÊáâÁî®Á®ãÂºè', 'warning');
                    }
                }
                
                tryNextScheme();
                showMessage('üì± Ê≠£Âú®ÂòóË©¶ÈñãÂïüË°å‰∫ãÊõÜ App...', 'info');
                
            } catch (error) {
                console.error('ÈñãÂïüË°å‰∫ãÊõÜ App Â§±Êïó:', error);
                showMessage('‚ùå ÈñãÂïüÂ§±ÊïóÔºåË´ãÊâãÂãïÈñãÂïüË°å‰∫ãÊõÜ App', 'error');
            }
        }

        function showCalendarDeletionGuide() {
            var guide = `üóëÔ∏è iOS Ë°å‰∫ãÊõÜÊéíÁ®ãÂà™Èô§ÊåáÂçóÔºö

üì± ÊñπÊ≥ï‰∏ÄÔºöÂú®Ë°å‰∫ãÊõÜ App ‰∏≠Âà™Èô§
1. ÈñãÂïü iOS„ÄåË°å‰∫ãÊõÜ„ÄçApp
2. ÂàáÊèõÂà∞„ÄåÂàóË°®„ÄçÊ™¢Ë¶ñÊàñ„ÄåÊúà„ÄçÊ™¢Ë¶ñ
3. ÊêúÂ∞ã„ÄåMphasis„ÄçÊàñ„ÄåÊâìÂç°„Äç
4. ÊâæÂà∞ÊâìÂç°ÊèêÈÜí‰∫ã‰ª∂
5. ÈªûÊìä‰∫ã‰ª∂ ‚Üí ÈªûÊìä„ÄåÁ∑®ËºØ„Äç
6. ÊãâÂà∞ÊúÄ‰∏ãÊñπ ‚Üí ÈªûÊìä„ÄåÂà™Èô§‰∫ã‰ª∂„Äç
7. ÈÅ∏Êìá„ÄåÂà™Èô§ÊâÄÊúâÈáçË§á‰∫ã‰ª∂„Äç
8. Á¢∫Ë™çÂà™Èô§

üîç ÊñπÊ≥ï‰∫åÔºöÈÄèÈÅéÊêúÂ∞ãÂø´ÈÄüÊâæÂà∞
1. ÈñãÂïüË°å‰∫ãÊõÜ App
2. ÈªûÊìäÂè≥‰∏äËßí„ÄåÊêúÂ∞ã„ÄçÂúñÁ§∫ üîç
3. Ëº∏ÂÖ•„ÄåMphasis„ÄçÊàñ„ÄåÊâìÂç°„Äç
4. ÈªûÊìäÊâæÂà∞ÁöÑ‰∫ã‰ª∂
5. ÊåâÁÖß‰∏äËø∞Ê≠•È©üÂà™Èô§

üìÖ ÊñπÊ≥ï‰∏âÔºöÊåâÊó•ÊúüÊü•Êâæ
1. ÂàáÊèõÂà∞„ÄåÊó•„ÄçÊàñ„ÄåÈÄ±„ÄçÊ™¢Ë¶ñ
2. ÊªëÂãïÂà∞ÊúâË®≠ÂÆöÊèêÈÜíÁöÑÊó•Êúü
3. ÊâæÂà∞ÊâìÂç°ÊèêÈÜí‰∫ã‰ª∂ÔºàÈÄöÂ∏∏Âú®Ë®≠ÂÆöÁöÑÊôÇÈñìÔºâ
4. ÈªûÊìä‰∫ã‰ª∂ÈÄ≤Ë°åÂà™Èô§

‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†ÖÔºö
‚Ä¢ Âà™Èô§ÊôÇÈÅ∏Êìá„ÄåÊâÄÊúâÈáçË§á‰∫ã‰ª∂„ÄçÊâçËÉΩÂÆåÂÖ®Ê∏ÖÈô§
‚Ä¢ Â¶ÇÊûúÊúâÂ§öÂÄãË®≠ÂÆöÔºåÈúÄË¶ÅÈÄê‰∏ÄÂà™Èô§
‚Ä¢ Âà™Èô§ÂæåÂèØËÉΩÈúÄË¶ÅÁ≠âÂæÖÂπæÂàÜÈêòÊâçÂÆåÂÖ®Ê∂àÂ§±
‚Ä¢ Âª∫Ë≠∞Âà™Èô§ÂâçÂÖàÁ¢∫Ë™çÊòØÊ≠£Á¢∫ÁöÑ‰∫ã‰ª∂

üí° Â∞èÊäÄÂ∑ßÔºö
‚Ä¢ ÂèØ‰ª•Âú®‰∫ã‰ª∂Ë©≥ÊÉÖ‰∏≠ÁúãÂà∞„ÄåMphasis Ëá™ÂãïÊâìÂç°ÊèêÈÜí„ÄçÊ®ôÈ°å
‚Ä¢ ‰∫ã‰ª∂ÊèèËø∞ÊúÉÂåÖÂê´„ÄåÊô∫ÊÖßÊâìÂç°Á≥ªÁµ±„ÄçÂ≠óÊ®£
‚Ä¢ ÈáçË§áË¶èÂâáÊúÉÈ°ØÁ§∫ÁÇ∫„ÄåÊØèÈÄ±„Äç`;

            alert(guide);
        }

        function showCalendarSearchGuide() {
            var guide = `üîç iOS Ë°å‰∫ãÊõÜÊéíÁ®ãÊü•ÊâæÊåáÂçóÔºö

üìù Â¶Ç‰ΩïÁ¢∫Ë™çÊéíÁ®ãÊòØÂê¶Â≠òÂú®Ôºö

1Ô∏è‚É£ Ê®ôÈ°åÊêúÂ∞ãÊ≥ïÔºö
‚Ä¢ ÈñãÂïüË°å‰∫ãÊõÜ App ‚Üí ÈªûÊìäÊêúÂ∞ã üîç
‚Ä¢ Ëº∏ÂÖ•„ÄåMphasis„Äç
‚Ä¢ Êü•ÁúãÊêúÂ∞ãÁµêÊûú

2Ô∏è‚É£ ÈóúÈçµÂ≠óÊêúÂ∞ãÊ≥ïÔºö
‚Ä¢ ÊêúÂ∞ã„ÄåÊâìÂç°„Äç
‚Ä¢ ÊêúÂ∞ã„ÄåÊèêÈÜí„Äç
‚Ä¢ ÊêúÂ∞ã„ÄåÊô∫ÊÖß„Äç

3Ô∏è‚É£ ÊôÇÈñìÊ™¢Ë¶ñÊ≥ïÔºö
‚Ä¢ ÂàáÊèõÂà∞„ÄåÊó•„ÄçÊ™¢Ë¶ñ
‚Ä¢ ÊªëÂãïÂà∞Â∑•‰ΩúÊó•
‚Ä¢ Êü•ÁúãË®≠ÂÆöÁöÑÊèêÈÜíÊôÇÈñìÈªû

4Ô∏è‚É£ ÂàóË°®Ê™¢Ë¶ñÊ≥ïÔºö
‚Ä¢ ÂàáÊèõÂà∞„ÄåÂàóË°®„ÄçÊ™¢Ë¶ñ
‚Ä¢ ÊåâÊó•ÊúüÁÄèË¶Ω
‚Ä¢ Â∞ãÊâæÈáçË§áÁöÑÊâìÂç°‰∫ã‰ª∂

üìã ÊéíÁ®ãÁâπÂæµÔºö
‚úÖ Ê®ôÈ°åÔºöüéØ Mphasis Ëá™ÂãïÊâìÂç°ÊèêÈÜí
‚úÖ ÈáçË§áÔºöÊØèÈÄ± (Â∑•‰ΩúÊó•)
‚úÖ ÊèêÈÜíÔºöÁ´ãÂç≥ÊèêÈÜí + 5ÂàÜÈêòÂâçÊèêÈÜí
‚úÖ ÊèèËø∞ÔºöÂåÖÂê´„ÄåÊô∫ÊÖßÊâìÂç°Á≥ªÁµ±„Äç

üóìÔ∏è Á¢∫Ë™çÊñπÊ≥ïÔºö
‚Ä¢ ÈªûÊìä‰∫ã‰ª∂Êü•ÁúãË©≥ÊÉÖ
‚Ä¢ Ê™¢Êü•ÈáçË§áË¶èÂâá
‚Ä¢ Á¢∫Ë™çÊèêÈÜíË®≠ÂÆö
‚Ä¢ Êü•Áúã‰∫ã‰ª∂ÊèèËø∞

‚ùå Â¶ÇÊûúÊâæ‰∏çÂà∞ÊéíÁ®ãÔºö
‚Ä¢ ÂèØËÉΩÊú™ÊàêÂäüÂª∫Á´ã
‚Ä¢ ÂèØËÉΩÂ∑≤Ë¢´Âà™Èô§
‚Ä¢ ÂèØËÉΩÂú®ÂÖ∂‰ªñË°å‰∫ãÊõÜ‰∏≠
‚Ä¢ ÈáçÊñ∞Âü∑Ë°å„ÄåiOS Ë°å‰∫ãÊõÜ„ÄçË®≠ÂÆö`;

            alert(guide);
        }

        function clearCalendarHistory() {
            if (confirm('üßπ Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊ≠∑Âè≤Ë®òÈåÑÂóéÔºü\n\nÈÄôÂ∞áÊ∏ÖÈô§Ôºö\n‚Ä¢ Ë°å‰∫ãÊõÜÂª∫Á´ãË®òÈåÑ\n‚Ä¢ Ë®≠ÂÆöÊ≠∑Âè≤\n‚Ä¢ Êö´Â≠òË≥áÊñô\n\n‚ö†Ô∏è Ê≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) {
                try {
                    // Ê∏ÖÈô§Áõ∏ÈóúÁöÑ localStorage È†ÖÁõÆ
                    localStorage.removeItem('lastCalendarSetup');
                    localStorage.removeItem('ios_ultimate_settings');
                    
                    // Ê∏ÖÈô§Êö´Â≠òÂÖßÂÆπ
                    if (window.tempCalendarContent) {
                        delete window.tempCalendarContent;
                    }
                    if (window.tempCalendarInfo) {
                        delete window.tempCalendarInfo;
                    }
                    
                    console.log('üßπ Ê≠∑Âè≤Ë®òÈåÑÂ∑≤Ê∏ÖÈô§');
                    showMessage('‚úÖ Ê≠∑Âè≤Ë®òÈåÑÂ∑≤Ê∏ÖÈô§ÔºÅ\n‰∏ãÊ¨°Ë®≠ÂÆöÂ∞áÈáçÊñ∞ÈñãÂßãË®òÈåÑ„ÄÇ', 'success');
                    
                    // ÈáçÊñ∞ËºâÂÖ•Ë®≠ÂÆöÈ°ØÁ§∫
                    loadCurrentCalendarSettings();
                    
                } catch (error) {
                    console.error('Ê∏ÖÈô§Ê≠∑Âè≤Ë®òÈåÑÂ§±Êïó:', error);
                    showMessage('‚ùå Ê∏ÖÈô§Â§±ÊïóÔºåË´ãÈáçË©¶', 'error');
                }
            }
        }

        function closeCalendarManagement() {
            var modal = document.getElementById('calendarManagementModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function showCalendarContentPrompt(icalContent) {
            var shortContent = icalContent.substring(0, 500) + '...';
            alert('üìã Áî±ÊñºÁÄèË¶ΩÂô®ÈôêÂà∂ÔºåË´ãÊâãÂãïË§áË£Ω‰ª•‰∏ãÂÖßÂÆπÔºö\n\n' + shortContent + '\n\nÂÆåÊï¥ÂÖßÂÆπË´ãÊü•ÁúãÁÄèË¶ΩÂô®ÊéßÂà∂Âè∞ (F12)');
            console.log('=== ÂÆåÊï¥ iCal ÂÖßÂÆπ ===');
            console.log(icalContent);
            console.log('=== Ë§áË£Ω‰∏äÊñπÂÖßÂÆπÂà∞Ë°å‰∫ãÊõÜ ===');
        }

        // È°ØÁ§∫Êó•ÊõÜ‰∏ãËºâÈÅ∏È†Ö
        function showCalendarDownloadOptions(icalContent, selectedDaysText) {
            var modalContent = `
                <div style="background: white; border-radius: 16px; padding: 24px; margin: 20px auto; max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    <h3 style="color: #FF6B35; margin-bottom: 16px; text-align: center;">üìÖ Ë°å‰∫ãÊõÜË®≠ÂÆöÈÅ∏È†Ö</h3>
                    
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <p style="margin: 0; color: #666; font-size: 14px; line-height: 1.5;">
                            <strong>Â¶ÇÊûúËá™Âãï‰∏ãËºâÂ§±ÊïóÔºåË´ã‰ΩøÁî®‰ª•‰∏ãÊñπÊ≥ïÔºö</strong>
                        </p>
                    </div>
                    
                    <button onclick="manualDownloadCalendar()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        üì• ÊâãÂãï‰∏ãËºâË°å‰∫ãÊõÜÊ™îÊ°à
                    </button>
                    
                    <button onclick="showCalendarInstructions()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        üì± Êü•Áúã iOS Ë®≠ÂÆöË™™Êòé
                    </button>
                    
                    <button onclick="copyCalendarContent()" 
                            style="width: 100%; padding: 12px; margin: 8px 0; background: #FF9800; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        üìã Ë§áË£ΩË°å‰∫ãÊõÜÂÖßÂÆπ
                    </button>
                    
                    <button onclick="closeCalendarOptions()" 
                            style="width: 100%; padding: 8px; margin: 16px 0 0 0; background: #f5f5f5; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                        ÈóúÈñâ
                    </button>
                </div>
            `;
            
            // ÂâµÂª∫Ê®°ÊÖãÊ°Ü
            var modal = document.createElement('div');
            modal.id = 'calendarOptionsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // ÂÑ≤Â≠òÂÖßÂÆπ‰æõÂæåÁ∫å‰ΩøÁî®
            window.tempCalendarContent = icalContent;
            window.tempCalendarInfo = selectedDaysText;
        }

        function manualDownloadCalendar() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            // Âº∑Âà∂‰ΩøÁî® data URL ÊñπÂºè
            var dataUrl = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icalContent);
            var link = document.createElement('a');
            link.href = dataUrl;
            link.download = 'mphasis-checkin-calendar.ics';
            link.target = '_blank';
            link.click();
            
            showMessage('üì• Ë°å‰∫ãÊõÜÊ™îÊ°àÂ∑≤Ê∫ñÂÇô‰∏ãËºâÔºÅÂ¶ÇÊûúÊ≤íÊúâËá™Âãï‰∏ãËºâÔºåË´ãÈï∑ÊåâÈÄ£ÁµêÈÅ∏Êìá„Äå‰∏ãËºâ„Äç', 'info');
        }

        function showCalendarInstructions() {
            var instructions = `üì± iOS Ë°å‰∫ãÊõÜË®≠ÂÆöÂÆåÊï¥Ë™™ÊòéÔºö

1Ô∏è‚É£ ‰∏ãËºâÊ™îÊ°àÂæåÔºö
   ‚Ä¢ Âú®„ÄåÊ™îÊ°à„Äçapp ‰∏≠ÊâæÂà∞‰∏ãËºâÁöÑ .ics Ê™îÊ°à
   ‚Ä¢ ÈªûÊìäÊ™îÊ°àÈñãÂïü
   ‚Ä¢ ÈÅ∏Êìá„ÄåÂä†ÂÖ•Ë°å‰∫ãÊõÜ„Äç

2Ô∏è‚É£ Ë®≠ÂÆöÊèêÈÜíÔºö
   ‚Ä¢ Á¢∫Ë™çÂåØÂÖ•Âà∞È†êË®≠Ë°å‰∫ãÊõÜ
   ‚Ä¢ Ê™¢Êü•ÊèêÈÜíÊôÇÈñìÊòØÂê¶Ê≠£Á¢∫
   ‚Ä¢ Á¢∫Ë™çÈáçË§áË®≠ÂÆöÁÇ∫ÊØèÈÄ±

3Ô∏è‚É£ Ê∏¨Ë©¶ÂäüËÉΩÔºö
   ‚Ä¢ Á≠âÂæÖÊèêÈÜíÊôÇÈñìÂà∞ÈÅî
   ‚Ä¢ ÈªûÊìäË°å‰∫ãÊõÜÈÄöÁü•
   ‚Ä¢ Á¢∫Ë™çÊúÉËá™ÂãïÈñãÂïüÊâìÂç°ÊáâÁî®

4Ô∏è‚É£ ÊïÖÈöúÊéíÈô§Ôºö
   ‚Ä¢ Â¶ÇÊûúÊ≤íÊúâÊî∂Âà∞ÊèêÈÜíÔºåÊ™¢Êü•Ë°å‰∫ãÊõÜÊ¨äÈôê
   ‚Ä¢ Á¢∫Ë™çÈÄöÁü•Ë®≠ÂÆöÂ∑≤ÂïüÁî®
   ‚Ä¢ ÈáçÊñ∞ÂåØÂÖ•Ë°å‰∫ãÊõÜÊ™îÊ°à`;
   
            alert(instructions);
        }

        function copyCalendarContent() {
            var icalContent = window.tempCalendarContent;
            if (!icalContent) return;
            
            // ÂòóË©¶Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(icalContent).then(() => {
                    showMessage('üìã Ë°å‰∫ãÊõÜÂÖßÂÆπÂ∑≤Ë§áË£ΩÔºÅÊÇ®ÂèØ‰ª•Ë≤ºÂà∞‰ªª‰ΩïÊñáÂ≠óÁ∑®ËºØÂô®‰∏≠ÔºåÂÑ≤Â≠òÁÇ∫ .ics Ê™îÊ°à', 'success');
                }).catch(() => {
                    // ÈôçÁ¥öÊñπÊ°à
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
            
            function fallbackCopy() {
                // ÂâµÂª∫Èö±ËóèÁöÑÊñáÂ≠óÂçÄÂüü
                var textArea = document.createElement('textarea');
                textArea.value = icalContent;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showMessage('üìã Ë°å‰∫ãÊõÜÂÖßÂÆπÂ∑≤Ë§áË£ΩÔºÅ', 'success');
                } catch (err) {
                    showMessage('‚ùå Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω‰∏ãÊñπÂÖßÂÆπ', 'error');
                    prompt('Ë´ãË§áË£Ω‰ª•‰∏ãÂÖßÂÆπÔºåÂÑ≤Â≠òÁÇ∫ .ics Ê™îÊ°àÔºö', icalContent);
                }
                
                document.body.removeChild(textArea);
            }
        }

        function closeCalendarOptions() {
            var modal = document.getElementById('calendarOptionsModal');
            if (modal) {
                document.body.removeChild(modal);
            }
            
            // Ê∏ÖÁêÜÊö´Â≠òÂÖßÂÆπ
            delete window.tempCalendarContent;
            delete window.tempCalendarInfo;
        }

        // ‰∏çÂÜçÈúÄË¶ÅË§áÈõúÁöÑÊó•ÊúüÊ†ºÂºèÂåñÔºåÂõ†ÁÇ∫‰ΩøÁî®Âõ∫ÂÆöÊó•Êúü 20250101
        // ‰øùÁïôÂáΩÊï∏‰ª•Èò≤Áõ∏ÂÆπÊÄßÂïèÈ°åÔºå‰ΩÜ‰∏çÂØ¶Èöõ‰ΩøÁî®
        
        // Á∞°ÂåñÁöÑÂ∑•‰ΩúÊó•Ë®àÁÆó (Êõ¥Á©©ÂÆö)
        function getNextWorkdaySimplified() {
            try {
                console.log('üîß getNextWorkdaySimplified ÈñãÂßãÂü∑Ë°å');
                
                var today = new Date();
                var currentDay = today.getDay();
                var currentHour = today.getHours();
                var currentMinute = today.getMinutes();
                
                console.log(`üìÖ ‰ªäÂ§©: ${today.toLocaleDateString('zh-TW')} (ÈÄ±${['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][currentDay]})`);
                console.log(`‚è∞ ÁõÆÂâçÊôÇÈñì: ${currentHour}:${currentMinute.toString().padStart(2, '0')}`);
                console.log(`üìã Â∑•‰ΩúÊó•Ë®≠ÂÆö: ${settings.weeklyDays.map(d => ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][d]).join('„ÄÅ')}`);
                
                // Á∞°ÂåñÈÇèËºØÔºöÂ¶ÇÊûú‰ªäÂ§©ÊòØÂ∑•‰ΩúÊó•‰∏îÊôÇÈñìÈÇÑÊó©ÔºåÁî®‰ªäÂ§©ÔºõÂê¶ÂâáÁî®‰∏ãÂÄãÂ∑•‰ΩúÊó•
                var timeParts = settings.checkinTime.split(':');
                var checkinHour = parseInt(timeParts[0]);
                var checkinMinute = parseInt(timeParts[1]);
                
                var todayCheckinTime = new Date(today);
                todayCheckinTime.setHours(checkinHour, checkinMinute, 0, 0);
                
                // Â¶ÇÊûú‰ªäÂ§©ÊòØÂ∑•‰ΩúÊó•‰∏îÈÇÑÊ≤íÂà∞ÊâìÂç°ÊôÇÈñì
                if (settings.weeklyDays.includes(currentDay) && today < todayCheckinTime) {
                    console.log('‚úÖ ‰ΩøÁî®‰ªäÂ§© (Â∑•‰ΩúÊó•‰∏îÊú™Âà∞ÊâìÂç°ÊôÇÈñì)');
                    return today;
                }
                
                // Êâæ‰∏ã‰∏ÄÂÄãÂ∑•‰ΩúÊó• (ÊúÄÂ§öÊâæ 7 Â§©)
                for (var i = 1; i <= 7; i++) {
                    var nextDate = new Date(today);
                    nextDate.setDate(today.getDate() + i);
                    var dayOfWeek = nextDate.getDay();
                    
                    if (settings.weeklyDays.includes(dayOfWeek)) {
                        console.log(`‚úÖ ÊâæÂà∞‰∏ãÂÄãÂ∑•‰ΩúÊó•: ${nextDate.toLocaleDateString('zh-TW')} (ÈÄ±${['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][dayOfWeek]})`);
                        return nextDate;
                    }
                }
                
                // Â¶ÇÊûúÊâæ‰∏çÂà∞Â∑•‰ΩúÊó•Ôºå‰ΩøÁî®ÊòéÂ§©‰ΩúÁÇ∫ÂÇôÁî®
                var tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                console.log('‚ö†Ô∏è Êú™ÊâæÂà∞Â∑•‰ΩúÊó•Ôºå‰ΩøÁî®ÊòéÂ§©‰ΩúÁÇ∫ÂÇôÁî®');
                return tomorrow;
                
            } catch (error) {
                console.error('getNextWorkdaySimplified ÈåØË™§:', error);
                // ÊúÄÁµÇÂÇôÁî®ÊñπÊ°àÔºöÊòéÂ§©
                var fallback = new Date();
                fallback.setDate(fallback.getDate() + 1);
                console.log('üîÑ ‰ΩøÁî®ÊúÄÁµÇÂÇôÁî®ÊñπÊ°à: ÊòéÂ§©');
                return fallback;
            }
        }
        
        // Áç≤Âèñ‰∏ã‰∏ÄÂÄãÂ∑•‰ΩúÊó• (‰øùÁïôÂéüÂáΩÊï∏‰ª•Èò≤Áõ∏ÂÆπÊÄßÂïèÈ°å)
        function getNextWorkday() {
            var today = new Date();
            var currentDay = today.getDay(); // 0=Sunday, 1=Monday, etc.
            var currentHour = today.getHours();
            var currentMinute = today.getMinutes();
            
            // Ê™¢Êü•‰ªäÂ§©ÊòØÂê¶Âú®Â∑•‰ΩúÊó•ÂÖß‰∏îÈÇÑÊ≤íÂà∞ÊâìÂç°ÊôÇÈñì
            var timeParts = settings.checkinTime.split(':');
            var checkinHour = parseInt(timeParts[0]);
            var checkinMinute = parseInt(timeParts[1]);
            
            var todayCheckinTime = new Date(today);
            todayCheckinTime.setHours(checkinHour, checkinMinute, 0, 0);
            
            // Â¶ÇÊûú‰ªäÂ§©ÊòØÂ∑•‰ΩúÊó•‰∏îÈÇÑÊ≤íÂà∞ÊâìÂç°ÊôÇÈñìÔºå‰ΩøÁî®‰ªäÂ§©
            if (settings.weeklyDays.includes(currentDay) && today < todayCheckinTime) {
                return today;
            }
            
            // Âê¶ÂâáÊâæ‰∏ã‰∏ÄÂÄãÂ∑•‰ΩúÊó•
            var nextDate = new Date(today);
            nextDate.setDate(today.getDate() + 1);
            
            // ÊúÄÂ§öÊâæ 7 Â§©ÔºåÁ¢∫‰øùËÉΩÊâæÂà∞‰∏ã‰∏ÄÂÄãÂ∑•‰ΩúÊó•
            for (var i = 0; i < 7; i++) {
                var dayOfWeek = nextDate.getDay();
                if (settings.weeklyDays.includes(dayOfWeek)) {
                    return nextDate;
                }
                nextDate.setDate(nextDate.getDate() + 1);
            }
            
            // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞Â∑•‰ΩúÊó•ÔºåËøîÂõûÊòéÂ§©
            var tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            return tomorrow;
        }

        // Ë®≠ÂÆö iOS È¨ßÈêò
        function setupIOSAlarms() {
            var timeParts = settings.checkinTime.split(':');
            var reminderHour = parseInt(timeParts[0]);
            var reminderMinute = parseInt(timeParts[1]) - settings.reminderMinutes;
            
            if (reminderMinute < 0) {
                reminderMinute += 60;
                reminderHour -= 1;
            }
            
            var reminderTime = reminderHour.toString().padStart(2, '0') + ':' + 
                             reminderMinute.toString().padStart(2, '0');
            
            var instructions = `üì± Ë®≠ÂÆö iOS Á≥ªÁµ±È¨ßÈêòÔºö

üïê ÊèêÈÜíÊôÇÈñìÔºö${reminderTime}
üè∑Ô∏è Ê®ôÁ±§ÔºöMphasisÊâìÂç°
üîÑ ÈáçË§áÔºöÈÄ±‰∏ÄÂà∞ÈÄ±‰∫î

Ë®≠ÂÆöÊ≠•È©üÔºö
1. ÈñãÂïü„ÄåÊôÇÈêò„ÄçÊáâÁî®
2. ÈªûÊìä„ÄåÈ¨ßÈêò„ÄçÊ®ôÁ±§
3. ÈªûÊìäÂè≥‰∏äËßí„Äå+„Äç
4. Ë®≠ÂÆöÊôÇÈñìÔºö${reminderTime}
5. ÈªûÊìä„ÄåÈáçË§á„ÄçÈÅ∏ÊìáÈÄ±‰∏ÄÂà∞ÈÄ±‰∫î
6. Âú®„ÄåÊ®ôÁ±§„Äç‰∏≠Ëº∏ÂÖ•ÔºöMphasisÊâìÂç°
7. ÈªûÊìä„ÄåÂÑ≤Â≠ò„Äç

üéØ È¨ßÈêòÈüøËµ∑ÊôÇÂ∞±ÊòØÊâìÂç°ÊôÇÈñìÔºÅ`;
            
            alert(instructions);
            
            // ÂòóË©¶ÈñãÂïüÊôÇÈêòÊáâÁî®
            try {
                window.location.href = 'clock-alarm://';
            } catch (error) {
                console.log('ÁÑ°Ê≥ïËá™ÂãïÈñãÂïüÊôÇÈêòÊáâÁî®');
            }
        }

        // Ë®≠ÂÆö Siri Êç∑Âæë
        function setupSiriShortcuts() {
            var shortcutName = 'MphasisÊô∫ÊÖßÊâìÂç°';
            
            // ÁîüÊàê Siri ÂñöÈÜí URL
            var siriWakeupUrl = window.location.href.split('?')[0] + '?wakeup=siri&time=' + 
                               settings.checkinTime.replace(':', '');
            
            var instructions = `üó£Ô∏è Âª∫Á´ã Siri Êô∫ÊÖßÊâìÂç°Êç∑ÂæëÔºö

üì± Á¨¨‰∏ÄÊ≠• - Âª∫Á´ãÊç∑ÂæëÔºö
1. ÈñãÂïü„ÄåÊç∑Âæë„ÄçÊáâÁî®
2. ÈªûÊìäÂè≥‰∏äËßí„Äå+„ÄçÊñ∞Â¢ûÊç∑Âæë
3. ÊêúÂ∞ã„ÄåÈñãÂïü URL„ÄçÂãï‰Ωú
4. Ëº∏ÂÖ•ÂñöÈÜíÁ∂≤ÂùÄÔºö
   ${siriWakeupUrl}
5. Ë®≠ÂÆöÊç∑ÂæëÂêçÁ®±Ôºö„Äå${shortcutName}„Äç
6. ÈªûÊìä„ÄåÂÆåÊàê„Äç

üéôÔ∏è Á¨¨‰∫åÊ≠• - Ë™ûÈü≥Ëß∏ÁôºÔºö
1. Âú®Êç∑Âæë‰∏≠ÊâæÂà∞„Äå${shortcutName}„Äç
2. ÈªûÊìä„Äå...„ÄçË®≠ÂÆö
3. ÈªûÊìä„ÄåÂä†Âà∞ Siri„Äç
4. ÈåÑË£ΩËß∏ÁôºË©ûÔºö„ÄåÂòø SiriÔºåÊâìÂç°ÊôÇÈñì„Äç
5. ÈªûÊìä„ÄåÂÆåÊàê„Äç

‚è∞ Á¨¨‰∏âÊ≠• - Ëá™ÂãïÂåñÔºö
1. ÂàáÊèõÂà∞„ÄåËá™ÂãïÂåñ„ÄçÈ†ÅÈù¢
2. ÈªûÊìäÂè≥‰∏äËßí„Äå+„Äç
3. ÈÅ∏Êìá„ÄåÂª∫Á´ãÂÄã‰∫∫Ëá™ÂãïÂåñ„Äç
4. ÈÅ∏Êìá„ÄåÊôÇÈñì„Äç
5. Ë®≠ÂÆöÊôÇÈñìÔºö${settings.checkinTime}
6. Ë®≠ÂÆöÈáçË§áÔºöÈÅ∏ÊìáË¶ÅÊâìÂç°ÁöÑÊó•Êúü
7. ÈªûÊìä„Äå‰∏ã‰∏ÄÊ≠•„Äç
8. ÊêúÂ∞ã„ÄåÂü∑Ë°åÊç∑Âæë„Äç
9. ÈÅ∏Êìá„Äå${shortcutName}„Äç
10. ÈóúÈñâ„ÄåÂü∑Ë°åÂâçË©¢Âïè„Äç
11. ÈªûÊìä„ÄåÂÆåÊàê„Äç

üéØ Êô∫ÊÖßÂäüËÉΩÔºö
‚úÖ Ëá™ÂãïÊ™¢Ê∏¨ÊâìÂç°ÊôÇÈñì
‚úÖ Êô∫ÊÖßÈñãÂïüÊâìÂç°È†ÅÈù¢
‚úÖ ÊîØÊè¥Ë™ûÈü≥ÊéßÂà∂
‚úÖ Ëá™ÂãïÂåñÂü∑Ë°å

üîó ÂñöÈÜíÁ∂≤ÂùÄÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ`;
            
            // Ë§áË£ΩÂñöÈÜí URL Âà∞Ââ™Ë≤ºÁ∞ø
            try {
                navigator.clipboard.writeText(siriWakeupUrl);
            } catch (error) {
                console.log('ÁÑ°Ê≥ïË§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø:', error);
            }
            
            showMessage(instructions, 'info');
            
            // ÂòóË©¶ÈñãÂïüÊç∑ÂæëÊáâÁî®
            setTimeout(() => {
                try {
                    window.location.href = 'shortcuts://';
                } catch (error) {
                    console.log('ÁÑ°Ê≥ïÈñãÂïüÊç∑ÂæëÊáâÁî®:', error);
                }
            }, 2000);
        }

        // Ë®≠ÂÆö iOS ÊèêÈÜí‰∫ãÈ†Ö
        function setupReminders() {
            var instructions = `üìù Âª∫Á´ã iOS ÊèêÈÜí‰∫ãÈ†ÖÔºö

ÊèêÈÜíÂÖßÂÆπÔºö„ÄåMphasis ÊâìÂç°ÊôÇÈñì„Äç
ÊèêÈÜíÊôÇÈñìÔºöÊØèÂ§© ${settings.checkinTime}

Ë®≠ÂÆöÊ≠•È©üÔºö
1. ÈñãÂïü„ÄåÊèêÈÜí‰∫ãÈ†Ö„ÄçÊáâÁî®
2. ÈªûÊìäÂè≥‰∏ãËßí„Äå+„Äç
3. Ëº∏ÂÖ•ÔºöMphasis ÊâìÂç°ÊôÇÈñì
4. ÈªûÊìä„Äåi„ÄçÂúñÁ§∫
5. ÈñãÂïü„ÄåÂú®ÊüêÊó•ÊèêÈÜíÊàë„Äç
6. Ë®≠ÂÆöÊôÇÈñìÔºö${settings.checkinTime}
7. ÈñãÂïü„ÄåÈáçË§á„ÄçÈÅ∏Êìá„ÄåÊØèÂ§©„Äç
8. ÈªûÊìä„ÄåÂÆåÊàê„Äç

üéØ Á≥ªÁµ±ÊúÉÂú®Ë®≠ÂÆöÊôÇÈñìËá™ÂãïÊèêÈÜíÊÇ®ÊâìÂç°ÔºÅ`;
            
            alert(instructions);
            
            // ÂòóË©¶ÈñãÂïüÊèêÈÜí‰∫ãÈ†ÖÊáâÁî®
            try {
                window.location.href = 'x-apple-reminderkit://';
            } catch (error) {
                console.log('ÁÑ°Ê≥ïËá™ÂãïÈñãÂïüÊèêÈÜí‰∫ãÈ†ÖÊáâÁî®');
            }
        }

        // ÂïüÂãïÂâçÊôØ‰øùÊåÅÊ®°Âºè
        function startForegroundMode() {
            showMessage('üîÑ ÂïüÂãïÂâçÊôØ‰øùÊåÅÊ®°Âºè...', 'info');
            
            // ÈáçÁΩÆË®àÊôÇÂô®
            activeStartTime = Date.now();
            
            // ÂïüÂãïÂâçÊôØÊèêÈÜíÊ™¢Êü•
            startForegroundReminderCheck();
            
            // ÂòóË©¶‰øùÊåÅÂ±èÂπïÂñöÈÜí
            try {
                if ('wakeLock' in navigator) {
                    navigator.wakeLock.request('screen').then(function(wakeLock) {
                        console.log('üîÜ Â±èÂπï‰øùÊåÅÂñöÈÜí');
                    }).catch(function(error) {
                        console.log('ÁÑ°Ê≥ï‰øùÊåÅÂ±èÂπïÂñöÈÜí:', error);
                    });
                }
            } catch (error) {
                console.log('‰∏çÊîØÊè¥Â±èÂπïÂñöÈÜí API');
            }
            
            showMessage('‚úÖ ÂâçÊôØ‰øùÊåÅÊ®°ÂºèÂ∑≤ÂïüÂãïÔºÅË´ã‰øùÊåÅÊáâÁî®Âú®ÂâçÊôØ„ÄÇ', 'success');
        }

        // ÂïüÂãïÂâçÊôØÊèêÈÜíÊ™¢Êü•
        function startForegroundReminderCheck() {
            if (reminderInterval) {
                clearInterval(reminderInterval);
            }
            
            reminderInterval = setInterval(function() {
                if (!document.hidden) {
                    checkForReminder();
                }
            }, 30000); // ÊØè30ÁßíÊ™¢Êü•‰∏ÄÊ¨°
        }

        // ÊéíÁ®ã‰∏ãÊ¨°Ê™¢Êü•ÔºàÈùûÊ¥ªË∫çÁãÄÊÖãÁî®Ôºâ
        function scheduleNextCheck() {
            setTimeout(function() {
                if (document.hidden) {
                    checkForReminder();
                    scheduleNextCheck(); // ÈÅûÊ≠∏ÊéíÁ®ã
                }
            }, 60000); // 1ÂàÜÈêòÂæåÊ™¢Êü•
        }

        // Ê∏¨Ë©¶ÂâçÊôØÊèêÈÜí
        function testForegroundReminder() {
            if (document.hidden) {
                showMessage('‚ö†Ô∏è Ë´ã‰øùÊåÅÊáâÁî®Âú®ÂâçÊôØ‰ª•Ê∏¨Ë©¶ÊèêÈÜí', 'warning');
                return;
            }
            
            showMessage('üß™ Ê∏¨Ë©¶ÊèêÈÜí‰∏≠...', 'info');
            setTimeout(function() {
                triggerCheckinReminder();
            }, 2000);
        }

        // Ê®°Êì¨ÊâìÂç°ÊèêÈÜí
        function showCheckinReminder() {
            triggerCheckinReminder();
        }

        // ÈñãÂïüÊâìÂç°È†ÅÈù¢
        function openCheckinPage() {
            var popup = window.open(settings.checkinUrl, 'checkin', 'width=414,height=736');
            
            if (popup) {
                showMessage('‚úÖ ÊâìÂç°È†ÅÈù¢Â∑≤ÈñãÂïüÔºÅ', 'success');
            } else {
                showMessage('‚ùå ÁÑ°Ê≥ïÈñãÂïüÈ†ÅÈù¢ÔºåË´ãÊ™¢Êü•ÂΩàÁ™óË®≠ÂÆö', 'error');
            }
        }

        // ÂÑ≤Â≠òË®≠ÂÆö
        function saveSettings() {
            try {
                localStorage.setItem('ios_ultimate_settings', JSON.stringify(settings));
            } catch (error) {
                console.error('ÂÑ≤Â≠òË®≠ÂÆöÂ§±Êïó:', error);
            }
        }

        // ËºâÂÖ•Ë®≠ÂÆö
        function loadSettings() {
            try {
                var saved = localStorage.getItem('ios_ultimate_settings');
                if (saved) {
                    var savedSettings = JSON.parse(saved);
                    settings = Object.assign(settings, savedSettings);
                    
                    // Êõ¥Êñ∞ UI
                    document.getElementById('quickCheckinTime').value = settings.checkinTime;
                    document.getElementById('quickReminderTime').value = settings.reminderMinutes;
                    document.getElementById('quickExcludeHolidays').checked = settings.excludeHolidays !== false;
                    
                    // Êõ¥Êñ∞Âø´ÈÄüÈÄ±ÈñìÈÅ∏Êìá
                    if (settings.weeklyDays) {
                        quickWeeklyDays = settings.weeklyDays.slice();
                    }
                    
                    // Êõ¥Êñ∞ Teams Ë®≠ÂÆö UI (Âª∂ÈÅ≤ËºâÂÖ•Á¢∫‰øù DOM Â∑≤Â∞±Á∑í)
                    setTimeout(() => {
                        if (document.getElementById('teamsEnabled')) {
                            document.getElementById('teamsEnabled').checked = settings.teamsEnabled || false;
                            if (document.getElementById('teamsWebhook')) {
                                document.getElementById('teamsWebhook').value = settings.teamsWebhook || '';
                            }
                            if (document.getElementById('teamsBackupWebhook')) {
                                document.getElementById('teamsBackupWebhook').value = settings.teamsBackupWebhook || '';
                            }
                            updateTeamsSettings();
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ë®≠ÂÆöÂ§±Êïó:', error);
            }
        }

        // Teams Ë®≠ÂÆöÁõ∏ÈóúÂáΩÊï∏
        function toggleTeamsSettings() {
            var teamsSettings = document.getElementById('teamsSettings');
            if (teamsSettings.style.display === 'none' || teamsSettings.style.display === '') {
                teamsSettings.style.display = 'block';
                
                // Âª∂ÈÅ≤ËºâÂÖ•Ë®≠ÂÆöÔºåÁ¢∫‰øùÂÖÉÁ¥†Â∑≤È°ØÁ§∫
                setTimeout(() => {
                    loadSettings(); // Á¢∫‰øùËºâÂÖ•ÊúÄÊñ∞Ë®≠ÂÆö
                    
                    // Âº∑Âà∂Êõ¥Êñ∞ UI ÂÖÉÁ¥†
                    if (document.getElementById('teamsWebhook')) {
                        var webhookValue = settings.teamsWebhook || '';
                        document.getElementById('teamsWebhook').value = webhookValue;
                        console.log('üîß ËºâÂÖ• Webhook URL:', webhookValue);
                    }
                    
                    if (document.getElementById('teamsBackupWebhook')) {
                        var backupValue = settings.teamsBackupWebhook || '';
                        document.getElementById('teamsBackupWebhook').value = backupValue;
                        console.log('üîß ËºâÂÖ•ÂÇôÁî® Webhook URL:', backupValue);
                    }
                    
                    updateTeamsSettings();
                }, 200);
                
            } else {
                teamsSettings.style.display = 'none';
            }
        }

        function updateTeamsSettings() {
            var enabled = document.getElementById('teamsEnabled').checked;
            var webhookSettings = document.getElementById('teamsWebhookSettings');
            
            if (enabled) {
                webhookSettings.style.display = 'block';
                
                // Âª∂ÈÅ≤ËÅöÁÑ¶Âà∞Á¨¨‰∏ÄÂÄãËº∏ÂÖ•Ê¨Ñ‰Ωç
                setTimeout(() => {
                    var webhookInput = document.getElementById('teamsWebhook');
                    if (webhookInput) {
                        webhookInput.focus();
                        console.log('üîß Teams Webhook Ëº∏ÂÖ•Ê¨Ñ‰ΩçÂ∑≤Áç≤ÂæóÁÑ¶Èªû');
                    }
                }, 100);
            } else {
                webhookSettings.style.display = 'none';
            }
        }

        function onTeamsWebhookInput(event) {
            try {
                var webhookInput = document.getElementById('teamsWebhook');
                var backupInput = document.getElementById('teamsBackupWebhook');
                
                // Èò≤Ê≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                if (event) {
                    event.stopPropagation();
                }
                
                // Ê∏õÂ∞ë console.log È†ªÁéáÔºåÂè™Âú®ÁâπÂÆöÊÉÖÊ≥Å‰∏ãË®òÈåÑ
                if (webhookInput.value.length % 10 === 0 || webhookInput.value.length < 5) {
                    console.log('üì§ Webhook Ëº∏ÂÖ•ÁãÄÊÖã:', {
                        main: `${webhookInput.value.length} Â≠óÂÖÉ`,
                        backup: `${backupInput.value.length} Â≠óÂÖÉ`
                    });
                }
                
                // Á∞°ÂåñÈ©óË≠âÔºåÈÅøÂÖçÈ†ªÁπÅÂü∑Ë°å
                if (webhookInput.value.length > 8 && !webhookInput.value.startsWith('https://')) {
                    console.log('‚ö†Ô∏è URL Ê†ºÂºèÊèêÁ§∫: ÈúÄË¶Å https:// ÈñãÈ†≠');
                }
            } catch (error) {
                console.error('Ëº∏ÂÖ•ËôïÁêÜÈåØË™§:', error);
            }
        }

        function saveTeamsSettings() {
            var enabled = document.getElementById('teamsEnabled').checked;
            var webhook = document.getElementById('teamsWebhook').value.trim();
            var backupWebhook = document.getElementById('teamsBackupWebhook').value.trim();
            
            if (enabled && !webhook) {
                showMessage('‚ùå Ë´ãËº∏ÂÖ•‰∏ªË¶Å Webhook URL', 'error');
                return;
            }
            
            // Á∞°ÂñÆÁöÑ URL È©óË≠â
            if (enabled && webhook && !webhook.startsWith('https://')) {
                showMessage('‚ùå Webhook URL ÂøÖÈ†à‰ª• https:// ÈñãÈ†≠', 'error');
                return;
            }
            
            // Êõ¥Êñ∞Ë®≠ÂÆö
            settings.teamsEnabled = enabled;
            settings.teamsWebhook = webhook;
            settings.teamsBackupWebhook = backupWebhook;
            
            // ÂÑ≤Â≠òË®≠ÂÆö
            saveSettings();
            
            showMessage('‚úÖ Teams Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò', 'success');
        }

        function testTeamsNotification() {
            try {
                console.log('üß™ ÈñãÂßãÊ∏¨Ë©¶ Teams ÈÄöÁü•...');
                showMessage('üß™ Ê≠£Âú®Ê∏¨Ë©¶ Teams ÈÄöÁü•...', 'info');
                
                // Ê™¢Êü• DOM ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
                var enabledElement = document.getElementById('teamsEnabled');
                var webhookElement = document.getElementById('teamsWebhook');
                var backupWebhookElement = document.getElementById('teamsBackupWebhook');
                
                if (!enabledElement) {
                    showMessage('‚ùå Êâæ‰∏çÂà∞ÂïüÁî®ÈñãÈóúÂÖÉÁ¥†', 'error');
                    console.error('teamsEnabled ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                    return;
                }
                
                if (!webhookElement) {
                    showMessage('‚ùå Êâæ‰∏çÂà∞ Webhook Ëº∏ÂÖ•Ê°Ü', 'error');
                    console.error('teamsWebhook ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                    return;
                }
                
                var enabled = enabledElement.checked;
                var webhook = webhookElement.value.trim();
                
                console.log('Teams ÂïüÁî®ÁãÄÊÖã:', enabled);
                console.log('Webhook URL:', webhook ? 'Â∑≤Ëº∏ÂÖ•' : 'Êú™Ëº∏ÂÖ•');
                
                if (!enabled) {
                    showMessage('‚ùå Ë´ãÂÖàÂïüÁî® Teams ÈÄöÁü•', 'error');
                    return;
                }
                
                if (!webhook) {
                    showMessage('‚ùå Ë´ãËº∏ÂÖ• Webhook URL', 'error');
                    return;
                }
                
                // Á∞°ÂñÆÁöÑ URL È©óË≠â
                if (!webhook.startsWith('https://')) {
                    showMessage('‚ùå Webhook URL ÂøÖÈ†à‰ª• https:// ÈñãÈ†≠', 'error');
                    return;
                }
                
                // Êö´ÊôÇÊõ¥Êñ∞Ë®≠ÂÆö‰ª•ÈÄ≤Ë°åÊ∏¨Ë©¶
                var originalSettings = {
                    teamsEnabled: settings.teamsEnabled || false,
                    teamsWebhook: settings.teamsWebhook || '',
                    teamsBackupWebhook: settings.teamsBackupWebhook || ''
                };
                
                settings.teamsEnabled = enabled;
                settings.teamsWebhook = webhook;
                settings.teamsBackupWebhook = backupWebhookElement ? backupWebhookElement.value.trim() : '';
                
                console.log('Ê∫ñÂÇôÁôºÈÄÅÊ∏¨Ë©¶ÈÄöÁü•...');
                
                // ÁôºÈÄÅÊ∏¨Ë©¶ÈÄöÁü•
                sendTeamsNotification(
                    'üß™ Teams ÈÄöÁü•Ê∏¨Ë©¶',
                    `ÈÄôÊòØ‰∏ÄÂâáÊ∏¨Ë©¶ÈÄöÁü•\nÊôÇÈñìÔºö${new Date().toLocaleString()}\nÂ¶ÇÊûúÊÇ®Êî∂Âà∞Ê≠§Ë®äÊÅØÔºåË°®Á§∫ Teams ÈÄöÁü•Ë®≠ÂÆöÊàêÂäüÔºÅ`,
                    'ÊèêÈÜí'
                ).then(() => {
                    console.log('Ê∏¨Ë©¶ÈÄöÁü•ÁôºÈÄÅÂÆåÊàê');
                }).catch((error) => {
                    console.error('Ê∏¨Ë©¶ÈÄöÁü•ÁôºÈÄÅÂ§±Êïó:', error);
                    showMessage('‚ùå Ê∏¨Ë©¶ÈÄöÁü•ÁôºÈÄÅÂ§±Êïó: ' + error.message, 'error');
                }).finally(() => {
                    // ÊÅ¢Âæ©ÂéüÂßãË®≠ÂÆö
                    settings.teamsEnabled = originalSettings.teamsEnabled;
                    settings.teamsWebhook = originalSettings.teamsWebhook;
                    settings.teamsBackupWebhook = originalSettings.teamsBackupWebhook;
                });
                
            } catch (error) {
                console.error('testTeamsNotification ÂáΩÊï∏ÈåØË™§:', error);
                showMessage('‚ùå Ê∏¨Ë©¶ÂáΩÊï∏Âü∑Ë°åÈåØË™§: ' + error.message, 'error');
            }
        }

        // ÈñãÂïüÁç®Á´ãÊ∏¨Ë©¶Â∑•ÂÖ∑
        function openTeamsTestTool() {
            try {
                window.open('teams_notification_test.html', '_blank');
                showMessage('üîß Â∑≤ÈñãÂïü Teams Ê∏¨Ë©¶Â∑•ÂÖ∑', 'info');
            } catch (error) {
                console.error('ÈñãÂïüÊ∏¨Ë©¶Â∑•ÂÖ∑Â§±Êïó:', error);
                showMessage('‚ùå ÁÑ°Ê≥ïÈñãÂïüÊ∏¨Ë©¶Â∑•ÂÖ∑', 'error');
            }
        }

        // ÈñãÂïü Webhook Ê∑±Â∫¶È©óË≠âÂ∑•ÂÖ∑
        function openWebhookValidator() {
            try {
                var webhookUrl = document.getElementById('teamsWebhook').value.trim();
                var url = 'teams_webhook_validator.html';
                if (webhookUrl) {
                    url += '?webhook=' + encodeURIComponent(webhookUrl);
                }
                window.open(url, '_blank');
                showMessage('üîç Â∑≤ÈñãÂïüÊ∑±Â∫¶È©óË≠âÂ∑•ÂÖ∑', 'info');
            } catch (error) {
                console.error('ÈñãÂïüÈ©óË≠âÂ∑•ÂÖ∑Â§±Êïó:', error);
                showMessage('‚ùå ÁÑ°Ê≥ïÈñãÂïüÈ©óË≠âÂ∑•ÂÖ∑', 'error');
            }
        }

        // Ê∏¨Ë©¶ÊúÄÁ∞°Ë®äÊÅØÊ†ºÂºè
        function testMinimalMessage() {
            try {
                var enabled = document.getElementById('teamsEnabled').checked;
                var webhook = document.getElementById('teamsWebhook').value.trim();
                
                if (!enabled) {
                    showMessage('‚ùå Ë´ãÂÖàÂïüÁî® Teams ÈÄöÁü•', 'error');
                    return;
                }
                
                if (!webhook) {
                    showMessage('‚ùå Ë´ãËº∏ÂÖ• Webhook URL', 'error');
                    return;
                }

                showMessage('üìù Ê≠£Âú®ÁôºÈÄÅÊúÄÁ∞°Ê†ºÂºèÊ∏¨Ë©¶...', 'info');
                console.log('üìù Ê∏¨Ë©¶ÊúÄÁ∞°Ë®äÊÅØÊ†ºÂºè...');

                // ‰ΩøÁî®ÊúÄÁ∞°Ê†ºÂºèÔºåTeams ÊúÄÂÆπÊòìÊé•Âèó
                var minimalPayload = {
                    "text": `üìù ÊúÄÁ∞°Ê∏¨Ë©¶Ë®äÊÅØ\nÊôÇÈñìÔºö${new Date().toLocaleString()}\nÂ¶ÇÊûúÊî∂Âà∞Ê≠§Ë®äÊÅØÔºåË°®Á§∫ Webhook ÂÆåÂÖ®Ê≠£Â∏∏ÔºÅ`
                };

                // Áõ¥Êé•‰ΩøÁî®‰ª£ÁêÜÁôºÈÄÅÊúÄÁ∞°Ê†ºÂºè
                var proxyUrl = 'https://api.allorigins.win/raw?url=';
                var fullUrl = proxyUrl + encodeURIComponent(webhook);

                fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(minimalPayload)
                })
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ ÊúÄÁ∞°Ë®äÊÅØÁôºÈÄÅÊàêÂäü');
                        showMessage('‚úÖ ÊúÄÁ∞°Ê∏¨Ë©¶Ë®äÊÅØÂ∑≤ÁôºÈÄÅÔºÅË´ãÊ™¢Êü• Teams È†ªÈÅì„ÄÇ\nÂ¶ÇÊûú‰ªçÊú™Êî∂Âà∞ÔºåÂèØËÉΩÊòØ Webhook URL ÂïèÈ°å„ÄÇ', 'success');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('‚ùå ÊúÄÁ∞°Ë®äÊÅØÁôºÈÄÅÂ§±Êïó:', error);
                    showMessage('‚ùå ÊúÄÁ∞°Ê∏¨Ë©¶Â§±Êïó: ' + error.message + '\nÂª∫Ë≠∞‰ΩøÁî®Ê∑±Â∫¶È©óË≠âÂ∑•ÂÖ∑Ê™¢Êü• Webhook„ÄÇ', 'error');
                });

            } catch (error) {
                console.error('testMinimalMessage ÂáΩÊï∏ÈåØË™§:', error);
                showMessage('‚ùå Ê∏¨Ë©¶ÂáΩÊï∏Âü∑Ë°åÈåØË™§: ' + error.message, 'error');
            }
        }

        // È°ØÁ§∫Ë®äÊÅØ
        function showMessage(message, type) {
            var statusArea = document.getElementById('statusArea');
            var className = 'status-' + (type || 'info');
            
            statusArea.innerHTML = '<div class="status ' + className + ' fade-in">' + message + '</div>';
            
            setTimeout(function() {
                if (statusArea.innerHTML.includes(message)) {
                    statusArea.innerHTML = '';
                }
            }, 5000);
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        console.log('üì± MphasisÊâìÂç°Á≥ªÁµ±Â∑≤ËºâÂÖ•');
    </script>
</body>
</html>
