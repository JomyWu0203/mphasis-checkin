<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mphasis æ‰“å¡ç³»çµ± - å„ªåŒ–ç‰ˆ</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mphasisæ‰“å¡">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Theme Colors -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-status-bar-style" content="#667eea">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eâ°%3C/text%3E%3C/svg%3E">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196F3;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            padding: 20px;
            position: relative;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .header h1 {
            color: var(--text-dark);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .status-badge {
            background: linear-gradient(45deg, var(--success-color), #45a049);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .time-card {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 3rem;
            font-weight: 200;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, monospace;
            letter-spacing: 2px;
        }

        .current-date {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .time-status {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .work-hours {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border: 1px solid var(--success-color);
        }

        .off-hours {
            background: rgba(255, 152, 0, 0.1);
            color: #ef6c00;
            border: 1px solid var(--warning-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .button-primary {
            background: linear-gradient(45deg, var(--success-color), #45a049);
            color: white;
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.3);
        }

        .button-secondary {
            background: linear-gradient(45deg, var(--info-color), #1976D2);
            color: white;
            box-shadow: 0 6px 25px rgba(33, 150, 243, 0.3);
        }

        .button-warning {
            background: linear-gradient(45deg, var(--warning-color), #f57c00);
            color: white;
            box-shadow: 0 6px 25px rgba(255, 152, 0, 0.3);
        }

        .button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
        }

        .button:disabled {
            background: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .checkin-methods {
            margin-bottom: 20px;
        }

        .method-option {
            background: var(--bg-light);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .method-option:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .method-option.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .method-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .method-description {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .last-checkin {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .last-checkin-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .last-checkin-time {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .status-message {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-weight: 500;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success-color);
            color: #2e7d32;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid var(--error-color);
            color: #c62828;
        }

        .status-info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid var(--info-color);
            color: #1565c0;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .quick-action {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .quick-action-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .quick-action-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .floating-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-button:hover {
            transform: scale(1.1);
        }

        .floating-button:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none;
        }

        /* æŒ‰éˆ•å‹•ç•«æ•ˆæœ */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 6px 25px rgba(255, 152, 0, 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 30px rgba(255, 152, 0, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 6px 25px rgba(255, 152, 0, 0.3);
            }
        }

        /* è‡ªé©æ‡‰è¨­è¨ˆ */
        @media (max-width: 375px) {
            .container {
                padding: 0 10px;
            }
            
            .current-time {
                font-size: 2.5rem;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æ´ */
        @media (prefers-color-scheme: dark) {
            .card {
                background: rgba(0, 0, 0, 0.8);
                color: white;
            }
            
            .form-group input,
            .form-group select {
                background: rgba(255, 255, 255, 0.1);
                color: white;
                border-color: rgba(255, 255, 255, 0.3);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="card header">
            <h1>â° Mphasis æ‰“å¡ç³»çµ±</h1>
            <div style="color: var(--text-light); font-size: 1rem;">å„ªåŒ–ç‰ˆ - ç¢ºä¿æ‰“å¡æˆåŠŸ</div>
            <div class="status-badge" id="systemStatus">ç³»çµ±æ­£å¸¸</div>
        </div>

        <!-- æ™‚é–“é¡¯ç¤º -->
        <div class="card time-card">
            <div class="current-time" id="currentTime">--:--</div>
            <div class="current-date" id="currentDate">è¼‰å…¥ä¸­...</div>
            <div class="time-status" id="timeStatus">æª¢æŸ¥ä¸­...</div>
        </div>

        <!-- æ‰“å¡è¨­å®š -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">âš™ï¸ æ‰“å¡è¨­å®š</h3>
            
            <div class="settings-grid">
                <div class="form-group">
                    <label for="checkinUrl">ğŸŒ æ‰“å¡ç¶²å€ï¼š</label>
                    <input type="url" id="checkinUrl" value="https://enterprise-apps.mphasis.com/ess/v1/#/home" placeholder="è«‹è¼¸å…¥å®Œæ•´çš„æ‰“å¡ç¶²å€">
                </div>

                <div class="form-group">
                    <label for="checkinTime">â° æ‰“å¡æ™‚é–“ï¼š</label>
                    <input type="time" id="checkinTime" value="09:00">
                </div>

                <div class="form-group">
                    <label for="companyName">ğŸ¢ å…¬å¸åç¨±ï¼š</label>
                    <input type="text" id="companyName" value="Mphasis" placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±">
                </div>

                <div class="form-group">
                    <label for="reminderMode">ğŸ“¢ æé†’æ¨¡å¼ï¼š</label>
                    <select id="reminderMode">
                        <option value="manual">æ‰‹å‹•æ‰“å¡</option>
                        <option value="popup">å½ˆçª—æé†’</option>
                        <option value="notification">é€šçŸ¥æé†’</option>
                    </select>
                </div>
            </div>

            <button class="button button-secondary" onclick="saveSettings()">
                ğŸ’¾ å„²å­˜è¨­å®š
            </button>
        </div>

        <!-- æ‰“å¡æ–¹æ³•é¸æ“‡ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ¯ é¸æ“‡æ‰“å¡æ–¹æ³•</h3>
            
            <div class="checkin-methods">
                <div class="method-option selected" data-method="direct" onclick="selectMethod('direct')">
                    <div class="method-title">ğŸš€ ç›´æ¥é–‹å•Ÿ (æ¨è–¦)</div>
                    <div class="method-description">åœ¨æ–°è¦–çª—ä¸­ç›´æ¥é–‹å•Ÿæ‰“å¡ç¶²ç«™</div>
                </div>

                <div class="method-option" data-method="copy" onclick="selectMethod('copy')">
                    <div class="method-title">ğŸ“‹ è¤‡è£½ç¶²å€</div>
                    <div class="method-description">è¤‡è£½ç¶²å€åˆ°å‰ªè²¼ç°¿ï¼Œæ‰‹å‹•é–‹å•Ÿç€è¦½å™¨</div>
                </div>

                <div class="method-option" data-method="bookmark" onclick="selectMethod('bookmark')">
                    <div class="method-title">ğŸ”– æ›¸ç±¤æ–¹å¼</div>
                    <div class="method-description">å»ºç«‹æ›¸ç±¤ï¼Œé»æ“Šå³å¯æ‰“å¡</div>
                </div>

                <div class="method-option" data-method="redirect" onclick="selectMethod('redirect')">
                    <div class="method-title">ğŸ”„ ç›´æ¥è·³è½‰</div>
                    <div class="method-description">ç›´æ¥è·³è½‰åˆ°æ‰“å¡ç¶²ç«™ï¼ˆæœƒé›¢é–‹ç•¶å‰é é¢ï¼‰</div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦æ‰“å¡æŒ‰éˆ• -->
        <div class="card">
            <button class="button button-primary" onclick="executeCheckin()">
                âœ… ç«‹å³æ‰“å¡
            </button>

            <div class="quick-actions">
                <div class="quick-action" onclick="testConnection()">
                    <div class="quick-action-icon">ğŸ”—</div>
                    <div class="quick-action-text">æ¸¬è©¦é€£ç·š</div>
                </div>

                <div class="quick-action" onclick="openSettings()">
                    <div class="quick-action-icon">âš™ï¸</div>
                    <div class="quick-action-text">é€²éšè¨­å®š</div>
                </div>
            </div>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <div>åŸ·è¡Œä¸­...</div>
            </div>

            <div id="statusMessage"></div>
        </div>

        <!-- æ‰“å¡è¨˜éŒ„ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ“Š æ‰“å¡è¨˜éŒ„</h3>
            
            <div class="last-checkin" id="lastCheckinRecord">
                <div class="last-checkin-title">ä¸Šæ¬¡æ‰“å¡æ™‚é–“</div>
                <div class="last-checkin-time" id="lastCheckinTime">å°šç„¡è¨˜éŒ„</div>
            </div>

            <button class="button button-secondary" onclick="viewHistory()">
                ğŸ“‹ æŸ¥çœ‹å®Œæ•´è¨˜éŒ„
            </button>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: var(--text-dark);">ğŸ› ï¸ å¿«é€Ÿæ“ä½œ</h3>
            
            <button class="button button-warning" onclick="clearAllData()">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™
            </button>

            <button class="button button-secondary" onclick="exportSettings()">
                ğŸ“¤ åŒ¯å‡ºè¨­å®š
            </button>

            <button class="button button-secondary" onclick="showHelp()">
                â“ ä½¿ç”¨èªªæ˜
            </button>
        </div>
    </div>

    <!-- æµ®å‹•æŒ‰éˆ• -->
    <button class="floating-button" onclick="quickCheckin()" title="å¿«é€Ÿæ‰“å¡">
        â°
    </button>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentMethod = 'direct';
        let settings = {
            checkinUrl: 'https://enterprise-apps.mphasis.com/ess/v1/#/home',
            checkinTime: '09:00',
            companyName: 'Mphasis',
            reminderMode: 'manual'
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateTime();
            setInterval(updateTime, 1000);
            updateTimeStatus();
            setInterval(updateTimeStatus, 60000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
            loadLastCheckin();
            
            console.log('âœ… Mphasis æ‰“å¡ç³»çµ±å„ªåŒ–ç‰ˆå·²å•Ÿå‹•');
        });

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            try {
                const saved = localStorage.getItem('mphasis_checkin_settings');
                if (saved) {
                    const savedSettings = JSON.parse(saved);
                    settings = { ...settings, ...savedSettings };
                    console.log('âœ… å¾ localStorage è¼‰å…¥è¨­å®š:', savedSettings);
                } else {
                    console.log('ğŸ“ ä½¿ç”¨é è¨­è¨­å®š:', settings);
                }
                
                // ç¢ºä¿ DOM å…ƒç´ å­˜åœ¨å¾Œå†æ›´æ–° UI
                setTimeout(() => {
                    updateSettingsUI();
                    updatePageTitle();
                }, 100);
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥è¨­å®šå¤±æ•—:', error);
                showMessage('âš ï¸ è¼‰å…¥è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­è¨­å®š', 'warning');
                // å³ä½¿è¼‰å…¥å¤±æ•—ï¼Œä¹Ÿè¦æ›´æ–° UI
                setTimeout(() => {
                    updateSettingsUI();
                }, 100);
            }
        }
        
        // æ›´æ–°è¨­å®š UI
        function updateSettingsUI() {
            try {
                const elements = {
                    checkinUrl: document.getElementById('checkinUrl'),
                    checkinTime: document.getElementById('checkinTime'),
                    companyName: document.getElementById('companyName'),
                    reminderMode: document.getElementById('reminderMode')
                };
                
                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                for (const [key, element] of Object.entries(elements)) {
                    if (element) {
                        element.value = settings[key] || '';
                        console.log(`âœ… æ›´æ–° ${key}:`, settings[key]);
                    } else {
                        console.warn(`âš ï¸ æ‰¾ä¸åˆ°å…ƒç´ : ${key}`);
                    }
                }
                
                console.log('âœ… UI æ›´æ–°å®Œæˆ');
            } catch (error) {
                console.error('âŒ æ›´æ–° UI å¤±æ•—:', error);
            }
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            try {
                // å¾è¼¸å…¥æ¬„ä½ç²å–æœ€æ–°å€¼
                const newSettings = {
                    checkinUrl: document.getElementById('checkinUrl').value.trim(),
                    checkinTime: document.getElementById('checkinTime').value,
                    companyName: document.getElementById('companyName').value.trim(),
                    reminderMode: document.getElementById('reminderMode').value
                };
                
                // é©—è­‰å¿…è¦æ¬„ä½
                if (!newSettings.checkinUrl) {
                    showMessage('âŒ è«‹è¼¸å…¥æ‰“å¡ç¶²å€', 'error');
                    return false;
                }
                
                if (!newSettings.companyName) {
                    showMessage('âŒ è«‹è¼¸å…¥å…¬å¸åç¨±', 'error');
                    return false;
                }
                
                // æ›´æ–°å…¨åŸŸè¨­å®šç‰©ä»¶
                settings = { ...settings, ...newSettings };
                
                // å„²å­˜åˆ° localStorage
                localStorage.setItem('mphasis_checkin_settings', JSON.stringify(settings));
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showMessage('âœ… è¨­å®šå·²æˆåŠŸå„²å­˜ï¼', 'success');
                
                // é‡ç½®å„²å­˜æŒ‰éˆ•ç‹€æ…‹
                resetSaveButton();
                
                // æ›´æ–°é é¢æ¨™é¡Œï¼ˆå¦‚æœæœ‰å…¬å¸åç¨±è®Šæ›´ï¼‰
                updatePageTitle();
                
                console.log('âœ… è¨­å®šå·²å„²å­˜:', settings);
                return true;
                
            } catch (error) {
                console.error('âŒ å„²å­˜è¨­å®šå¤±æ•—:', error);
                showMessage('âŒ å„²å­˜è¨­å®šå¤±æ•—ï¼š' + error.message, 'error');
                return false;
            }
        }
        
        // æ›´æ–°é é¢æ¨™é¡Œ
        function updatePageTitle() {
            if (settings.companyName && settings.companyName !== 'Mphasis') {
                document.title = `${settings.companyName} æ‰“å¡ç³»çµ± - å„ªåŒ–ç‰ˆ`;
                const headerTitle = document.querySelector('.header h1');
                if (headerTitle) {
                    headerTitle.textContent = `â° ${settings.companyName} æ‰“å¡ç³»çµ±`;
                }
            }
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            const dateStr = now.toLocaleDateString('zh-TW', { 
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
            
            document.getElementById('currentTime').textContent = timeStr.substring(0, 5); // åªé¡¯ç¤ºæ™‚åˆ†
            document.getElementById('currentDate').textContent = dateStr;
        }

        // æ›´æ–°æ™‚é–“ç‹€æ…‹
        function updateTimeStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            const statusElement = document.getElementById('timeStatus');
            
            if (currentHour >= 9 && currentHour < 18) {
                statusElement.textContent = 'ä¸Šç­æ™‚é–“ ğŸ“ˆ';
                statusElement.className = 'time-status work-hours';
            } else {
                statusElement.textContent = 'éä¸Šç­æ™‚é–“ ğŸŒ™';
                statusElement.className = 'time-status off-hours';
            }
        }

        // é¸æ“‡æ‰“å¡æ–¹æ³•
        function selectMethod(method) {
            currentMethod = method;
            
            // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.method-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // æ·»åŠ é¸ä¸­ç‹€æ…‹
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');
            
            console.log('é¸æ“‡æ‰“å¡æ–¹æ³•:', method);
        }

        // åŸ·è¡Œæ‰“å¡
        function executeCheckin() {
            const url = settings.checkinUrl;
            if (!url) {
                showMessage('âŒ è«‹å…ˆè¨­å®šæ‰“å¡ç¶²å€', 'error');
                return;
            }

            showLoading(true);
            console.log(`é–‹å§‹åŸ·è¡Œæ‰“å¡ - æ–¹æ³•: ${currentMethod}, ç¶²å€: ${url}`);

            // æ ¹æ“šé¸æ“‡çš„æ–¹æ³•åŸ·è¡Œæ‰“å¡
            switch (currentMethod) {
                case 'direct':
                    executeDirectMethod(url);
                    break;
                case 'copy':
                    executeCopyMethod(url);
                    break;
                case 'bookmark':
                    executeBookmarkMethod(url);
                    break;
                case 'redirect':
                    executeRedirectMethod(url);
                    break;
                default:
                    executeDirectMethod(url);
            }

            // è¨˜éŒ„æ‰“å¡æ™‚é–“
            recordCheckinTime();
        }

        // ç›´æ¥é–‹å•Ÿæ–¹æ³•
        function executeDirectMethod(url) {
            try {
                // å˜—è©¦å¤šç¨®é–‹å•Ÿæ–¹å¼
                const methods = [
                    () => window.open(url, '_blank', 'noopener,noreferrer'),
                    () => window.open(url, '_blank'),
                    () => {
                        const link = document.createElement('a');
                        link.href = url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                ];

                let success = false;
                for (let i = 0; i < methods.length && !success; i++) {
                    try {
                        const result = methods[i]();
                        if (result && !result.closed) {
                            success = true;
                            console.log(`ç›´æ¥é–‹å•Ÿæ–¹æ³• ${i + 1} æˆåŠŸ`);
                        }
                    } catch (e) {
                        console.warn(`ç›´æ¥é–‹å•Ÿæ–¹æ³• ${i + 1} å¤±æ•—:`, e);
                    }
                }

                setTimeout(() => {
                    showLoading(false);
                    if (success) {
                        showMessage('âœ… æ‰“å¡ç¶²ç«™å·²é–‹å•Ÿï¼è«‹å®Œæˆæ‰“å¡æµç¨‹ã€‚', 'success');
                    } else {
                        showMessage('âš ï¸ ç›´æ¥é–‹å•Ÿå¯èƒ½è¢«é˜»æ“‹ï¼Œè«‹å˜—è©¦å…¶ä»–æ–¹æ³•ã€‚', 'error');
                    }
                }, 2000);

            } catch (error) {
                showLoading(false);
                showMessage(`âŒ é–‹å•Ÿå¤±æ•—ï¼š${error.message}`, 'error');
                console.error('ç›´æ¥é–‹å•Ÿå¤±æ•—:', error);
            }
        }

        // è¤‡è£½ç¶²å€æ–¹æ³•
        function executeCopyMethod(url) {
            try {
                navigator.clipboard.writeText(url).then(() => {
                    showLoading(false);
                    showMessage('âœ… ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹é–‹å•Ÿç€è¦½å™¨ä¸¦è²¼ä¸Šã€‚', 'success');
                    console.log('ç¶²å€å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                }).catch(() => {
                    // å‚™ç”¨è¤‡è£½æ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    showLoading(false);
                    showMessage('âœ… ç¶²å€å·²è¤‡è£½ï¼è«‹æ‰‹å‹•é–‹å•Ÿç€è¦½å™¨ä¸¦è²¼ä¸Šã€‚', 'success');
                    console.log('ç¶²å€å·²è¤‡è£½ï¼ˆå‚™ç”¨æ–¹æ³•ï¼‰');
                });
            } catch (error) {
                showLoading(false);
                showMessage(`âŒ è¤‡è£½å¤±æ•—ï¼š${error.message}`, 'error');
                console.error('è¤‡è£½å¤±æ•—:', error);
            }
        }

        // æ›¸ç±¤æ–¹æ³•
        function executeBookmarkMethod(url) {
            const bookmarkScript = `javascript:window.open('${url}', '_blank');`;
            
            try {
                navigator.clipboard.writeText(bookmarkScript).then(() => {
                    showLoading(false);
                    showMessage('âœ… æ‰“å¡æ›¸ç±¤å·²è¤‡è£½ï¼è«‹å»ºç«‹æ–°æ›¸ç±¤ä¸¦è²¼ä¸Šå…§å®¹ã€‚', 'success');
                    console.log('æ›¸ç±¤å·²è¤‡è£½');
                }).catch(() => {
                    showLoading(false);
                    showMessage(`ğŸ“‹ è«‹æ‰‹å‹•è¤‡è£½æ›¸ç±¤ï¼š\\n\\n${bookmarkScript}`, 'info');
                });
            } catch (error) {
                showLoading(false);
                showMessage(`âŒ æ›¸ç±¤ç”Ÿæˆå¤±æ•—ï¼š${error.message}`, 'error');
                console.error('æ›¸ç±¤ç”Ÿæˆå¤±æ•—:', error);
            }
        }

        // ç›´æ¥è·³è½‰æ–¹æ³•
        function executeRedirectMethod(url) {
            if (confirm('âš ï¸ æ­¤æ–¹æ³•æœƒé›¢é–‹ç•¶å‰é é¢ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                showLoading(false);
                console.log('ç›´æ¥è·³è½‰åˆ°:', url);
                window.location.href = url;
            } else {
                showLoading(false);
                showMessage('âŒ å·²å–æ¶ˆè·³è½‰', 'info');
            }
        }

        // å¿«é€Ÿæ‰“å¡
        function quickCheckin() {
            console.log('å¿«é€Ÿæ‰“å¡');
            executeCheckin();
        }

        // æ¸¬è©¦é€£ç·š
        function testConnection() {
            const url = settings.checkinUrl;
            if (!url) {
                showMessage('âŒ è«‹å…ˆè¨­å®šæ‰“å¡ç¶²å€', 'error');
                return;
            }

            showLoading(true);
            console.log('æ¸¬è©¦é€£ç·š:', url);

            // å˜—è©¦å‰µå»ºä¸€å€‹åœ–ç‰‡è«‹æ±‚ä¾†æ¸¬è©¦ç¶²ç«™å¯é”æ€§
            const img = new Image();
            const timeout = setTimeout(() => {
                showLoading(false);
                showMessage('âš ï¸ é€£ç·šæ¸¬è©¦è¶…æ™‚ï¼Œç¶²ç«™å¯èƒ½ç„¡æ³•è¨ªå•', 'error');
            }, 10000);

            img.onload = img.onerror = () => {
                clearTimeout(timeout);
                showLoading(false);
                showMessage('âœ… ç¶²ç«™é€£ç·šæ­£å¸¸ï¼', 'success');
                console.log('é€£ç·šæ¸¬è©¦æˆåŠŸ');
            };

            // ä½¿ç”¨ç¶²ç«™çš„ favicon æˆ–æ ¹ç›®éŒ„ä¾†æ¸¬è©¦
            img.src = new URL(url).origin + '/favicon.ico?' + Date.now();
        }

        // è¨˜éŒ„æ‰“å¡æ™‚é–“
        function recordCheckinTime() {
            const now = new Date();
            const record = {
                timestamp: now.toISOString(),
                time: now.toLocaleString('zh-TW'),
                method: currentMethod,
                url: settings.checkinUrl
            };

            try {
                // å„²å­˜æœ€æ–°è¨˜éŒ„
                localStorage.setItem('mphasis_last_checkin', JSON.stringify(record));
                
                // å„²å­˜æ­·å²è¨˜éŒ„
                const history = JSON.parse(localStorage.getItem('mphasis_checkin_history') || '[]');
                history.unshift(record);
                
                // åªä¿ç•™æœ€è¿‘ 50 æ¬¡è¨˜éŒ„
                if (history.length > 50) {
                    history.splice(50);
                }
                
                localStorage.setItem('mphasis_checkin_history', JSON.stringify(history));
                
                // æ›´æ–°é¡¯ç¤º
                loadLastCheckin();
                
                console.log('æ‰“å¡è¨˜éŒ„å·²å„²å­˜:', record);
            } catch (error) {
                console.error('å„²å­˜æ‰“å¡è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥æœ€å¾Œæ‰“å¡è¨˜éŒ„
        function loadLastCheckin() {
            try {
                const lastCheckin = localStorage.getItem('mphasis_last_checkin');
                if (lastCheckin) {
                    const record = JSON.parse(lastCheckin);
                    document.getElementById('lastCheckinTime').textContent = record.time;
                } else {
                    document.getElementById('lastCheckinTime').textContent = 'å°šç„¡è¨˜éŒ„';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ‰“å¡è¨˜éŒ„å¤±æ•—:', error);
                document.getElementById('lastCheckinTime').textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }

        // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('statusMessage');
            messageContainer.innerHTML = `
                <div class="status-message status-${type}">
                    ${message}
                </div>
            `;

            // 3ç§’å¾Œè‡ªå‹•æ¸…é™¤è¨Šæ¯
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        // é–‹å•Ÿè¨­å®š
        function openSettings() {
            document.getElementById('checkinUrl').focus();
        }

        // æŸ¥çœ‹æ­·å²è¨˜éŒ„
        function viewHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('mphasis_checkin_history') || '[]');
                
                if (history.length === 0) {
                    showMessage('ğŸ“‹ å°šç„¡æ‰“å¡è¨˜éŒ„', 'info');
                    return;
                }

                let historyText = 'ğŸ“Š æœ€è¿‘æ‰“å¡è¨˜éŒ„ï¼š\\n\\n';
                history.slice(0, 10).forEach((record, index) => {
                    historyText += `${index + 1}. ${record.time} (${record.method})\\n`;
                });

                alert(historyText);
            } catch (error) {
                console.error('æŸ¥çœ‹æ­·å²è¨˜éŒ„å¤±æ•—:', error);
                showMessage('âŒ æŸ¥çœ‹æ­·å²è¨˜éŒ„å¤±æ•—', 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                try {
                    localStorage.removeItem('mphasis_checkin_settings');
                    localStorage.removeItem('mphasis_last_checkin');
                    localStorage.removeItem('mphasis_checkin_history');
                    
                    // é‡æ–°è¼‰å…¥é é¢
                    location.reload();
                } catch (error) {
                    console.error('æ¸…é™¤è³‡æ–™å¤±æ•—:', error);
                    showMessage('âŒ æ¸…é™¤è³‡æ–™å¤±æ•—', 'error');
                }
            }
        }

        // åŒ¯å‡ºè¨­å®š
        function exportSettings() {
            try {
                const data = {
                    settings: settings,
                    lastCheckin: JSON.parse(localStorage.getItem('mphasis_last_checkin') || 'null'),
                    history: JSON.parse(localStorage.getItem('mphasis_checkin_history') || '[]')
                };

                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `mphasis_checkin_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('âœ… è¨­å®šå·²åŒ¯å‡º', 'success');
            } catch (error) {
                console.error('åŒ¯å‡ºè¨­å®šå¤±æ•—:', error);
                showMessage('âŒ åŒ¯å‡ºè¨­å®šå¤±æ•—', 'error');
            }
        }

        // é¡¯ç¤ºä½¿ç”¨èªªæ˜
        function showHelp() {
            const helpText = `
ğŸ“± Mphasis æ‰“å¡ç³»çµ±ä½¿ç”¨èªªæ˜

ğŸ¯ æ‰“å¡æ–¹æ³•ï¼š
â€¢ ç›´æ¥é–‹å•Ÿï¼šåœ¨æ–°è¦–çª—é–‹å•Ÿæ‰“å¡ç¶²ç«™ï¼ˆæ¨è–¦ï¼‰
â€¢ è¤‡è£½ç¶²å€ï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œæ‰‹å‹•é–‹å•Ÿ
â€¢ æ›¸ç±¤æ–¹å¼ï¼šå»ºç«‹æ›¸ç±¤ï¼Œä¸€éµæ‰“å¡
â€¢ ç›´æ¥è·³è½‰ï¼šè·³è½‰åˆ°æ‰“å¡ç¶²ç«™

âš™ï¸ è¨­å®šèªªæ˜ï¼š
â€¢ æ‰“å¡ç¶²å€ï¼šæ‚¨å…¬å¸çš„æ‰“å¡ç³»çµ±ç¶²å€
â€¢ æ‰“å¡æ™‚é–“ï¼šè¨­å®šæé†’æ™‚é–“
â€¢ å…¬å¸åç¨±ï¼šè‡ªè¨‚å…¬å¸åç¨±
â€¢ æé†’æ¨¡å¼ï¼šé¸æ“‡æé†’æ–¹å¼

ğŸ› ï¸ æ•…éšœæ’é™¤ï¼š
â€¢ å¦‚æœç›´æ¥é–‹å•Ÿå¤±æ•—ï¼Œå˜—è©¦è¤‡è£½ç¶²å€æ–¹æ³•
â€¢ ç¢ºä¿ç€è¦½å™¨å…è¨±å½ˆçª—
â€¢ æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸

â“ éœ€è¦å”åŠ©ï¼Ÿ
è«‹ç¢ºä¿å·²æ­£ç¢ºè¨­å®šæ‰“å¡ç¶²å€å’Œç›¸é—œåƒæ•¸ã€‚
            `;
            
            alert(helpText);
        }

        // ç›£è½éŒ¯èª¤
        window.addEventListener('error', function(e) {
            console.error('JavaScript éŒ¯èª¤:', e.error);
        });

        // ç›£è½è¨­å®šè®Šæ›´ - åªé¡¯ç¤ºæç¤ºï¼Œä¸è‡ªå‹•å„²å­˜
        document.getElementById('checkinUrl').addEventListener('input', showUnsavedChanges);
        document.getElementById('checkinTime').addEventListener('change', showUnsavedChanges);
        document.getElementById('companyName').addEventListener('input', showUnsavedChanges);
        document.getElementById('reminderMode').addEventListener('change', showUnsavedChanges);
        
        // é¡¯ç¤ºæœªå„²å­˜è®Šæ›´æç¤º
        function showUnsavedChanges() {
            const saveButton = document.querySelector('button[onclick="saveSettings()"]');
            if (saveButton) {
                saveButton.style.background = 'linear-gradient(45deg, #ff9800, #f57c00)';
                saveButton.textContent = 'ğŸ’¾ æœ‰è®Šæ›´éœ€è¦å„²å­˜';
                saveButton.style.animation = 'pulse 2s infinite';
            }
        }
        
        // é‡ç½®å„²å­˜æŒ‰éˆ•ç‹€æ…‹
        function resetSaveButton() {
            const saveButton = document.querySelector('button[onclick="saveSettings()"]');
            if (saveButton) {
                saveButton.style.background = 'linear-gradient(45deg, #2196F3, #1976D2)';
                saveButton.textContent = 'ğŸ’¾ å„²å­˜è¨­å®š';
                saveButton.style.animation = 'none';
            }
        }

        console.log('ğŸš€ Mphasis æ‰“å¡ç³»çµ±å„ªåŒ–ç‰ˆåˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>
